******* ZR900PD 109 <1263748030>
      ******************************************************************
      *                           ZR900PD                              *
      ******************************************************************
      ******************************************************************
      * Program Logic                                                  *
      * - Based on AR251 Aging                                         *
      * - Logic added to create 80(direct billed customer) recs        *
      *     and to create 81(employer billed customer recs             *
      * - Logic added to capture transactions AFTER the as of date     *
      *     to send them to 82(invoice and credit) and 84(Payment) recs*
      *     - 1150 paragraph will write trans > as of date to WF4      *
      * - Logic to use  PBHSTDTL added to do extracts at benefit level *
      *     instead of the invoice level.                              *
      *     - paragraphs 1085, 1087, 1088 for 80/81 recs               *
      *     - paragraphs 3020, 3021, 3022 for 82 recs                  *
      *     - Matching PBHSTDTL with invoice requires looking at the   *
      *         ARO-DESC and doing an IF10 lookup with teh PBHSTDTL    *
      *         plan type and plan code to match the ARO-DESC.         *
      *         This is because PBHSTDTL drops the last two digits of  *
      *         the invoice number when WBxxx logic creates the recs   *
      * - Retro logic added to 80/81 and 82 record processing          *
      *     - 80/81 - 1088 paragraph will capture retros from pbhstdtl *
      *         related to pre-as-of-date invoices and send them to WF4*
      *         so 82 record will be created in detail,(no summary)    *
      *     - 82 - 3022 paragraph will capture retros from pbhstdtl    *
      *                                                                *
      * - Custom Headers are required, so the extracts files have the  *
      *   headers concatenated onto them at the end of processing.     *
      *                                                                *
      * - "ARTOAP"logic will exclude credit adjs  that were sent to AP *
      *    via the ARAPSELECT table even if the adjustment happened    *
      *    after the AS-OF date.  See 710-OPEN-CREDIT-LW logic copied  *
      *    from ARCOMMOPEN pdlib and modified with ARTOAP mod codes    *
      * - "DB0001" Direct billed PBHSTDTL logic: there is a 1:1        *
      *    relationship of invoice:pbhstdtl for "D" customers so to    *
      *    avoid including PBHSTDTL multiple time we need to match     *
      *    them based on invoice sequence & order in pbhstdtl          *
      * **Pending logic notes                                          *
      ******************************************************************
      ******************************************************************
      *               M O D I F I C A T I O N   L O G
      ******************************************************************
      *    Date    Pgmr               Description
      * 07/14/22 D.Steger       -ZR900 is a copy of AR251 modifed as 
      *          S.Calvin        described below:
      *                         -Add two more aging buckets for 150 and
      *                          170 days past due.
      *                         -Add work file ZR9002WORK to allow pgm
      *                          to summarize by employee, employer and
      *                          Lifeworks plan in section 2000-DO-LIFE~
      *                         -Output files for Lifeworks interface.
      *                          Records are type 80, 81, 83 and 84
      *              P3FX01 - Set biling entity to Employer value for
      *                       supplife billing items for Employer recs
      *              P3FX02 - Suppress 0 $ payments                   
      *              P3FX03 - Put Employee number in BILLING-ENTITY for
      *                        suppLife records.
      *              P3FX04 - On ManAdj credits - reverse sign on Amount
      *              P3FX05 - Fix negative on credit calculations for 
      *                       pre-as-of-date items  
      *              P3FX06 - Fix Amt on partial applied partial ARTOAP
      *              P3FX07 - Add logic for payments sent to AP (!!!)
      *              P3FX08 - Skip Cancelled payments if not applied 
      *                       but continue to keep cancelled that are appld
      *              P3FX09 - Logic to alter credit balance to open if 
      *                       credit is applied to an obligation that is
      *                       dated after teh as-of date (this is to 
      *                       account for an odd business practice)
      *                       e.g. ER05055 9/14 debit memo
      *              P3FX10 - Skip bad data on customer D32702300      
      *              P3FX11 - Skip bad data on customer ER07499        
      *              P3FX12 - Add Benefit check on pbhstdtl lookup for
      *                       direct billed customers
      *              P3FX13 - Fix for partial appld cancelled payment 
      *                       e.g. ER04620 as of 9/1/22 
      *              P3FX14 - Avoid double counting of unapplied pmts
      *                       when falling on AS OF date                      
      *              P3FX15 - Fix rounding on compute                 
      *              P3FX16 - Fix rounding on pbhstdtl partial applies
      *              P3FX17 - More rounding fixes to consider orig amt
      *              P3FX18 - Add benefit to 1086-D paragraph logic   
      *              P3FX19 - Add Rounding fixes to WF4 processing    
      *              P3FX20 - Revise rounding logic to count pbhstdtls
      *              P3FX21 - Change Status calc to be from extract date
      *                       instead of AS-OF date(clone AR50 logic)
      *              P3FX22 - Add 120-15,150-170 and over 170 logic to FX21
      *              P3FX23 - Always display LW-INVOICE Column for CPS     
      *                       to use in research - they will remove before
      *                       sending to LW
      *              P3FX24 - For 82 Recs with ManAdj - Send distribution
      *                       information
      ******************************************************************
       050-EDIT-PARAMETERS             SECTION 10.
      ******************************************************************
       050-START.

000100     IF  (PRM-COMPANY                 = ZEROS)
000110     AND (PRM-COMPANY-GROUP           = SPACES)
000120         MOVE 053                    TO CRT-ERROR-NBR
               MOVE WS-TRUE                TO WS-PARAMETER-ERROR
000130         PERFORM 780-PRINT-ERROR-MSG
000140         GO TO 050-END.
000150
000160     IF  (PRM-COMPANY                 NOT = ZEROS)
000170     AND (PRM-COMPANY-GROUP           NOT = SPACES)
000180         MOVE 054                    TO CRT-ERROR-NBR
               MOVE WS-TRUE                TO WS-PARAMETER-ERROR
000190         PERFORM 780-PRINT-ERROR-MSG
000200         GO TO 050-END.
000210
000220     IF (PRM-COMPANY-GROUP            NOT = SPACES)
000230         MOVE PRM-COMPANY-GROUP       TO DB-COMPANY-GROUP
000240         PERFORM 840-KFIND-GCGSET1
000250         IF (GLCPYGRP-KNOTFOUND)
000260             MOVE PRM-COMPANY-GROUP   TO CRT-ERR-VAR1
000270             MOVE 055                 TO CRT-ERROR-NBR
000280             PERFORM 780-PRINT-ERROR-MSG
000290             GO TO 050-END
000300         ELSE
000310             MOVE GCCSET3-COMPANY-GROUP TO WS-DB-BEG-RNG
000320             PERFORM 850-FIND-BEGRNG-GCCSET3
000330             IF (GLCGCPY-NOTFOUND)
000340                 MOVE PRM-COMPANY-GROUP TO CRT-ERR-VAR1
000350                 MOVE 056               TO CRT-ERROR-NBR
000360                 PERFORM 780-PRINT-ERROR-MSG
000370                 GO TO 050-END.
000380
           IF  (PRM-REPORT-OPTION = "L")
           AND (PRM-ACTIVITY-LIST = SPACES)
               MOVE 078                     TO CRT-ERROR-NBR
               MOVE WS-TRUE                 TO WS-PARAMETER-ERROR
000190         PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

J56704**** JT-356704 BILL-TO ENHANCEMENT
J56704     IF  (PRM-ARO-BILL-TO    NOT = ZEROES)
           AND (PRM-COMPANY        NOT = ZEROES)
           AND (PRM-CUSTOMER       NOT = SPACES)
               MOVE PRM-COMPANY             TO DB-COMPANY
               PERFORM 840-FIND-ACOSET1
               IF (ARCOMP-FOUND)
                   MOVE ACO-CUST-GROUP      TO DB-CUST-GROUP
                   MOVE PRM-CUSTOMER        TO DB-CUSTOMER
                   MOVE PRM-ARO-BILL-TO     TO DB-BILL-TO
                   PERFORM 840-FIND-ABSSET1
                   IF (BILLTO-NOTFOUND)
                       MOVE PRM-ARO-BILL-TO TO CRT-ERR-VAR1
                       MOVE PRM-CUSTOMER    TO CRT-ERR-VAR2
                       MOVE 105             TO CRT-ERROR-NBR
                       MOVE WS-TRUE         TO WS-PARAMETER-ERROR
                       PERFORM 780-PRINT-ERROR-MSG
                       GO TO 050-END
                   END-IF
               END-IF
           END-IF.

J56704     IF  (PRM-ARO-BILL-TO    NOT = ZEROES)
           AND (PRM-REPORT-OPTION  NOT = "B")
               MOVE 101                     TO CRT-ERROR-NBR
               MOVE WS-TRUE                 TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

J56704     IF  (PRM-ARO-BILL-TO    NOT = ZEROES)
           AND (PRM-INCLUDE-PAYMENTS   = "Y")
               MOVE 102                     TO CRT-ERROR-NBR
               MOVE WS-TRUE                 TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

J56704     IF  (PRM-REPORT-OPTION      = "B")
           AND (PRM-INCLUDE-PAYMENTS   = "Y")
               MOVE 103                     TO CRT-ERROR-NBR
               MOVE WS-TRUE                 TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

J56704     IF  (PRM-REPORT-OPTION      = "B")
           AND (PRM-DETAIL-OPTION      = "C")
               MOVE 104                     TO CRT-ERROR-NBR
               MOVE WS-TRUE                 TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

           IF (PRM-ACTIVITY                    NOT = SPACES)
               IF (PRM-ACTIVITY-LIST           NOT = SPACES)
                   MOVE 077                    TO CRT-ERROR-NBR
                   MOVE WS-TRUE                TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO  TO 050-END.

           IF  (PRM-MIN-CLASS           NOT = SPACES)
           AND (PRM-MAJ-CLASS           = SPACES)
               MOVE 100                    TO CRT-ERROR-NBR
               MOVE WS-TRUE                TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

           IF (PRM-MAJ-CLASS            NOT = SPACES)
               MOVE PRM-MAJ-CLASS       TO DB-MAJOR-CLASS
               PERFORM 840-KFIND-MJCSET1
               IF (MAJCUSTCL-KNOTFOUND)
                   MOVE 057                    TO CRT-ERROR-NBR
                   MOVE WS-TRUE                TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 050-END.

           IF (PRM-MIN-CLASS            NOT = SPACES)
               MOVE PRM-MAJ-CLASS       TO DB-MAJOR-CLASS
               MOVE PRM-MIN-CLASS       TO DB-MINOR-CLASS
               PERFORM 840-KFIND-MNCSET1
               IF (MINCUSTCL-KNOTFOUND)
                   MOVE 058                    TO CRT-ERROR-NBR
                   MOVE WS-TRUE                TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 050-END.

           IF  (PRM-CUSTOMER            NOT = SPACES)
           AND (PRM-CREDIT-ANLYST       NOT = SPACES)
               MOVE 088                    TO CRT-ERROR-NBR
               MOVE WS-TRUE                TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

           IF (PRM-CUSTOMER            NOT = SPACES)
               IF (PRM-MATRIX-LIST     NOT = SPACES)
               OR (PRM-CREDIT-ANLYST   NOT = SPACES)
               OR (PRM-MAJ-CLASS       NOT = SPACES)
               OR (PRM-BALANCE         NOT = ZEROS)
      *         OR (PRM-PAST-DUE-ONLY       = "Y")
                   MOVE 091                    TO CRT-ERROR-NBR
                   MOVE WS-TRUE                TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 050-END.

           IF (PRM-MATRIX-LIST         NOT = SPACES)
               MOVE PRM-MTH-OBJ-TYPE   TO ARMXWS-OBJ-TYPE
               MOVE PRM-MATRIX-LIST    TO ARMXWS-MATRIX-LIST
               PERFORM 7000-VALIDATE-ARMXLIST
               IF (ERROR-FOUND)
                   MOVE PRM-MATRIX-LIST TO CRT-ERR-VAR1
                   MOVE WS-TRUE                TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 050-END.

           IF (PRM-TO-TRANS-USER1       NOT = SPACES)
               IF (PRM-FR-TRANS-USER1   = SPACES)
                   MOVE 060                    TO CRT-ERROR-NBR
                   MOVE WS-TRUE                TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 050-END.

           IF (PRM-TO-TRANS-USER1              = SPACES)
               MOVE PRM-FR-TRANS-USER1         TO PRM-TO-TRANS-USER1.

           IF (PRM-FR-TRANS-USER1              > PRM-TO-TRANS-USER1)
               MOVE 097                        TO CRT-ERROR-NBR
               MOVE WS-TRUE                    TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

           IF (PRM-TO-SALESMAN          NOT = ZEROES)
               IF (PRM-FR-SALESMAN      = ZEROES)
                   MOVE 061                    TO CRT-ERROR-NBR
                   MOVE WS-TRUE                TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 050-END.

           IF (PRM-TO-SALESMAN          = ZEROES)
               IF (PRM-FR-SALESMAN      NOT = ZEROES)
                   MOVE PRM-FR-SALESMAN TO PRM-TO-SALESMAN.

           IF (PRM-FR-SALESMAN          > PRM-TO-SALESMAN)
               MOVE 062                     TO CRT-ERROR-NBR
               MOVE WS-TRUE                 TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

           IF  (PRM-TRANS-DATE          = ZEROES)
           AND (PRM-PERIOD-OF           = SPACES)
               MOVE 064                     TO CRT-ERROR-NBR
               MOVE WS-TRUE                 TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

           IF  (PRM-TRANS-DATE          NOT = ZEROES)
           AND (PRM-PERIOD-OF           = "P")
               MOVE 065                     TO CRT-ERROR-NBR
               MOVE WS-TRUE                 TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

           IF  (PRM-TRANS-DATE          = ZEROES)
           AND (PRM-PERIOD-OF           = "A")
               MOVE 075                     TO CRT-ERROR-NBR
               MOVE WS-TRUE                 TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

           IF  (PRM-PERIOD-OF           = "A")
           AND (PRM-FUTURE-APPS         = "N")
               MOVE 076                     TO CRT-ERROR-NBR
               MOVE WS-TRUE                 TO WS-PARAMETER-ERROR
               PERFORM 780-PRINT-ERROR-MSG
               GO TO 050-END.

           MOVE PRM-AGE-PERIODS-1   TO ZR900WS-PRM-AGE-PERIODS-1.
           MOVE PRM-AGE-PERIODS-2   TO ZR900WS-PRM-AGE-PERIODS-2.
           MOVE PRM-AGE-PERIODS-3   TO ZR900WS-PRM-AGE-PERIODS-3.
           MOVE PRM-AGE-PERIODS-4   TO ZR900WS-PRM-AGE-PERIODS-4.
           MOVE PRM-AGE-PERIODS-5   TO ZR900WS-PRM-AGE-PERIODS-5.
           MOVE PRM-AGE-PERIODS-6   TO ZR900WS-PRM-AGE-PERIODS-6.

           MOVE PRM-AGE-CURRENT        TO ZR900WS-PRM-AGE-CURRENT.
           MOVE PRM-AGE-AGE-CREDITS    TO ZR900WS-PRM-AGE-AGE-CREDITS.
           MOVE PRM-AGE-AGE-PYMNT      TO ZR900WS-PRM-AGE-AGE-PYMNT.
           MOVE PRM-AGE-AGE-DISPUTES   TO ZR900WS-PRM-AGE-AGE-DISPUTES.
           MOVE PRM-ACO-AGE-TYPE       TO ZR900WS-PRM-ACO-AGE-TYPE.

           IF (PRM-COMPANY                     NOT = ZEROS)
               MOVE PRM-COMPANY                TO ZR900WS-PRM-COMPANY
               MOVE WS-TRUE                    TO ZR900WS-PASS-EDITS
               PERFORM 101-EDIT-PARAMETERS
               IF (ZR900WS-PASS-EDITS          = WS-FALSE)
J37933             MOVE WS-TRUE                TO ZR900WS-ERROR-FL
                   GO TO 050-END.


       050-END.

      ******************************************************************
       100-PROGRAM-CONTROL             SECTION 10.
      ******************************************************************
       100-START.

           MOVE WS-FALSE                TO ZR900WS-FINISH.
AI0000     MOVE PRM-TRANS-DATE          TO WS-AS-OF-DATE-ALP.
           MOVE PRM-TRANS-DATE          TO WSDR-FR-DATE.
           PERFORM 900-DATE-TO-JULIAN.
           MOVE WSDR-JULIAN-DAYS        TO ZR900WS-ASOF-DAYS.

           PERFORM 1000-OPEN-WORKFLOW-DB.
           PERFORM 600-BEGIN-BROADCAST.

           MOVE PRM-PRINT-FILE          TO ZR900WS-PRINT-FILE-1.

           MOVE 051                     TO CRT-MSG-NBR.
           PERFORM 780-DISPLAY-MSG.

           PERFORM 840-FIND-CKPSET1.
           IF  (CKPOINT-FOUND)
           AND (CKP-RESTART-INFO       NOT = SPACES)
               MOVE CKP-RESTART-INFO   TO ZR900WS-RESTART-DATA
               MOVE WS-TRUE            TO PROGRAM-RESTARTING.

           PERFORM 900-BUILD-TMP-FILE-NAME.
           MOVE WS-TMP-FILE         TO WS-ZR9001WORK-NAME.
AI0000     PERFORM 900-BUILD-TMP-FILE-NAME.
AI0000     MOVE WS-TMP-FILE         TO WS-ZR9002WORK-NAME.
           INITIALIZE   RPT-PAGE-COUNT (ZR900-R2).
           MOVE WS-FALSE                TO ZR900WS-ERROR-FL.

091502     IF  (PRM-COMPANY-GROUP    NOT = SPACES)
091502     AND (PRM-CSV-FILE-OPT         = "Y")  
091502          PERFORM 800-OPENOUTPUTCSV-CUSTDET
091502     END-IF.
      *--- Open Extract files
AI0000     PERFORM 900-BUILD-TMP-FILE-NAME.
AI0000     MOVE WS-TMP-FILE         TO WS-HEADER80-FILE.
AI0000     PERFORM 800-OPENOUTPUTCSV-HEADER80.
AI0000     PERFORM 900-BUILD-TMP-FILE-NAME.
AI0000     MOVE WS-TMP-FILE         TO WS-HEADER81-FILE.
AI0000     PERFORM 800-OPENOUTPUTCSV-HEADER81.
AI0000     PERFORM 900-BUILD-TMP-FILE-NAME.
AI0000     MOVE WS-TMP-FILE         TO WS-HEADER82-FILE.
AI0000     PERFORM 800-OPENOUTPUTCSV-HEADER82.
AI0000     PERFORM 900-BUILD-TMP-FILE-NAME.
AI0000     MOVE WS-TMP-FILE         TO WS-HEADER84-FILE.
AI0000     PERFORM 800-OPENOUTPUTCSV-HEADER84.
AI0000     PERFORM 900-BUILD-TMP-FILE-NAME.
AI0000     MOVE WS-TMP-FILE         TO WS-RECORD80-FILE.
AI0000     PERFORM 800-OPENOUTPUTCSV-RECORD80.
AI0000     PERFORM 900-BUILD-TMP-FILE-NAME.
AI0000     MOVE WS-TMP-FILE         TO WS-RECORD81-FILE.
AI0000     PERFORM 800-OPENOUTPUTCSV-RECORD81.
AI0000     PERFORM 900-BUILD-TMP-FILE-NAME.
AI0000     MOVE WS-TMP-FILE         TO WS-RECORD82-FILE.
AI0000     PERFORM 800-OPENOUTPUTCSV-RECORD82.
AI0000     PERFORM 900-BUILD-TMP-FILE-NAME.
AI0000     MOVE WS-TMP-FILE         TO WS-RECORD84-FILE.
AI0000     PERFORM 800-OPENOUTPUTCSV-RECORD84.
AI0000     PERFORM 900-BUILD-TMP-FILE-NAME.
AI0000     MOVE WS-TMP-FILE         TO WS-REC84WRK-FILE.
AI0000     OPEN OUTPUT REC84WRK-FILE.

           IF (PRM-COMPANY-GROUP            NOT = SPACES)
               MOVE WS-FALSE                TO ZR900WS-FINISH
               MOVE PRM-COMPANY-GROUP       TO DB-COMPANY-GROUP
               MOVE GCCSET3-COMPANY-GROUP   TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-GCCSET3
               PERFORM
               UNTIL (GLCGCPY-NOTFOUND)
                   MOVE WS-FALSE           TO ZR900WS-FINISH
                   IF (PROGRAM-RESTARTING   = WS-TRUE)
                       IF (GCC-COMPANY      = ZR900WS-RESTART-COMPANY)
                           MOVE GCC-COMPANY TO ZR900WS-PRM-COMPANY
                           MOVE WS-TRUE     TO ZR900WS-PASS-EDITS
                           PERFORM 101-EDIT-PARAMETERS
                           IF (ZR900WS-PASS-EDITS = WS-TRUE)
                               PERFORM 1000-SEL-REPORT
                           ELSE
                               MOVE WS-TRUE      TO ZR900WS-ERROR-FL
                           END-IF
                           MOVE WS-FALSE    TO PROGRAM-RESTARTING
                       END-IF
                   ELSE
                       MOVE WS-TRUE         TO ZR900WS-PASS-EDITS
                       MOVE GCC-COMPANY     TO ZR900WS-PRM-COMPANY
                       PERFORM 101-EDIT-PARAMETERS
                       IF (ZR900WS-PASS-EDITS = WS-TRUE)
                           PERFORM 910-AUDIT-BEGIN
                           PERFORM 840-MODIFY-CKPSET1
                           MOVE ZR900WS-PRM-COMPANY
                                              TO ZR900WS-RESTART-COMPANY
                           MOVE PRM-COMPANY-GROUP
                                              TO ZR900WS-RESTART-CO-GRP
                           MOVE ZR900WS-RESTART-DATA TO CKP-RESTART-INFO
                           PERFORM 820-STORE-CKPOINT
                           PERFORM 900-SAVE-PRINT-FILES
                           PERFORM 920-AUDIT-END
                           PERFORM 1000-SEL-REPORT
                       ELSE
                           MOVE WS-TRUE      TO ZR900WS-ERROR-FL
                       END-IF
                   END-IF
                   PERFORM 860-FIND-NXTRNG-GCCSET3
               END-PERFORM.

091502     IF  (PRM-COMPANY-GROUP  NOT = SPACES)
091502     AND (CS1INFO-FILE-OPEN  NOT = "N")
091502          PERFORM 800-CLOSECSV-CUSTDET 
091502     END-IF.

           IF (PRM-COMPANY                  NOT = ZEROS)
               MOVE PRM-COMPANY             TO ZR900WS-PRM-COMPANY
               PERFORM 910-AUDIT-BEGIN
               PERFORM 840-MODIFY-CKPSET1
               MOVE ZR900WS-PRM-COMPANY  TO ZR900WS-RESTART-COMPANY
               MOVE PRM-COMPANY-GROUP    TO ZR900WS-RESTART-CO-GRP
               PERFORM 820-STORE-CKPOINT
               PERFORM 900-SAVE-PRINT-FILES
               PERFORM 920-AUDIT-END
               PERFORM 1000-SEL-REPORT.

AI0000     CLOSE REC84WRK-FILE SAVE.
AI0000     PERFORM 2000-DO-LIFEWORKS-PHASE1.
AI0000
AI0000     CLOSE REC84WRK-FILE SAVE.
AI0000     PERFORM 3000-DO-LIFEWORKS-PHASE2.
AI0000
           MOVE WS-ZR9001WORK-NAME  TO WS-TMP-FILE.
           PERFORM 901-REMOVE-TMP-FILE.
AI0000     MOVE WS-ZR9002WORK-NAME  TO WS-TMP-FILE.
AI0000     PERFORM 901-REMOVE-TMP-FILE.

           PERFORM 605-END-BROADCAST.
AI0000*--- Write Header Records
AI0000     MOVE "80"             TO H80-DATA-TYPE.
AI0000     MOVE "0"              TO H80-RECORD-TYPE.    
AI0000     MOVE "001"            TO H80-VERSION-CODE.     
AI0000     MOVE WS-80-COUNT      TO H80-RECORD-COUNT.     
AI0000     PERFORM 800-WRITECSV-HEADER80.
AI0000     MOVE "81"             TO H81-DATA-TYPE.
AI0000     MOVE "0"              TO H81-RECORD-TYPE.    
AI0000     MOVE "001"            TO H81-VERSION-CODE.     
AI0000     MOVE WS-81-COUNT      TO H81-RECORD-COUNT.     
AI0000     PERFORM 800-WRITECSV-HEADER81.
AI0000     MOVE "82"             TO H82-DATA-TYPE.
AI0000     MOVE "0"              TO H82-RECORD-TYPE.    
AI0000     MOVE "001"            TO H82-VERSION-CODE.     
AI0000     MOVE WS-82-COUNT      TO H82-RECORD-COUNT.     
AI0000     PERFORM 800-WRITECSV-HEADER82.
AI0000     MOVE "84"             TO H84-DATA-TYPE.
AI0000     MOVE "0"              TO H84-RECORD-TYPE.    
AI0000     MOVE "001"            TO H84-VERSION-CODE.     
AI0000     MOVE WS-84-COUNT      TO H84-RECORD-COUNT.     
AI0000     PERFORM 800-WRITECSV-HEADER84.
AI0000*--- Close detail and header CSV files then cat them together.
AI0000     PERFORM 800-CLOSECSV-RECORD80. 
AI0000     PERFORM 800-CLOSECSV-RECORD81. 
AI0000     PERFORM 800-CLOSECSV-RECORD82. 
AI0000     PERFORM 800-CLOSECSV-RECORD84. 
AI0000     CLOSE REC84WRK-FILE.
AI0000     PERFORM 800-CLOSECSV-HEADER80. 
AI0000     PERFORM 800-CLOSECSV-HEADER81. 
AI0000     PERFORM 800-CLOSECSV-HEADER82. 
AI0000     PERFORM 800-CLOSECSV-HEADER84. 
AI0000     PERFORM 2500-CONCATENATE-FILES.
       
       100-END.

      ******************************************************************
       101-EDIT-PARAMETERS                  SECTION 50.
      ******************************************************************
       101-START.

           INITIALIZE CRT-ERROR-NBR
                      CRT-ERROR-CAT.
           MOVE ZR900WS-PRM-COMPANY         TO DB-COMPANY.
           PERFORM 840-FIND-ACOSET1.
           IF (ARCOMP-NOTFOUND)
               MOVE SPACES                  TO ZR900WS-CO-NAME
               MOVE 050                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR
               END-IF
           ELSE
               MOVE ACO-NAME                TO ZR900WS-CO-NAME.

           MOVE ACO-CUST-GROUP                 TO DB-CUST-GROUP.
           PERFORM 840-FIND-ACGSET1.
           IF (ARCUSTGRP-NOTFOUND)
               MOVE 089                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-ACTIVITY                    NOT = SPACES)
               IF (PRM-ACTIVITY-LIST           NOT = SPACES)
                   MOVE ZR900WS-PRM-COMPANY        TO ACACWS-COMPANY
                   MOVE PRM-ACTIVITY               TO ACACWS-ACTIVITY
                   INITIALIZE ACACWS-ACCT-CATEGORY
                   MOVE "3"              TO ACACWS-EDIT-CODE
                   MOVE "N"              TO ACACWS-CURRENCY-OR
                   MOVE "N"              TO ACACWS-ACCT-CAT-OR
                   MOVE "N"              TO ACACWS-RESOURCE-OR
                   MOVE "N"              TO ACACWS-BUDGET-OR
                   MOVE "N"              TO ACACWS-GL-OR
                   MOVE "N"              TO ACACWS-POST
                   PERFORM 640-EDIT-ACTIVITY-70
                   IF (ERROR-FOUND)
                       IF (PRM-COMPANY          NOT = ZEROS)
                           MOVE WS-TRUE         TO WS-PARAMETER-ERROR
                           PERFORM 780-PRINT-ERROR-MSG
                           GO TO 101-END
                       ELSE
                           GO TO 101-PRINT-ERROR.

           IF (PRM-CUSTOMER                    NOT = SPACES)
               MOVE PRM-CUSTOMER               TO DB-CUSTOMER
               PERFORM 700-EDIT-CUSTOMER-NBR
               IF (ERROR-FOUND)
                   MOVE PRM-CUSTOMER           TO CRT-ERR-VAR1
                   MOVE WS-TRUE                TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
J64120             MOVE ZR900WS-PRM-COMPANY    TO DB-COMPANY
                   MOVE DB-CUSTOMER            TO PRM-CUSTOMER
                   PERFORM 840-FIND-ACMSET1
                   IF (ARCUSTOMER-NOTFOUND)
                       MOVE PRM-CUSTOMER       TO CRT-ERR-VAR1
                       MOVE 099                TO CRT-ERROR-NBR
                       IF (PRM-COMPANY         NOT = ZEROS)
                           MOVE WS-TRUE        TO WS-PARAMETER-ERROR
                           PERFORM 780-PRINT-ERROR-MSG
                           GO TO 101-END
                       ELSE
                          GO TO 101-PRINT-ERROR.

           IF (PRM-CREDIT-ANLYST        NOT = SPACES)
               MOVE ZR900WS-PRM-COMPANY TO DB-COMPANY
               MOVE PRM-CREDIT-ANLYST   TO DB-CREDIT-ANLYST
               PERFORM 840-KFIND-CANSET1
               IF (CRANALYST-KNOTFOUND)
                   MOVE 059                    TO CRT-ERROR-NBR
                   IF (PRM-COMPANY              NOT = ZEROS)
                       MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                       PERFORM 780-PRINT-ERROR-MSG
                       GO TO 101-END
                   ELSE
                       GO TO 101-PRINT-ERROR.

           IF (PRM-PROCESS-LEVEL        NOT = SPACES)
               MOVE ZR900WS-PRM-COMPANY TO DB-COMPANY
               MOVE PRM-PROCESS-LEVEL   TO DB-PROCESS-LEVEL
               PERFORM 840-KFIND-APVSET1
               IF (ARPROCLEVL-KNOTFOUND)
                   MOVE 052                    TO CRT-ERROR-NBR
                   IF (PRM-COMPANY              NOT = ZEROS)
                       MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                       PERFORM 780-PRINT-ERROR-MSG
                       GO TO 101-END
                   ELSE
                       GO TO 101-PRINT-ERROR.

           IF (PRM-FR-SALESMAN          NOT = ZEROES)
               IF (PRM-FR-SALESMAN      = PRM-TO-SALESMAN)
                   MOVE ZR900WS-PRM-COMPANY     TO DB-COMPANY
                   MOVE PRM-FR-SALESMAN TO DB-SALESMAN
                   PERFORM 840-KFIND-SAWSET1
                   IF (SALESREP-KNOTFOUND)
                       MOVE 063                   TO CRT-ERROR-NBR
                       IF (PRM-COMPANY            NOT = ZEROS)
                           MOVE WS-TRUE           TO WS-PARAMETER-ERROR
                           PERFORM 780-PRINT-ERROR-MSG
                           GO TO 101-END
                       ELSE
                           GO TO 101-PRINT-ERROR.

           MOVE ZR900WS-PRM-COMPANY     TO IFCOWS-COMPANY.
           MOVE "AR"                    TO IFCOWS-SYSTEM.
           PERFORM 615-EDIT-COMPANY-60.
           IF (ERROR-FOUND)
               IF (PRM-COMPANY              NOT = ZEROS)
J37933             MOVE 050                 TO CRT-ERROR-NBR
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR
               END-IF
           ELSE
               IF (PRM-TRANS-DATE       = ZEROES)
                   MOVE IFCOWS-CURR-PER-END-DT  TO PRM-TRANS-DATE.

           IF (PRM-CUSTOMER             = SPACES)
               PERFORM 105-COMPANY-AGEING
           ELSE
               PERFORM 104-CUSTOMER-AGEING.

           IF (PRM-AGE-PERIODS-1         = ZEROS)
           OR (PRM-AGE-PERIODS-2         = ZEROS)
           OR (PRM-AGE-PERIODS-3         = ZEROS)
           OR (PRM-AGE-PERIODS-4         = ZEROS)
           OR (PRM-AGE-PERIODS-5         = ZEROS)
           OR (PRM-AGE-PERIODS-6         = ZEROS)
               MOVE 066                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-AGE-PERIODS-1         > PRM-AGE-PERIODS-2)
               MOVE 080                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-AGE-PERIODS-2         > PRM-AGE-PERIODS-3)
               MOVE 081                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-AGE-PERIODS-3         > PRM-AGE-PERIODS-4)
               MOVE 082                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-AGE-PERIODS-4         > PRM-AGE-PERIODS-5)
               MOVE 083                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-AGE-PERIODS-5         > PRM-AGE-PERIODS-6)
               MOVE 084                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-ACO-AGE-TYPE          = SPACES)
               MOVE 083                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-AGE-AGE-CREDITS           = SPACES)
               MOVE 084                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-AGE-AGE-PYMNT         = SPACES)
               MOVE 085                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-AGE-AGE-DISPUTES         = SPACES)
               MOVE 086                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-ACO-CURR-DISPLAY          = "T")
               IF (ACO-MULTI-CURR-FL         = "N")
                   MOVE 067                  TO CRT-ERROR-NBR
                   IF (PRM-COMPANY           NOT = ZEROS)
                       MOVE WS-TRUE           TO WS-PARAMETER-ERROR
                       PERFORM 780-PRINT-ERROR-MSG
                       GO TO 101-END
                   ELSE
                       GO TO 101-PRINT-ERROR.

           IF (PRM-ACO-CURR-DISPLAY          = "T")
               IF (PRM-DETAIL-OPTION         = "N")
                   MOVE 068                  TO CRT-ERROR-NBR
                   IF (PRM-COMPANY           NOT = ZEROS)
                       MOVE WS-TRUE          TO WS-PARAMETER-ERROR
                       PERFORM 780-PRINT-ERROR-MSG
                       GO TO 101-END
                   ELSE
                       GO TO 101-PRINT-ERROR.

           IF (PRM-ACO-CURR-DISPLAY          = "T")
               IF (PRM-EXPANDED-OPT          = "Y")
                   MOVE 069                  TO CRT-ERROR-NBR
                   IF (PRM-COMPANY           NOT = ZEROS)
                       MOVE WS-TRUE          TO WS-PARAMETER-ERROR
                       PERFORM 780-PRINT-ERROR-MSG
                       GO TO 101-END
                   ELSE
                       GO TO 101-PRINT-ERROR.

           IF  (PRM-NA-SUMM            = "Y")
           AND (PRM-CUSTOMER           NOT = SPACES)
           AND (ACM-NAT-FLAG           NOT = "N")
               MOVE 070                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF  (PRM-NA-SUMM                = "Y")
           AND (PRM-ACO-CURR-DISPLAY       = "T")
               MOVE 073                    TO CRT-ERROR-NBR
               IF (PRM-COMPANY             NOT = ZEROS)
                   MOVE WS-TRUE            TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-NA-SUMM             = "Y")
               IF (ACO-CURRENCY-CD     NOT = ACG-CURRENCY-CD)
                   MOVE ZR900WS-PRM-COMPANY    TO IFCRWS-COMPANY
                   MOVE ACO-CURRENCY-CD TO IFCRWS-FR-CURR-CODE
                   MOVE ACG-CURRENCY-CD TO IFCRWS-TO-CURR-CODE
                   PERFORM 655-EDIT-CURRENCY-RELATION-60
                   IF  (ERROR-FOUND)  
                   AND (IFCRWS-CURSOR-POSITION  = "C")
                       IF (PRM-COMPANY             NOT = ZEROS)
                          MOVE WS-TRUE            TO WS-PARAMETER-ERROR
                          PERFORM 780-PRINT-ERROR-MSG
                          GO TO 101-END
                       ELSE
                           GO TO 101-PRINT-ERROR.

           IF  (PRM-NA-SUMM             = "Y")
           AND (ACO-CURRENCY-CD         NOT = ACG-CURRENCY-CD)
               MOVE ZR900WS-PRM-COMPANY TO IFGRWS-COMPANY
               MOVE ACO-CURRENCY-CD     TO IFGRWS-FR-CURR-CODE
               MOVE ACG-CURRENCY-CD     TO IFGRWS-TO-CURR-CODE
               MOVE "AR"                TO IFGRWS-SYSTEM
               MOVE PRM-TRANS-DATE      TO IFGRWS-EFFECT-DATE
               PERFORM 660-GET-CURRENCY-RATE-60
               IF  (ERROR-FOUND)
               AND (IFGRWS-CURSOR-POSITION  = "C")
                   IF (PRM-COMPANY             NOT = ZEROS)
                      MOVE WS-TRUE            TO WS-PARAMETER-ERROR
                      PERFORM 780-PRINT-ERROR-MSG
                      GO TO 101-END
                   ELSE
                       GO TO 101-PRINT-ERROR.

           IF  (PRM-X-GAIN-LOSS        = "Y")
           AND (PRM-ACO-CURR-DISPLAY   NOT = "B")
               MOVE 074                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-NA-SUMM              = "Y")
               MOVE WS-FALSE            TO ZR900WS-ERR-FL
               MOVE ACO-CURRENCY-CD     TO ZR900WS-CURRENCY-CD
               MOVE ZR900WS-PRM-COMPANY TO DB-NAT-COMPANY
               IF (PRM-CUSTOMER         NOT = SPACES)
                   MOVE PRM-CUSTOMER    TO DB-NAT-CUSTOMER
                   MOVE NACSET3-NAT-CUSTOMER TO WS-DB-BEG-RNG
               ELSE
                   MOVE NACSET3-NAT-COMPANY  TO WS-DB-BEG-RNG
               END-IF                       
               PERFORM 850-FIND-BEGRNG-NACSET3
               PERFORM 103-CHECK-NAT-COMPANY
                   UNTIL (NATACCT-NOTFOUND)
                   OR    (ZR900WS-PASS-EDITS    = WS-FALSE)
               IF (ZR900WS-PASS-EDITS           = WS-FALSE)
                   GO TO 101-END
               ELSE
                   MOVE ZR900WS-PRM-COMPANY     TO DB-COMPANY
                   PERFORM 840-FIND-ACOSET1.

           IF  (PRM-BALANCE            NOT = ZEROS)
           AND (PRM-ACO-CURR-DISPLAY   NOT = "B")
               MOVE 079                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF (PRM-PAST-DUE-DAYS-FR   NOT = ZEROS)
           OR (PRM-PAST-DUE-DAYS-TO   NOT = ZEROS)
               IF (PRM-PAST-TRAN-DAYS-FR  NOT = ZEROS)
               OR (PRM-PAST-TRAN-DAYS-TO  NOT = ZEROS)
                   MOVE 087                    TO CRT-ERROR-NBR
                   IF (PRM-COMPANY              NOT = ZEROS)
                       MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                       PERFORM 780-PRINT-ERROR-MSG
                       GO TO 101-END
                   ELSE
                       GO TO 101-PRINT-ERROR.

           IF (PRM-PAST-DUE-DAYS-FR    NOT = ZEROS)
               IF (PRM-PAST-DUE-DAYS-TO    = ZEROS)
                   MOVE 9999               TO PRM-PAST-DUE-DAYS-TO
               ELSE
               IF (PRM-PAST-DUE-DAYS-TO    < PRM-PAST-DUE-DAYS-FR)
                   MOVE 092                    TO CRT-ERROR-NBR
                   IF (PRM-COMPANY              NOT = ZEROS)
                       MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                       PERFORM 780-PRINT-ERROR-MSG
                       GO TO 101-END
                   ELSE
                       GO TO 101-PRINT-ERROR
                   END-IF
               END-IF
           ELSE
           IF (PRM-PAST-DUE-DAYS-TO    NOT = ZEROS)
               IF (PRM-PAST-DUE-DAYS-FR    = ZEROS)
                   MOVE 093                    TO CRT-ERROR-NBR
                   IF (PRM-COMPANY              NOT = ZEROS)
                       MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                       PERFORM 780-PRINT-ERROR-MSG
                       GO TO 101-END
                   ELSE
                       GO TO 101-PRINT-ERROR.

           IF (PRM-PAST-TRAN-DAYS-FR   NOT = ZEROS)
               IF (PRM-PAST-TRAN-DAYS-TO   = ZEROS)
                   MOVE 9999               TO PRM-PAST-TRAN-DAYS-TO
               ELSE
               IF (PRM-PAST-TRAN-DAYS-TO   < PRM-PAST-TRAN-DAYS-FR)
                   MOVE 092                    TO CRT-ERROR-NBR
                   GO TO 101-END
               END-IF
           ELSE
           IF (PRM-PAST-TRAN-DAYS-TO   NOT = ZEROS)
               IF (PRM-PAST-TRAN-DAYS-FR   = ZEROS)
                   MOVE 093                    TO CRT-ERROR-NBR
                   IF (PRM-COMPANY              NOT = ZEROS)
                       MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                       PERFORM 780-PRINT-ERROR-MSG
                       GO TO 101-END
                   ELSE
                       GO TO 101-PRINT-ERROR.

           IF  (PRM-INCLUDE-INVOICES   = "N")
           AND (PRM-INCLUDE-CREDITS    = "N")
           AND (PRM-INCLUDE-DEBITS     = "N")
           AND (PRM-INCLUDE-PAYMENTS   = "N")
               MOVE 095                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           IF  (PRM-DETAIL-OPTION  NOT = "Y" AND "A")
           AND (PRM-TRANS-SORT     NOT = SPACES)
               MOVE 094                     TO CRT-ERROR-NBR
               IF (PRM-COMPANY              NOT = ZEROS)
                   MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                   PERFORM 780-PRINT-ERROR-MSG
                   GO TO 101-END
               ELSE
                   GO TO 101-PRINT-ERROR.

           MOVE ACO-DISPLAY-DATE        TO ZR900WS-DISPLAY-DATE.
           MOVE ACO-TRANS-SEQUENCE      TO ZR900WS-TRANS-SEQUENCE.
           IF (PRM-ACO-CURR-DISPLAY        = "B")
               MOVE ACO-BASE-ND         TO ZR900WS-TABLE-ND
               MOVE ACO-CURRENCY-CD     TO ZR900WS-TABLE-CURR.

           MOVE PRM-TRANS-DATE          TO R1G1-AS-OF-DATE.
           MOVE IFCOWS-PRIOR-PER-END-DT TO WSDR-FR-DATE.
           PERFORM 900-DATE-TO-JULIAN.
           MOVE WSDR-JULIAN-DAYS        TO ZR900WS-PR-PER-JULIAN-DAYS.
           MOVE IFCOWS-CURR-PER-END-DT  TO WSDR-FR-DATE.
           PERFORM 900-DATE-TO-JULIAN.
           COMPUTE ZR900WS-PERIOD-DAYS  = WSDR-JULIAN-DAYS 
                                        - ZR900WS-PR-PER-JULIAN-DAYS.
           MOVE IFCOWS-ACCT-PERIOD      TO WS9.

           GO TO 101-END.

       101-PRINT-ERROR.

J37933     IF (ZR900WS-ERROR-FL = WS-FALSE)
J37933         OPEN OUTPUT ERROR-RPT-FILE 
720909         MOVE E1-COMPANY-ERROR    TO RPT-GROUP-REQUEST
720909         PERFORM 700-PRINT-RPT-GRP
J37933     END-IF.
           MOVE CRT-ERROR-NBR          TO CRT-MSG-NBR.
           MOVE WS-FALSE               TO ZR900WS-PASS-EDITS.
           MOVE ZR900WS-PRM-COMPANY    TO E1-COMPANY.
           MOVE ZR900WS-CO-NAME        TO E1-NAME.
           PERFORM 790-GET-MSG.
           MOVE CRT-MESSAGE            TO E1-MESSAGE.
           MOVE E1-DETAIL-LINE         TO RPT-GROUP-REQUEST.
           PERFORM 700-PRINT-RPT-GRP.

       101-END.

      ******************************************************************
       103-CHECK-NAT-COMPANY                SECTION 50.
      ******************************************************************
       103-START.

           MOVE NAC-COMPANY            TO DB-COMPANY.
           PERFORM 840-FIND-ACOSET1.
           IF (ACO-CURRENCY-CD         NOT = ZR900WS-CURRENCY-CD)
               MOVE WS-FALSE               TO ZR900WS-PASS-EDITS
               IF (PRM-COMPANY             NOT = ZEROS)
                  MOVE 071                 TO CRT-ERROR-NBR
                  MOVE WS-TRUE             TO WS-PARAMETER-ERROR
                  PERFORM 780-PRINT-ERROR-MSG
                  GO TO 103-END
               ELSE   
J37933             IF (ZR900WS-ERROR-FL = WS-FALSE)
J37933                 OPEN OUTPUT ERROR-RPT-FILE 
J37933             END-IF 
J37933             MOVE E1-COMPANY-ERROR   TO RPT-GROUP-REQUEST 
J37933             PERFORM 700-PRINT-RPT-GRP 
J37933             MOVE WS-TRUE            TO ZR900WS-ERROR-FL
                   MOVE 071                TO CRT-MSG-NBR
                   PERFORM 790-GET-MSG
                   MOVE CRT-MESSAGE        TO E1-MESSAGE
                   MOVE E1-DETAIL-LINE     TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP 
                   GO TO 103-END.

           PERFORM 860-FIND-NXTRNG-NACSET3.

       103-END.

      ******************************************************************
       104-CUSTOMER-AGEING                  SECTION 50.
      ******************************************************************
       104-START.

           IF  ((PRM-ACTIVITY         NOT = SPACES)
           OR  (PRM-ACTIVITY-LIST     NOT = SPACES))
           AND (ACACWS-COMPANY        NOT = ZEROS)
           AND (ACACWS-AGING-CODE     NOT = ZEROS)
               MOVE ACACWS-COMPANY    TO DB-COMPANY
               MOVE ACACWS-AGING-CODE TO DB-AGING-CODE
               PERFORM 840-FIND-AGESET1
               IF (AGINGCODE-FOUND)
                   IF (AGE-ACTIVE-STATUS        = "A")
                       IF  (PRM-AGE-PERIODS-1   = ZEROS)
                       AND (PRM-AGE-PERIODS-2   = ZEROS)
                       AND (PRM-AGE-PERIODS-3   = ZEROS)
                       AND (PRM-AGE-PERIODS-4   = ZEROS)
                       AND (PRM-AGE-PERIODS-5   = ZEROS)
                       AND (PRM-AGE-PERIODS-6   = ZEROS)
                           MOVE AGE-AGE-PERIODS (1) TO PRM-AGE-PERIODS-1
                           MOVE AGE-AGE-PERIODS (2) TO PRM-AGE-PERIODS-2
                           MOVE AGE-AGE-PERIODS (3) TO PRM-AGE-PERIODS-3
                           MOVE AGE-AGE-PERIODS (4) TO PRM-AGE-PERIODS-4
                           MOVE 150                 TO PRM-AGE-PERIODS-5
                           MOVE 170                 TO PRM-AGE-PERIODS-6
                       END-IF
                       IF (PRM-AGE-CURRENT      = ZEROS)
                           MOVE AGE-AGE-CURRENT TO PRM-AGE-CURRENT
                       END-IF
                       IF (PRM-AGE-AGE-CREDITS  = SPACES)
                           MOVE AGE-AGE-CREDITS TO PRM-AGE-AGE-CREDITS
                       END-IF
                       IF (PRM-AGE-AGE-PYMNT    = SPACES)
                           MOVE AGE-AGE-PYMNT   TO PRM-AGE-AGE-PYMNT
                       END-IF
                       IF (PRM-AGE-AGE-DISPUTES      = SPACES)
J16781                    IF (ACM-AGE-DISPUTES NOT = SPACES)
J16781                        MOVE ACM-AGE-DISPUTES
J16781                                          TO PRM-AGE-AGE-DISPUTES
J16781                    ELSE
                              MOVE AGE-AGE-DISPUTES
                                              TO PRM-AGE-AGE-DISPUTES
J16781                    END-IF
J16781                 END-IF.
                 
           MOVE ZR900WS-PRM-COMPANY  TO DB-COMPANY.
           MOVE PRM-CUSTOMER         TO DB-CUSTOMER.
           PERFORM 840-FIND-ACMSET1.
           MOVE ACM-AGING-CODE       TO DB-AGING-CODE.
           PERFORM 840-FIND-AGESET1.
           IF (AGE-ACTIVE-STATUS        = "A")
               IF  (PRM-AGE-PERIODS-1   = ZEROS)
               AND (PRM-AGE-PERIODS-2   = ZEROS)
               AND (PRM-AGE-PERIODS-3   = ZEROS)
               AND (PRM-AGE-PERIODS-4   = ZEROS)
               AND (PRM-AGE-PERIODS-5   = ZEROS)
               AND (PRM-AGE-PERIODS-6   = ZEROS)
                   MOVE AGE-AGE-PERIODS (1) TO PRM-AGE-PERIODS-1
                   MOVE AGE-AGE-PERIODS (2) TO PRM-AGE-PERIODS-2
                   MOVE AGE-AGE-PERIODS (3) TO PRM-AGE-PERIODS-3
                   MOVE AGE-AGE-PERIODS (4) TO PRM-AGE-PERIODS-4
                   MOVE 150                 TO PRM-AGE-PERIODS-5
                   MOVE 170                 TO PRM-AGE-PERIODS-6
               END-IF
               IF (PRM-AGE-CURRENT      = ZEROS)
                   MOVE AGE-AGE-CURRENT TO PRM-AGE-CURRENT
               END-IF
               IF (PRM-AGE-AGE-CREDITS  = SPACES)
                   MOVE AGE-AGE-CREDITS TO PRM-AGE-AGE-CREDITS
               END-IF
               IF (PRM-AGE-AGE-PYMNT    = SPACES)
                   MOVE AGE-AGE-PYMNT   TO PRM-AGE-AGE-PYMNT
               END-IF
               IF (PRM-AGE-AGE-DISPUTES      = SPACES)
J16781            IF (ACM-AGE-DISPUTES NOT = SPACES)
J16781                MOVE ACM-AGE-DISPUTES
J16781                                  TO PRM-AGE-AGE-DISPUTES
J16781            ELSE
                      MOVE AGE-AGE-DISPUTES TO PRM-AGE-AGE-DISPUTES
J16781            END-IF
               END-IF
               IF (PRM-ACO-AGE-TYPE = SPACES)
J41030             MOVE AGE-AGE-TYPE    TO PRM-ACO-AGE-TYPE  
               END-IF.

               IF  (PRM-AGE-PERIODS-1   = ZEROS)
               AND (PRM-AGE-PERIODS-2   = ZEROS)
               AND (PRM-AGE-PERIODS-3   = ZEROS)
               AND (PRM-AGE-PERIODS-4   = ZEROS)
               AND (PRM-AGE-PERIODS-5   = ZEROS)
               AND (PRM-AGE-PERIODS-6   = ZEROS)
                   MOVE ACO-AGE-PERIODS (1) TO PRM-AGE-PERIODS-1
                   MOVE ACO-AGE-PERIODS (2) TO PRM-AGE-PERIODS-2
                   MOVE ACO-AGE-PERIODS (3) TO PRM-AGE-PERIODS-3
                   MOVE ACO-AGE-PERIODS (4) TO PRM-AGE-PERIODS-4.
                   MOVE 150                 TO PRM-AGE-PERIODS-5.
                   MOVE 170                 TO PRM-AGE-PERIODS-6.

               IF (PRM-AGE-CURRENT      = ZEROS)
                   MOVE ACO-AGE-CURRENT TO PRM-AGE-CURRENT.
               IF (PRM-AGE-AGE-CREDITS  = SPACES)
                   MOVE ACO-AGE-CREDITS TO PRM-AGE-AGE-CREDITS.
               IF (PRM-AGE-AGE-PYMNT    = SPACES)
                   MOVE ACO-AGE-PYMNT   TO PRM-AGE-AGE-PYMNT.
               IF (PRM-AGE-AGE-DISPUTES      = SPACES)
J16781             IF (ACM-AGE-DISPUTES NOT = SPACES)
J16781                 MOVE ACM-AGE-DISPUTES
J16781                                   TO PRM-AGE-AGE-DISPUTES
J16781             ELSE
                       MOVE ACO-AGE-DISPUTES TO PRM-AGE-AGE-DISPUTES
J16781             END-IF
J16781         END-IF.
               IF (PRM-ACO-AGE-TYPE      = SPACES)
                   MOVE ACO-AGE-TYPE     TO PRM-ACO-AGE-TYPE.
                 
       104-END.
      ******************************************************************
       105-COMPANY-AGEING                   SECTION 50.
      ******************************************************************
       105-START.

           MOVE ZR900WS-PRM-AGE-PERIODS-1      TO PRM-AGE-PERIODS-1.
           MOVE ZR900WS-PRM-AGE-PERIODS-2      TO PRM-AGE-PERIODS-2.
           MOVE ZR900WS-PRM-AGE-PERIODS-3      TO PRM-AGE-PERIODS-3.
           MOVE ZR900WS-PRM-AGE-PERIODS-4      TO PRM-AGE-PERIODS-4.
           MOVE ZR900WS-PRM-AGE-PERIODS-5      TO PRM-AGE-PERIODS-5.
           MOVE ZR900WS-PRM-AGE-PERIODS-6      TO PRM-AGE-PERIODS-6.

           MOVE ZR900WS-PRM-AGE-CURRENT        TO PRM-AGE-CURRENT.
           MOVE ZR900WS-PRM-AGE-AGE-CREDITS    TO PRM-AGE-AGE-CREDITS.
           MOVE ZR900WS-PRM-AGE-AGE-PYMNT      TO PRM-AGE-AGE-PYMNT.
           MOVE ZR900WS-PRM-AGE-AGE-DISPUTES   TO PRM-AGE-AGE-DISPUTES.
           MOVE ZR900WS-PRM-ACO-AGE-TYPE       TO PRM-ACO-AGE-TYPE.

           IF  ((PRM-ACTIVITY         NOT = SPACES)
           OR  (PRM-ACTIVITY-LIST     NOT = SPACES))
           AND (ACACWS-COMPANY        NOT = ZEROS)
           AND (ACACWS-AGING-CODE     NOT = ZEROS)
               MOVE ACACWS-COMPANY   TO DB-COMPANY
               MOVE ACACWS-AGING-CODE TO DB-AGING-CODE
               PERFORM 840-FIND-AGESET1
               IF (AGINGCODE-FOUND)
                   IF (AGE-ACTIVE-STATUS        = "A")
                       IF  (PRM-AGE-PERIODS-1   = ZEROS)
                       AND (PRM-AGE-PERIODS-2   = ZEROS)
                       AND (PRM-AGE-PERIODS-3   = ZEROS)
                       AND (PRM-AGE-PERIODS-4   = ZEROS)
                       AND (PRM-AGE-PERIODS-5   = ZEROS)
                       AND (PRM-AGE-PERIODS-6   = ZEROS)
                           MOVE AGE-AGE-PERIODS (1) TO PRM-AGE-PERIODS-1
                           MOVE AGE-AGE-PERIODS (2) TO PRM-AGE-PERIODS-2
                           MOVE AGE-AGE-PERIODS (3) TO PRM-AGE-PERIODS-3
                           MOVE AGE-AGE-PERIODS (4) TO PRM-AGE-PERIODS-4
                           MOVE 150                 TO PRM-AGE-PERIODS-5
                           MOVE 170                 TO PRM-AGE-PERIODS-6
                       END-IF
                       IF (PRM-AGE-CURRENT      = ZEROS)
                           MOVE AGE-AGE-CURRENT TO PRM-AGE-CURRENT
                       END-IF
                       IF (PRM-AGE-AGE-CREDITS      = SPACES)
                           MOVE AGE-AGE-CREDITS TO PRM-AGE-AGE-CREDITS
                       END-IF
                       IF (PRM-AGE-AGE-PYMNT    = SPACES)
                           MOVE AGE-AGE-PYMNT   TO PRM-AGE-AGE-PYMNT
                       END-IF
                       IF (PRM-AGE-AGE-DISPUTES      = SPACES)
J16781                    IF (ACM-AGE-DISPUTES NOT = SPACES)
J16781                        MOVE ACM-AGE-DISPUTES
J16781                                          TO PRM-AGE-AGE-DISPUTES
J16781                    ELSE
                              MOVE AGE-AGE-DISPUTES 
                                                TO PRM-AGE-AGE-DISPUTES
J16781                    END-IF
J16781                 END-IF.
                 
           IF  (PRM-AGE-PERIODS-1   = ZEROS)
           AND (PRM-AGE-PERIODS-2   = ZEROS)
           AND (PRM-AGE-PERIODS-3   = ZEROS)
           AND (PRM-AGE-PERIODS-4   = ZEROS)
           AND (PRM-AGE-PERIODS-5   = ZEROS)
           AND (PRM-AGE-PERIODS-6   = ZEROS)
               MOVE ACO-AGE-PERIODS (1) TO PRM-AGE-PERIODS-1
               MOVE ACO-AGE-PERIODS (2) TO PRM-AGE-PERIODS-2
               MOVE ACO-AGE-PERIODS (3) TO PRM-AGE-PERIODS-3
               MOVE ACO-AGE-PERIODS (4) TO PRM-AGE-PERIODS-4.
               MOVE 150                 TO PRM-AGE-PERIODS-5.
               MOVE 170                 TO PRM-AGE-PERIODS-6.

           IF (PRM-AGE-CURRENT          = ZEROS)
               MOVE ACO-AGE-CURRENT     TO PRM-AGE-CURRENT.
           IF (PRM-AGE-AGE-CREDITS      = SPACES)
               MOVE ACO-AGE-CREDITS     TO PRM-AGE-AGE-CREDITS.
           IF (PRM-AGE-AGE-PYMNT        = SPACES)
               MOVE ACO-AGE-PYMNT       TO PRM-AGE-AGE-PYMNT.
           IF (PRM-AGE-AGE-DISPUTES     = SPACES)
J16781         IF (ACM-AGE-DISPUTES NOT = SPACES)
J16781             MOVE ACM-AGE-DISPUTES
J16781                                  TO PRM-AGE-AGE-DISPUTES
J16781         ELSE
                   MOVE ACO-AGE-DISPUTES    TO PRM-AGE-AGE-DISPUTES
J16781         END-IF
J16781     END-IF.
           IF (PRM-ACO-AGE-TYPE         = SPACES)
               MOVE ACO-AGE-TYPE        TO PRM-ACO-AGE-TYPE.
                 
       105-END.
      ******************************************************************
       1000-SEL-REPORT                 SECTION 50.
      ******************************************************************
       1000-START.

           INITIALIZE ZR900WS-FILTER-TRANS-TYPE.

           OPEN OUTPUT ZR9001WORK-FILE.
           CLOSE ZR9001WORK-FILE.
           OPEN I-O ZR9001WORK-FILE.

           IF (PRM-CUSTOMER            NOT = SPACES)
           OR (PRM-MATRIX-LIST         NOT = SPACES)
           OR (PRM-CREDIT-ANLYST       NOT = SPACES)
           OR (PRM-MAJ-CLASS           NOT = SPACES)
           OR (PRM-MIN-CLASS           NOT = SPACES)
           OR (PRM-RISK-CD             NOT = SPACES)
           OR (PRM-NA-SUMM                 = "Y")
           OR (PRM-AGE-AGE-PYMNT           = "L")
           OR (PRM-AGE-AGE-CREDITS         = "L")
               MOVE ZR900WS-PRM-COMPANY     TO DB-COMPANY
               MOVE PRM-CUSTOMER            TO DB-CUSTOMER
               IF (PRM-CUSTOMER = SPACES)
                   MOVE ACMSET1-COMPANY     TO WS-DB-BEG-RNG
               ELSE
                   MOVE ACMSET1-CUSTOMER    TO WS-DB-BEG-RNG
               END-IF
               PERFORM 850-FIND-BEGRNG-ACMSET1
               PERFORM 1040-SEL-ARO-CUSTOMER
               THRU    1040-END
                   UNTIL (ZR900WS-FINISH = WS-TRUE)
           ELSE
               PERFORM 1050-SEL-ARO-TRANS
               THRU    1050-END.

           MOVE ZEROES                 TO WF1-COMPANY
                                          WF1-BATCH-NBR
                                          WF1-SEQ-NBR.
           MOVE SPACES                 TO WF1-ORIG-CURRENCY
                                          WF1-SEARCH-NAME
                                          WF1-CUSTOMER
                                          WF1-TRANS-TYPE
                                          WF1-INVOICE
                                          WF1-CR-INVOICE.

           PERFORM 8500-FIND-NLT-ZR9001WORK.
           IF (ARWORK-NOTFOUND)
               MOVE 098                    TO CRT-MSG-NBR
J37933         IF (PRM-COMPANY NOT = ZEROS)
J37933             PERFORM 780-PRINT-MSG
J37933         ELSE
J37933             IF (ZR900WS-ERROR-FL = WS-FALSE)
J37933                 OPEN OUTPUT ERROR-RPT-FILE
720909                 MOVE E1-COMPANY-ERROR    TO RPT-GROUP-REQUEST
720909                 PERFORM 700-PRINT-RPT-GRP
J37933             END-IF
J37933             PERFORM 790-GET-MSG
J37933             MOVE CRT-MESSAGE            TO E1-MESSAGE
J37933             MOVE ZR900WS-PRM-COMPANY    TO E1-COMPANY
J37933             MOVE ZR900WS-CO-NAME        TO E1-NAME
J37933             MOVE E1-DETAIL-LINE         TO RPT-GROUP-REQUEST
J37933             PERFORM 700-PRINT-RPT-GRP
J37933             MOVE WS-TRUE                TO ZR900WS-ERROR-FL
J37933         END-IF
               CLOSE ZR9001WORK-FILE
               GO TO 1000-END.

           PERFORM 1000-DO-REPORT-1.

           CLOSE ZR9001WORK-FILE.
AI0000     CLOSE ZR9002WORK-FILE.

           GO TO 1000-END.

      ******************************************************************
       1040-SEL-ARO-CUSTOMER.
      ******************************************************************

           IF  (PRM-NA-SUMM            = "Y")
           AND (ACM-NAT-FLAG           = "I")
                GO TO 1040-NEXT-CUSTOMER.

           IF  (PRM-CREDIT-ANLYST      NOT = SPACES)
           AND (ACM-CREDIT-ANLYST      NOT = PRM-CREDIT-ANLYST)
                GO TO 1040-NEXT-CUSTOMER.

           IF  (PRM-MAJ-CLASS          NOT = SPACES)
           AND (ACM-MAJ-CLASS          NOT = PRM-MAJ-CLASS)
                GO TO 1040-NEXT-CUSTOMER.

           IF  (PRM-MIN-CLASS          NOT = SPACES)
           AND (ACM-MIN-CLASS          NOT = PRM-MIN-CLASS)
                GO TO 1040-NEXT-CUSTOMER.

           IF  (PRM-RISK-CD            NOT = SPACES)
           AND (ACM-RISK-CD            NOT = PRM-RISK-CD)
                GO TO 1040-NEXT-CUSTOMER.

      *IF LIST NOT = SPACES, CHECK THAT CUSTOMER EXISTS IN LIST.
           IF  (PRM-MATRIX-LIST         NOT = SPACES)
           AND (ACM-OBJ-ID              NOT = ZEROS)
               MOVE PRM-MTH-OBJ-TYPE   TO DB-OBJ-TYPE
               MOVE ACM-OBJ-ID         TO DB-OBJ-ID
               MOVE PRM-MATRIX-LIST    TO DB-MATRIX-LIST
               PERFORM 840-FIND-MLMSET2
               IF (MXLISTMBR-NOTFOUND)
                   GO TO 1040-NEXT-CUSTOMER.

           IF (PRM-SORT-OPTION         = "N")
               MOVE ACM-CUSTOMER       TO ZR900WS-SEARCH-NAME
               MOVE ACM-CUSTOMER       TO ZR900WS-CUST
           ELSE
               MOVE ACM-SEARCH-NAME    TO ZR900WS-SEARCH-NAME
               MOVE ACM-CUSTOMER       TO ZR900WS-CUST.

           MOVE 2                      TO ZR900WS-AGE-PER-FL.
           PERFORM 1044-ZERO-ARRAYS
           THRU    1044-END.

           MOVE ZR900WS-PRM-COMPANY    TO ZR900WS-COMPANY.
           MOVE ACM-CUSTOMER           TO ZR900WS-CUSTOMER
                                          ZR900WS-SAVE-CUSTOMER.

           MOVE ACM-MIN-CLASS      TO WS-MIN-CLASS.
           MOVE WS-FALSE               TO ZR900WS-ACTIVE-ACCT.
           PERFORM 1060-SEL-ARO-DUE-DATE
           THRU    1060-END.

           MOVE ACM-CUSTOMER           TO ZR900WS-NAT-CUSTOMER.
           IF  (PRM-NA-SUMM            = "Y")
           AND (ACM-NAT-FLAG           = "N")
                MOVE ACM-COMPANY           TO DB-NAT-COMPANY
                MOVE ACM-CUSTOMER          TO DB-NAT-CUSTOMER
                MOVE NACSET1-NAT-CUSTOMER  TO WS-DB-BEG-RNG
                PERFORM 850-FIND-BEGRNG-NACSET1
                PERFORM 1041-SEL-NAT-CUSTOMER
                THRU    1041-END
                    UNTIL (NATACCT-NOTFOUND).

           IF  (PRM-ACO-CURR-DISPLAY       = "B")
J56704     AND (PRM-REPORT-OPTION      = "C" OR "B")
           AND (ZR900WS-ACTIVE-ACCT    = WS-TRUE)
               PERFORM 1043-BUILD-TOTAL
               THRU    1043-END.

           IF (PRM-ACO-CURR-DISPLAY   = "T")
           OR (PRM-REPORT-OPTION      = "A" OR "P" OR "S" OR "M" OR "L")
               MOVE 1                  TO J
               PERFORM 1042-CREATE-BALANCE
               THRU    1042-END
                   UNTIL  (J > 20).

           IF (PRM-CUSTOMER            NOT = SPACES)
               MOVE WS-TRUE            TO ZR900WS-FINISH
               GO TO 1040-END.

       1040-NEXT-CUSTOMER.

           PERFORM 860-FIND-NXTRNG-ACMSET1.
           IF (ARCUSTOMER-NOTFOUND)
               MOVE WS-TRUE            TO ZR900WS-FINISH.

       1040-END.

      ******************************************************************
       1041-SEL-NAT-CUSTOMER.
      ******************************************************************

           MOVE NAC-COMPANY           TO ZR900WS-COMPANY.
           MOVE NAC-CUSTOMER          TO ZR900WS-CUSTOMER.
           PERFORM 1060-SEL-ARO-DUE-DATE
           THRU    1060-END.
           PERFORM 860-FIND-NXTRNG-NACSET1.

       1041-END.

      ******************************************************************
       1042-CREATE-BALANCE.
      ******************************************************************

           IF (ZR900WS-CURR (J) = SPACES)
               MOVE 21                TO J
               GO TO 1042-END.     

           MOVE ZR900WS-PRM-COMPANY   TO WF1-COMPANY.
           MOVE ZR900WS-SORT-F (J)    TO WF1-SORT-FIELD.
           MOVE ZR900WS-CURR (J)      TO WF1-ORIG-CURRENCY.
           MOVE ZR900WS-SEARCH-NAME   TO WF1-SEARCH-NAME.
           MOVE ZR900WS-CUST          TO WF1-CUSTOMER.
J56704     MOVE ZEROES                TO WF1-BILL-TO.
           MOVE ZEROES                TO WF1-SEQ-NBR.
           MOVE SPACES                TO WF1-TRANS-SORT-SIGN.
           MOVE ZEROES                TO WF1-TRANS-SORT.
           MOVE SPACES                TO WF1-SORT-TYPE.
           INITIALIZE WF1-TRANS-TYPE
                      WF1-SORT-DATE
                      WF1-INVOICE
                      WF1-PAYMENT-SEQ
                      WF1-CR-INVOICE
                      WF1-BATCH-NBR
                      WF1-CUST.

           PERFORM 8400-FIND-ZR9001WORK.
           IF (ARWORK-NOTFOUND)
               PERFORM 8000-CREATE-ZR9001WORK
               MOVE ZR900WS-PRM-COMPANY   TO WF1-COMPANY
               MOVE ZR900WS-SEARCH-NAME   TO WF1-SEARCH-NAME
               MOVE ZR900WS-CUST          TO WF1-CUSTOMER
               MOVE ZEROES                TO WF1-SEQ-NBR
               MOVE ZR900WS-SORT-F (J)    TO WF1-SORT-FIELD
               MOVE ZR900WS-AMT  (J)      TO WF1-AMOUNT
               MOVE ZR900WS-CURR (J)      TO WF1-ORIG-CURRENCY
               MOVE ZR900WS-ND   (J)      TO WF1-ORIG-ND
               MOVE SPACES                TO WF1-SORT-TYPE
               MOVE ZR900WS-AGE-PER-FL    TO WF1-LAST-AGE-PER
AI0000         MOVE ARO-PROCESS-LEVEL     TO WF1-PROCESS-LEVEL
           ELSE
               IF (ZR900WS-AGE-PER-FL     > WF1-LAST-AGE-PER)
                   MOVE ZR900WS-AGE-PER-FL    TO WF1-LAST-AGE-PER
               END-IF
               ADD  ZR900WS-AMT  (J)      TO WF1-AMOUNT.

           PERFORM 8200-STORE-ZR9001WORK.

           ADD 1                      TO J.

       1042-END.

      ******************************************************************
       1043-BUILD-TOTAL.
      ******************************************************************

           MOVE ZR900WS-PRM-COMPANY   TO WF1-COMPANY.
           MOVE SPACES                TO WF1-SORT-FIELD.
           MOVE ACO-CURRENCY-CD       TO WF1-ORIG-CURRENCY.
           MOVE ZR900WS-SEARCH-NAME   TO WF1-SEARCH-NAME.
           MOVE ZR900WS-CUST          TO WF1-CUSTOMER.
J56704     MOVE ZEROES                TO WF1-BILL-TO.
           MOVE ZEROES                TO WF1-SEQ-NBR.
           MOVE SPACES                TO WF1-TRANS-SORT-SIGN.
           MOVE ZEROES                TO WF1-TRANS-SORT.
           MOVE SPACES                TO WF1-SORT-TYPE.
           INITIALIZE WF1-TRANS-TYPE
                      WF1-SORT-DATE
                      WF1-INVOICE
                      WF1-PAYMENT-SEQ
                      WF1-CR-INVOICE
                      WF1-BATCH-NBR
                      WF1-CUST.

           PERFORM 8400-FIND-ZR9001WORK.
           IF (ARWORK-FOUND)
               IF  (ZR900WS-AGE-PER-FL    > WF1-AGE-PERIOD)
                   MOVE ZR900WS-AGE-PER-FL  TO WF1-AGE-PERIOD
               END-IF
               ADD  ZR900WS-TOTAL       TO WF1-AMOUNT
           ELSE
                PERFORM 8000-CREATE-ZR9001WORK
                MOVE ZR900WS-PRM-COMPANY TO WF1-COMPANY
                MOVE ACO-CURRENCY-CD     TO WF1-ORIG-CURRENCY
                MOVE ZR900WS-SEARCH-NAME TO WF1-SEARCH-NAME
                MOVE ZR900WS-CUST        TO WF1-CUSTOMER
                MOVE ZEROES              TO WF1-SEQ-NBR
                MOVE SPACES              TO WF1-SORT-TYPE
                MOVE ZR900WS-TOTAL       TO WF1-AMOUNT
                MOVE ACO-BASE-ND         TO WF1-ORIG-ND
                MOVE ZR900WS-AGE-PER-FL  TO WF1-AGE-PERIOD
                MOVE "N"                 TO WF1-PAST-DUE-TRANS
                MOVE ZR900WS-AGE-PER-FL  TO WF1-LAST-AGE-PER.

           IF (ZR900WS-PAST-DUE-TRANS  = "Y")
               MOVE "Y"                TO WF1-PAST-DUE-TRANS.

           PERFORM 8200-STORE-ZR9001WORK.

       1043-END.

      ******************************************************************
       1044-ZERO-ARRAYS.
      ******************************************************************

           MOVE 2                      TO ZR900WS-AGE-PER-FL.
           MOVE ZEROES                 TO ZR900WS-TOTAL.
           PERFORM 
               VARYING I1 FROM 1 BY 1 
               UNTIL  (I1 > 20)
                   MOVE ZEROES         TO ZR900WS-AMT    (I1)
                   MOVE SPACES         TO ZR900WS-CURR   (I1)
                   MOVE ZEROS          TO ZR900WS-ND     (I1)
                   MOVE SPACES         TO ZR900WS-SORT-F (I1)
           END-PERFORM.
           MOVE ZEROES                 TO K.

       1044-END.

      ******************************************************************
       1050-SEL-ARO-TRANS.
      ******************************************************************

           PERFORM 1044-ZERO-ARRAYS
           THRU    1044-END.

           MOVE WS-FALSE              TO ZR900WS-ACTIVE-ACCT.
           INITIALIZE ZR900WS-SAVE-CUSTOMER
                      ZR900WS-SUM-NBR
                      ZR900WS-SUM-AMT.
           MOVE WS-FALSE              TO ZR900WS-SUM-REC.
           MOVE PRM-TRANS-DATE        TO AROPWS-POST-DATE.
           MOVE ZR900WS-PRM-COMPANY   TO DB-COMPANY.
           MOVE "D"                   TO DB-TRANS-TYPE.
           MOVE "D"                   TO ZR900WS-FILTER-TRANS-TYPE.

           IF (PRM-PERIOD-OF          = "A")
               MOVE AROSET1-TRANS-TYPE TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-AROSET1
           ELSE
               IF (PRM-FUTURE-APPS    = "N")
                   MOVE AROSET9-TRANS-TYPE TO WS-DB-BEG-RNG
                   PERFORM 850-FIND-BEGRNG-AROSET9
               ELSE
                   PERFORM 1051-INDEX-FILTER
                   THRU    1051-END
                   MOVE AROSET6-COMPANY    TO WS-DB-BEG-RNG
                   PERFORM 850-FILTER-BEGRNG-AROSET6.

           PERFORM 1080-SEL-ARO-ITEMS
           THRU    1080-END
               UNTIL (AROITEMS-NOTFOUND).

           MOVE "I"                   TO DB-TRANS-TYPE.
           MOVE "I"                   TO ZR900WS-FILTER-TRANS-TYPE.

           IF (PRM-PERIOD-OF          = "A")
               MOVE AROSET1-TRANS-TYPE TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-AROSET1
           ELSE
               IF (PRM-FUTURE-APPS    = "N")
                   MOVE AROSET9-TRANS-TYPE TO WS-DB-BEG-RNG
                   PERFORM 850-FIND-BEGRNG-AROSET9
               ELSE
                   PERFORM 1051-INDEX-FILTER
                   THRU    1051-END
                   MOVE AROSET6-COMPANY    TO WS-DB-BEG-RNG
                   PERFORM 850-FILTER-BEGRNG-AROSET6.

           PERFORM 1080-SEL-ARO-ITEMS
           THRU    1080-END
               UNTIL (AROITEMS-NOTFOUND).

           MOVE "C"                   TO DB-TRANS-TYPE.
           MOVE "C"                   TO ZR900WS-FILTER-TRANS-TYPE.

           IF (PRM-PERIOD-OF          = "A")
               MOVE AROSET1-TRANS-TYPE TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-AROSET1
           ELSE
               IF (PRM-FUTURE-APPS    = "N")
                   MOVE AROSET9-TRANS-TYPE TO WS-DB-BEG-RNG
                   PERFORM 850-FIND-BEGRNG-AROSET9
               ELSE
                   PERFORM 1051-INDEX-FILTER
                   THRU    1051-END
                   MOVE AROSET6-COMPANY    TO WS-DB-BEG-RNG
                   PERFORM 850-FILTER-BEGRNG-AROSET6.

           PERFORM 1080-SEL-ARO-ITEMS
           THRU    1080-END
               UNTIL (AROITEMS-NOTFOUND).

           INITIALIZE ZR900WS-SAVE-CUSTOMER.
           MOVE ZR900WS-PRM-COMPANY   TO DB-COMPANY.
           MOVE ARZSET2-COMPANY       TO WS-DB-BEG-RNG.
           PERFORM 850-FIND-BEGRNG-ARZSET2.
           PERFORM 1091-ARITEMAUD
           THRU    1091-END
               UNTIL (ARITEMAUD-NOTFOUND).

           IF  (PRM-ACTIVITY          = SPACES)
           AND (PRM-REPORT-OPTION   NOT = "M")
           AND (PRM-ACTIVITY-LIST       = SPACES)
           AND (PRM-REPORT-OPTION   NOT = "L")
           AND (ACG-DRAFT-PROCESS     = "Y")
           AND (ACO-OB-DRF-FL     NOT = "N")
               INITIALIZE ZR900WS-SAVE-CUSTOMER
               MOVE ZR900WS-PRM-COMPANY       TO DB-COMPANY
               MOVE ARDSET9-COMPANY   TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-ARDSET9
               PERFORM 1130-SEL-DRAFTS
               THRU    1130-END
                   UNTIL (ARDRAFTS-NOTFOUND).

           IF  (PRM-FR-TRANS-USER1    NOT = SPACES)
           AND (PRM-TO-TRANS-USER1    NOT = SPACES)
               GO TO 1050-TAG.

           IF  (PRM-ACTIVITY          = SPACES)
           AND (PRM-REPORT-OPTION     NOT = "M")
           AND (PRM-ACTIVITY-LIST         = SPACES)
           AND (PRM-REPORT-OPTION     NOT = "L")
               INITIALIZE ZR900WS-SAVE-CUSTOMER
               MOVE ZR900WS-PRM-COMPANY       TO DB-COMPANY
               IF (PRM-PERIOD-OF      = "A")
                   MOVE APMSET10-COMPANY  TO WS-DB-BEG-RNG
                   PERFORM 850-FIND-BEGRNG-APMSET10
               ELSE
                   IF (PRM-FUTURE-APPS  = "N")
061651* JT-1061651
061651                 MOVE APMSET6-COMPANY   TO WS-DB-BEG-RNG
061651                 PERFORM 850-FIND-BEGRNG-APMSET6
                   ELSE
                       MOVE APMSET8-COMPANY   TO WS-DB-BEG-RNG
                       PERFORM 850-FIND-BEGRNG-APMSET8
                   END-IF
               END-IF
               PERFORM 1100-SEL-PAYMENTS
               THRU    1100-END
                   UNTIL (ARPAYMENT-NOTFOUND).

       1050-TAG.
           PERFORM 1250-CUSTOMER-CHANGE
           THRU    1250-END.

       1050-END.

      ******************************************************************
       1051-INDEX-FILTER.
      ******************************************************************

000590     INITIALIZE                     FILTER-STRING.
000610     MOVE 1                         TO ZR900WS-I1.
000620
000630     STRING "("                     DELIMITED BY SIZE
000640        INTO                        FILTER-STRING
000650        POINTER                     ZR900WS-I1.
000660
000820     STRING                         ZR900WS-INVOICE-FILTER
000840        DELIMITED                   BY SIZE
000850        INTO                        FILTER-STRING
000860        POINTER                     ZR900WS-I1.
000870
000880     STRING ")"                     DELIMITED BY SIZE
000890        INTO                        FILTER-STRING
000900        POINTER                     ZR900WS-I1.
000910
000920     PERFORM 890-CREATE-FILTER.
000930
015850     MOVE ZR900WS-FILTER-TRANS-TYPE   TO ALPHANUM-FILTER-VALUE.
016200     PERFORM 890-SET-ALPHANUM-FILTER-VALUE.
015860
       1051-END.

      ******************************************************************
       1060-SEL-ARO-DUE-DATE.
      ******************************************************************

           MOVE PRM-TRANS-DATE        TO AROPWS-POST-DATE.
           INITIALIZE ZR900WS-SUM-NBR
                      ZR900WS-SUM-AMT.
           MOVE WS-FALSE              TO ZR900WS-SUM-REC.
           MOVE ZR900WS-COMPANY       TO DB-COMPANY.
           MOVE ZR900WS-CUSTOMER      TO DB-CUSTOMER.
           IF (PRM-INCLUDE-DEBITS     = "Y")
           OR (PRM-PAST-DUE-ONLY      = "Y")
               MOVE "D"               TO DB-TRANS-TYPE
               IF (PRM-PERIOD-OF      = "A")
                   MOVE AROSET5-TRANS-TYPE TO WS-DB-BEG-RNG
                   PERFORM 850-FIND-BEGRNG-AROSET5
               ELSE
                   IF (PRM-FUTURE-APPS = "N")
                       MOVE AROSET3-TRANS-TYPE TO WS-DB-BEG-RNG
                       PERFORM 850-FIND-BEGRNG-AROSET3
                   ELSE
                       MOVE AROSET6-TRANS-TYPE TO WS-DB-BEG-RNG
                       PERFORM 850-FIND-BEGRNG-AROSET6
                   END-IF
               END-IF
               PERFORM 1080-SEL-ARO-ITEMS
               THRU    1080-END
                   UNTIL (AROITEMS-NOTFOUND).

           INITIALIZE ZR900WS-SUM-NBR
                      ZR900WS-SUM-AMT.
           MOVE WS-FALSE              TO ZR900WS-SUM-REC.
           MOVE ZR900WS-COMPANY       TO DB-COMPANY.
           MOVE ZR900WS-CUSTOMER      TO DB-CUSTOMER.
           IF (PRM-INCLUDE-INVOICES   = "Y")
           OR (PRM-PAST-DUE-ONLY      = "Y")
               MOVE "I"               TO DB-TRANS-TYPE
               IF (PRM-PERIOD-OF      = "A")
                   MOVE AROSET5-TRANS-TYPE TO WS-DB-BEG-RNG
                   PERFORM 850-FIND-BEGRNG-AROSET5
               ELSE
                   IF (PRM-FUTURE-APPS    = "N")
                       MOVE AROSET3-TRANS-TYPE TO WS-DB-BEG-RNG
                       PERFORM 850-FIND-BEGRNG-AROSET3
                   ELSE
                       MOVE AROSET6-TRANS-TYPE TO WS-DB-BEG-RNG
                       PERFORM 850-FIND-BEGRNG-AROSET6
                   END-IF
               END-IF
               PERFORM 1080-SEL-ARO-ITEMS
               THRU    1080-END
                   UNTIL (AROITEMS-NOTFOUND).

           INITIALIZE ZR900WS-SUM-NBR
                      ZR900WS-SUM-AMT.
           MOVE WS-FALSE              TO ZR900WS-SUM-REC.
           MOVE ZR900WS-COMPANY       TO DB-COMPANY.
           MOVE ZR900WS-CUSTOMER      TO DB-CUSTOMER.
           IF (PRM-INCLUDE-CREDITS    = "Y")
           OR (PRM-PAST-DUE-ONLY      = "Y")
               MOVE "C"               TO DB-TRANS-TYPE
               IF (PRM-PERIOD-OF      = "A")
                   MOVE AROSET5-TRANS-TYPE TO WS-DB-BEG-RNG
                   PERFORM 850-FIND-BEGRNG-AROSET5
               ELSE
                   IF (PRM-FUTURE-APPS    = "N")
                       MOVE AROSET3-TRANS-TYPE TO WS-DB-BEG-RNG
                       PERFORM 850-FIND-BEGRNG-AROSET3
                   ELSE
                       MOVE AROSET6-TRANS-TYPE TO WS-DB-BEG-RNG
                       PERFORM 850-FIND-BEGRNG-AROSET6
                   END-IF
               END-IF
               PERFORM 1080-SEL-ARO-ITEMS
               THRU    1080-END
                   UNTIL (AROITEMS-NOTFOUND).

           MOVE ZR900WS-COMPANY       TO DB-COMPANY.
           MOVE ZR900WS-CUSTOMER      TO DB-CUSTOMER.
           MOVE ARZSET2-CUSTOMER      TO WS-DB-BEG-RNG.
           PERFORM 850-FIND-BEGRNG-ARZSET2.
           PERFORM 1091-ARITEMAUD
           THRU    1091-END
               UNTIL (ARITEMAUD-NOTFOUND).

           IF  (PRM-ACTIVITY          = SPACES)
           AND (PRM-REPORT-OPTION NOT = "M")
           AND (PRM-ACTIVITY-LIST     = SPACES)
           AND (PRM-REPORT-OPTION NOT = "L")
           AND (ACO-OB-DRF-FL     NOT = "N")
           AND (ACG-DRAFT-PROCESS     = "Y")
               MOVE ZR900WS-COMPANY   TO DB-COMPANY
               MOVE ZR900WS-CUSTOMER  TO DB-CUSTOMER
               MOVE ARDSET9-CUSTOMER  TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-ARDSET9
               PERFORM 1130-SEL-DRAFTS
               THRU    1130-END
                   UNTIL (ARDRAFTS-NOTFOUND).

           IF  (PRM-FR-TRANS-USER1    NOT = SPACES)
           AND (PRM-TO-TRANS-USER1    NOT = SPACES)
               GO TO 1060-END.

           IF (PRM-FR-SALESMAN        NOT = ZEROES)
           OR (PRM-TO-SALESMAN        NOT = ZEROES)
               IF (ACM-SALESMAN       < PRM-FR-SALESMAN)
               OR (ACM-SALESMAN       > PRM-TO-SALESMAN)
                   GO TO 1060-END.

           IF  (PRM-INCLUDE-PAYMENTS   = "N")
           AND (PRM-PAST-DUE-ONLY      = "N") 
               GO TO 1060-END.

           IF  (PRM-ACTIVITY              = SPACES)
           AND (PRM-REPORT-OPTION     NOT = "M")
           AND (PRM-ACTIVITY-LIST         = SPACES)
           AND (PRM-REPORT-OPTION     NOT = "L")
               MOVE ZR900WS-COMPANY   TO DB-COMPANY
               MOVE ZR900WS-CUSTOMER  TO DB-CUSTOMER
               IF (PRM-PERIOD-OF      = "A")
                   MOVE APMSET10-CUSTOMER  TO WS-DB-BEG-RNG
                   PERFORM 850-FIND-BEGRNG-APMSET10
               ELSE
                   IF (PRM-FUTURE-APPS  = "N")
061651* JT-1061651
061651                 MOVE APMSET6-CUSTOMER  TO WS-DB-BEG-RNG
061651                 PERFORM 850-FIND-BEGRNG-APMSET6
                   ELSE
                       MOVE APMSET8-CUSTOMER  TO WS-DB-BEG-RNG
                       PERFORM 850-FIND-BEGRNG-APMSET8
                   END-IF
               END-IF
               PERFORM 1100-SEL-PAYMENTS
               THRU    1100-END
                   UNTIL (ARPAYMENT-NOTFOUND).

       1060-END.

      ******************************************************************
       1080-SEL-ARO-ITEMS.
      ******************************************************************
           
           IF  (ZR900WS-SAVE-CUSTOMER  NOT = ARO-CUSTOMER)
           AND (PRM-NA-SUMM            = "N")
               PERFORM 1250-CUSTOMER-CHANGE
               THRU    1250-END
               MOVE ARO-COMPANY        TO DB-COMPANY
               MOVE ARO-CUSTOMER       TO DB-CUSTOMER
                                          ZR900WS-SAVE-CUSTOMER
               PERFORM 840-FIND-ACMSET1
               MOVE ACM-CUSTOMER        TO ZR900WS-CUST
               IF (PRM-SORT-OPTION         = "N")
                   MOVE ACM-CUSTOMER    TO ZR900WS-SEARCH-NAME
               ELSE
                   MOVE ACM-SEARCH-NAME TO ZR900WS-SEARCH-NAME.

J56704     IF  (PRM-ARO-BILL-TO    NOT = ZEROES)
           AND (ARO-BILL-TO        NOT = PRM-ARO-BILL-TO)
               GO TO 1080-NEXT-AROITEMS.

           IF  (PRM-INCLUDE-INVOICES   = "N")
           AND (ARO-TRANS-TYPE         = "I")
               GO TO 1080-NEXT-AROITEMS.

           IF  (PRM-INCLUDE-DEBITS     = "N")
           AND (ARO-TRANS-TYPE         = "D")
               GO TO 1080-NEXT-AROITEMS.

           IF  (PRM-INCLUDE-CREDITS    = "N")
           AND (ARO-TRANS-TYPE         = "C")
               GO TO 1080-NEXT-AROITEMS.

           IF (PRM-EXEMPT-FIN-CHRG-FL = "Y")
               IF (ARO-TRANS-TYPE = "D")
                   MOVE ARO-INVOICE        TO ZR900WS-INVOICE
                   IF (ZR900WS-TRAN-PREFIX = "FC-")
                       GO TO 1080-NEXT-AROITEMS.

342466     IF  (PRM-EXEMPT-FIN-CHRG-FL  = "Y")
           AND (ARO-TRANS-TYPE          = "D")
           AND (ACO-FIN-CHG-PRFX        NOT = SPACES)
               MOVE ARO-INVOICE         TO ZR900WS-INVOICE
               IF (ACO-FIN-CHG-PRFX      = ZR900WS-TRAN-PREFIX)   
342466             GO TO 1080-NEXT-AROITEMS.

           IF  (PRM-PROCESS-LEVEL      NOT = SPACES)
           AND (ARO-PROCESS-LEVEL      NOT = PRM-PROCESS-LEVEL)
               GO TO 1080-NEXT-AROITEMS.

P3FX11     IF (ARO-CUSTOMER = "  ER07499")
P3FX11         GO TO 1080-NEXT-AROITEMS.

J54577     IF (PRM-PAST-DUE-ONLY   = "Y")
J54577        IF (PRM-ACO-AGE-TYPE = "D")
J54577          IF (ARO-DUE-DATE      NOT < PRM-TRANS-DATE)
AI0000             PERFORM 1150-SEL-ARO-TRX
AI0000                THRU 1150-END
J54577             GO TO 1080-NEXT-AROITEMS
J54577          END-IF
J54577        ELSE
J54577          IF (PRM-ACO-AGE-TYPE = "T")
J54577            IF (ARO-TRANS-DATE  NOT < PRM-TRANS-DATE)
AI0000               PERFORM 1150-SEL-ARO-TRX
AI0000                  THRU 1150-END
J54577               GO TO 1080-NEXT-AROITEMS
J54577            END-IF
J54577          END-IF
J54577        END-IF
J54577     ELSE
J54577        IF (ARO-GL-DATE             > PRM-TRANS-DATE)
AI0000            PERFORM 1150-SEL-ARO-TRX
AI0000               THRU 1150-END
J54577           GO TO 1080-NEXT-AROITEMS
J54577        END-IF
J54577     END-IF.

           IF (PRM-FR-TRANS-USER1      NOT = SPACES)
           OR (PRM-TO-TRANS-USER1      NOT = SPACES)
               IF (ARO-TRANS-USER1     < PRM-FR-TRANS-USER1)
               OR (ARO-TRANS-USER1     > PRM-TO-TRANS-USER1)
                   GO TO 1080-NEXT-AROITEMS.

           IF (PRM-FR-SALESMAN         NOT = ZEROES)
           OR (PRM-TO-SALESMAN         NOT = ZEROES)
               IF (ARO-SALESMAN        < PRM-FR-SALESMAN)
               OR (ARO-SALESMAN        > PRM-TO-SALESMAN)
                   GO TO 1080-NEXT-AROITEMS.

           IF (ARO-STATUS              = ZERO)
               GO TO 1080-NEXT-AROITEMS.

           IF  (PRM-ACTIVITY           NOT = SPACES)
           AND (ARO-ACTIVITY           NOT = PRM-ACTIVITY)
               GO TO 1080-NEXT-AROITEMS.

           INITIALIZE ZR900WS-CANCEL-DATE
                      ZR900WS-CANCEL-FLAG
                      ZR900WS-CANCEL-CUST.
J54577     IF (PRM-PAST-DUE-ONLY       = "Y")
J54577       IF (PRM-ACO-AGE-TYPE        = "D")
J54577           MOVE ARO-DUE-DATE           TO ZR900WS-AGE-DATE
J54577       ELSE
J54577          IF (PRM-ACO-AGE-TYPE     = "T")
J54577             MOVE ARO-TRANS-DATE       TO ZR900WS-AGE-DATE
J54577          END-IF
J54577       END-IF
J54577     ELSE
J54577       MOVE ARO-DUE-DATE               TO ZR900WS-AGE-DATE
J54577     END-IF.
           PERFORM 1200-FIND-PERIOD
           THRU    1200-END.

           IF (ARO-CANCEL-FLAG         = "Y")
               MOVE WS-FALSE           TO ZR900WS-ARZ-REC
               PERFORM 1121-CANCELED-AROIHDR
               THRU    1121-END
               IF (ZR900WS-ARZ-REC     = WS-TRUE)
                   GO TO 1080-NEXT-AROITEMS.

J07626*----Validate if Mixed Signed Application
J07626     IF  (ARO-STATUS     = 7  )
J07626     AND (ARO-ALT-TYPE   = "M")
J07626     AND (ARO-TRANS-TYPE = "C")
807481     AND (PRM-FUTURE-APPS = "N")
J07626          MOVE ARO-COMPANY         TO DB-CR-COMPANY
J07626          IF (ARO-CANCEL-FLAG = "Y")
J07626              MOVE ZR900WS-CANCEL-CUST TO DB-CR-CUSTOMER
J07626          ELSE
J07626              MOVE ARO-CUSTOMER    TO DB-CR-CUSTOMER
J07626          END-IF
J58879          MOVE ARO-TRAN-AMT        TO ZR900WS-TEMP-TRAN-AMT
J07626          MOVE ARO-TRANS-TYPE      TO DB-CR-TYPE
J07626          MOVE ARO-INVOICE         TO DB-CR-NBR
J07626          MOVE ARO-PAYMENT-SEQ     TO DB-CR-PYMNT-SEQ
J07626          MOVE ARO-BATCH-NBR       TO DB-CR-BATCH
J07626          MOVE ARASET3-CR-BATCH    TO WS-DB-BEG-RNG
J07626          PERFORM 850-FIND-BEGRNG-ARASET3
J58879          PERFORM
J58879          UNTIL (ARAPPLIED-NOTFOUND)
J58879                SUBTRACT ARA-APPLD-AMT FROM ZR900WS-TEMP-TRAN-AMT
J58879                IF  (ARA-APP-SOURCE = "S")
J58879                AND (ZR900WS-TEMP-TRAN-AMT NOT = ZEROES)
J58879                     PERFORM 860-FIND-NXTRNG-ARASET3
J58879                ELSE 
J58879                     GO TO 1080-NEXT-AROITEMS
J58879                END-IF
J58879          END-PERFORM
J07626     END-IF.

           IF (PRM-PAST-TRAN-DAYS-FR   NOT = ZEROS)
               MOVE ARO-TRANS-DATE     TO ZR900WS-AGE-DATE
               PERFORM 1200-FIND-PERIOD
               THRU    1200-END
               IF (ZR900WS-DP          < PRM-PAST-TRAN-DAYS-FR)
               OR (ZR900WS-DP          > PRM-PAST-TRAN-DAYS-TO)
                   GO TO 1080-NEXT-AROITEMS.

           IF (PRM-PAST-DUE-DAYS-FR    NOT = ZEROS)
               MOVE ARO-DUE-DATE       TO ZR900WS-AGE-DATE
               PERFORM 1200-FIND-PERIOD
               THRU    1200-END
               IF (ZR900WS-DP          < PRM-PAST-DUE-DAYS-FR)
               OR (ZR900WS-DP          > PRM-PAST-DUE-DAYS-TO)
                   GO TO 1080-NEXT-AROITEMS.

           IF  (ZR900WS-PER             > 2)
           AND (ARO-TRANS-TYPE          = "D" OR "I")
               MOVE "Y"                 TO ZR900WS-PAST-DUE-TRANS.

           MOVE "Y"                    TO ZR900WS-REC-FOUND.
           MOVE SPACES                 TO AROPWS-FUTURE.
           MOVE SPACES                 TO ZR900WS-APPL.

           IF (ARO-INVOICE NOT = ZR900WS-SAVE-INVOICE)
           OR (ARO-SUM-LINE    = "N")
               MOVE ARO-INVOICE        TO ZR900WS-SAVE-INVOICE
               INITIALIZE   AROPWS-OPEN-AMT
                            AROPWS-ORIG-OPEN-AMT
                            ZR900WS-SUMLINE.

903341     INITIALIZE AROPWS-APPLD-AMT
903341                AROPWS-ADJ-AMT.

           MOVE ARO-TRAN-AMT           TO AROPWS-OPEN-AMT.
           MOVE ARO-ORIG-AMT           TO AROPWS-ORIG-OPEN-AMT.

           IF (ARO-TRANS-TYPE          = "D" OR "I")
               IF (ARO-APPLIED-SEQ     NOT = ZEROES)
                   PERFORM 730-OPEN-TRANSACTION.
           
           IF (ARO-TRANS-TYPE          = "C")
               IF (ARO-APPLIED-SEQ     NOT = ZEROES)
ARTOAP*            PERFORM 710-OPEN-CREDIT.
ARTOAP             PERFORM 710-OPEN-CREDIT-LW.
          
910922     IF (AROPWS-ORIG-OPEN-AMT      = ZEROS)
910922     OR (((ARO-TRAN-AMT - (ARO-APPLD-AMT + ARO-ADJ-AMT)) = ZEROS)
910922     AND (PRM-FUTURE-APPS       = "N"))   
               MOVE "N"                 TO ZR900WS-REC-FOUND
J54577         MOVE ZR900WS-PAST-DUE-TRANS-A TO ZR900WS-PAST-DUE-TRANS
J54577         GO TO 1080-NEXT-AROITEMS
J54577     ELSE
J54577         MOVE ZR900WS-PAST-DUE-TRANS   TO ZR900WS-PAST-DUE-TRANS-A
J54577     END-IF.

807481     IF  (ARO-STATUS          = 1  )
807481     AND (PRM-FUTURE-APPS     = "N")
807481           COMPUTE AROPWS-OPEN-AMT ROUNDED =  ARO-TRAN-AMT
807481                                         - (ARO-APPLD-AMT
807481                                         +  ARO-ADJ-AMT)
807481
807481           COMPUTE AROPWS-ORIG-OPEN-AMT ROUNDED =  ARO-ORIG-AMT
807481                                              - (ARO-ORIG-APP-AMT
807481                                              +  ARO-ORIG-ADJ-AMT)
807481     END-IF.
807481

838004     IF  (ARO-STATUS          = 1  )
838004     AND (AROPWS-APPLD-AMT   >= ARO-APPLD-AMT)
838004     AND (ARO-TRANS-TYPE      = "C")
838004     AND (ARO-ALT-TYPE        = "C")
838004     AND (ARO-DESC            = "INTERFACE TRANSACTION")
838004           COMPUTE AROPWS-OPEN-AMT ROUNDED =  ARO-TRAN-AMT
838004                                         - (ARO-APPLD-AMT
838004                                         +  ARO-ADJ-AMT)
838004
838004           COMPUTE AROPWS-ORIG-OPEN-AMT ROUNDED =  ARO-ORIG-AMT
838004                                              - (ARO-ORIG-APP-AMT
838004                                              +  ARO-ORIG-ADJ-AMT)
838004     END-IF.

           IF (PRM-TRANS-OPEN-AMT       NOT = ZEROS)
               IF (AROPWS-OPEN-AMT      NOT > PRM-TRANS-OPEN-AMT)
                   GO TO 1080-NEXT-AROITEMS.

           IF (AROPWS-OPEN-AMT       NOT = ARO-TRAN-AMT)
               MOVE "*"                 TO ZR900WS-APPL.

           INITIALIZE ZR900WS-ATTRIBUTE-KEY.

           IF (PRM-ACTIVITY-LIST       NOT = SPACES)
               IF (ARO-ACTIVITY = SPACES)
                   GO TO 1080-NEXT-AROITEMS
               END-IF
               MOVE "ACTVY"               TO ACMAWS-OBJ-TYPE    
               MOVE PRM-ACTIVITY-LIST     TO ACMAWS-MATRIX-LIST
               MOVE ARO-ACTIVITY          TO ACMAWS-ACTIVITY
               IF (PRM-REPORT-OPTION = "L")
                   MOVE "Y"               TO ACMAWS-KEY-REQUEST
               ELSE
                   MOVE "N"               TO ACMAWS-KEY-REQUEST
               END-IF
               PERFORM 610-VAL-MATRIX-ACTIVITY
               IF (ACMAWS-MATRIX-MEMBER NOT = "Y")
                   GO TO 1080-NEXT-AROITEMS
               END-IF
               IF (PRM-REPORT-OPTION = "L")
                   MOVE ACMAWS-KEY        TO ZR900WS-ATTRIBUTE-KEY.

           IF (PRM-X-GAIN-LOSS         = "Y")
               PERFORM 1125-GAIN-LOSS-AMT
               THRU    1125-END.

J56704     IF (PRM-REPORT-OPTION       = "C" OR "B")
               MOVE SPACES             TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "A")
               MOVE ACM-CREDIT-ANLYST  TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "P")
               MOVE ARO-PROCESS-LEVEL  TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "S")
               MOVE ARO-SALESMAN       TO ZR900WS-SALESMAN
               MOVE ZR900WS-ALPHA-S    TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "M")
               MOVE ARO-ACTIVITY       TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "L")
               MOVE ZR900WS-ATTRIBUTE-KEY TO ZR900WS-SORT-FIELD.

           IF (PRM-ACO-CURR-DISPLAY        = "B")
J56704         IF (PRM-REPORT-OPTION   NOT = "C" OR "B")
                   MOVE WS-FALSE       TO ZR900WS-RECORD-SELECTED
                   PERFORM
                       VARYING I1 FROM 1 BY 1 
                       UNTIL  (I1 > 20)
                       OR     (ZR900WS-RECORD-SELECTED = WS-TRUE)
                           IF  (ACO-CURRENCY-CD = ZR900WS-CURR   (I1))
                           AND (ZR900WS-SORT-FIELD 
                                                = ZR900WS-SORT-F (I1))
                               MOVE I1      TO J
                               MOVE WS-TRUE TO ZR900WS-RECORD-SELECTED
                           END-IF
                   END-PERFORM
                   IF (ZR900WS-RECORD-SELECTED  = WS-TRUE)
                       IF (ARO-TRANS-TYPE      = "C")
                           SUBTRACT AROPWS-OPEN-AMT FROM ZR900WS-AMT (J)
                       ELSE
                           ADD AROPWS-OPEN-AMT      TO ZR900WS-AMT (J)
                       END-IF
                   ELSE
                       ADD 1                    TO K
                       IF (K = ZERO)
                           MOVE 21 TO K
                       END-IF
                       IF (K                    > 20)
                           IF (ARO-TRANS-TYPE   = "C")
                               MOVE "S"         TO ZR900WS-TEMP-TYPE
                           ELSE
                               MOVE "A"         TO ZR900WS-TEMP-TYPE
                           END-IF
                           MOVE ACO-CURRENCY-CD   TO ZR900WS-TEMP-CURR
                           PERFORM 1260-BLD-AS-OF-AMT
                           THRU    1260-END
                       ELSE
                           IF (ARO-TRANS-TYPE      = "C")
                               SUBTRACT AROPWS-OPEN-AMT
                                                    FROM ZR900WS-AMT (K)
                           ELSE
                               ADD AROPWS-OPEN-AMT  TO ZR900WS-AMT (K)
                           END-IF
                           MOVE ZR900WS-SORT-FIELD TO ZR900WS-SORT-F (K)
                           MOVE ACO-BASE-ND       TO ZR900WS-ND     (K)
                           MOVE ACO-CURRENCY-CD   TO ZR900WS-CURR   (K).
        
           IF (PRM-ACO-CURR-DISPLAY        = "T")
               MOVE WS-FALSE           TO ZR900WS-RECORD-SELECTED
               PERFORM
                   VARYING I1 FROM 1 BY 1 
                   UNTIL  (I1 > 20)
                   OR     (ZR900WS-RECORD-SELECTED = WS-TRUE)
                       IF  (ARO-ORIG-CURRENCY   = ZR900WS-CURR   (I1))
                       AND (ZR900WS-SORT-FIELD  = ZR900WS-SORT-F (I1))
                           MOVE I1      TO J
                           MOVE WS-TRUE TO ZR900WS-RECORD-SELECTED
                       END-IF
               END-PERFORM
               IF (ZR900WS-RECORD-SELECTED  = WS-TRUE)
                   IF (ARO-TRANS-TYPE      = "C")
                       SUBTRACT AROPWS-ORIG-OPEN-AMT
                                                  FROM ZR900WS-AMT (J)
                   ELSE
                       ADD AROPWS-ORIG-OPEN-AMT   TO ZR900WS-AMT (J)
                   END-IF
               ELSE
                   ADD 1                    TO K
                   IF (K = ZERO)
                       MOVE 21 TO K
                   END-IF
                   IF (K                    > 20)
                       IF (ARO-TRANS-TYPE   = "C")
                           MOVE "S"         TO ZR900WS-TEMP-TYPE
                       ELSE
                           MOVE "A"         TO ZR900WS-TEMP-TYPE
                       END-IF
                       MOVE ARO-ORIG-CURRENCY TO ZR900WS-TEMP-CURR
                       PERFORM 1260-BLD-AS-OF-AMT
                       THRU    1260-END
                       ELSE
                           IF (ARO-TRANS-TYPE      = "C")
                               SUBTRACT AROPWS-ORIG-OPEN-AMT
                                                    FROM ZR900WS-AMT (K)
                           ELSE
                               ADD AROPWS-ORIG-OPEN-AMT
                                                     TO ZR900WS-AMT (K)
                           END-IF
                           MOVE ZR900WS-SORT-FIELD TO ZR900WS-SORT-F (K)
                           MOVE ARO-ORIG-ND       TO ZR900WS-ND     (K)
                           MOVE ARO-ORIG-CURRENCY TO ZR900WS-CURR   (K).

           MOVE WS-FALSE                  TO ZR900WS-XREF-FL.
           IF (ARO-TRANS-TYPE          = "C")
               PERFORM 1115-CRMEMO-XREF
               THRU    1115-END.

           IF  (ARO-SUM-LINE    = "Y")
           AND (ZR900WS-XREF-FL = WS-FALSE)
               MOVE ZR900WS-PRM-COMPANY   TO WF1-COMPANY
               MOVE ZR900WS-SORT-FIELD    TO WF1-SORT-FIELD
               IF (PRM-ACO-CURR-DISPLAY        = "T")
                   MOVE ARO-ORIG-CURRENCY TO WF1-ORIG-CURRENCY
               ELSE
                   MOVE ACO-CURRENCY-CD   TO WF1-ORIG-CURRENCY
               END-IF
               MOVE ZR900WS-SEARCH-NAME   TO WF1-SEARCH-NAME
               MOVE ZR900WS-CUST          TO WF1-CUSTOMER
J56704         IF (PRM-REPORT-OPTION = "B")
                   MOVE ARO-BILL-TO       TO WF1-BILL-TO
               ELSE
                   MOVE ZEROES            TO WF1-BILL-TO
               END-IF
               MOVE 1                     TO WF1-SEQ-NBR
               IF (ARO-ALT-TYPE   = "M")
                   MOVE ARO-ALT-TYPE       TO DB-TRANS-TYPE
                   MOVE ARO-INVOICE        TO DB-INVOICE
                   PERFORM 840-FIND-ARHSET1
                   IF (ARH-ALT-TYPE = "I")
                       MOVE "2"            TO WF1-SORT-TYPE
                       MOVE "3"            TO WF1-TRANS-TYPE
                   ELSE
                   IF (ARH-ALT-TYPE = "D")
                       MOVE "2"            TO WF1-SORT-TYPE
                       MOVE "4"            TO WF1-TRANS-TYPE
                   ELSE
                   IF (ARH-ALT-TYPE = "C")
                       MOVE "1"            TO WF1-SORT-TYPE
                       MOVE "2"            TO WF1-TRANS-TYPE
                   END-IF
                   END-IF
                   END-IF
               ELSE
                   IF (ARO-TRANS-TYPE = "I")
                       MOVE "2"            TO WF1-SORT-TYPE
                       MOVE "3"            TO WF1-TRANS-TYPE
                   ELSE
                   IF (ARO-TRANS-TYPE = "D")
                       MOVE "2"            TO WF1-SORT-TYPE
                       MOVE "4"            TO WF1-TRANS-TYPE
                   ELSE
                   IF (ARO-TRANS-TYPE = "C")
                       MOVE "1"            TO WF1-SORT-TYPE
                       MOVE "2"            TO WF1-TRANS-TYPE
                   END-IF
                   END-IF
                   END-IF
               END-IF
               IF (ZR900WS-TRANS-SEQUENCE  = "D")
                   MOVE ARO-DUE-DATE      TO WF1-SORT-DATE
               ELSE
                   MOVE ZEROS             TO WF1-SORT-DATE
               END-IF
               MOVE ARO-INVOICE           TO WF1-INVOICE
               MOVE 1                     TO WF1-PAYMENT-SEQ
               MOVE SPACES                TO WF1-CR-INVOICE
               MOVE ARO-CUSTOMER          TO WF1-CUST
               MOVE ARO-BATCH-NBR         TO WF1-BATCH-NBR
               IF (PRM-TRANS-SORT          = "D")
                   MOVE ARO-DUE-DATE       TO WF1-TRANS-SORT
               END-IF
               IF (PRM-TRANS-SORT          = "T")
                   MOVE ARO-TRANS-DATE     TO WF1-TRANS-SORT
               END-IF
               IF (PRM-TRANS-SORT          = "O")
                   IF (ARO-TRANS-TYPE      = "C")
                       MOVE "N"                TO WF1-TRANS-SORT-SIGN
                       COMPUTE WF1-TRANS-SORT  = AROPWS-OPEN-AMT
                                               * 100
                   ELSE
                       COMPUTE WF1-TRANS-SORT  = ZR900WS-ALL-NINES
                                               - (AROPWS-OPEN-AMT
                                               *  100)
                       MOVE SPACES             TO WF1-TRANS-SORT-SIGN
                   END-IF
               END-IF
               MOVE ARO-CUSTOMER               TO WF1-CUST
AI0000         MOVE ARO-PROCESS-LEVEL          TO WF1-PROCESS-LEVEL
               IF (PRM-TRANS-SORT          = SPACE)
                   INITIALIZE WF1-TRANS-SORT-SIGN
                   INITIALIZE WF1-TRANS-SORT
               END-IF
               PERFORM 8400-FIND-ZR9001WORK
               IF (ARWORK-FOUND)
                   IF  (PRM-REPORT-OPTION  = "M")
                   AND (ARH-SUM-LINE       = "Y")
                       MOVE WF1-TRAN-AMT   TO ZR900WS-ORIG-OPEN-AMT
                   ELSE
                       MOVE ZEROS          TO ZR900WS-ORIG-OPEN-AMT
                   END-IF
                   IF (PRM-ACO-CURR-DISPLAY        = "T")
                       MOVE AROPWS-ORIG-OPEN-AMT    TO WF1-AMOUNT
                       IF (ARO-TRANS-TYPE   = "D" OR "I")
                           ADD AROPWS-ORIG-OPEN-AMT TO WF1-TRAN-AMT
                                                       ZR900WS-TOTAL
                       ELSE
                           COMPUTE ZR900WS-SUMLINE
                                                  = AROPWS-ORIG-OPEN-AMT
                                                  * NEGATIVE-ONE
                           ADD ZR900WS-SUMLINE   TO WF1-TRAN-AMT
                                                    ZR900WS-TOTAL
                       END-IF
                   END-IF
                   IF (PRM-ACO-CURR-DISPLAY = "B")
                       IF (ARO-TRANS-TYPE   = "D" OR "I")
                           ADD AROPWS-OPEN-AMT   TO WF1-TRAN-AMT
                                                    ZR900WS-TOTAL
                       ELSE
                           COMPUTE ZR900WS-SUMLINE
                                                  = AROPWS-OPEN-AMT
                                                  * NEGATIVE-ONE
                           ADD ZR900WS-SUMLINE   TO WF1-TRAN-AMT
                                                    ZR900WS-TOTAL
                       END-IF
                   END-IF
                   IF (ARO-DISPUTE-SEQ         NOT = ZEROS)
                       MOVE "Y"                TO WF1-DISPUTE-EXISTS
                   END-IF
                   IF (ARO-TRANS-TYPE            = "D" OR "I")
                       IF (ZR900WS-PER           > ZR900WS-AGE-PER-FL)
                           MOVE ZR900WS-PER      TO ZR900WS-AGE-PER-FL
                       END-IF
                   END-IF
                   MOVE WS-TRUE                  TO ZR900WS-ACTIVE-ACCT
AI0000             MOVE ARO-TRAN-AMT             TO WF1-TRX-AMT
                   PERFORM 8200-STORE-ZR9001WORK
                   GO TO 1080-NEXT-AROITEMS.

           IF  (ARO-SUM-LINE    = "Y")
           AND (ZR900WS-XREF-FL = WS-TRUE)
               MOVE ZR900WS-PRM-COMPANY   TO WF1-COMPANY
               MOVE ZR900WS-SORT-FIELD    TO WF1-SORT-FIELD
               IF (PRM-ACO-CURR-DISPLAY        = "T")
                   MOVE ARO-ORIG-CURRENCY TO WF1-ORIG-CURRENCY
               ELSE
                   MOVE ACO-CURRENCY-CD   TO WF1-ORIG-CURRENCY
               END-IF
               MOVE ZR900WS-SEARCH-NAME   TO WF1-SEARCH-NAME
               MOVE ZR900WS-CUST          TO WF1-CUSTOMER
J56704         IF (PRM-REPORT-OPTION = "B")
                   MOVE ARO-BILL-TO       TO WF1-BILL-TO
               ELSE
                   MOVE ZEROES            TO WF1-BILL-TO
               END-IF
               MOVE 1                     TO WF1-SEQ-NBR
               IF (ZR900WS-TRANS-SEQUENCE  = "D")
                   MOVE ARO-DUE-DATE      TO WF1-SORT-DATE
               ELSE
                   MOVE ZEROS             TO WF1-SORT-DATE
               END-IF
               MOVE ZR900WS-TRANS-TYPE    TO WF1-TRANS-TYPE
               MOVE ARO-XREF-NBR          TO WF1-INVOICE
               MOVE ARO-INVOICE           TO WF1-CR-INVOICE
               MOVE "2"                   TO WF1-SORT-TYPE
               MOVE 999999                TO WF1-PAYMENT-SEQ
               MOVE ARO-CUSTOMER          TO WF1-CUST
               MOVE ARO-BATCH-NBR         TO WF1-BATCH-NBR
               PERFORM 8400-FIND-ZR9001WORK
               IF (ARWORK-FOUND)
                   IF  (PRM-REPORT-OPTION  = "M")
                   AND (ARH-SUM-LINE       = "Y")
                       MOVE WF1-TRAN-AMT   TO ZR900WS-ORIG-OPEN-AMT
                   ELSE
                       MOVE ZEROS          TO ZR900WS-ORIG-OPEN-AMT
                   END-IF
                   IF (PRM-ACO-CURR-DISPLAY        = "T")
                       IF (ARO-TRANS-TYPE   = "D" OR "I")
                           ADD AROPWS-ORIG-OPEN-AMT TO WF1-TRAN-AMT
                                                       ZR900WS-TOTAL
                       ELSE
                           COMPUTE ZR900WS-SUMLINE
                                                  = AROPWS-ORIG-OPEN-AMT
                                                  * NEGATIVE-ONE
                           ADD ZR900WS-SUMLINE   TO WF1-TRAN-AMT
                                                    ZR900WS-TOTAL
                       END-IF
                   END-IF
                   IF (PRM-ACO-CURR-DISPLAY        = "B")
                       IF (ARO-TRANS-TYPE   = "D" OR "I")
                           ADD AROPWS-OPEN-AMT   TO WF1-TRAN-AMT
                                                    ZR900WS-TOTAL
                       ELSE
                           COMPUTE ZR900WS-SUMLINE
                                                  = AROPWS-OPEN-AMT
                                                  * NEGATIVE-ONE
                           ADD ZR900WS-SUMLINE   TO WF1-TRAN-AMT
                                                    ZR900WS-TOTAL
                       END-IF
                   END-IF
                   IF (ARO-DISPUTE-SEQ         NOT = ZEROS)
                       MOVE "Y"                TO WF1-DISPUTE-EXISTS
                   END-IF
                   MOVE WS-TRUE                TO ZR900WS-ACTIVE-ACCT
AI0000             MOVE ARO-TRAN-AMT           TO WF1-TRX-AMT
                   PERFORM 8200-STORE-ZR9001WORK
                   GO TO 1080-NEXT-AROITEMS.

           IF  (PRM-AGE-AGE-DISPUTES         = "N")
           AND (ARO-DISPUTE-SEQ              NOT = ZEROS)
           AND (PRM-AGE-AGE-CREDITS          = "L")
           AND (ARO-TRANS-TYPE               = "C")
               IF (PRM-CUSTOMER              = SPACES)
               OR (PRM-MATRIX-LIST           = SPACES)
               OR (PRM-CREDIT-ANLYST         = SPACES)
               OR (PRM-MAJ-CLASS             = SPACES)
               OR (PRM-MIN-CLASS             = SPACES)
               OR (PRM-NA-SUMM               NOT = "Y")
                   MOVE ARO-COMPANY              TO WF1-COMPANY
                   MOVE SPACES                   TO WF1-SORT-FIELD
                   MOVE ARO-ORIG-CURRENCY        TO WF1-ORIG-CURRENCY
                   MOVE ZR900WS-SEARCH-NAME      TO WF1-SEARCH-NAME
                   MOVE ARO-CUSTOMER             TO WF1-CUSTOMER
                   MOVE ZERO                     TO WF1-SEQ-NBR
                   MOVE SPACES             TO WF1-SORT-TYPE
                   MOVE ZEROS              TO WF1-SORT-DATE
                                              WF1-PAYMENT-SEQ
                                              WF1-TRANS-SORT
                                              WF1-BATCH-NBR
J56704                                        WF1-BILL-TO
                   MOVE SPACES             TO WF1-TRANS-TYPE
                                              WF1-CUST
                                              WF1-TRANS-SORT-SIGN
                                              WF1-INVOICE
                                              WF1-CR-INVOICE
                   PERFORM 8500-FIND-NLT-ZR9001WORK
                   IF  (ARWORK-FOUND)
                   AND (WF1-COMPANY        = PRM-COMPANY)
                   AND (WF1-ORIG-CURRENCY  = ARO-ORIG-CURRENCY)
                   AND (WF1-CUSTOMER       = ARO-CUSTOMER)
                   AND (WF1-SEARCH-NAME    = ZR900WS-SEARCH-NAME)
                   AND (WF1-CUSTOMER       = ARO-CUSTOMER)
                   AND (WF1-SEQ-NBR        = ZERO)
                      MOVE WF1-LAST-AGE-PER TO ZR900WS-AGE-PER-FL.

           PERFORM 8000-CREATE-ZR9001WORK.

           IF (PRM-ACO-CURR-DISPLAY        = "T")
               MOVE ARO-ORIG-CURRENCY  TO WF1-ORIG-CURRENCY
               MOVE AROPWS-ORIG-OPEN-AMT   TO WF1-AMOUNT
               IF (ARO-TRANS-TYPE  = "D" OR "I")
                   MOVE AROPWS-ORIG-OPEN-AMT  TO WF1-TRAN-AMT
                   ADD  AROPWS-ORIG-OPEN-AMT  TO ZR900WS-TOTAL
               ELSE
                   COMPUTE WF1-TRAN-AMT   = AROPWS-ORIG-OPEN-AMT
                                          * NEGATIVE-ONE
                   SUBTRACT AROPWS-ORIG-OPEN-AMT FROM ZR900WS-TOTAL.

           IF (PRM-ACO-CURR-DISPLAY        = "B")
               MOVE ACO-CURRENCY-CD    TO WF1-ORIG-CURRENCY
               MOVE AROPWS-OPEN-AMT    TO WF1-AMOUNT
               IF (ARO-TRANS-TYPE  = "D" OR "I")
                   MOVE AROPWS-OPEN-AMT  TO WF1-TRAN-AMT
                   ADD AROPWS-OPEN-AMT   TO ZR900WS-TOTAL
               ELSE
                   COMPUTE WF1-TRAN-AMT  = AROPWS-OPEN-AMT
                                         * NEGATIVE-ONE
                   SUBTRACT AROPWS-OPEN-AMT FROM ZR900WS-TOTAL.

           MOVE AROPWS-FUTURE          TO WF1-FUTURE.
           MOVE ZR900WS-APPL           TO WF1-APPL.
           MOVE ARO-BATCH-NBR          TO WF1-BATCH-NBR.

           IF  (ARO-TRANS-TYPE  = "I")
           AND (ZR900WS-XREF-FL = WS-FALSE)
               MOVE "2"                TO WF1-SORT-TYPE
               MOVE "3"                TO WF1-TRANS-TYPE
           ELSE
           IF (ARO-TRANS-TYPE = "D")
           AND (ZR900WS-XREF-FL = WS-FALSE)
               MOVE "2"                TO WF1-SORT-TYPE
               MOVE "4"                TO WF1-TRANS-TYPE.

           IF  (ARO-SUM-LINE    = "Y")
           AND (ZR900WS-XREF-FL = WS-FALSE)
               IF (ARO-ALT-TYPE   = "M")
                   IF (ARH-ALT-TYPE = "I")
                       MOVE "2"            TO WF1-SORT-TYPE
                       MOVE "3"            TO WF1-TRANS-TYPE
                   ELSE
                   IF (ARH-ALT-TYPE = "D")
                       MOVE "2"            TO WF1-SORT-TYPE
                       MOVE "4"            TO WF1-TRANS-TYPE
                   ELSE
                   IF (ARH-ALT-TYPE = "C")
                       MOVE "1"            TO WF1-SORT-TYPE
                       MOVE "2"            TO WF1-TRANS-TYPE
                   END-IF
                   END-IF
                   END-IF
               ELSE
                   IF (ARO-TRANS-TYPE = "I")
                       MOVE "2"            TO WF1-SORT-TYPE
                       MOVE "3"            TO WF1-TRANS-TYPE
                   ELSE
                   IF (ARO-TRANS-TYPE = "D")
                       MOVE "2"            TO WF1-SORT-TYPE
                       MOVE "4"            TO WF1-TRANS-TYPE
                   ELSE
                   IF (ARO-TRANS-TYPE = "C")
                       MOVE "1"            TO WF1-SORT-TYPE
                       MOVE "2"            TO WF1-TRANS-TYPE.

           IF (PRM-TRANS-SORT          = "D")
               MOVE ARO-DUE-DATE       TO WF1-TRANS-SORT
           ELSE
           IF (PRM-TRANS-SORT          = "T")
               MOVE ARO-TRANS-DATE     TO WF1-TRANS-SORT
           ELSE
           IF (PRM-TRANS-SORT          = "O")
               IF (ARO-TRANS-TYPE      = "C")
                   MOVE "N"                TO WF1-TRANS-SORT-SIGN
                   COMPUTE WF1-TRANS-SORT  = AROPWS-OPEN-AMT
                                           * 100
               ELSE
                   COMPUTE WF1-TRANS-SORT  = ZR900WS-ALL-NINES
                                           - (AROPWS-OPEN-AMT
                                           *  100)
                   MOVE SPACES             TO WF1-TRANS-SORT-SIGN.

           MOVE ARO-COMPANY            TO WF1-COMP.
           MOVE ZR900WS-CUST           TO WF1-CUSTOMER.
J56704     IF (PRM-REPORT-OPTION = "B")
               MOVE ARO-BILL-TO        TO WF1-BILL-TO
           ELSE
               MOVE ZEROES             TO WF1-BILL-TO
           END-IF.
           MOVE ARO-CUSTOMER           TO WF1-CUST.
           MOVE ZR900WS-PRM-COMPANY    TO WF1-COMPANY.
           MOVE ARO-SUM-LINE           TO WF1-SUM-LINE.
           IF (ZR900WS-XREF-FL = WS-FALSE)
               MOVE ARO-INVOICE        TO WF1-INVOICE
               MOVE SPACES             TO WF1-CR-INVOICE
               IF (ARO-SUM-LINE    = "Y")
                   MOVE 1               TO WF1-PAYMENT-SEQ
               ELSE
                   MOVE ARO-PAYMENT-SEQ TO WF1-PAYMENT-SEQ
               END-IF
           ELSE
               MOVE ZR900WS-TRANS-TYPE    TO WF1-TRANS-TYPE
               MOVE ARO-XREF-NBR          TO WF1-INVOICE
               MOVE ARO-INVOICE           TO WF1-CR-INVOICE
               MOVE "2"                   TO WF1-SORT-TYPE
               MOVE ARO-PAYMENT-SEQ       TO WF1-PAYMENT-SEQ.

           IF (ZR900WS-TRANS-SEQUENCE  = "D")
               MOVE ARO-DUE-DATE       TO WF1-SORT-DATE
           ELSE
               MOVE ZEROS              TO WF1-SORT-DATE.

           MOVE ARO-ORIG-ND            TO WF1-ORIG-ND.
           IF (ZR900WS-DISPLAY-DATE    = "D")
               MOVE ARO-DUE-DATE       TO WF1-DUE-DATE
           ELSE
               MOVE ARO-TRANS-DATE     TO WF1-DUE-DATE.
           MOVE ARO-TRANS-DATE     TO WF1-TRANS-DATE.
           MOVE ZR900WS-SEARCH-NAME    TO WF1-SEARCH-NAME.
           MOVE ZR900WS-SORT-FIELD     TO WF1-SORT-FIELD.

           IF (PRM-ACO-AGE-TYPE = "T")
               MOVE ARO-TRANS-DATE     TO ZR900WS-AGE-DATE
           ELSE
               MOVE ARO-DUE-DATE       TO ZR900WS-AGE-DATE.

           MOVE ARO-ALT-TYPE           TO WF1-ALT-TYPE.
           MOVE ARO-DESC               TO WF1-DESC.
           MOVE ARO-CUST-PO-NBR        TO WF1-CUST-PO-NBR.
           MOVE ARO-ACTIVITY           TO WF1-ACTIVITY.
           MOVE ZR900WS-CANCEL-DATE    TO WF1-CANCEL-DATE.
           MOVE ZR900WS-CANCEL-FLAG    TO WF1-CANCEL-FLAG.
           MOVE ZR900WS-CANCEL-CUST    TO WF1-CANCEL-CUST.
           MOVE ARO-SORT-1             TO WF1-SORT-1.
           MOVE ARO-SORT-2             TO WF1-SORT-2.
           MOVE ARO-SORT-3             TO WF1-SORT-3.
           MOVE ARO-SORT-4             TO WF1-SORT-4.
           MOVE ARO-XREF-COMPANY       TO WF1-XREF-COMPANY.
           MOVE ARO-XREF-TYPE          TO WF1-XREF-TYPE.
           MOVE ARO-XREF-NBR           TO WF1-XREF-NBR.
           MOVE ARO-LAST-STA-DATE      TO WF1-LAST-STA-DATE.
           MOVE ARO-LAST-FC-DATE       TO WF1-LAST-FC-DATE.
           MOVE ARO-LAST-LTR-DATE      TO WF1-LAST-LTR-DATE.
           IF (ARO-DISPUTE-SEQ         NOT = ZEROS)
               MOVE "Y"                TO WF1-DISPUTE-EXISTS.

           IF (ARO-TRANS-TYPE           = "D" OR "I")
           OR (ARO-SUM-LINE             = "Y")
               PERFORM 1200-FIND-PERIOD
               THRU    1200-END.

           IF  (ARO-TRANS-TYPE  = "C")
           AND (ARO-SUM-LINE    = "N")
               PERFORM 1120-CRMEMO
               THRU    1120-END
               IF (PRM-AGE-AGE-CREDITS     = "N")
                   MOVE 2                  TO ZR900WS-PER
               ELSE
               IF (PRM-AGE-AGE-CREDITS     = "L")
                   IF (ZR900WS-PAST-DUE-TRANS  = "Y")
                      MOVE ZR900WS-AGE-PER-FL TO ZR900WS-PER
                   ELSE
                      MOVE ZR900WS-PER     TO ZR900WS-AGE-PER-FL
                   END-IF
               ELSE
               IF (PRM-AGE-AGE-CREDITS     = "R")
                   IF (PRM-ACO-AGE-TYPE = "D")
                       MOVE ARO-DUE-DATE       TO ZR900WS-AGE-DATE
                   ELSE
                       MOVE ARO-TRANS-DATE     TO ZR900WS-AGE-DATE
                   END-IF
                   PERFORM 1200-FIND-PERIOD
                   THRU    1200-END.

           IF  (PRM-AGE-AGE-DISPUTES = "N")
           AND (ZR900WS-PER         NOT  = 2)
                IF (ARO-DISPUTE-SEQ NOT = ZEROS)
                    MOVE ZEROES               TO ZR900WS-DISPUTE-AMT
                    MOVE ARO-COMPANY          TO DB-COMPANY
                    MOVE ARO-CUSTOMER         TO DB-CUSTOMER
                    MOVE ARO-TRANS-TYPE       TO DB-TRANS-TYPE
                    MOVE ARO-INVOICE          TO DB-INVOICE 
                    MOVE ARO-PAYMENT-SEQ      TO DB-PAYMENT-SEQ
                    MOVE ADPSET1-PAYMENT-SEQ  TO WS-DB-BEG-RNG
                    PERFORM 850-FIND-BEGRNG-ADPSET1
                    PERFORM 1082-BLD-DISPUTE-AMT
                    THRU    1082-END
                        UNTIL (ARDISPUTE-NOTFOUND)
                    IF (ZR900WS-DISPUTE-AMT > AROPWS-OPEN-AMT)
                    OR (ZR900WS-DISPUTE-AMT = AROPWS-OPEN-AMT)
                       MOVE 2                  TO ZR900WS-PER
                    END-IF
                    MOVE ARO-TRANS-TYPE      TO WF1-DISPUTE-TYPE
                    MOVE ZR900WS-DISPUTE-AMT TO WF1-DISPUTE-AMT.

           MOVE ARO-DISPUTE-SEQ              TO WF1-DISPUTE-SEQ.
           IF  (ZR900WS-PER                  > ZR900WS-AGE-PER-FL)
           AND (ARO-TRANS-TYPE               NOT = "C")
               MOVE ZR900WS-PER              TO ZR900WS-AGE-PER-FL.

           MOVE ZR900WS-PER                  TO WF1-AGE-PERIOD.
           MOVE ARO-TRANS-DATE               TO ZR900WS-AGE-DATE.
           PERFORM 1200-FIND-PERIOD
           THRU    1200-END.
           COMPUTE ZR900WS-FOR-PERIOD        = ZR900WS-PER - 2.
           IF (ZR900WS-FOR-PERIOD < 1)
              MOVE 1                         TO WF1-FOR-PERIOD
           ELSE                       
              MOVE ZR900WS-FOR-PERIOD        TO WF1-FOR-PERIOD.
           MOVE ZR900WS-DP                   TO WF1-PAST.
           IF (ZR900WS-DP < 1)
               MOVE 1                        TO WF1-PAST.

       1080-STORE.
           MOVE 1                            TO WF1-SEQ-NBR.
           MOVE WS-TRUE                      TO ZR900WS-ACTIVE-ACCT.
AI0000     MOVE ARO-TRAN-AMT                 TO WF1-TRX-AMT.
      *     DISPLAY "Write to WF1 " WF1-TRX-AMT " " WF1-INVOICE 
      *     " "  WF1-TRX-AMT.
           PERFORM 8200-STORE-ZR9001WORK.

       1080-NEXT-AROITEMS.
           IF (ZR900WS-FILTER-TRANS-TYPE    = SPACES)
               IF (PRM-PERIOD-OF          = "A")
                   PERFORM 860-FIND-NXTRNG-AROSET5
               ELSE
                   IF (PRM-FUTURE-APPS    = "N")
                       PERFORM 860-FIND-NXTRNG-AROSET3
                   ELSE
                       PERFORM 860-FIND-NXTRNG-AROSET6.

           IF (ZR900WS-FILTER-TRANS-TYPE    NOT = SPACES)
               IF (PRM-PERIOD-OF          = "A")
                   PERFORM 860-FIND-NXTRNG-AROSET1
               ELSE
                   IF (PRM-FUTURE-APPS    = "N")
                       PERFORM 860-FIND-NXTRNG-AROSET9
                   ELSE
                       PERFORM 860-FIND-NXTRNG-AROSET6.

       1080-END.

      ******************************************************************
       1082-BLD-DISPUTE-AMT.
      ******************************************************************

           IF (ADP-DISPUTE-DATE > PRM-TRANS-DATE)
               GO TO 1082-NEXT-ARDISPUTE.

           IF  (ADP-RESOLV-DATE NOT = ZEROES)
                IF (ADP-RESOLV-DATE     < PRM-TRANS-DATE)
                OR (ADP-RESOLV-DATE     = PRM-TRANS-DATE)
                    GO TO 1082-NEXT-ARDISPUTE.

           IF (PRM-ACO-CURR-DISPLAY        = "B")
               IF (ADP-TRANS-TYPE          = "D" OR "I")
                   ADD ADP-DISPUTE-AMT     TO ZR900WS-DISPUTE-AMT
               ELSE
                   SUBTRACT ADP-DISPUTE-AMT FROM ZR900WS-DISPUTE-AMT
               END-IF
           ELSE
               IF (ADP-TRANS-TYPE          = "D" OR "I")
                   ADD ADP-ORIG-DISP       TO ZR900WS-DISPUTE-AMT
               ELSE
                   SUBTRACT ADP-ORIG-DISP   FROM ZR900WS-DISPUTE-AMT.

       1082-NEXT-ARDISPUTE.
           PERFORM 860-FIND-NXTRNG-ADPSET1.

       1082-END.

      ******************************************************************
       1091-ARITEMAUD.
      ******************************************************************

           IF  (ZR900WS-SAVE-CUSTOMER  NOT = ARZ-CUSTOMER)
           AND (PRM-NA-SUMM            = "N")
               PERFORM 1250-CUSTOMER-CHANGE
               THRU    1250-END
               MOVE ARZ-COMPANY        TO DB-COMPANY
               MOVE ARZ-CUSTOMER       TO DB-CUSTOMER
                                          ZR900WS-SAVE-CUSTOMER
               PERFORM 840-FIND-ACMSET1
               MOVE ACM-CUSTOMER        TO ZR900WS-CUST
               IF (PRM-SORT-OPTION         = "N")
                   MOVE ACM-CUSTOMER    TO ZR900WS-SEARCH-NAME
               ELSE
                   MOVE ACM-SEARCH-NAME TO ZR900WS-SEARCH-NAME.

           MOVE ARZ-DUE-DATE           TO ZR900WS-AGE-DATE.
           PERFORM 1200-FIND-PERIOD
           THRU    1200-END.
           IF (ZR900WS-PER              > 2)
               MOVE "Y"                 TO ZR900WS-PAST-DUE-TRANS.

           IF  (PRM-INCLUDE-INVOICES   = "N")
           AND (ARZ-TRANS-TYPE         = "I")
               GO TO 1091-NEXT.

           IF  (PRM-INCLUDE-CREDITS    = "N")
           AND (ARZ-TRANS-TYPE         = "C")
               GO TO 1091-NEXT.

           IF  (PRM-INCLUDE-DEBITS     = "N")
           AND (ARZ-TRANS-TYPE         = "D")
               GO TO 1091-NEXT.

           IF (ARZ-CANCEL-DATE         < PRM-TRANS-DATE)
               GO TO 1091-NEXT.

           IF (ARZ-CANCEL-DATE         = PRM-TRANS-DATE)
               GO TO 1091-NEXT.

           MOVE ARZ-TRANS-TYPE         TO DB-TRANS-TYPE.
           MOVE ARZ-INVOICE            TO DB-INVOICE.
           MOVE ARZ-PAYMENT-SEQ        TO DB-PAYMENT-SEQ.
           PERFORM 840-FIND-AROSET1.

           IF  (PRM-PROCESS-LEVEL      NOT = SPACES)
           AND (ARO-PROCESS-LEVEL      NOT = PRM-PROCESS-LEVEL)
               GO TO 1091-NEXT.

           IF  (PRM-ACTIVITY           NOT = SPACES)
           AND (ARZ-ACTIVITY           NOT = PRM-ACTIVITY)
               GO TO 1091-NEXT.

           INITIALIZE ZR900WS-ATTRIBUTE-KEY.

           IF (PRM-ACTIVITY-LIST       NOT = SPACES)
               IF (ARZ-ACTIVITY = SPACES)
                   GO TO 1091-NEXT
               END-IF
               MOVE "ACTVY"               TO ACMAWS-OBJ-TYPE    
               MOVE PRM-ACTIVITY-LIST     TO ACMAWS-MATRIX-LIST
               MOVE ARZ-ACTIVITY          TO ACMAWS-ACTIVITY
               IF (PRM-REPORT-OPTION = "L")
                   MOVE "Y"               TO ACMAWS-KEY-REQUEST
               ELSE
                   MOVE "N"               TO ACMAWS-KEY-REQUEST
               END-IF
               PERFORM 610-VAL-MATRIX-ACTIVITY
               IF (ACMAWS-MATRIX-MEMBER NOT = "Y")
                   GO TO 1091-NEXT
               END-IF
               IF (PRM-REPORT-OPTION = "L")
                   MOVE ACMAWS-KEY        TO ZR900WS-ATTRIBUTE-KEY.

J54577     IF (PRM-PAST-DUE-ONLY = "Y")
J54577       IF (PRM-ACO-AGE-TYPE = "D")
J54577          IF (ARO-DUE-DATE      NOT < PRM-TRANS-DATE)
J54577             GO TO 1091-NEXT
J54577          END-IF
J54577       ELSE
J54577          IF (PRM-ACO-AGE-TYPE = "T")
J54577             IF (ARO-TRANS-DATE NOT < PRM-TRANS-DATE)
J54577                GO TO 1091-NEXT
J54577             END-IF
J54577          END-IF
J54577       END-IF
J54577     ELSE
J54577       IF (ARO-GL-DATE             > PRM-TRANS-DATE)
J54577          GO TO 1091-NEXT
J54577       END-IF
J54577     END-IF.

           IF (PRM-FR-TRANS-USER1      NOT = SPACES)
           OR (PRM-TO-TRANS-USER1      NOT = SPACES)
               IF (ARO-TRANS-USER1     < PRM-FR-TRANS-USER1)
               OR (ARO-TRANS-USER1     > PRM-TO-TRANS-USER1)
                   GO TO 1091-NEXT.

           IF (PRM-FR-SALESMAN         NOT = ZEROES)
           OR (PRM-TO-SALESMAN         NOT = ZEROES)
               IF (ARO-SALESMAN        < PRM-FR-SALESMAN)
               OR (ARO-SALESMAN        > PRM-TO-SALESMAN)
                   GO TO 1091-NEXT.
        
           MOVE "Y"                    TO ZR900WS-REC-FOUND.
           MOVE SPACES                 TO AROPWS-FUTURE.
           MOVE SPACES                 TO ZR900WS-APPL.
           MOVE ARZ-TRAN-AMT           TO AROPWS-OPEN-AMT.
           MOVE ARZ-ORIG-AMT           TO AROPWS-ORIG-OPEN-AMT.

            IF (ARO-TRANS-TYPE          = "D" OR "I")
                IF (ARO-APPLIED-SEQ     NOT = ZEROES)
                    PERFORM 730-OPEN-TRANSACTION.

            IF (ARO-TRANS-TYPE          = "C")
                MOVE ARZ-CUSTOMER       TO AROPWS-CUSTOMER
                IF (ARO-APPLIED-SEQ     NOT = ZEROES)
ARTOAP*             PERFORM 710-OPEN-CREDIT.
ARTOAP             PERFORM 710-OPEN-CREDIT-LW.

            IF (AROPWS-ORIG-OPEN-AMT     = ZEROS)
                MOVE "N"                 TO ZR900WS-REC-FOUND
J54577          MOVE ZR900WS-PAST-DUE-TRANS-A TO ZR900WS-PAST-DUE-TRANS
J54577          GO TO 1091-NEXT
J54577      ELSE
J54577          MOVE ZR900WS-PAST-DUE-TRANS TO ZR900WS-PAST-DUE-TRANS-A
J54577      END-IF.

            IF (AROPWS-OPEN-AMT       NOT = ARO-TRAN-AMT)
                MOVE "*"                 TO ZR900WS-APPL.

J56704     IF (PRM-REPORT-OPTION       = "C" OR "B")
               MOVE SPACES             TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "A")
               MOVE ACM-CREDIT-ANLYST  TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "P")
               MOVE ARO-PROCESS-LEVEL  TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "S")
               MOVE ARO-SALESMAN       TO ZR900WS-SALESMAN
               MOVE ZR900WS-ALPHA-S    TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "M")
               MOVE ARZ-ACTIVITY       TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "L")
               MOVE ZR900WS-ATTRIBUTE-KEY TO ZR900WS-SORT-FIELD.

J56704     IF (PRM-ACO-CURR-DISPLAY        = "B")
               IF (PRM-REPORT-OPTION   NOT = "C" OR "B")
                   MOVE WS-FALSE       TO ZR900WS-RECORD-SELECTED
                   PERFORM
                       VARYING I1 FROM 1 BY 1 
                       UNTIL  (I1 > 20)
                       OR     (ZR900WS-RECORD-SELECTED = WS-TRUE)
                           IF  (ACO-CURRENCY-CD = ZR900WS-CURR   (I1))
                           AND (ZR900WS-SORT-FIELD 
                                                = ZR900WS-SORT-F (I1))
                               MOVE I1      TO J
                               MOVE WS-TRUE TO ZR900WS-RECORD-SELECTED
                           END-IF
                   END-PERFORM
                   IF (ZR900WS-RECORD-SELECTED  = WS-TRUE)
                       IF (ARZ-TRANS-TYPE = "C")
                           SUBTRACT AROPWS-OPEN-AMT FROM ZR900WS-AMT (J)
                       ELSE
                           ADD AROPWS-OPEN-AMT      TO ZR900WS-AMT (J)
                       END-IF
                   ELSE
                       ADD 1                    TO K
                       IF (K = ZERO)
                           MOVE 21 TO K
                       END-IF
                       IF (K                    > 20)
                           MOVE "A"             TO ZR900WS-TEMP-TYPE
                           MOVE ACO-CURRENCY-CD TO ZR900WS-TEMP-CURR
                           PERFORM 1260-BLD-AS-OF-AMT
                           THRU    1260-END
                       ELSE
                           IF (ARZ-TRANS-TYPE = "C")
                               SUBTRACT AROPWS-OPEN-AMT
                                                FROM ZR900WS-AMT (K)
                           ELSE
                               ADD AROPWS-OPEN-AMT 
                                                TO   ZR900WS-AMT (K)
                           END-IF
                           MOVE ZR900WS-SORT-FIELD TO ZR900WS-SORT-F (K)
                           MOVE ACO-BASE-ND       TO ZR900WS-ND     (K)
                           MOVE ACO-CURRENCY-CD   TO ZR900WS-CURR   (K)
                       END-IF
                   END-IF
               END-IF
           END-IF.

           IF (PRM-ACO-CURR-DISPLAY = "T")
               MOVE WS-FALSE           TO ZR900WS-RECORD-SELECTED
               PERFORM
                   VARYING I1 FROM 1 BY 1 
                   UNTIL  (I1 > 20)
                   OR     (ZR900WS-RECORD-SELECTED = WS-TRUE)
                       IF  (ARO-ORIG-CURRENCY   = ZR900WS-CURR   (I1))
                       AND (ZR900WS-SORT-FIELD  = ZR900WS-SORT-F (I1))
                           MOVE I1      TO J
                           MOVE WS-TRUE TO ZR900WS-RECORD-SELECTED
                       END-IF
               END-PERFORM
               IF (ZR900WS-RECORD-SELECTED  = WS-TRUE)
                   IF (ARZ-TRANS-TYPE = "C")
                       SUBTRACT AROPWS-ORIG-OPEN-AMT
                                            FROM ZR900WS-AMT (J)
                   ELSE
                       ADD AROPWS-ORIG-OPEN-AMT
                                            TO   ZR900WS-AMT (J)
                   END-IF
               ELSE
                   ADD 1                    TO K
                   IF (K = ZERO)
                       MOVE 21 TO K
                   END-IF
                   IF (K                    > 20)
                       MOVE "A"             TO ZR900WS-TEMP-TYPE
                       MOVE ARO-ORIG-CURRENCY TO ZR900WS-TEMP-CURR
                       PERFORM 1260-BLD-AS-OF-AMT
                       THRU    1260-END
                   ELSE
                       IF (ARZ-TRANS-TYPE = "C")
                           SUBTRACT AROPWS-ORIG-OPEN-AMT
                                                FROM ZR900WS-AMT (K)
                       ELSE
                           ADD AROPWS-ORIG-OPEN-AMT
                                                TO   ZR900WS-AMT (K)
                       END-IF
                       MOVE ZR900WS-SORT-FIELD  TO ZR900WS-SORT-F (K)
                       MOVE ARO-ORIG-ND         TO ZR900WS-ND     (K)
                       MOVE ARO-ORIG-CURRENCY   TO ZR900WS-CURR   (K).
J58560**--
J58560     MOVE WS-FALSE TO ZR900WS-XREF-FL.
J58560     IF (ARZ-TRANS-TYPE          = "C")
J58560         PERFORM 1115-CRMEMO-XREF
J58560         THRU    1115-END
J58560     END-IF.
J58560
J58560     IF  (ARO-SUM-LINE    = "Y")
J58560     AND (ZR900WS-XREF-FL = WS-FALSE)
J58560          MOVE ZR900WS-PRM-COMPANY   TO WF1-COMPANY
J58560          MOVE ZR900WS-SORT-FIELD    TO WF1-SORT-FIELD
J58560          IF (PRM-ACO-CURR-DISPLAY        = "T")
J58560              MOVE ARO-ORIG-CURRENCY TO WF1-ORIG-CURRENCY
J58560          ELSE
J58560              MOVE ACO-CURRENCY-CD   TO WF1-ORIG-CURRENCY
J58560          END-IF
J58560          MOVE ZR900WS-SEARCH-NAME   TO WF1-SEARCH-NAME
J58560          MOVE ZR900WS-CUST          TO WF1-CUSTOMER
J56704          IF (PRM-REPORT-OPTION = "B")
J56704              MOVE ARO-BILL-TO       TO WF1-BILL-TO
J56704          ELSE
J56704              MOVE ZEROES            TO WF1-BILL-TO
J56704          END-IF
J58560          MOVE 1                     TO WF1-SEQ-NBR
J58560          IF (ARO-ALT-TYPE   = "M")
J58560              MOVE ARO-ALT-TYPE       TO DB-TRANS-TYPE
J58560              MOVE ARO-INVOICE        TO DB-INVOICE
J58560              PERFORM 840-FIND-ARHSET1
J58560              IF (ARH-ALT-TYPE             = "I")
J58560                  MOVE "2"           TO WF1-SORT-TYPE
J58560                  MOVE "3"           TO WF1-TRANS-TYPE
J58560              END-IF
J58560              IF (ARH-ALT-TYPE            = "D")
J58560                  MOVE "2"           TO WF1-SORT-TYPE
J58560                  MOVE "4"           TO WF1-TRANS-TYPE
J58560              END-IF
J58560              IF (ARH-ALT-TYPE            = "C")
J58560                  MOVE "1"           TO WF1-SORT-TYPE
J58560                  MOVE "2"           TO WF1-TRANS-TYPE
J58560              END-IF
J58560          ELSE
J58560              IF (ARZ-TRANS-TYPE           = "I")
J58560                  MOVE "2"           TO WF1-SORT-TYPE
J58560                  MOVE "3"           TO WF1-TRANS-TYPE
J58560              END-IF
J58560              IF (ARZ-TRANS-TYPE          = "D")
J58560                  MOVE "2"           TO WF1-SORT-TYPE
J58560                  MOVE "4"           TO WF1-TRANS-TYPE
J58560              END-IF
J58560              IF (ARZ-TRANS-TYPE          = "C")
J58560                  MOVE "1"           TO WF1-SORT-TYPE
J58560                  MOVE "2"           TO WF1-TRANS-TYPE
J58560              END-IF
J58560          END-IF
J58560          IF (ZR900WS-TRANS-SEQUENCE  = "D")
J58560              MOVE ARO-DUE-DATE      TO WF1-SORT-DATE
J58560          ELSE
J58560              MOVE ZEROS             TO WF1-SORT-DATE
J58560          END-IF
J58560          MOVE ARZ-INVOICE           TO WF1-INVOICE
J58560          MOVE 1                     TO WF1-PAYMENT-SEQ
J58560          MOVE SPACES                TO WF1-CR-INVOICE
J58560          MOVE ARZ-CUSTOMER          TO WF1-CUST
J58560          MOVE ARO-BATCH-NBR         TO WF1-BATCH-NBR
J58560          IF (PRM-TRANS-SORT         = "D")
J58560              MOVE ARO-DUE-DATE      TO WF1-TRANS-SORT
J58560          END-IF
J58560          IF (PRM-TRANS-SORT         = "T")
J58560              MOVE ARO-TRANS-DATE    TO WF1-TRANS-SORT
J58560          END-IF
J58560          IF (PRM-TRANS-SORT         = "O")
J58560              IF (ARO-TRANS-TYPE     = "C")
J58560                  MOVE "N"           TO WF1-TRANS-SORT-SIGN
J58560                  COMPUTE WF1-TRANS-SORT = AROPWS-OPEN-AMT
J58560                                         * 100
J58560              ELSE
J58560                  COMPUTE WF1-TRANS-SORT = ZR900WS-ALL-NINES
J58560                                         - (AROPWS-OPEN-AMT
J58560                                         * 100)
J58560                  MOVE SPACES TO WF1-TRANS-SORT-SIGN   
J58560              END-IF
J58560          END-IF
J58560          MOVE ARZ-CUSTOMER              TO WF1-CUST
J58560          IF (PRM-TRANS-SORT             = SPACE)
J58560              INITIALIZE WF1-TRANS-SORT-SIGN
J58560              INITIALIZE WF1-TRANS-SORT
J58560          END-IF
J58560          PERFORM 8400-FIND-ZR9001WORK
J58560          IF (ARWORK-FOUND)
J58560              IF  (PRM-REPORT-OPTION  = "M")
J58560               AND (ARO-SUM-LINE       = "Y")
J58560                   MOVE WF1-TRAN-AMT TO ZR900WS-ORIG-OPEN-AMT
J58560               ELSE
J58560                   MOVE ZEROS        TO ZR900WS-ORIG-OPEN-AMT
J58560               END-IF
J58560               IF (PRM-ACO-CURR-DISPLAY        = "T")
J58560                   MOVE AROPWS-ORIG-OPEN-AMT TO WF1-AMOUNT
J58560                   IF (ARZ-TRANS-TYPE   = "D" OR "I")
J58560                       ADD AROPWS-ORIG-OPEN-AMT TO WF1-TRAN-AMT
J58560                                                   ZR900WS-TOTAL
J58560                   ELSE
J58560                       COMPUTE ZR900WS-SUMLINE
J58560                                            = AROPWS-ORIG-OPEN-AMT
J58560                                            * NEGATIVE-ONE
J58560                       ADD ZR900WS-SUMLINE TO WF1-TRAN-AMT
J58560                                              ZR900WS-TOTAL
J58560                   END-IF
J58560               END-IF
J58560               IF (PRM-ACO-CURR-DISPLAY = "B")
J58560                   IF (ARZ-TRANS-TYPE   = "D" OR "I")
J58560                       ADD AROPWS-OPEN-AMT TO WF1-TRAN-AMT
J58560                                              ZR900WS-TOTAL
J58560                   ELSE
J58560                       COMPUTE ZR900WS-SUMLINE
J58560                                              = AROPWS-OPEN-AMT
J58560                                              * NEGATIVE-ONE
J58560                       ADD ZR900WS-SUMLINE   TO WF1-TRAN-AMT
J58560                                                ZR900WS-TOTAL
J58560                   END-IF
J58560               END-IF
J58560               IF (ARO-DISPUTE-SEQ  NOT = ZEROS)
J58560                   MOVE "Y"          TO WF1-DISPUTE-EXISTS
J58560               END-IF
J58560               IF (ARZ-TRANS-TYPE = "D" OR "I")
J58560                   IF (ZR900WS-PER   > ZR900WS-AGE-PER-FL)
J58560                       MOVE ZR900WS-PER TO ZR900WS-AGE-PER-FL
J58560                   END-IF
J58560               END-IF
J58560               MOVE WS-TRUE TO ZR900WS-ACTIVE-ACCT
J58560               PERFORM 8200-STORE-ZR9001WORK
J58560               GO TO 1091-NEXT
J58560          END-IF
J58560     END-IF.
J58560
J58560     IF  (ARO-SUM-LINE    = "Y")
J58560     AND (ZR900WS-XREF-FL = WS-TRUE)
J58560          MOVE ZR900WS-PRM-COMPANY   TO WF1-COMPANY
J58560          MOVE ZR900WS-SORT-FIELD    TO WF1-SORT-FIELD
J58560          IF (PRM-ACO-CURR-DISPLAY        = "T")
J58560              MOVE ARO-ORIG-CURRENCY TO WF1-ORIG-CURRENCY
J58560          ELSE
J58560              MOVE ACO-CURRENCY-CD   TO WF1-ORIG-CURRENCY
J58560          END-IF
J58560          MOVE ZR900WS-SEARCH-NAME   TO WF1-SEARCH-NAME
J58560          MOVE ZR900WS-CUST          TO WF1-CUSTOMER
J56704          IF (PRM-REPORT-OPTION = "B")
J56704              MOVE ARO-BILL-TO       TO WF1-BILL-TO
J56704          ELSE
J56704              MOVE ZEROES            TO WF1-BILL-TO
J56704          END-IF
J58560          MOVE 1                     TO WF1-SEQ-NBR
J58560          IF (ZR900WS-TRANS-SEQUENCE  = "D")
J58560              MOVE ARZ-DUE-DATE      TO WF1-SORT-DATE
J58560          ELSE
J58560              MOVE ZEROS             TO WF1-SORT-DATE
J58560          END-IF
J58560          MOVE ZR900WS-TRANS-TYPE    TO WF1-TRANS-TYPE
J58560          MOVE ARO-XREF-NBR          TO WF1-INVOICE
J58560          MOVE ARZ-INVOICE           TO WF1-CR-INVOICE
J58560          MOVE "2"                   TO WF1-SORT-TYPE
J58560          MOVE 999999                TO WF1-PAYMENT-SEQ
J58560          MOVE ARZ-CUSTOMER          TO WF1-CUST
J58560          MOVE ARO-BATCH-NBR         TO WF1-BATCH-NBR
J58560          PERFORM 8400-FIND-ZR9001WORK
J58560          IF (ARWORK-FOUND)
J58560              IF  (PRM-REPORT-OPTION  = "M")
J58560              AND (ARO-SUM-LINE       = "Y")
J58560                  MOVE WF1-TRAN-AMT TO ZR900WS-ORIG-OPEN-AMT
J58560              ELSE
J58560                  MOVE ZEROS        TO ZR900WS-ORIG-OPEN-AMT
J58560              END-IF
J58560              IF (PRM-ACO-CURR-DISPLAY        = "T")
J58560                  IF (ARZ-TRANS-TYPE   = "D" OR "I")
J58560                      ADD AROPWS-ORIG-OPEN-AMT TO WF1-TRAN-AMT
J58560                                                  ZR900WS-TOTAL
J58560                  ELSE
J58560                      COMPUTE ZR900WS-SUMLINE
J58560                                           = AROPWS-ORIG-OPEN-AMT
J58560                                           * NEGATIVE-ONE
J58560                      ADD ZR900WS-SUMLINE TO WF1-TRAN-AMT
J58560                                             ZR900WS-TOTAL
J58560                  END-IF
J58560              END-IF
J58560              IF (PRM-ACO-CURR-DISPLAY        = "B")
J58560                  IF (ARZ-TRANS-TYPE   = "D" OR "I")
J58560                      ADD AROPWS-OPEN-AMT TO WF1-TRAN-AMT
J58560                                             ZR900WS-TOTAL
J58560                  ELSE
J58560                      COMPUTE ZR900WS-SUMLINE
J58560                                             = AROPWS-OPEN-AMT
J58560                                             * NEGATIVE-ONE
J58560                      ADD ZR900WS-SUMLINE   TO WF1-TRAN-AMT
J58560                                               ZR900WS-TOTAL
J58560                  END-IF
J58560              END-IF
J58560              IF (ARO-DISPUTE-SEQ NOT = ZEROS)
J58560                  MOVE "Y"         TO WF1-DISPUTE-EXISTS
J58560              END-IF
J58560              MOVE WS-TRUE         TO ZR900WS-ACTIVE-ACCT
J58560              PERFORM 8200-STORE-ZR9001WORK
J58560              GO TO 1091-NEXT
J58560          END-IF
J58560     END-IF.
J58560
J58560     IF  (PRM-AGE-AGE-DISPUTES         = "N")
J58560     AND (ARO-DISPUTE-SEQ          NOT = ZEROS)
J58560     AND (PRM-AGE-AGE-CREDITS          = "L")
J58560     AND (ARZ-TRANS-TYPE               = "C")
J58560         IF (PRM-CUSTOMER              = SPACES)
J58560         OR (PRM-MATRIX-LIST           = SPACES)
J58560         OR (PRM-CREDIT-ANLYST         = SPACES)
J58560         OR (PRM-MAJ-CLASS             = SPACES)
J58560         OR (PRM-MIN-CLASS             = SPACES)
J58560         OR (PRM-NA-SUMM           NOT = "Y")
J58560             MOVE ARZ-COMPANY              TO WF1-COMPANY
J58560             MOVE SPACES                   TO WF1-SORT-FIELD
J58560             MOVE ARO-ORIG-CURRENCY        TO WF1-ORIG-CURRENCY
J58560             MOVE ZR900WS-SEARCH-NAME      TO WF1-SEARCH-NAME
J58560             MOVE ARZ-CUSTOMER             TO WF1-CUSTOMER
J58560             MOVE ZERO                     TO WF1-SEQ-NBR
J58560             MOVE SPACES             TO WF1-SORT-TYPE
J58560             MOVE ZEROS              TO WF1-SORT-DATE
J58560                                        WF1-PAYMENT-SEQ
J58560                                        WF1-TRANS-SORT
J58560                                        WF1-BATCH-NBR
J56704                                        WF1-BILL-TO
J58560             MOVE SPACES             TO WF1-TRANS-TYPE
J58560                                        WF1-CUST
J58560                                        WF1-TRANS-SORT-SIGN
J58560                                        WF1-INVOICE
J58560                                        WF1-CR-INVOICE
J58560             PERFORM 8500-FIND-NLT-ZR9001WORK
J58560             IF  (ARWORK-FOUND)
J58560             AND (WF1-COMPANY        = PRM-COMPANY)
J58560             AND (WF1-ORIG-CURRENCY  = ARO-ORIG-CURRENCY)
J58560             AND (WF1-CUSTOMER       = ARO-CUSTOMER)
J58560             AND (WF1-SEARCH-NAME    = ZR900WS-SEARCH-NAME)
J58560             AND (WF1-CUSTOMER       = ARZ-CUSTOMER)
J58560             AND (WF1-SEQ-NBR        = ZERO)
J58560                  MOVE WF1-LAST-AGE-PER TO ZR900WS-AGE-PER-FL
J58560             END-IF
J58560     END-IF.
J58560**--
         PERFORM 8000-CREATE-ZR9001WORK.

J58560   IF (PRM-ACO-CURR-DISPLAY        = "T")
J58560       MOVE ARO-ORIG-CURRENCY  TO WF1-ORIG-CURRENCY
J58560       MOVE AROPWS-ORIG-OPEN-AMT   TO WF1-AMOUNT
J58560       IF (ARO-TRANS-TYPE  = "D" OR "I")
J58560           MOVE AROPWS-ORIG-OPEN-AMT  TO WF1-TRAN-AMT
J58560           ADD  AROPWS-ORIG-OPEN-AMT  TO ZR900WS-TOTAL
J58560       ELSE
J58560           COMPUTE WF1-TRAN-AMT    = AROPWS-ORIG-OPEN-AMT
J58560                                   * NEGATIVE-ONE
J58560           SUBTRACT AROPWS-ORIG-OPEN-AMT FROM ZR900WS-TOTAL
J58560       END-IF
J58560   END-IF.

J58560   IF (PRM-ACO-CURR-DISPLAY        = "B")
J58560       MOVE ACO-CURRENCY-CD    TO WF1-ORIG-CURRENCY
J58560       MOVE AROPWS-OPEN-AMT    TO WF1-AMOUNT
J58560       IF (ARZ-TRANS-TYPE  = "D" OR "I")
J58560           MOVE AROPWS-OPEN-AMT  TO WF1-TRAN-AMT
J58560           ADD AROPWS-OPEN-AMT   TO ZR900WS-TOTAL
J58560       ELSE
J58560           COMPUTE WF1-TRAN-AMT    = AROPWS-OPEN-AMT
J58560                                   * NEGATIVE-ONE
J58560           SUBTRACT AROPWS-OPEN-AMT FROM ZR900WS-TOTAL
J58560       END-IF
J58560   END-IF.

           MOVE AROPWS-FUTURE          TO WF1-FUTURE.
           MOVE ZR900WS-APPL           TO WF1-APPL.
J58560     MOVE ARO-BATCH-NBR          TO WF1-BATCH-NBR.

           IF (ARZ-TRANS-TYPE           = "I")
J58560     AND (ZR900WS-XREF-FL = WS-FALSE)
J58560         MOVE "2"                TO WF1-SORT-TYPE
J58560         MOVE "3"                TO WF1-TRANS-TYPE.
           IF (ARZ-TRANS-TYPE          = "D")
J58560     AND (ZR900WS-XREF-FL = WS-FALSE)
               MOVE "4"                TO WF1-TRANS-TYPE
               MOVE "2"                TO WF1-SORT-TYPE.
J58560
J58560     IF  (ARO-SUM-LINE    = "Y")
J58560     AND (ZR900WS-XREF-FL = WS-FALSE)
J58560          IF (ARO-ALT-TYPE   = "M")
J58560              IF (ARH-ALT-TYPE   = "I")
J58560                  MOVE "2"      TO WF1-SORT-TYPE
J58560                  MOVE "3"      TO WF1-TRANS-TYPE
J58560              END-IF
J58560              IF (ARH-ALT-TYPE   = "D")
J58560                  MOVE "2"      TO WF1-SORT-TYPE
J58560                  MOVE "4"      TO WF1-TRANS-TYPE
J58560              END-IF
J58560              IF (ARH-ALT-TYPE   = "C")
J58560                  MOVE "1"      TO WF1-SORT-TYPE
J58560                  MOVE "2"      TO WF1-TRANS-TYPE
J58560              END-IF
J58560          ELSE
J58560              IF (ARZ-TRANS-TYPE = "I")
J58560                  MOVE "2"      TO WF1-SORT-TYPE
J58560                  MOVE "3"      TO WF1-TRANS-TYPE
J58560              END-IF
J58560              IF (ARZ-TRANS-TYPE = "D")
J58560                  MOVE "2"      TO WF1-SORT-TYPE
J58560                  MOVE "4"      TO WF1-TRANS-TYPE
J58560              END-IF
J58560              IF (ARZ-TRANS-TYPE = "C")
J58560                  MOVE "1"      TO WF1-SORT-TYPE
J58560                  MOVE "2"      TO WF1-TRANS-TYPE
J58560              END-IF
J58560          END-IF
J58560     END-IF.
J58560
           IF (PRM-TRANS-SORT          = "D")
               MOVE ARZ-DUE-DATE       TO WF1-TRANS-SORT
           ELSE
           IF (PRM-TRANS-SORT          = "T")
               MOVE ARO-TRANS-DATE     TO WF1-TRANS-SORT
           ELSE
           IF (PRM-TRANS-SORT          = "O")
               IF (ARZ-TRANS-TYPE      = "C")
                   MOVE "N"                TO WF1-TRANS-SORT-SIGN
                   COMPUTE WF1-TRANS-SORT  = AROPWS-OPEN-AMT
                                           * 100
               ELSE
                   COMPUTE WF1-TRANS-SORT  = ZR900WS-ALL-NINES
                                           - (AROPWS-OPEN-AMT
                                           *  100)
                   MOVE SPACES             TO WF1-TRANS-SORT-SIGN.

           MOVE ARZ-COMPANY            TO WF1-COMP.
J58560     MOVE ARZ-CUSTOMER           TO WF1-CUST.
           MOVE ZR900WS-CUST           TO WF1-CUSTOMER.
           MOVE ZR900WS-PRM-COMPANY    TO WF1-COMPANY.
J58560     MOVE ARO-SUM-LINE           TO WF1-SUM-LINE.
J58560     IF (ZR900WS-XREF-FL = WS-FALSE)
J58560         MOVE ARZ-INVOICE        TO WF1-INVOICE
J58560         MOVE SPACES             TO WF1-CR-INVOICE
J58560         IF (ARO-SUM-LINE    = "Y")
J58560             MOVE 1               TO WF1-PAYMENT-SEQ
J58560         ELSE
J58560             MOVE ARZ-PAYMENT-SEQ TO WF1-PAYMENT-SEQ
J58560         END-IF
J58560     ELSE
J58560         MOVE ARZ-TRANS-TYPE      TO WF1-TRANS-TYPE
J58560         MOVE ARO-XREF-NBR        TO WF1-INVOICE
J58560         MOVE ARZ-INVOICE         TO WF1-CR-INVOICE
J58560         MOVE "2"                 TO WF1-SORT-TYPE
J58560         MOVE ARZ-PAYMENT-SEQ     TO WF1-PAYMENT-SEQ
J58560     END-IF.
J58560     MOVE ZR900WS-SEARCH-NAME TO WF1-SEARCH-NAME.
J58560     MOVE ZR900WS-SORT-FIELD  TO WF1-SORT-FIELD.
J56704     IF (PRM-REPORT-OPTION = "B")
J56704         MOVE ARO-BILL-TO       TO WF1-BILL-TO
J56704     ELSE
J56704         MOVE ZEROES            TO WF1-BILL-TO
J56704     END-IF.
           IF (ZR900WS-TRANS-SEQUENCE  = "D")
               MOVE ARZ-DUE-DATE       TO WF1-SORT-DATE
           ELSE
               MOVE ZEROS              TO WF1-SORT-DATE.

           IF (PRM-ACO-AGE-TYPE = "T")
               MOVE ARO-TRANS-DATE     TO ZR900WS-AGE-DATE
           ELSE
               MOVE ARZ-DUE-DATE       TO ZR900WS-AGE-DATE.

           MOVE ARO-ALT-TYPE           TO WF1-ALT-TYPE.
           MOVE ARO-DESC               TO WF1-DESC.
           MOVE ARO-CUST-PO-NBR        TO WF1-CUST-PO-NBR.
           MOVE ARO-ACTIVITY           TO WF1-ACTIVITY.
J58560     MOVE ZR900WS-CANCEL-FLAG    TO WF1-CANCEL-FLAG.
J58560     MOVE ZR900WS-CANCEL-DATE    TO WF1-CANCEL-DATE.
J58560     MOVE ZR900WS-CANCEL-CUST    TO WF1-CANCEL-CUST.
           MOVE ARO-SORT-1             TO WF1-SORT-1.
           MOVE ARO-SORT-2             TO WF1-SORT-2.
           MOVE ARO-SORT-3             TO WF1-SORT-3.
           MOVE ARO-SORT-4             TO WF1-SORT-4.
           MOVE ARO-XREF-COMPANY       TO WF1-XREF-COMPANY.
           MOVE ARO-XREF-TYPE          TO WF1-XREF-TYPE.
           MOVE ARO-XREF-NBR           TO WF1-XREF-NBR.
           MOVE ARO-LAST-STA-DATE      TO WF1-LAST-STA-DATE.
           MOVE ARO-LAST-FC-DATE       TO WF1-LAST-FC-DATE.
           MOVE ARO-LAST-LTR-DATE      TO WF1-LAST-LTR-DATE.
           IF (ARO-DISPUTE-SEQ         NOT = ZEROS)
               MOVE "Y"                TO WF1-DISPUTE-EXISTS.

J58560     IF (ARZ-TRANS-TYPE = "D" OR "I")
J58560     OR (ARO-SUM-LINE   = "Y")
J58560         PERFORM 1200-FIND-PERIOD
J58560         THRU    1200-END.
J58560
J58560     IF  (ARZ-TRANS-TYPE  = "C")
J58560     AND (ARO-SUM-LINE    = "N")
J58560         PERFORM 1120-CRMEMO
J58560         THRU    1120-END
J58560         IF (PRM-AGE-AGE-CREDITS     = "N")
J58560             MOVE 2                  TO ZR900WS-PER
J58560         ELSE
J58560         IF (PRM-AGE-AGE-CREDITS     = "L")
J58560             IF (ZR900WS-PAST-DUE-TRANS  = "Y")
J58560                MOVE ZR900WS-AGE-PER-FL TO ZR900WS-PER
J58560             ELSE
J58560                MOVE ZR900WS-PER     TO ZR900WS-AGE-PER-FL
J58560             END-IF
J58560         ELSE
J58560         IF (PRM-AGE-AGE-CREDITS     = "R")
J58560             IF (PRM-ACO-AGE-TYPE = "D")
J58560                 MOVE ARZ-DUE-DATE       TO ZR900WS-AGE-DATE
J58560             ELSE
J58560                 MOVE ARO-TRANS-DATE     TO ZR900WS-AGE-DATE
J58560             END-IF
J58560             PERFORM 1200-FIND-PERIOD
J58560             THRU    1200-END.
J58560
J58560     IF  (PRM-AGE-AGE-DISPUTES     = "N")
J58560     AND (ZR900WS-PER         NOT  = 2)
J58560          IF (ARO-DISPUTE-SEQ NOT = ZEROS)
J58560              MOVE ZEROES               TO ZR900WS-DISPUTE-AMT
J58560              MOVE ARZ-COMPANY          TO DB-COMPANY
J58560              MOVE ARZ-CUSTOMER         TO DB-CUSTOMER
J58560              MOVE ARZ-TRANS-TYPE       TO DB-TRANS-TYPE
J58560              MOVE ARZ-INVOICE          TO DB-INVOICE 
J58560              MOVE ARZ-PAYMENT-SEQ      TO DB-PAYMENT-SEQ
J58560              MOVE ADPSET1-PAYMENT-SEQ  TO WS-DB-BEG-RNG
J58560              PERFORM 850-FIND-BEGRNG-ADPSET1
J58560              PERFORM 1082-BLD-DISPUTE-AMT
J58560              THRU    1082-END
J58560                  UNTIL (ARDISPUTE-NOTFOUND)
J58560              IF (ZR900WS-DISPUTE-AMT > AROPWS-OPEN-AMT)
J58560              OR (ZR900WS-DISPUTE-AMT = AROPWS-OPEN-AMT)
J58560                  MOVE 2                  TO ZR900WS-PER
J58560              END-IF
J58560              MOVE ARZ-TRANS-TYPE      TO WF1-DISPUTE-TYPE
J58560              MOVE ZR900WS-DISPUTE-AMT TO WF1-DISPUTE-AMT
J58560          END-IF
J58560     END-IF.
J58560
J58560     MOVE ARO-DISPUTE-SEQ              TO WF1-DISPUTE-SEQ.

J58560     IF  (ZR900WS-PER             > ZR900WS-AGE-PER-FL)
J58560     AND (ARO-TRANS-TYPE      NOT = "C")
J58560          MOVE ZR900WS-PER        TO ZR900WS-AGE-PER-FL.

           MOVE ZR900WS-PER            TO WF1-AGE-PERIOD.
           MOVE ARO-TRANS-DATE         TO ZR900WS-AGE-DATE.
           PERFORM 1200-FIND-PERIOD
           THRU    1200-END.
           COMPUTE ZR900WS-FOR-PERIOD  = ZR900WS-PER - 2.
           IF (ZR900WS-FOR-PERIOD < 1)
              MOVE 1                         TO WF1-FOR-PERIOD
           ELSE                       
              MOVE ZR900WS-FOR-PERIOD        TO WF1-FOR-PERIOD.
           MOVE ZR900WS-DP                   TO WF1-PAST.
           IF (ZR900WS-DP < 1)
               MOVE 1                        TO WF1-PAST.

           MOVE ARO-ORIG-ND                  TO WF1-ORIG-ND.
           IF (ZR900WS-DISPLAY-DATE          = "D")
               MOVE ARZ-DUE-DATE             TO WF1-DUE-DATE
           ELSE
               MOVE ARO-TRANS-DATE           TO WF1-DUE-DATE.
           MOVE ARO-TRANS-DATE     TO WF1-TRANS-DATE.

           MOVE 1                            TO WF1-SEQ-NBR.
           MOVE WS-TRUE                      TO ZR900WS-ACTIVE-ACCT.
           PERFORM 8200-STORE-ZR9001WORK.

       1091-NEXT.
           PERFORM 860-FIND-NXTRNG-ARZSET2.

       1091-END.
      ******************************************************************
       1100-SEL-PAYMENTS.
      ******************************************************************

           IF  (ZR900WS-SAVE-CUSTOMER  NOT = APM-CUSTOMER)
           AND (PRM-NA-SUMM            = "N")
               PERFORM 1250-CUSTOMER-CHANGE
               THRU    1250-END
               MOVE APM-COMPANY        TO DB-COMPANY
               MOVE APM-CUSTOMER       TO DB-CUSTOMER
                                          ZR900WS-SAVE-CUSTOMER
               PERFORM 840-FIND-ACMSET1
               MOVE ACM-CUSTOMER        TO ZR900WS-CUST
               IF (PRM-SORT-OPTION         = "N")
                   MOVE ACM-CUSTOMER    TO ZR900WS-SEARCH-NAME
               ELSE
                   MOVE ACM-SEARCH-NAME TO ZR900WS-SEARCH-NAME.

           MOVE APM-DEPOSIT-DATE       TO ZR900WS-AGE-DATE.
           PERFORM 1200-FIND-PERIOD
           THRU    1200-END.
           IF (ZR900WS-PER              > 2)
               MOVE WS-TRUE             TO ZR900WS-ACTIVE-ACCT
               MOVE "Y"                 TO ZR900WS-PAST-DUE-TRANS.

           IF (PRM-INCLUDE-PAYMENTS   = "N")
               GO TO 1100-NEXT-ARPAYMENT.

           IF (APM-CUSTOMER = SPACES)
               GO TO 1100-NEXT-ARPAYMENT.

           IF (PRM-PAST-TRAN-DAYS-FR    NOT = ZEROS)
           OR (PRM-PAST-DUE-DAYS-FR     NOT = ZEROS)
               MOVE APM-DEPOSIT-DATE    TO ZR900WS-AGE-DATE
               PERFORM 1200-FIND-PERIOD
               THRU    1200-END
               IF (ZR900WS-DP          < PRM-PAST-TRAN-DAYS-FR)
               OR (ZR900WS-DP          > PRM-PAST-TRAN-DAYS-TO)
                   GO TO 1100-NEXT-ARPAYMENT.

           IF (APM-TRANS-TYPE          NOT = "P" AND "B")
               GO TO 1100-NEXT-ARPAYMENT.

           IF (APM-STATUS              NOT > 1)
               GO TO 1100-NEXT-ARPAYMENT.

           IF  (APM-CANCEL-DATE        NOT = ZEROS)
           AND (APM-CANCEL-DATE        NOT > PRM-TRANS-DATE)
               GO TO 1100-NEXT-ARPAYMENT.

P3FX08     IF  (APM-CANCEL-DATE        NOT = ZEROS)
P3FX08     AND (APM-APPLD-AMT          = ZEROES)    
P3FX08         GO TO 1100-NEXT-ARPAYMENT-A.

           IF  (APM-TRANSFER-DATE      NOT = ZEROS)
           AND (APM-CUSTOMER               = APM-TRNS-CUST)
               IF (APM-TRANSFER-DATE       > PRM-TRANS-DATE)
                   GO TO 1100-NEXT-ARPAYMENT.

           IF  (APM-TRANSFER-DATE      NOT = ZEROS)
           AND (APM-CUSTOMER           NOT = APM-TRNS-CUST)
               IF  (APM-TRANSFER-AMT       = APM-ORIG-AMT)
               AND (APM-TRANSFER-DATE  NOT > PRM-TRANS-DATE)
                   GO TO 1100-NEXT-ARPAYMENT.

J54577     IF (PRM-PAST-DUE-ONLY       = "Y")
J54577       IF (APM-DEPOSIT-DATE  NOT < PRM-TRANS-DATE)
J54577           GO TO 1100-NEXT-ARPAYMENT
J54577       END-IF
J54577     ELSE
J54577       IF (APM-GL-DATE           > PRM-TRANS-DATE)
J54577          GO TO 1100-NEXT-ARPAYMENT
J54577       END-IF
J54577     END-IF.

           IF  (PRM-PROCESS-LEVEL      NOT = SPACES)
           AND (APM-PROCESS-LEVEL      NOT = PRM-PROCESS-LEVEL)
               GO TO 1100-NEXT-ARPAYMENT.

           IF (PRM-FR-SALESMAN         NOT = ZEROES)
           OR (PRM-TO-SALESMAN         NOT = ZEROES)
               IF (ACM-SALESMAN        < PRM-FR-SALESMAN)
               OR (ACM-SALESMAN        > PRM-TO-SALESMAN)
                   GO TO 1100-NEXT-ARPAYMENT.

J63141     IF  (APM-TRNS-CUST        = "NON-AR")
J63141     AND (APM-TRANSFER-AMT NOT = ZEROES)
942549         IF (APM-TRANSFER-DATE NOT > PRM-TRANS-DATE)
942549         OR (APM-TRANSFER-DATE     = PRM-TRANS-DATE)
J63141            GO TO 1100-NEXT-ARPAYMENT
942549         END-IF
J63141     END-IF.


           INITIALIZE ZR900WS-ATTRIBUTE-KEY.

J56704     IF (PRM-REPORT-OPTION       = "C" OR "B" OR "M" OR "L")
               MOVE SPACES             TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "A")
               MOVE ACM-CREDIT-ANLYST  TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "P")
               MOVE APM-PROCESS-LEVEL  TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "S")
               MOVE ACM-SALESMAN       TO ZR900WS-SALESMAN
               MOVE ZR900WS-ALPHA-S    TO ZR900WS-SORT-FIELD.

           MOVE "Y"                    TO ZR900WS-REC-FOUND.
           MOVE SPACES                 TO AROPWS-FUTURE.
           MOVE SPACES                 TO ZR900WS-APPL.
           MOVE APM-TRAN-AMT           TO AROPWS-OPEN-AMT.
           MOVE APM-ORIG-AMT           TO AROPWS-ORIG-OPEN-AMT.
           IF (APM-APPLIED-SEQ         NOT = ZEROES)
               PERFORM 720-OPEN-PAYMENT.
P3FX07           
P3FX07*--- Check ARAPSELECT for a record for this invoice
P3FX07*--- skipping any records sent to AP for their full amount
P3FX07*--- and adjusting any partial applieds sent to AP
P3FX07     MOVE APM-COMPANY          TO DB-COMPANY. 
P3FX07     MOVE APM-CUSTOMER         TO DB-CUSTOMER.   
P3FX07     MOVE APM-BATCH-NBR        TO DB-BATCH-NBR.
P3FX07     MOVE APM-PAYMENT-SEQ      TO DB-PAYMENT-SEQ.  
P3FX07     PERFORM 840-FIND-AAISET3. 
P3FX07     IF (ARAPSELECT-FOUND)              
P3FX07             DISPLAY "ARTOAP PMT Adj " APM-CUSTOMER " " 
P3XX07                      APM-TRANS-NBR " " AAI-BASE-AMT
P3FX07             IF (AROPWS-OPEN-AMT NOT = ZERO)
P3FX07                COMPUTE AROPWS-OPEN-AMT = AROPWS-OPEN-AMT
P3FX07                                         - AAI-BASE-AMT
O3FX07             END-IF
P3FX07             IF (AROPWS-ORIG-OPEN-AMT NOT = ZERO)
P3FX07                 COMPUTE AROPWS-ORIG-OPEN-AMT = 
P3FX07                                    AROPWS-ORIG-OPEN-AMT
P3FX07                                         - AAI-BASE-AMT.
       1100-CONT.
           IF (PRM-PAYMENT-OPEN-AMT     NOT = ZEROS)
               IF (AROPWS-OPEN-AMT      NOT > PRM-PAYMENT-OPEN-AMT)
                   GO TO 1100-NEXT-ARPAYMENT.

           IF (AROPWS-OPEN-AMT          NOT = APM-TRAN-AMT)
               MOVE "*"                 TO ZR900WS-APPL.

           IF (AROPWS-ORIG-OPEN-AMT     = ZEROS)
               MOVE "N"                 TO ZR900WS-REC-FOUND
J54577         MOVE ZR900WS-PAST-DUE-TRANS-A TO ZR900WS-PAST-DUE-TRANS
J54577         GO TO 1100-NEXT-ARPAYMENT
J54577     ELSE
J54577         MOVE ZR900WS-PAST-DUE-TRANS TO ZR900WS-PAST-DUE-TRANS-A
J54577     END-IF.

807481     IF  (APM-STATUS     = 2  )
807481     AND (APM-TRANS-TYPE = "P")
807481     AND (PRM-FUTURE-APPS = "N")
131100     AND (APM-CREDIT-APPLD = ZERO)    
807481
807481         COMPUTE AROPWS-OPEN-AMT ROUNDED =  APM-TRAN-AMT
807481                                         - (APM-APPLD-AMT
807481                                         +  APM-ADJ-AMT)
807481
807481         COMPUTE AROPWS-ORIG-OPEN-AMT ROUNDED =  APM-ORIG-AMT
807481                                              - (APM-ORIG-APP-AMT
807481                                              +  APM-ORIG-ADJ-AMT)
807481     END-IF.

131100     IF  (APM-STATUS      = 2  )
131100     AND (APM-TRANS-TYPE  = "P")
131100     AND (PRM-FUTURE-APPS = "N")
131100     AND (APM-CREDIT-APPLD NOT = ZERO)
131100
131100         COMPUTE AROPWS-OPEN-AMT ROUNDED =  APM-TRAN-AMT
131100                                         +  APM-CREDIT-APPLD
131100                                         - (APM-ADJ-AMT
131100                                         +  APM-APPLD-AMT)
131100
131100         COMPUTE AROPWS-ORIG-OPEN-AMT ROUNDED =  APM-ORIG-AMT
131100                                              +  APM-ORIG-CR-APPLD
131100                                              - (APM-ORIG-ADJ-AMT
131100                                              +  APM-ORIG-APP-AMT)
131100     END-IF.

           IF (PRM-ACO-CURR-DISPLAY        = "B")
J56704         IF (PRM-REPORT-OPTION   NOT = "C" OR "B")
                   MOVE WS-FALSE           TO ZR900WS-RECORD-SELECTED
                   PERFORM
                       VARYING I1 FROM 1 BY 1 
                       UNTIL  (I1 > 20)
                       OR     (ZR900WS-RECORD-SELECTED = WS-TRUE)
                           IF  (ACO-CURRENCY-CD = ZR900WS-CURR   (I1))
                           AND (ZR900WS-SORT-FIELD 
                                                = ZR900WS-SORT-F (I1))
                               MOVE I1      TO J
                               MOVE WS-TRUE TO ZR900WS-RECORD-SELECTED
                           END-IF
                   END-PERFORM
                   IF (ZR900WS-RECORD-SELECTED  = WS-TRUE)
                       SUBTRACT AROPWS-OPEN-AMT  FROM ZR900WS-AMT (J)
                   ELSE
                       ADD 1                    TO K
                       IF (K = ZERO)
                           MOVE 21 TO K
                       END-IF
                       IF (K                    > 20)
                           MOVE "S"             TO ZR900WS-TEMP-TYPE
                           MOVE ACO-CURRENCY-CD TO ZR900WS-TEMP-CURR
                           PERFORM 1260-BLD-AS-OF-AMT
                           THRU    1260-END
                       ELSE
                           SUBTRACT AROPWS-OPEN-AMT  
                                                  FROM ZR900WS-AMT  (K)
                           MOVE ZR900WS-SORT-FIELD TO ZR900WS-SORT-F (K)
                           MOVE ACO-BASE-ND       TO ZR900WS-ND     (K)
                           MOVE ACO-CURRENCY-CD   TO ZR900WS-CURR   (K).
        
           IF (PRM-ACO-CURR-DISPLAY        = "T")
               MOVE WS-FALSE           TO ZR900WS-RECORD-SELECTED
               PERFORM
                   VARYING I1 FROM 1 BY 1 
                   UNTIL  (I1 > 20)
                   OR     (ZR900WS-RECORD-SELECTED = WS-TRUE)
                       IF  (APM-ORIG-CURRENCY = ZR900WS-CURR    (I1))
                       AND (ZR900WS-SORT-FIELD = ZR900WS-SORT-F (I1))
                           MOVE I1      TO J
                           MOVE WS-TRUE TO ZR900WS-RECORD-SELECTED
                       END-IF
               END-PERFORM
               IF (ZR900WS-RECORD-SELECTED  = WS-TRUE)
                   SUBTRACT AROPWS-ORIG-OPEN-AMT FROM ZR900WS-AMT (J)
               ELSE
                   ADD 1                    TO K
                   IF (K = ZERO)
                       MOVE 21 TO K
                   END-IF
                   IF (K                    > 20)
                       MOVE "S"             TO ZR900WS-TEMP-TYPE
                       MOVE APM-ORIG-CURRENCY TO ZR900WS-TEMP-CURR
                       PERFORM 1260-BLD-AS-OF-AMT
                       THRU    1260-END
                   ELSE
                       SUBTRACT AROPWS-ORIG-OPEN-AMT
                                             FROM ZR900WS-AMT (K)
                       MOVE ZR900WS-SORT-FIELD  TO ZR900WS-SORT-F (K)
                       MOVE APM-ORIG-ND         TO ZR900WS-ND     (K)
                       MOVE APM-ORIG-CURRENCY   TO ZR900WS-CURR   (K).

           PERFORM 8000-CREATE-ZR9001WORK.

           IF (PRM-ACO-CURR-DISPLAY        = "B")
               COMPUTE WF1-TRAN-AMT    = AROPWS-OPEN-AMT
                                       * NEGATIVE-ONE
               MOVE ACO-CURRENCY-CD    TO WF1-ORIG-CURRENCY
               SUBTRACT AROPWS-OPEN-AMT FROM ZR900WS-TOTAL.

           IF (PRM-ACO-CURR-DISPLAY        = "T")
               COMPUTE WF1-TRAN-AMT    = AROPWS-ORIG-OPEN-AMT
                                       * NEGATIVE-ONE
               MOVE APM-ORIG-CURRENCY  TO WF1-ORIG-CURRENCY.

           MOVE AROPWS-FUTURE          TO WF1-FUTURE.
           MOVE ZR900WS-APPL           TO WF1-APPL.

           MOVE "1"                    TO WF1-SORT-TYPE.
           MOVE "1"                    TO WF1-TRANS-TYPE.
           MOVE APM-COMPANY            TO WF1-COMP.
           MOVE APM-CUSTOMER           TO WF1-CUST.
           IF (ZR900WS-TRANS-SEQUENCE  = "D")
               MOVE APM-GL-DATE        TO WF1-SORT-DATE
           ELSE
               MOVE ZEROS              TO WF1-SORT-DATE.
           MOVE APM-DEPOSIT-DATE       TO WF1-DUE-DATE.
           MOVE ZR900WS-CUST           TO WF1-CUSTOMER.
J56704     MOVE ZEROES                 TO WF1-BILL-TO.
           MOVE ZR900WS-PRM-COMPANY    TO WF1-COMPANY.
           MOVE APM-TRANS-NBR          TO WF1-INVOICE.
           MOVE SPACES                 TO WF1-CR-INVOICE.
           MOVE ZEROES                 TO WF1-DISPUTE-SEQ.
           MOVE APM-ORIG-ND            TO WF1-ORIG-ND.
           MOVE APM-BATCH-NBR          TO WF1-BATCH-NBR.
           MOVE APM-PAYMENT-SEQ        TO WF1-PAYMENT-SEQ.
           MOVE APM-ACTIVITY           TO WF1-ACTIVITY.
           MOVE APM-LAST-STA-DATE      TO WF1-LAST-STA-DATE.
           MOVE APM-LAST-FC-DATE       TO WF1-LAST-FC-DATE.
           IF (APM-TRANSFER-DATE NOT = ZEROES)
               MOVE APM-TRANSFER-DATE  TO WF1-TRANSFER-DATE
               IF (APM-TRAN-AMT      NOT = APM-TRANSFER-AMT)
                   MOVE APM-TRANSFER-AMT   TO WF1-PARTIAL-TXFR
               ELSE
                   MOVE ZEROES             TO WF1-PARTIAL-TXFR
               END-IF
           ELSE
               INITIALIZE  WF1-TRANSFER-DATE
                           WF1-PARTIAL-TXFR
           END-IF.
           MOVE APM-CANCEL-DATE        TO WF1-CANCEL-DATE.
           MOVE APM-REF-TYPE           TO WF1-XREF-TYPE.
           MOVE APM-AR-REFERENCE       TO WF1-XREF-NBR.

           IF (PRM-AGE-AGE-PYMNT       = "N")
               MOVE 2                  TO WF1-AGE-PERIOD.

           IF (PRM-AGE-AGE-PYMNT       = "L")
               MOVE ZR900WS-AGE-PER-FL TO WF1-AGE-PERIOD.

           IF (PRM-AGE-AGE-PYMNT       = "R")
               MOVE WF1-DUE-DATE       TO ZR900WS-AGE-DATE
               PERFORM 1200-FIND-PERIOD
               THRU    1200-END
               MOVE ZR900WS-PER        TO WF1-AGE-PERIOD.

           MOVE 1                      TO WF1-SEQ-NBR.
           MOVE ZR900WS-SEARCH-NAME    TO WF1-SEARCH-NAME.
           MOVE ZR900WS-SORT-FIELD     TO WF1-SORT-FIELD.
           MOVE WS-TRUE                TO ZR900WS-ACTIVE-ACCT.

           IF (PRM-TRANS-SORT          = "D")
               MOVE APM-DEPOSIT-DATE   TO WF1-TRANS-SORT
           ELSE
           IF (PRM-TRANS-SORT          = "T")
               MOVE APM-DEPOSIT-DATE   TO WF1-TRANS-SORT
           ELSE
           IF (PRM-TRANS-SORT          = "O")
               MOVE "N"                TO WF1-TRANS-SORT-SIGN
               COMPUTE WF1-TRANS-SORT  = AROPWS-OPEN-AMT
                                       * 100.

           IF (APM-CANCEL-DATE         = ZEROS)
               INITIALIZE WF1-CUST.

           IF (APM-TRANSFER-DATE       = ZEROS)
               INITIALIZE WF1-TRANSFER-FLAG   
                          WF1-CUST
           ELSE
               IF (APM-TRNS-CUST = "NON-AR")
                   MOVE "N"                TO WF1-TRANSFER-FLAG
                   MOVE APM-TRNS-CUST      TO WF1-CUST
               ELSE
               IF (APM-TRNS-CUST = APM-CUSTOMER)
                   MOVE APM-TRANS-FRM-CUST TO WF1-CUST
                   MOVE "T"                TO WF1-TRANSFER-FLAG
               ELSE
                   MOVE APM-TRNS-CUST      TO WF1-CUST
                   MOVE "F"                TO WF1-TRANSFER-FLAG.

AI0000     MOVE APM-TRAN-AMT               TO WF1-TRX-AMT.
           PERFORM 8200-STORE-ZR9001WORK.

       1100-NEXT-ARPAYMENT.
AI0000     PERFORM 1160-SEL-ARPAYMENT-TRX
AI0000        THRU 1160-END.
AI0000
P3FX08 1100-NEXT-ARPAYMENT-A.
      * 1100-NEXT-ARPAYMENT.
           IF (PRM-PERIOD-OF           = "A")
               PERFORM 860-FIND-NXTRNG-APMSET10
           ELSE
               IF (PRM-FUTURE-APPS     = "N")
061651* JT-1061651
061651             PERFORM 860-FIND-NXTRNG-APMSET6
               ELSE  
                   PERFORM 860-FIND-NXTRNG-APMSET8.

       1100-END.

      ******************************************************************
       1115-CRMEMO-XREF.
      ******************************************************************

           IF (ARO-XREF-TYPE            = "I" OR "D")
               IF (ARO-XREF-TYPE        = "I")
                   MOVE "3"             TO ZR900WS-TRANS-TYPE
               ELSE
                   MOVE "4"             TO ZR900WS-TRANS-TYPE
               END-IF
               MOVE ZR900WS-PRM-COMPANY TO WF1-COMPANY    
               MOVE ZR900WS-SEARCH-NAME TO WF1-SEARCH-NAME
               MOVE ZR900WS-CUST        TO WF1-CUSTOMER
               IF (PRM-ACO-CURR-DISPLAY     = "B")
                   MOVE ACO-CURRENCY-CD    TO WF1-ORIG-CURRENCY
               ELSE
                   MOVE ARO-ORIG-CURRENCY  TO WF1-ORIG-CURRENCY
               END-IF
               MOVE 1                  TO WF1-SEQ-NBR
               MOVE "2"                TO WF1-SORT-TYPE
               MOVE ZEROS              TO WF1-SORT-DATE
                                          WF1-PAYMENT-SEQ
                                          WF1-BATCH-NBR
J56704                                    WF1-BILL-TO
               MOVE SPACES             TO WF1-TRANS-TYPE
                                          WF1-INVOICE
                                          WF1-CR-INVOICE
               PERFORM 8500-FIND-NLT-ZR9001WORK
               PERFORM
                   UNTIL (ARWORK-NOTFOUND)
                   OR    (WF1-COMPANY        NOT = PRM-COMPANY)
                   OR    (WF1-SEARCH-NAME    NOT = ZR900WS-SEARCH-NAME)
                   OR    (WF1-CUSTOMER       NOT = ZR900WS-CUST)
                   OR    (ZR900WS-XREF-FL    = WS-TRUE)
                       IF  (WF1-SEQ-NBR      = 1)
                       AND (WF1-SORT-TYPE    = "2")
                       AND (WF1-TRANS-TYPE   = ZR900WS-TRANS-TYPE)
                       AND (WF1-INVOICE      = ARO-XREF-NBR)
                           MOVE WS-TRUE      TO ZR900WS-XREF-FL
                       END-IF
                       IF (ZR900WS-XREF-FL   = WS-FALSE)
                           PERFORM 8600-FIND-NEXT-ZR9001WORK
                       END-IF
               END-PERFORM.

       1115-END.

      ******************************************************************
       1120-CRMEMO.
      ******************************************************************

           IF (ZR900WS-XREF-FL         = WS-TRUE)
               MOVE ZR900WS-TRANS-TYPE TO WF1-TRANS-TYPE
               MOVE ARO-XREF-NBR       TO WF1-INVOICE
               MOVE ARO-INVOICE        TO WF1-CR-INVOICE
               MOVE "2"                TO WF1-SORT-TYPE
               IF (ARO-SUM-LINE = "N")
                   COMPUTE WF1-PAYMENT-SEQ = 999999 - ARO-PAYMENT-SEQ
               ELSE
                   MOVE 999999         TO WF1-PAYMENT-SEQ 
               END-IF.

           IF (ZR900WS-XREF-FL         = WS-FALSE)
               IF (ZR900WS-TRANS-SEQUENCE   = "D")
                   MOVE ARO-GL-DATE    TO WF1-SORT-DATE
               ELSE
                   MOVE ZEROS          TO WF1-SORT-DATE
               END-IF
               MOVE "1"                TO WF1-SORT-TYPE
               MOVE "2"                TO WF1-TRANS-TYPE
               MOVE ARO-INVOICE        TO WF1-INVOICE
               MOVE SPACES             TO WF1-CR-INVOICE.

       1120-END.

      ******************************************************************
       1121-CANCELED-AROIHDR.
      ******************************************************************

           MOVE ARO-COMPANY        TO DB-COMPANY.
           MOVE ARO-TRANS-TYPE     TO DB-TRANS-TYPE.
           MOVE ARO-INVOICE        TO DB-INVOICE.
           MOVE ARO-PAYMENT-SEQ    TO DB-PAYMENT-SEQ.
           PERFORM 840-FIND-ARZSET1.
           IF  (ARITEMAUD-FOUND)
           AND (ARZ-CANCEL-DATE    > PRM-TRANS-DATE)
               MOVE WS-TRUE        TO ZR900WS-ARZ-REC.

           IF (ARITEMAUD-FOUND)
               MOVE "F"                TO ZR900WS-CANCEL-FLAG
               MOVE ARZ-CANCEL-DATE    TO ZR900WS-CANCEL-DATE
               MOVE ARZ-CUSTOMER       TO ZR900WS-CANCEL-CUST.

       1121-END.
      ******************************************************************
       1125-GAIN-LOSS-AMT.
      ******************************************************************

           IF (ARO-ORIG-CURRENCY       = ACO-CURRENCY-CD)
               GO TO 1125-END.

           IF (ARO-REVALUE-FL      NOT = "Y")
               GO TO 1125-END.

           IF (ARO-TRANS-TYPE           = "C")
               SUBTRACT ARO-GAINLOS-AMT FROM AROPWS-OPEN-AMT
           ELSE
               ADD ARO-GAINLOS-AMT      TO AROPWS-OPEN-AMT.

       1125-END.

      ******************************************************************
       1130-SEL-DRAFTS.
      ******************************************************************

           IF  (ZR900WS-SAVE-CUSTOMER  NOT = ARD-CUSTOMER)
           AND (PRM-NA-SUMM            = "N")
               PERFORM 1250-CUSTOMER-CHANGE
               THRU    1250-END
               MOVE ARD-COMPANY        TO DB-COMPANY
               MOVE ARD-CUSTOMER       TO DB-CUSTOMER
                                          ZR900WS-SAVE-CUSTOMER
               PERFORM 840-FIND-ACMSET1
               MOVE ACM-CUSTOMER        TO ZR900WS-CUST
               IF (PRM-SORT-OPTION         = "N")
                   MOVE ACM-CUSTOMER    TO ZR900WS-SEARCH-NAME
               ELSE
                   MOVE ACM-SEARCH-NAME TO ZR900WS-SEARCH-NAME.

           MOVE ARD-MATURITY-DATE      TO ZR900WS-AGE-DATE.
           PERFORM 1200-FIND-PERIOD
           THRU    1200-END.
           IF (ZR900WS-PER              > 2)
               MOVE WS-TRUE             TO ZR900WS-ACTIVE-ACCT
               MOVE "Y"                 TO ZR900WS-PAST-DUE-TRANS.

           IF (ARD-STATUS = 5)
               GO TO 1130-NEXT-DRAFT.

           IF (ARD-STATUS = 9)
               GO TO 1130-NEXT-DRAFT.

           IF  (PRM-PROCESS-LEVEL       NOT = SPACES)
           AND (ARD-PROCESS-LEVEL       NOT = PRM-PROCESS-LEVEL)
               GO TO 1130-NEXT-DRAFT.

           IF (ARD-DRAFT-DATE           > PRM-TRANS-DATE)
               GO TO 1130-NEXT-DRAFT.

           IF (ARD-STATUS               = 7)
               IF (ARD-DISHONOR-DATE    NOT > PRM-TRANS-DATE)
                   IF (ARD-RESOLUTION-FL = SPACE)
                       NEXT SENTENCE
                   ELSE
                       IF (ARD-RESOLVED-DATE > PRM-TRANS-DATE)
                           NEXT SENTENCE
                       ELSE
                           GO TO 1130-NEXT-DRAFT
               ELSE
               IF (ARD-CASH-DATE            NOT = ZEROS)
                   IF (ARD-CASH-DATE        NOT > PRM-TRANS-DATE)
                       GO TO 1130-NEXT-DRAFT
                   ELSE
                       NEXT SENTENCE
               ELSE
                   NEXT SENTENCE
           ELSE
           IF (ARD-STATUS                  = 8)
               IF (ARD-CANCEL-DATE         NOT > PRM-TRANS-DATE)
                   GO TO 1130-NEXT-DRAFT
               ELSE
                   NEXT SENTENCE
           ELSE
           IF (ARD-STATUS               = 6)
               IF  (ARD-CASH-DATE       NOT > PRM-TRANS-DATE)
               AND (ARD-RISK-FL         NOT = "Y")
                   GO TO 1130-NEXT-DRAFT.

       1130-CONT.

           MOVE SPACES                  TO AROPWS-FUTURE 
                                           ZR900WS-APPL.
           MOVE ARD-TRAN-AMT            TO AROPWS-OPEN-AMT.
           MOVE ARD-ORIG-AMT            TO AROPWS-ORIG-OPEN-AMT.

           INITIALIZE ZR900WS-ATTRIBUTE-KEY.

J56704     IF (PRM-REPORT-OPTION       = "C" OR "B")
               MOVE SPACES             TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "A")
               MOVE ACM-CREDIT-ANLYST  TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "P")
               MOVE ARD-PROCESS-LEVEL  TO ZR900WS-SORT-FIELD.
           IF (PRM-REPORT-OPTION       = "S")
               MOVE ACM-SALESMAN       TO ZR900WS-SALESMAN
               MOVE ZR900WS-ALPHA-S    TO ZR900WS-SORT-FIELD.

           IF (PRM-ACO-CURR-DISPLAY        = "B")
J56704         IF (PRM-REPORT-OPTION   NOT = "C" OR "B")
                   MOVE WS-FALSE       TO ZR900WS-RECORD-SELECTED
                   PERFORM
                       VARYING I1 FROM 1 BY 1 
                       UNTIL  (I1 > 20)
                       OR     (ZR900WS-RECORD-SELECTED = WS-TRUE)
                           IF  (ACO-CURRENCY-CD   = ZR900WS-CURR   (I1))
                           AND (ZR900WS-SORT-FIELD    
                                                = ZR900WS-SORT-F (I1))
                               MOVE I1      TO J
                               MOVE WS-TRUE TO ZR900WS-RECORD-SELECTED
                           END-IF
                   END-PERFORM
                   IF (ZR900WS-RECORD-SELECTED  = WS-TRUE)
                       ADD AROPWS-OPEN-AMT     TO ZR900WS-AMT (J)
                   ELSE
                       ADD 1                    TO K
                       IF (K = ZERO)
                           MOVE 21 TO K
                       END-IF
                       IF (K                    > 20)
                           MOVE "A"             TO ZR900WS-TEMP-TYPE
                           MOVE ACO-CURRENCY-CD TO ZR900WS-TEMP-CURR
                           PERFORM 1260-BLD-AS-OF-AMT
                           THRU    1260-END
                       ELSE
                           ADD AROPWS-OPEN-AMT     TO ZR900WS-AMT    (K)
                           MOVE ZR900WS-SORT-FIELD TO ZR900WS-SORT-F (K)
                           MOVE ACO-BASE-ND        TO ZR900WS-ND     (K)
                           MOVE ACO-CURRENCY-CD   TO ZR900WS-CURR   (K).
        
           IF (PRM-ACO-CURR-DISPLAY        = "T")
               MOVE WS-FALSE           TO ZR900WS-RECORD-SELECTED
               PERFORM
                   VARYING I1 FROM 1 BY 1 
                   UNTIL  (I1 > 20)
                   OR     (ZR900WS-RECORD-SELECTED = WS-TRUE)
                       IF  (ARD-ORIG-CURRENCY   = ZR900WS-CURR    (I1))
                       AND (ZR900WS-SORT-FIELD  = ZR900WS-SORT-F (I1))
                           MOVE I1      TO J
                           MOVE WS-TRUE TO ZR900WS-RECORD-SELECTED
                       END-IF
               END-PERFORM
               IF (ZR900WS-RECORD-SELECTED  = WS-TRUE)
                   ADD AROPWS-ORIG-OPEN-AMT    TO ZR900WS-AMT (J)
               ELSE
                   ADD 1                    TO K
                   IF (K = ZERO)
                       MOVE 21 TO K
                   END-IF
                   IF (K                    > 20)
                       MOVE "A"             TO ZR900WS-TEMP-TYPE
                       MOVE ARD-ORIG-CURRENCY TO ZR900WS-TEMP-CURR
                       PERFORM 1260-BLD-AS-OF-AMT
                       THRU    1260-END
                   ELSE
                       ADD AROPWS-ORIG-OPEN-AMT TO ZR900WS-AMT    (K)
                       MOVE ZR900WS-SORT-FIELD  TO ZR900WS-SORT-F (K)
                       MOVE ARD-ORIG-ND         TO ZR900WS-ND     (K)
                       MOVE ARD-ORIG-CURRENCY   TO ZR900WS-CURR   (K).

           PERFORM 8000-CREATE-ZR9001WORK.

           IF (PRM-ACO-CURR-DISPLAY        = "T")
               MOVE ARD-ORIG-CURRENCY  TO WF1-ORIG-CURRENCY
               MOVE AROPWS-ORIG-OPEN-AMT  TO WF1-TRAN-AMT.

           IF (PRM-ACO-CURR-DISPLAY        = "B")
               MOVE ACO-CURRENCY-CD    TO WF1-ORIG-CURRENCY
               MOVE AROPWS-OPEN-AMT    TO WF1-TRAN-AMT
               ADD AROPWS-OPEN-AMT TO ZR900WS-TOTAL.

           MOVE AROPWS-FUTURE           TO WF1-FUTURE.
           MOVE ZR900WS-APPL            TO WF1-APPL.

           MOVE ARD-COMPANY             TO WF1-COMP.
           MOVE ARD-CUSTOMER            TO WF1-CUST.
           MOVE ZR900WS-CUST            TO WF1-CUSTOMER.
J56704     MOVE ZEROES                  TO WF1-BILL-TO.
           MOVE ZR900WS-PRM-COMPANY     TO WF1-COMPANY.
           IF (ZR900WS-TRANS-SEQUENCE   = "D")
               MOVE ARD-MATURITY-DATE   TO WF1-SORT-DATE
           ELSE
               MOVE ZEROS               TO WF1-SORT-DATE.
           MOVE ARD-MATURITY-DATE       TO WF1-DUE-DATE.
           MOVE ZEROES                  TO WF1-DISPUTE-SEQ.
           MOVE 1                       TO WF1-SEQ-NBR.
           MOVE ZR900WS-SEARCH-NAME     TO WF1-SEARCH-NAME.
           MOVE ARD-ORIG-ND             TO WF1-ORIG-ND.
           MOVE ZEROS                   TO WF1-BATCH-NBR.

           MOVE "2"                     TO WF1-SORT-TYPE.
           MOVE "6"                     TO WF1-TRANS-TYPE.
           MOVE ARD-AR-DRAFT-NBR        TO WF1-INVOICE.
           MOVE SPACES                  TO WF1-CR-INVOICE.

           MOVE ARD-DRAFT-DATE          TO ZR900WS-AGE-DATE.
           PERFORM 1200-FIND-PERIOD
           THRU    1200-END.
           COMPUTE ZR900WS-FOR-PERIOD   = ZR900WS-PER - 2.
           IF (ZR900WS-FOR-PERIOD       < 1)
              MOVE 1                    TO WF1-FOR-PERIOD
           ELSE
              MOVE ZR900WS-FOR-PERIOD   TO WF1-FOR-PERIOD.
           MOVE ZR900WS-DP              TO WF1-PAST.
           IF (ZR900WS-DP               < 1)
               MOVE 1                   TO WF1-PAST.

           IF (PRM-ACO-AGE-TYPE = "T")
               MOVE ARD-DRAFT-DATE      TO ZR900WS-AGE-DATE
           ELSE
               MOVE ARD-MATURITY-DATE   TO ZR900WS-AGE-DATE.

           PERFORM 1200-FIND-PERIOD
           THRU    1200-END.

           IF (ZR900WS-PER              > ZR900WS-AGE-PER-FL)
               MOVE ZR900WS-PER         TO ZR900WS-AGE-PER-FL.

           MOVE ZR900WS-PER             TO WF1-AGE-PERIOD.
           MOVE ZR900WS-SORT-FIELD      TO WF1-SORT-FIELD.
           MOVE WS-TRUE                 TO ZR900WS-ACTIVE-ACCT.

           IF (PRM-TRANS-SORT          = "D")
               MOVE ARD-MATURITY-DATE  TO WF1-TRANS-SORT
           ELSE
           IF (PRM-TRANS-SORT          = "T")
               MOVE ARD-DRAFT-DATE     TO WF1-TRANS-SORT
           ELSE
           IF (PRM-TRANS-SORT          = "O")
               MOVE "N"                TO WF1-TRANS-SORT-SIGN
               COMPUTE WF1-TRANS-SORT  = AROPWS-OPEN-AMT
                                       * 100.

           PERFORM 8200-STORE-ZR9001WORK.

       1130-NEXT-DRAFT.

           PERFORM 860-FIND-NXTRNG-ARDSET9.

       1130-END.

AI0000******************************************************************
AI0000 1150-SEL-ARO-TRX.
AI0000******************************************************************
AI0000
           INITIALIZE             WS-INVOICE-TOT.
      *--- All items after our as of date are always fully unapplied 
P3FX06*    IF (ARO-TRANS-DATE          NOT > PRM-TRANS-DATE)
P3FX06*--- Item on or after the as of date are fully unapplied
P3FX06     IF (ARO-TRANS-DATE          <     PRM-TRANS-DATE)
807481         COMPUTE WS-INVOICE-TOT ROUNDED =  ARO-TRAN-AMT
807481                                        - (ARO-APPLD-AMT
807481                                        +  ARO-ADJ-AMT)
           ELSE
ARTOAP*--- Check ARAPSELECT for a record for this invoice
ARTOAP*--- skipping any records sent to AP for their full amount
ARTOAP*--- and adjusting any partial applieds sent to AP
ARTOAP         MOVE ARO-COMPANY          TO DB-COMPANY 
ARTOAP         MOVE ARO-TRANS-TYPE       TO DB-TRANS-TYPE 
ARTOAP         MOVE ARO-INVOICE          TO DB-INVOICE 
ARTOAP         MOVE ARO-PAYMENT-SEQ      TO DB-PAYMENT-SEQ  
ARTOAP         PERFORM 840-FIND-AAISET2 
ARTOAP         IF (ARAPSELECT-FOUND)              
ARTOAP             IF (ARO-TRAN-AMT = AAI-BASE-AMT)
ARTOAP                 GO TO 1150-END 
ARTOAP             ELSE
ARTOAP                 COMPUTE WS-INVOICE-TOT = ARO-TRAN-AMT
ARTOAP                                        - AAI-BASE-AMT
ARTOAP             END-IF
ARTOAP         ELSE
                   MOVE ARO-TRAN-AMT           TO WS-INVOICE-TOT.

      *--- write a work file for later use to write detail records-type
      *--- 82 and 84. 
      *     DISPLAY "1150: WsCust-Emp-Num: " WS-CUST-EMP-NUM
      *       " " ARO-INVOICE " " ARO-TRANS-DATE " " WS-INVOICE-TOT. 
           INITIALIZE                    WF4-REC84WRK-REC.
           MOVE ARO-COMPANY           TO WF4-COMPANY.
           MOVE ARO-CUSTOMER          TO WF4-CUSTOMER.
           MOVE ZEROES                TO WF4-EMPLOYEE.
AI0000     MOVE WS-CUST-EMP-NUM       TO WF4-EMPLOYEE.
CRED01     MOVE ARO-DESC              TO WF4-DESC.            
           MOVE ARO-TRANS-TYPE        TO WF4-TRANS-TYPE.
           MOVE ARO-INVOICE           TO WF4-INVOICE.
           MOVE ARO-TRANS-DATE        TO WF4-TRANS-DATE.
           MOVE ARO-DESC              TO WF4-DESC.       
           MOVE SPACES                TO WF4-PROCESS-LEVEL.
P3FX06*    MOVE ARO-TRAN-AMT          TO WF4-TRAN-AMT.
P3FX06     MOVE ARO-TRAN-AMT          TO WF4-TRX-AMT.
P3FX06     MOVE WS-INVOICE-TOT        TO WF4-TRAN-AMT.  
           MOVE WS-LW-BILL-ITEM       TO WF4-LW-BILL-ITEM.
           MOVE WS-ZB3-PLAN-TYPE      TO WF4-PLAN-TYPE.
           MOVE WS-ZB3-PLAN-CODE      TO WF4-PLAN-CODE.
           MOVE WS-MAJ-CLASS          TO WF4-MAJ-CLASS.
           MOVE WS-MIN-CLASS          TO WF4-MIN-CLASS.
           MOVE WS-LW-STATUS          TO WF4-LW-STATUS.
           MOVE WS-LW-BENEFIT         TO WF4-LW-BENEFIT.
           MOVE WS-LW-PLAN            TO WF4-LW-PLAN.
           MOVE WS-LW-OPTION          TO WF4-LW-OPTION.
      *    MOVE WS-LW-SOURCE          TO WF4-LW-SOURCE.
           MOVE WS-LW-CHK-NBR         TO WF4-LW-CHK-NBR.
           MOVE WS-LW-DATE-RECVD      TO WF4-LW-DATE-RECVD.

      *     DISPLAY "1150 rec84wrk: " WF4-REC84WRK-REC.
           WRITE REC84WRK-REC       FROM WF4-REC84WRK-REC.

AI0000 1150-END.
AI0000
AI0000******************************************************************
AI0000 1160-SEL-ARPAYMENT-TRX.
AI0000******************************************************************
AI0000
P3FX14*     IF (APM-DEPOSIT-DATE < PRM-TRANS-DATE)
P3FX14      IF (APM-DEPOSIT-DATE NOT > PRM-TRANS-DATE)
                 GO TO 1160-END
            END-IF.
P3FX10*--- Skipping bad data
P3FX10     IF (APM-CUSTOMER = "D32702300")
P3FX10           GO TO 1160-END.

  temp*    DISPLAY "arpayment.Company: " APM-COMPANY
  temp*            " Customer: " APM-CUSTOMER.
  temp*    DISPLAY "TransType: " APM-TRANS-TYPE
  temp*            " TransNbr: " APM-TRANS-NBR.
AI0000     INITIALIZE             WS-INVOICE-TOT.
            IF (APM-DEPOSIT-DATE NOT > PRM-TRANS-DATE)
AI0000         COMPUTE WS-INVOICE-TOT ROUNDED =  APM-TRAN-AMT
AI0000                                        - (APM-APPLD-AMT
AI0000                                        +  APM-ADJ-AMT)
            ELSE
P3FX07*--- Check ARAPSELECT for a record for this invoice
P3FX07*--- skipping any records sent to AP for their full amount
P3FX07*--- and adjusting any partial applieds sent to AP
P3FX07         MOVE APM-COMPANY          TO DB-COMPANY 
P3FX07         MOVE APM-CUSTOMER         TO DB-CUSTOMER   
P3FX07         MOVE APM-BATCH-NBR        TO DB-BATCH-NBR
P3FX07         MOVE APM-PAYMENT-SEQ      TO DB-PAYMENT-SEQ  
P3FX07         PERFORM 840-FIND-AAISET3 
P3FX07         IF (ARAPSELECT-FOUND)              
P3FX07             IF (APM-TRAN-AMT = AAI-BASE-AMT)
P3FX07                 GO TO 1160-END 
P3FX07             ELSE
P3FX07                 COMPUTE WS-INVOICE-TOT = APM-TRAN-AMT
P3FX07                                        - AAI-BASE-AMT
P3FX07             END-IF
P3FX07         ELSE
                MOVE APM-TRAN-AMT          TO WS-INVOICE-TOT.

P3FX13     IF (APM-CANCEL-DATE        NOT = ZEROS)
P3FX13     AND (APM-APPLD-AMT         NOT = ZEROES)
P3FX13         COMPUTE WS-INVOICE-TOT  ROUNDED = APM-APPLD-AMT
P3FX13
AI0000
  temp*    DISPLAY " Amount: " WS-INVOICE-TOT.
  temp*    DISPLAY "APM.tranAmt: " APM-TRAN-AMT
  temp*            " APM.appldAmt: " APM-APPLD-AMT
  temp*            " APM.AdjAmt: " APM-ADJ-AMT.
           INITIALIZE                    WF4-REC84WRK-REC.
           MOVE APM-COMPANY           TO WF4-COMPANY.
           MOVE APM-CUSTOMER          TO WF4-CUSTOMER.
           INITIALIZE                    WS-WF2-CUSTOMER
                                         WS-TMP-NBR-A.
           IF (APM-CUSTOMER(1:1) = "D")
CPS001         MOVE APM-CUSTOMER(2:6) TO WS-TMP-NBR-A
CPS001         IF (APM-CUSTOMER(2:6)  NOT NUMERIC)
CPS001             MOVE ZEROES         TO WS-TMP-NBR-A
AI0000         END-IF
AI0000         MOVE WS-TMP-NBR-A       TO JSTWS-STR
AI0000         MOVE 6                  TO JSTWS-STR-LEN
AI0000         MOVE 9                  TO JSTWS-STR-OUT-LEN
AI0000         SET JSTWS-NUMERIC TO TRUE
AI0000         PERFORM 2000-JUSTIFY-OBJECT
AI0000         MOVE JSTWS-STR-OUT      TO WS-WF2-CUSTOMER
AI0000     END-IF.
AI0000     MOVE WS-CUST-EMP-NUM       TO WF4-EMPLOYEE.
           MOVE APM-TRANS-TYPE        TO WF4-TRANS-TYPE.
           MOVE APM-TRANS-NBR         TO WF4-INVOICE.
           MOVE APM-DEPOSIT-DATE      TO WF4-TRANS-DATE.
           MOVE SPACES                TO WF4-PROCESS-LEVEL.
           MOVE WS-INVOICE-TOT        TO WF4-TRAN-AMT.
P3FX06     MOVE APM-TRAN-AMT          TO WF4-TRX-AMT.
           MOVE WS-LW-BILL-ITEM       TO WF4-LW-BILL-ITEM.
      *    MOVE WS-ZB3-PLAN-TYPE      TO WF4-PLAN-TYPE.
      *    MOVE WS-ZB3-PLAN-CODE      TO WF4-PLAN-CODE.
           MOVE WS-MAJ-CLASS          TO WF4-MAJ-CLASS.
           MOVE WS-MIN-CLASS          TO WF4-MIN-CLASS.
      *    MOVE WS-LW-STATUS          TO WF4-LW-STATUS.
      *    MOVE WS-LW-BENEFIT         TO WF4-LW-BENEFIT.
      *    MOVE WS-LW-PLAN            TO WF4-LW-PLAN.
      *    MOVE WS-LW-OPTION          TO WF4-LW-OPTION.
      *    MOVE WS-LW-SOURCE          TO WF4-LW-SOURCE.
           MOVE APM-TRANS-NBR         TO WF4-LW-CHK-NBR.
           MOVE APM-BATCH-NBR         TO WF4-LW-BATCH.     
           MOVE APM-DEPOSIT-DATE      TO WF4-LW-DATE-RECVD.

      *     DISPLAY "1160 rec84wrk: " WF4-REC84WRK-REC.
P3FX02*--- Do not include zero $$ payments
P3FX02     IF (WS-INVOICE-TOT NOT = ZERO)
               WRITE REC84WRK-REC       FROM WF4-REC84WRK-REC.

AI0000 1160-END.
AI0000
      ******************************************************************
       1200-FIND-PERIOD.
      ******************************************************************

           MOVE ZR900WS-AGE-DATE       TO WSDR-FR-DATE.
           PERFORM 900-DATE-TO-JULIAN.
           COMPUTE ZR900WS-DP ROUNDED  = ZR900WS-ASOF-DAYS
                                       - WSDR-JULIAN-DAYS.

           IF (ZR900WS-DP              = ZEROS)
               MOVE 2                  TO ZR900WS-PER
               GO TO 1200-END.

           IF (ZR900WS-DP              < ZERO)
               COMPUTE ZR900WS-DP      = ZR900WS-DP * NEGATIVE-ONE
               IF (ZR900WS-DP          NOT > PRM-AGE-CURRENT)
                   MOVE 2              TO ZR900WS-PER
                   COMPUTE ZR900WS-DP  = ZR900WS-DP * NEGATIVE-ONE
                   GO TO 1200-END
               ELSE
                   MOVE 1              TO ZR900WS-PER
                   COMPUTE ZR900WS-DP  = ZR900WS-DP * NEGATIVE-ONE
                   GO TO 1200-END.

            IF (ZR900WS-DP             > 999)
                MOVE 7                 TO ZR900WS-PER
                GO TO 1200-END
            ELSE
                MOVE ZR900WS-DP        TO ZR900WS-DP-1.

            MOVE 1                     TO ZR900WS-PER.
            PERFORM 1201-LOOP-AGE-PERIOD
            THRU    1201-END.

       1200-END.

      ******************************************************************
       1201-LOOP-AGE-PERIOD.
      ******************************************************************

           IF  (ZR900WS-DP             > PRM-AGE-PERIODS-6)
               MOVE 9                  TO ZR900WS-PER
           ELSE
           IF  (ZR900WS-DP             > PRM-AGE-PERIODS-5)
               MOVE 8                  TO ZR900WS-PER
           ELSE
           IF  (ZR900WS-DP             > PRM-AGE-PERIODS-4)
               MOVE 7                  TO ZR900WS-PER
           ELSE
           IF  (ZR900WS-DP             > PRM-AGE-PERIODS-3)
               MOVE 6                  TO ZR900WS-PER
           ELSE
           IF  (ZR900WS-DP             > PRM-AGE-PERIODS-2)
               MOVE 5                  TO ZR900WS-PER
           ELSE
           IF  (ZR900WS-DP             > PRM-AGE-PERIODS-1)
               MOVE 4                  TO ZR900WS-PER
           ELSE
               MOVE 3                  TO ZR900WS-PER.

       1201-END.

      ******************************************************************
       1250-CUSTOMER-CHANGE.
      ******************************************************************

           IF  (PRM-ACO-CURR-DISPLAY   = "B")
J56704     AND (PRM-REPORT-OPTION      = "C" OR "B")
           AND (ZR900WS-ACTIVE-ACCT    = WS-TRUE)
               PERFORM 1043-BUILD-TOTAL
               THRU    1043-END.

           IF (PRM-ACO-CURR-DISPLAY   = "T")
           OR (PRM-REPORT-OPTION      = "A" OR "P" OR "S" OR "M" OR "L")
               MOVE 1                  TO J
               PERFORM 1042-CREATE-BALANCE
               THRU    1042-END
                   UNTIL  (J > 20).

           MOVE "N"                    TO ZR900WS-PAST-DUE-TRANS.
J54577     MOVE "N"                    TO ZR900WS-PAST-DUE-TRANS-A.
           MOVE WS-FALSE               TO ZR900WS-ACTIVE-ACCT.
           PERFORM 1044-ZERO-ARRAYS
           THRU    1044-END.

       1250-END.

      ******************************************************************
       1260-BLD-AS-OF-AMT.
      ******************************************************************

           MOVE ZR900WS-PRM-COMPANY      TO WF1-COMPANY.
           MOVE ZR900WS-SORT-FIELD       TO WF1-SORT-FIELD.
           MOVE ZR900WS-TEMP-CURR        TO WF1-ORIG-CURRENCY.
           MOVE ZR900WS-SEARCH-NAME      TO WF1-SEARCH-NAME.
           MOVE ZR900WS-CUST             TO WF1-CUSTOMER.
J56704     MOVE ZEROES                   TO WF1-BILL-TO.
           MOVE ZEROES                   TO WF1-SEQ-NBR.
           MOVE SPACES                   TO WF1-SORT-TYPE.
           INITIALIZE WF1-TRANS-TYPE
                      WF1-SORT-DATE
                      WF1-INVOICE  
                      WF1-PAYMENT-SEQ
                      WF1-CR-INVOICE  
                      WF1-BATCH-NBR
                      WF1-CUST.
           PERFORM 8400-FIND-ZR9001WORK.
           IF (ARWORK-NOTFOUND)
               PERFORM 8000-CREATE-ZR9001WORK
               MOVE ZR900WS-PRM-COMPANY   TO WF1-COMPANY
               MOVE ZR900WS-SEARCH-NAME   TO WF1-SEARCH-NAME
               MOVE ZR900WS-CUST          TO WF1-CUSTOMER
J56704         MOVE ZEROES                TO WF1-BILL-TO
               MOVE ZEROES                TO WF1-SEQ-NBR
               MOVE ZR900WS-SORT-FIELD    TO WF1-SORT-FIELD
               IF (ZR900WS-TEMP-TYPE      = "S")
                   COMPUTE WF1-AMOUNT     = AROPWS-OPEN-AMT
                                          * NEGATIVE-ONE
               ELSE
                   MOVE AROPWS-OPEN-AMT   TO WF1-AMOUNT 
               END-IF
               MOVE ACO-CURRENCY-CD       TO WF1-ORIG-CURRENCY
               MOVE ACO-BASE-ND           TO WF1-ORIG-ND
               MOVE SPACES                TO WF1-SORT-TYPE
               MOVE ZR900WS-AGE-PER-FL    TO WF1-AGE-PERIOD
           ELSE
               IF (ZR900WS-TEMP-TYPE      = "S")
                   SUBTRACT AROPWS-OPEN-AMT FROM WF1-AMOUNT
               ELSE
                   ADD AROPWS-OPEN-AMT    TO WF1-AMOUNT. 

           PERFORM 8200-STORE-ZR9001WORK.

       1260-END.

       1000-END.

      ******************************************************************
       1000-DO-REPORT-1                SECTION 50.
      ******************************************************************
       1000-START.

AI0000     OPEN OUTPUT ZR9002WORK-FILE.
AI0000     CLOSE ZR9002WORK-FILE.
AI0000     OPEN I-O ZR9002WORK-FILE.
AI0000
           MOVE ZEROES                 TO RPT-PAGE-COUNT (ZR900-R1).

           IF (ACO-DISPLAY-DATE        = "T")
               MOVE 195                TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               IF (PRM-AMTS-OPT        = "N")
                   MOVE CRT-MESSAGE    TO R1G3-DATE-HEADER
               ELSE
                   MOVE CRT-MESSAGE    TO R1GT3-DATE-HEADER
               END-IF
           ELSE
               MOVE 117                TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               IF (PRM-AMTS-OPT      = "N")
                   MOVE CRT-MESSAGE    TO R1G3-DATE-HEADER
               ELSE
                   MOVE CRT-MESSAGE    TO R1GT3-DATE-HEADER.

           IF (PRM-ACO-AGE-TYPE            = "T")
               MOVE 200                TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               IF (PRM-AMTS-OPT        = "N")
                   MOVE CRT-MESSAGE    TO R1G3-TYPE-HEADER
               ELSE
                   MOVE CRT-MESSAGE    TO R1GT3-TYPE-HEADER
               END-IF
           ELSE
               MOVE 201                TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               IF (PRM-AMTS-OPT      = "N")
                   MOVE CRT-MESSAGE    TO R1G3-TYPE-HEADER
               ELSE
                   MOVE CRT-MESSAGE    TO R1GT3-TYPE-HEADER.

           MOVE PRM-AGE-PERIODS-1      TO R1G3-AGE-PERIOD-1E.
           MOVE PRM-AGE-PERIODS-1      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G3-AGE-PERIOD-2.
           MOVE PRM-AGE-PERIODS-2      TO R1G3-AGE-PERIOD-2E.
           MOVE PRM-AGE-PERIODS-2      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G3-AGE-PERIOD-3.
           MOVE PRM-AGE-PERIODS-3      TO R1G3-AGE-PERIOD-3E.
           MOVE PRM-AGE-PERIODS-3      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G3-AGE-PERIOD-4.
           MOVE PRM-AGE-PERIODS-4      TO R1G3-AGE-PERIOD-4E.
           MOVE PRM-AGE-PERIODS-4      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G3-AGE-PERIOD-5.
           MOVE PRM-AGE-PERIODS-5      TO R1G3-AGE-PERIOD-5E.
           MOVE PRM-AGE-PERIODS-5      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G3-AGE-PERIOD-6.
           MOVE PRM-AGE-PERIODS-6      TO R1G3-AGE-PERIOD-6E.
           MOVE PRM-AGE-PERIODS-6      TO R1G3-AGE-PERIOD-7.

           MOVE PRM-AGE-PERIODS-1      TO R1GT3-AGE-PERIOD-1E.
           MOVE PRM-AGE-PERIODS-1      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1GT3-AGE-PERIOD-2.
           MOVE PRM-AGE-PERIODS-2      TO R1GT3-AGE-PERIOD-2E.
           MOVE PRM-AGE-PERIODS-2      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1GT3-AGE-PERIOD-3.
           MOVE PRM-AGE-PERIODS-3      TO R1GT3-AGE-PERIOD-3E.
           MOVE PRM-AGE-PERIODS-3      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1GT3-AGE-PERIOD-4.
           MOVE PRM-AGE-PERIODS-4      TO R1GT3-AGE-PERIOD-4E.
           MOVE PRM-AGE-PERIODS-4      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1GT3-AGE-PERIOD-5.
           MOVE PRM-AGE-PERIODS-5      TO R1GT3-AGE-PERIOD-5E.
           MOVE PRM-AGE-PERIODS-5      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1GT3-AGE-PERIOD-6.
           MOVE PRM-AGE-PERIODS-6      TO R1GT3-AGE-PERIOD-6E.
           MOVE PRM-AGE-PERIODS-6      TO R1GT3-AGE-PERIOD-7.

           MOVE PRM-AGE-PERIODS-1      TO R1G31-AGE-PERIOD-1E.
           MOVE PRM-AGE-PERIODS-1      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G31-AGE-PERIOD-2.
           MOVE PRM-AGE-PERIODS-2      TO R1G31-AGE-PERIOD-2E.
           MOVE PRM-AGE-PERIODS-2      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G31-AGE-PERIOD-3.
           MOVE PRM-AGE-PERIODS-3      TO R1G31-AGE-PERIOD-3E.
           MOVE PRM-AGE-PERIODS-3      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G31-AGE-PERIOD-4.
           MOVE PRM-AGE-PERIODS-4      TO R1G31-AGE-PERIOD-4E.
           MOVE PRM-AGE-PERIODS-4      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G31-AGE-PERIOD-5.
           MOVE PRM-AGE-PERIODS-5      TO R1G31-AGE-PERIOD-5E.
           MOVE PRM-AGE-PERIODS-5      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G31-AGE-PERIOD-6.
           MOVE PRM-AGE-PERIODS-6      TO R1G31-AGE-PERIOD-6E.
           MOVE PRM-AGE-PERIODS-6      TO R1G31-AGE-PERIOD-7.

           MOVE PRM-AGE-PERIODS-1      TO R1G32-AGE-PERIOD-1E.
           MOVE PRM-AGE-PERIODS-1      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G32-AGE-PERIOD-2.
           MOVE PRM-AGE-PERIODS-2      TO R1G32-AGE-PERIOD-2E.
           MOVE PRM-AGE-PERIODS-2      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G32-AGE-PERIOD-3.
           MOVE PRM-AGE-PERIODS-3      TO R1G32-AGE-PERIOD-3E.
           MOVE PRM-AGE-PERIODS-3      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G32-AGE-PERIOD-4.
           MOVE PRM-AGE-PERIODS-4      TO R1G32-AGE-PERIOD-4E.
           MOVE PRM-AGE-PERIODS-4      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G32-AGE-PERIOD-5.
           MOVE PRM-AGE-PERIODS-5      TO R1G32-AGE-PERIOD-5E.
           MOVE PRM-AGE-PERIODS-5      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1G32-AGE-PERIOD-6.
           MOVE PRM-AGE-PERIODS-6      TO R1G32-AGE-PERIOD-6E.
           MOVE PRM-AGE-PERIODS-6      TO R1G32-AGE-PERIOD-7.

           MOVE PRM-AGE-PERIODS-1      TO R1T1-AGE-PERIOD-1E.
           MOVE PRM-AGE-PERIODS-1      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1T1-AGE-PERIOD-2.
           MOVE PRM-AGE-PERIODS-2      TO R1T1-AGE-PERIOD-2E.
           MOVE PRM-AGE-PERIODS-2      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1T1-AGE-PERIOD-3.
           MOVE PRM-AGE-PERIODS-3      TO R1T1-AGE-PERIOD-3E.
           MOVE PRM-AGE-PERIODS-3      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1T1-AGE-PERIOD-4.
           MOVE PRM-AGE-PERIODS-4      TO R1T1-AGE-PERIOD-4E.
           MOVE PRM-AGE-PERIODS-4      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1T1-AGE-PERIOD-5.
           MOVE PRM-AGE-PERIODS-5      TO R1T1-AGE-PERIOD-5E.
           MOVE PRM-AGE-PERIODS-5      TO ZR900WS-AGE-PERIOD.
           ADD 1                       TO ZR900WS-AGE-PERIOD.
           MOVE ZR900WS-AGE-PERIOD        TO R1T1-AGE-PERIOD-6.
           MOVE PRM-AGE-PERIODS-6      TO R1T1-AGE-PERIOD-6E.
           MOVE PRM-AGE-PERIODS-6      TO R1T1-AGE-PERIOD-7.

           IF (PRM-DETAIL-OPTION = "C")
               MOVE R1T1-AGE-PERIOD-1E      TO C1T1-AGE-PERIOD-1E
               MOVE R1T1-AGE-PERIOD-2       TO C1T1-AGE-PERIOD-2
               MOVE R1T1-AGE-PERIOD-2E      TO C1T1-AGE-PERIOD-2E
               MOVE R1T1-AGE-PERIOD-3       TO C1T1-AGE-PERIOD-3
               MOVE R1T1-AGE-PERIOD-3E      TO C1T1-AGE-PERIOD-3E
               MOVE R1T1-AGE-PERIOD-4       TO C1T1-AGE-PERIOD-4
               MOVE R1T1-AGE-PERIOD-4E      TO C1T1-AGE-PERIOD-4E
               MOVE R1T1-AGE-PERIOD-5       TO C1T1-AGE-PERIOD-5 
               MOVE R1T1-AGE-PERIOD-5E      TO C1T1-AGE-PERIOD-5E
               MOVE R1T1-AGE-PERIOD-6       TO C1T1-AGE-PERIOD-6
               MOVE R1T1-AGE-PERIOD-6E      TO C1T1-AGE-PERIOD-6E
               MOVE R1T1-AGE-PERIOD-7       TO C1T1-AGE-PERIOD-7.

           IF (PRM-DETAIL-OPTION       = "A")
               MOVE 301                TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               MOVE CRT-MESSAGE        TO ZR900WS-D1-LABEL
               MOVE 302                TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               MOVE CRT-MESSAGE        TO ZR900WS-D2-LABEL
               MOVE 303                TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               MOVE CRT-MESSAGE        TO ZR900WS-D3-LABEL.

           IF (PRM-DETAIL-OPTION       = "A")
               MOVE ZEROS                  TO DB-INDEX-NBR
               MOVE "ARIDX"                TO DB-OBJ-TYPE
               PERFORM
                   VARYING I1  FROM 1 BY 1
                   UNTIL  (I1  > 4)
                       MOVE I1             TO DB-INDEX-NBR
                       PERFORM 840-FIND-ARMSET1
                       IF (ARMAP-NOTFOUND)
                           MOVE SPACES        TO ZR900WS-MATRIX-CAT (I1)
                                                 ZR900WS-COL-HEAD   (I1)
                       ELSE
                           MOVE ARM-COL-HEADING TO ZR900WS-COL-HEAD (I1)
                           MOVE ARM-MATRIX-CAT TO DB-MATRIX-CAT
                                                ZR900WS-MATRIX-CAT (I1)
                           PERFORM 840-FIND-MOCSET1
                           MOVE MOC-REQUIRED   TO ZR900WS-REQUIRED (I1)
                           PERFORM 840-FIND-MXCSET1
                           MOVE MXC-ELEMENT-NAME   TO DB-ELEMENT-NAME
                           MOVE MXC-HAS-VALIDATION
                           TO ZR900WS-HAS-VALIDATION (I1)
                           PERFORM 840-FIND-MXESET1
                           MOVE MXE-DATA-TYPE  TO ZR900WS-DATA-TYPE (I1)
                           MOVE MXE-FIELD-SIZE TO ZR900WS-FIELD-SIZE(I1)
                       END-IF
               END-PERFORM.

           PERFORM 1020-DO-ARO-COMPANY
           THRU    1020-END
               UNTIL (ARWORK-NOTFOUND).

           MOVE T12-REPORT-MESSAGE     TO RPT-GROUP-REQUEST.
           PERFORM 700-PRINT-RPT-GRP.

           GO TO 1000-END.

      ******************************************************************
       1020-DO-ARO-COMPANY.
      ******************************************************************

           MOVE WF1-COMPANY            TO WS-ARO-COMPANY.

           PERFORM 
               VARYING I1 FROM 1 BY 1 
               UNTIL  (I1 > 7)
                   MOVE ZEROES         TO ZR900WS-REPORT-AMT (I1)
                                          ZR900WS-REPORT-PCT (I1)
           END-PERFORM.
           PERFORM 
               VARYING I1 FROM 1 BY 1 
               UNTIL  (I1 > 5)
                   MOVE ZEROES         TO ZR900WS-REP-AMT (I1)
                                          ZR900WS-REPORT-FOR (I1)
                                          ZR900WS-REP-FOR (I1)
                                          ZR900WS-PRINT-FOR (I1)
           END-PERFORM.

           MOVE ZEROS                  TO WS-TOTAL
                                          WS-SALE
                                          ZR900WS-NET-AMT.
           MOVE WF1-COMPANY            TO R1G1-ARO-COMPANY
                                          R1G1-COMPANY.

           MOVE ACO-NAME               TO R1G1-ACO-NAME.
           MOVE ACO-CURRENCY-CD        TO R1G1-ACO-CURRENCY-CD 
                                          WS-CURRENCY.

           PERFORM 1025-DO-SORT
           THRU    1025-END
               UNTIL (ARWORK-NOTFOUND)
               OR    (WF1-COMPANY  NOT = WS-ARO-COMPANY).

           IF (PRM-ACO-CURR-DISPLAY        = "T")
               GO TO 1020-END.

           IF  (PRM-PERIOD-OF           = "P")
J56704     AND (PRM-REPORT-OPTION       = "A" OR "C" OR "S" OR "B")
               MOVE 90                  TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               MOVE CRT-MESSAGE         TO R1T1-TOT-HEADER
                                           R1T1P-TOT-HEADER
               MOVE ".00"               TO R1T1-TOT-DSO
               MOVE ".00"               TO R1T1P-TOT-DSO
               IF  (WS-SALE             > ZEROES)
               AND (WS-TOTAL            > ZEROES)
                    COMPUTE WS-DSO ROUNDED = (WS-TOTAL / WS-SALE)
                                           * ZR900WS-PERIOD-DAYS
                    MOVE WS-DSO         TO WS-DSO-NBR
                    MOVE WS-DSO-CHAR    TO R1T1-TOT-DSO
                                           R1T1P-TOT-DSO 
               END-IF
           END-IF.

           IF (PRM-DETAIL-OPTION = "C")
               MOVE ZR900WS-REPORT-AMT (1)      TO C1T1-1-OPENAMT
               MOVE ZR900WS-REPORT-AMT (2)      TO C1T1-2-OPENAMT
               MOVE ZR900WS-REPORT-AMT (3)      TO C1T1-3-OPENAMT
               MOVE ZR900WS-REPORT-AMT (4)      TO C1T1-4-OPENAMT
               MOVE ZR900WS-REPORT-AMT (5)      TO C1T1-5-OPENAMT
               MOVE ZR900WS-REPORT-AMT (6)      TO C1T1-6-OPENAMT
               MOVE ZR900WS-REPORT-AMT (7)      TO C1T1-7-OPENAMT
               MOVE ZR900WS-NET-AMT             TO C1T1-NETAMT
           ELSE
               MOVE ZR900WS-REPORT-AMT (1)      TO R1T1-1-OPENAMT
               MOVE ZR900WS-REPORT-AMT (2)      TO R1T1-2-OPENAMT
               MOVE ZR900WS-REPORT-AMT (3)      TO R1T1-3-OPENAMT
               MOVE ZR900WS-REPORT-AMT (4)      TO R1T1-4-OPENAMT
               MOVE ZR900WS-REPORT-AMT (5)      TO R1T1-5-OPENAMT
               MOVE ZR900WS-REPORT-AMT (6)      TO R1T1-6-OPENAMT
               MOVE ZR900WS-REPORT-AMT (7)      TO R1T1-7-OPENAMT
               MOVE ZR900WS-NET-AMT             TO R1T1-NETAMT
           END-IF.

           MOVE ACO-BASE-ND             TO R1T1-1-OPENAMT-ND
                                           R1T1-2-OPENAMT-ND
                                           R1T1-3-OPENAMT-ND
                                           R1T1-4-OPENAMT-ND
                                           R1T1-5-OPENAMT-ND
                                           R1T1-6-OPENAMT-ND
                                           R1T1-7-OPENAMT-ND
                                           R1T1-NETAMT-ND
                                           C1T1-1-OPENAMT-ND
                                           C1T1-2-OPENAMT-ND
                                           C1T1-3-OPENAMT-ND
                                           C1T1-4-OPENAMT-ND
                                           C1T1-5-OPENAMT-ND
                                           C1T1-6-OPENAMT-ND
                                           C1T1-7-OPENAMT-ND
                                           C1T1-NETAMT-ND.

           IF (PRM-CSV-FILE-OPT = "Y")
               MOVE ZR900WS-PRM-COMPANY       TO CS1-COMPANY
               MOVE SPACES                    TO CS1-CUSTOMER
               MOVE 403                       TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               MOVE CRT-MESSAGE               TO CS1-CUST-NAME
               MOVE ZR900WS-REPORT-AMT (1)    TO CS1-FUTURE    
               MOVE ZR900WS-REPORT-AMT (2)    TO CS1-CURRENT   
               MOVE ZR900WS-REPORT-AMT (3)    TO CS1-AGE1
               MOVE ZR900WS-REPORT-AMT (4)    TO CS1-AGE2      
               MOVE ZR900WS-REPORT-AMT (5)    TO CS1-AGE3      
               MOVE ZR900WS-REPORT-AMT (6)    TO CS1-AGE4       
               MOVE ZR900WS-REPORT-AMT (7)    TO CS1-AGE5       
               MOVE ZR900WS-REPORT-AMT (8)    TO CS1-AGE6       
               MOVE ZR900WS-REPORT-AMT (9)    TO CS1-OVER6     

               COMPUTE CS1-TOTAL     = ZR900WS-REPORT-AMT (1)
                                     + ZR900WS-REPORT-AMT (2)       
                                     + ZR900WS-REPORT-AMT (3)    
                                     + ZR900WS-REPORT-AMT (4)    
                                     + ZR900WS-REPORT-AMT (5)      
                                     + ZR900WS-REPORT-AMT (6)       
                                     + ZR900WS-REPORT-AMT (7)     
                                     + ZR900WS-REPORT-AMT (8)     
                                     + ZR900WS-REPORT-AMT (9)     
               PERFORM 800-WRITECSV-CUSTDET
           END-IF.

           IF (ZR900WS-DO-BASE-BROADCAST =  "Y")
               MOVE R1GN1-ARO-COMPANY  TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (PRM-DETAIL-OPTION = "C")
               MOVE C1TN1-REPORT-TOTAL      TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP
           ELSE
               MOVE R1TN1-REPORT-TOTAL      TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP
           END-IF.

           MOVE ZEROES                  TO AROPWS-OPEN-AMT.
           PERFORM 
               VARYING I1 FROM 1 BY 1 
               UNTIL  (I1 > 7)
                 ADD ZR900WS-REPORT-AMT (I1)     TO AROPWS-OPEN-AMT
           END-PERFORM.

           IF (AROPWS-OPEN-AMT        NOT = ZEROES)
               PERFORM 
                   VARYING I1 FROM 1 BY 1
                   UNTIL  (I1 > 7)
                       COMPUTE ZR900WS-REPORT-PCT (I1) ROUNDED = 
                                                (ZR900WS-REPORT-AMT (I1)
                                               / AROPWS-OPEN-AMT)
                                               * 100
               END-PERFORM
           ELSE
               PERFORM 
                   VARYING I1 FROM 1 BY 1 
                   UNTIL  (I1 > 7)
                       MOVE ZEROES     TO ZR900WS-REPORT-PCT (I1)
               END-PERFORM.


           MOVE ZR900WS-REPORT-PCT (1)     TO R1T1-1-PERCENT.
           MOVE ZR900WS-REPORT-PCT (2)     TO R1T1-2-PERCENT.
           MOVE ZR900WS-REPORT-PCT (3)     TO R1T1-3-PERCENT.
           MOVE ZR900WS-REPORT-PCT (4)     TO R1T1-4-PERCENT.
           MOVE ZR900WS-REPORT-PCT (5)     TO R1T1-5-PERCENT.
           MOVE ZR900WS-REPORT-PCT (6)     TO R1T1-6-PERCENT.
           MOVE ZR900WS-REPORT-PCT (7)     TO R1T1-7-PERCENT.

           IF  (PRM-ACO-AGE-TYPE           = "D")
           AND (PRM-DETAIL-OPTION      = "Y" OR "A")
               MOVE ZR900WS-REPORT-PCT (1)  TO R1T1P-1-PERCENT
               MOVE ZR900WS-REPORT-PCT (2)  TO R1T1P-2-PERCENT
               MOVE ZR900WS-REPORT-PCT (3)  TO R1T1P-3-PERCENT
               MOVE ZR900WS-REPORT-PCT (4)  TO R1T1P-4-PERCENT
               MOVE ZR900WS-REPORT-PCT (5)  TO R1T1P-5-PERCENT
               MOVE ZR900WS-REPORT-PCT (6)  TO R1T1P-6-PERCENT
               MOVE ZR900WS-REPORT-PCT (7)  TO R1T1P-7-PERCENT.

           MOVE ZEROES                 TO WS-TOTAL-AMT.
           MOVE ZEROES                 TO WS-TOTAL-FOR.
           PERFORM 
               VARYING I1 FROM 1 BY 1 
               UNTIL  (I1 > 5)
                   ADD ZR900WS-REP-AMT (I1) TO WS-TOTAL-AMT
                   ADD ZR900WS-REP-FOR (I1) TO WS-TOTAL-FOR
                   IF (ZR900WS-REP-AMT (I1) NOT = ZEROES)
                       COMPUTE ZR900WS-PRINT-FOR (I1) ROUNDED 
                                               = ZR900WS-REP-FOR (I1)
                                               / ZR900WS-REP-AMT (I1)
                   END-IF
           END-PERFORM.

           MOVE ZR900WS-PRINT-FOR (1)  TO R1T1-1-FOR-AVG.
           MOVE ZR900WS-PRINT-FOR (2)  TO R1T1-2-FOR-AVG.
           MOVE ZR900WS-PRINT-FOR (3)  TO R1T1-3-FOR-AVG.
           MOVE ZR900WS-PRINT-FOR (4)  TO R1T1-4-FOR-AVG.
           MOVE ZR900WS-PRINT-FOR (5)  TO R1T1-5-FOR-AVG.

           MOVE ZEROES                 TO ZR900WS-FOR-AVG.
           IF (WS-TOTAL-AMT            NOT = ZEROES)
               COMPUTE ZR900WS-FOR-AVG ROUNDED = WS-TOTAL-FOR 
                                               / WS-TOTAL-AMT.

           MOVE ZR900WS-FOR-AVG        TO R1T1-FOR-AVG.
           MOVE ZR900WS-FOR-AVG        TO R1T1P-FOR-AVG.

           IF  (PRM-ACO-AGE-TYPE           = "T")
           AND (PRM-DETAIL-OPTION      = "Y" OR "A")
               MOVE R1TN1-TOTAL-FOR    TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF  (PRM-ACO-AGE-TYPE           = "D")
           AND (PRM-DETAIL-OPTION      = "Y" OR "A")
               MOVE R1TN1-TOTAL-FOR-P  TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (PRM-CSV-FILE-OPT = "Y")
091502     AND (PRM-COMPANY NOT = ZEROS)
               PERFORM 800-CLOSECSV-CUSTDET.

       1020-END.

      ******************************************************************
       1025-DO-SORT.
      ******************************************************************

           IF (PRM-REPORT-OPTION         = "A")
               MOVE ZR900WS-PRM-COMPANY  TO DB-COMPANY
               MOVE WF1-SORT-FIELD       TO DB-CREDIT-ANLYST
               PERFORM 840-FIND-CANSET1
               MOVE WF1-SORT-FIELD       TO R1G3-CREDIT-ANLYST
               MOVE CAN-NAME             TO R1G3-CAN-NAME
               MOVE CAN-NAME             TO ZR900WS-CSV-TOT-NAME.

      *** Begin Tag for channels (Credit Analyst)
           IF  (PRM-REPORT-OPTION          = "A")
               MOVE 710                        TO ZR900WS-ELEMENT-TYPE 
               MOVE CAN-NAME                   TO ZR900WS-ELEMENT-VALUE
               PERFORM 610-BEG-ELEMENT-TAG 
           END-IF.

           IF (PRM-REPORT-OPTION         = "S")
               MOVE ZR900WS-PRM-COMPANY  TO DB-COMPANY
               MOVE WF1-SORT-FIELD       TO ZR900WS-ALPHA-S
               MOVE ZR900WS-SALESMAN     TO DB-SALESMAN
               PERFORM 840-FIND-SAWSET1
               MOVE ZR900WS-SALESMAN     TO R1G3-SALESMAN
               MOVE SAW-NAME             TO R1G3-SAW-NAME
               MOVE SAW-NAME             TO ZR900WS-CSV-TOT-NAME

      *** Begin Tag for channels (Sales Rep)
               MOVE 711                        TO ZR900WS-ELEMENT-TYPE 
               MOVE SAW-NAME                   TO ZR900WS-ELEMENT-VALUE
               PERFORM 610-BEG-ELEMENT-TAG 
           END-IF.

           IF (PRM-REPORT-OPTION         = "P")
               MOVE ZR900WS-PRM-COMPANY  TO DB-COMPANY
               MOVE WF1-SORT-FIELD       TO DB-PROCESS-LEVEL
               PERFORM 840-FIND-APVSET1
               MOVE WF1-SORT-FIELD       TO R1G3-PROCESS-LEVEL
               MOVE APV-NAME             TO R1G3-APV-NAME
               MOVE APV-NAME             TO ZR900WS-CSV-TOT-NAME

      *** Begin Tag for channels (Process Level)
               MOVE 575                        TO ZR900WS-ELEMENT-TYPE 
               MOVE APV-NAME                   TO ZR900WS-ELEMENT-VALUE
               PERFORM 610-BEG-ELEMENT-TAG 
           END-IF.

           IF (PRM-REPORT-OPTION         = "M")
               MOVE 436                  TO CRT-MSG-NBR
               MOVE "ARMSG"              TO CRT-ERROR-CAT
               PERFORM 790-GET-MSG
               MOVE CRT-MESSAGE          TO R3T1-TOT-HEADER
               MOVE WF1-SORT-FIELD       TO R3T1-TOT-TYPE
               MOVE WF1-SORT-FIELD       TO R1G3-ACTIVITY
               MOVE CRT-MESSAGE          TO C3T1-TOT-HEADER
               MOVE WF1-SORT-FIELD       TO C3T1-TOT-TYPE
               MOVE ACACWS-ACV-DESCRIPTION TO R1G3-DESCRIPTION
               MOVE ZR900WS-PRM-COMPANY   TO ACACWS-COMPANY
               MOVE "4"                   TO ACACWS-EDIT-CODE
               MOVE "N"                   TO ACACWS-CURRENCY-OR
               MOVE "N"                   TO ACACWS-RESOURCE-OR
               MOVE "N"                   TO ACACWS-BUDGET-OR
               MOVE "N"                   TO ACACWS-GL-OR
               MOVE "Y"                   TO ACACWS-BILLABLE-OR
               MOVE WF1-SORT-FIELD        TO ACACWS-ACTIVITY
               INITIALIZE ACACWS-ACCT-CATEGORY
               PERFORM 640-EDIT-ACTIVITY-70
               IF (ERROR-FOUND)
                   INITIALIZE R1G3-DESCRIPTION
               ELSE 
                   MOVE ACACWS-ACV-DESCRIPTION TO R1G3-DESCRIPTION
               END-IF

      *** Begin Tag for channels (Activity)
               MOVE 601                        TO ZR900WS-ELEMENT-TYPE 
               MOVE ACACWS-ACV-DESCRIPTION     TO ZR900WS-ELEMENT-VALUE
               PERFORM 610-BEG-ELEMENT-TAG 
           END-IF.

      * Currently there will be no bursting/broadcasting for Activity Lists.
      *    IF (PRM-REPORT-OPTION         = "L")
      *** Begin Tag for channels (Activity List Attributes)
      *        MOVE 620                        TO ZR900WS-ELEMENT-TYPE 
      *        MOVE WF1-ATTRIBUTE-KEY          TO ZR900WS-ELEMENT-VALUE
      *        PERFORM 610-BEG-ELEMENT-TAG 
      *    END-IF.

           MOVE R1GN1-ARO-COMPANY        TO RPT-GROUP-REQUEST.
           PERFORM 700-PRINT-RPT-GRP.

           IF (PRM-CSV-FILE-OPT = "Y")
091502     AND (PRM-COMPANY NOT = ZEROS) 
               PERFORM 800-OPENOUTPUTCSV-CUSTDET
               PERFORM 800-ALLUSEDCSV-CUSTDET.

           IF  (PRM-ACTIVITY              NOT = SPACES)
               MOVE PRM-ACTIVITY         TO R1G3-ACTIVITY
               MOVE ACACWS-ACV-DESCRIPTION TO R1G3-DESCRIPTION
               IF (PRM-REPORT-OPTION NOT = "M")
                   MOVE R1GN3-ACTIVITY       TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP
               END-IF
           END-IF.

           MOVE WF1-SORT-FIELD           TO ZR900WS-SORT-FIELD.

           IF (PRM-REPORT-OPTION         = "A")
               MOVE R1GN3-CREDIT-ANLYST  TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (PRM-REPORT-OPTION         = "S")
               MOVE R1GN3-SALESMAN       TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (PRM-REPORT-OPTION         = "P")
               MOVE R1GN3-PROCESS-LEVEL  TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF  (PRM-DETAIL-OPTION = "C")
           AND (PRM-ACO-CURR-DISPLAY  = "B")
               MOVE R1GN32H-CONDENSED  TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (PRM-ACO-CURR-DISPLAY          = "B")
               IF (PRM-DETAIL-OPTION         = "C")
                   IF (PRM-REPORT-OPTION     = "A")
                       MOVE 268              TO CRT-MSG-NBR
                       MOVE WF1-SORT-FIELD   TO ZR900WS-CA-VAR
                       MOVE WF1-SORT-FIELD   TO C3T1-TOT-TYPE
                   END-IF
                   IF (PRM-REPORT-OPTION     = "S")
                       MOVE 264              TO CRT-MSG-NBR
                       MOVE WF1-SORT-FIELD   TO ZR900WS-SR-VAR
                       MOVE WF1-SORT-FIELD   TO C3T1-TOT-TYPE
                       INSPECT C3T1-TOT-TYPE 
                                 REPLACING LEADING ZEROS BY SPACES
                   END-IF
                   IF (PRM-REPORT-OPTION     = "P")
                       MOVE 120              TO CRT-MSG-NBR
                      MOVE WF1-SORT-FIELD   TO ZR900WS-PL-VAR
                      MOVE WF1-SORT-FIELD   TO C3T1-TOT-TYPE
                   END-IF
                   IF (PRM-REPORT-OPTION     = "A" OR "S" OR "P")
                       MOVE "ARMSG"          TO CRT-ERROR-CAT
                       PERFORM 790-GET-MSG
                       MOVE CRT-MESSAGE      TO C3T1-TOT-HEADER
                   END-IF 
               ELSE
                   IF (PRM-REPORT-OPTION     = "A")
                       MOVE 268              TO CRT-MSG-NBR
                       MOVE WF1-SORT-FIELD   TO ZR900WS-CA-VAR
                       MOVE WF1-SORT-FIELD   TO R3T1-TOT-TYPE
                   END-IF
                   IF (PRM-REPORT-OPTION     = "S")
                       MOVE 264              TO CRT-MSG-NBR
                       MOVE WF1-SORT-FIELD   TO ZR900WS-SR-VAR
                       MOVE WF1-SORT-FIELD   TO R3T1-TOT-TYPE
                       INSPECT R3T1-TOT-TYPE 
                                 REPLACING LEADING ZEROS BY SPACES
                   END-IF
                   IF (PRM-REPORT-OPTION     = "P")
                       MOVE 120              TO CRT-MSG-NBR
                      MOVE WF1-SORT-FIELD   TO ZR900WS-PL-VAR
                      MOVE WF1-SORT-FIELD   TO R3T1-TOT-TYPE
                   END-IF
                   IF (PRM-REPORT-OPTION     = "A" OR "S" OR "P")
                       MOVE "ARMSG"          TO CRT-ERROR-CAT
                       PERFORM 790-GET-MSG
                       MOVE CRT-MESSAGE      TO R3T1-TOT-HEADER.

           IF (PRM-REPORT-OPTION         = "M")
               MOVE R1GN3-ACTIVITY       TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (PRM-REPORT-OPTION         = "L")
               MOVE "ACTVY"               TO ACMKWS-OBJ-TYPE    
               MOVE PRM-ACTIVITY-LIST     TO ACMKWS-MATRIX-LIST
               MOVE WF1-SORT-FIELD        TO ACMKWS-KEY
               PERFORM 635-FORMAT-MATRIX-KEY

               PERFORM 1026-BUILD-ATTR-STRING
               THRU    1026-END 
           END-IF.

           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 7)
                   MOVE ZEROES         TO ZR900WS-SORT-AMT (I1)
                                          ZR900WS-SORT-PCT (I1)
           END-PERFORM.

           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 5)
                   MOVE ZEROES         TO ZR900WS-SRT-AMT (I1)
                                          ZR900WS-SRT-FOR (I1)
           END-PERFORM.

           IF (PRM-ACO-CURR-DISPLAY        = "T")
               PERFORM 1030-DO-CURRENCY-CODE
               THRU    1030-END
                   UNTIL (ARWORK-NOTFOUND)
                   OR    (WF1-COMPANY       NOT = WS-ARO-COMPANY)
                   OR    (WF1-SORT-FIELD    NOT = ZR900WS-SORT-FIELD)
           ELSE
               PERFORM 1040-DO-ARO-CUSTOMER
               THRU    1040-END
                   UNTIL (ARWORK-NOTFOUND)
                   OR    (WF1-COMPANY       NOT = WS-ARO-COMPANY)
                   OR    (WF1-SORT-FIELD    NOT = ZR900WS-SORT-FIELD).

           IF (PRM-ACO-CURR-DISPLAY             NOT = "B")
               GO TO 1025-END.

J56704     IF (PRM-REPORT-OPTION            = "C" OR "B")
               GO TO 1025-CONT.

           MOVE ACO-BASE-ND                 TO R3T1-NETAMT-ND
                                               R3T1-1-OPENAMT-ND
                                               R3T1-2-OPENAMT-ND
                                               R3T1-3-OPENAMT-ND
                                               R3T1-4-OPENAMT-ND
                                               R3T1-5-OPENAMT-ND
                                               R3T1-6-OPENAMT-ND
                                               R3T1-7-OPENAMT-ND.

           MOVE ACO-BASE-ND                 TO C3T1-NETAMT-ND
                                               C3T1-1-OPENAMT-ND
                                               C3T1-2-OPENAMT-ND
                                               C3T1-3-OPENAMT-ND
                                               C3T1-4-OPENAMT-ND
                                               C3T1-5-OPENAMT-ND
                                               C3T1-6-OPENAMT-ND
                                               C3T1-7-OPENAMT-ND.

           IF (PRM-DETAIL-OPTION = "C")
               MOVE ZR900WS-SORT-AMT (1)    TO C3T1-1-OPENAMT
               MOVE ZR900WS-SORT-AMT (2)    TO C3T1-2-OPENAMT
               MOVE ZR900WS-SORT-AMT (3)    TO C3T1-3-OPENAMT
               MOVE ZR900WS-SORT-AMT (4)    TO C3T1-4-OPENAMT
               MOVE ZR900WS-SORT-AMT (5)    TO C3T1-5-OPENAMT
               MOVE ZR900WS-SORT-AMT (6)    TO C3T1-6-OPENAMT
               MOVE ZR900WS-SORT-AMT (7)    TO C3T1-7-OPENAMT
               COMPUTE C3T1-NETAMT ROUNDED = ZR900WS-SORT-AMT (1)
                                           + ZR900WS-SORT-AMT (2)
                                           + ZR900WS-SORT-AMT (3)
                                           + ZR900WS-SORT-AMT (4)
                                           + ZR900WS-SORT-AMT (5)
                                           + ZR900WS-SORT-AMT (6)
                                           + ZR900WS-SORT-AMT (7)
               MOVE C3TN1-PROCESS-LEVEL    TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP
           ELSE
               MOVE ZR900WS-SORT-AMT (1)    TO R3T1-1-OPENAMT
               MOVE ZR900WS-SORT-AMT (2)    TO R3T1-2-OPENAMT
               MOVE ZR900WS-SORT-AMT (3)    TO R3T1-3-OPENAMT
               MOVE ZR900WS-SORT-AMT (4)    TO R3T1-4-OPENAMT
               MOVE ZR900WS-SORT-AMT (5)    TO R3T1-5-OPENAMT
               MOVE ZR900WS-SORT-AMT (6)    TO R3T1-6-OPENAMT
               MOVE ZR900WS-SORT-AMT (7)    TO R3T1-7-OPENAMT
               COMPUTE R3T1-NETAMT ROUNDED = ZR900WS-SORT-AMT (1)
                                           + ZR900WS-SORT-AMT (2)
                                           + ZR900WS-SORT-AMT (3)
                                           + ZR900WS-SORT-AMT (4)
                                           + ZR900WS-SORT-AMT (5)
                                           + ZR900WS-SORT-AMT (6)
                                           + ZR900WS-SORT-AMT (7)
               MOVE R3TN1-PROCESS-LEVEL    TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP
           END-IF.


       1025-CONT.

           IF  (PRM-CSV-FILE-OPT = "Y")
J56704     AND (PRM-REPORT-OPTION               NOT = "C" AND "B")
               IF (PRM-REPORT-OPTION = "A")
                   MOVE R1G3-CREDIT-ANLYST      TO ZR900WS-CA-VAR
                   MOVE ZR900WS-CA-SORT         TO CS1-CUSTOMER
               END-IF
               IF (PRM-REPORT-OPTION = "S")
                   MOVE R1G3-SALESMAN           TO ZR900WS-SR-VAR
                   MOVE ZR900WS-SR-SORT         TO CS1-CUSTOMER
               END-IF
               IF (PRM-REPORT-OPTION = "P")
                   MOVE R1G3-PROCESS-LEVEL      TO ZR900WS-PL-VAR
                   MOVE ZR900WS-PL-SORT         TO CS1-CUSTOMER
               END-IF
               MOVE ZR900WS-CSV-TOT-NAME        TO CS1-CUST-NAME
               MOVE ZR900WS-SORT-AMT (1)        TO CS1-FUTURE
               MOVE ZR900WS-SORT-AMT (2)        TO CS1-CURRENT
               MOVE ZR900WS-SORT-AMT (3)        TO CS1-AGE1
               MOVE ZR900WS-SORT-AMT (4)        TO CS1-AGE2
               MOVE ZR900WS-SORT-AMT (5)        TO CS1-AGE3
               MOVE ZR900WS-SORT-AMT (6)        TO CS1-AGE4
               MOVE ZR900WS-SORT-AMT (7)        TO CS1-AGE5
               MOVE ZR900WS-SORT-AMT (8)        TO CS1-AGE6
               MOVE ZR900WS-SORT-AMT (9)        TO CS1-OVER6
               COMPUTE CS1-TOTAL = ZR900WS-SORT-AMT (1)
                                 + ZR900WS-SORT-AMT (2)
                                 + ZR900WS-SORT-AMT (3)
                                 + ZR900WS-SORT-AMT (4)
                                 + ZR900WS-SORT-AMT (5)
                                 + ZR900WS-SORT-AMT (6)
                                 + ZR900WS-SORT-AMT (7)
                                 + ZR900WS-SORT-AMT (8)
                                 + ZR900WS-SORT-AMT (9)
               PERFORM 800-WRITECSV-CUSTDET
           END-IF.

      *** End Tag for channels (Credit Analyst)
           IF  (PRM-REPORT-OPTION          = "A")
               MOVE 710                        TO ZR900WS-ELEMENT-TYPE 
               MOVE CAN-NAME                   TO ZR900WS-ELEMENT-VALUE
               PERFORM 615-END-ELEMENT-TAG 
           END-IF.    

      *** End Tag for channels (Sales Reps)
           IF  (PRM-REPORT-OPTION          = "S")
               MOVE 711                        TO ZR900WS-ELEMENT-TYPE 
               MOVE SAW-NAME                   TO ZR900WS-ELEMENT-VALUE
               PERFORM 615-END-ELEMENT-TAG 
           END-IF.    

      *** End Tag for channels (Process Level)
           IF  (PRM-REPORT-OPTION          = "P")
               MOVE 575                        TO ZR900WS-ELEMENT-TYPE 
               MOVE APV-NAME                   TO ZR900WS-ELEMENT-VALUE
               PERFORM 615-END-ELEMENT-TAG 
           END-IF.    

      *** End Tag for channels (Activity)
           IF  (PRM-REPORT-OPTION          = "M")
               MOVE 601                        TO ZR900WS-ELEMENT-TYPE 
               MOVE ACACWS-ACV-DESCRIPTION     TO ZR900WS-ELEMENT-VALUE
               PERFORM 615-END-ELEMENT-TAG 
           END-IF.    

      *** End Tag for channels (Activity List Attributes)
      *    IF  (PRM-REPORT-OPTION          = "L")
      *        MOVE 620                        TO ZR900WS-ELEMENT-TYPE 
      *        MOVE ZR900WS-ATTRIBUTE-KEY      TO ZR900WS-ELEMENT-VALUE
      *        PERFORM 615-END-ELEMENT-TAG 
      *    END-IF.    

       1025-END.

      ******************************************************************
       1026-BUILD-ATTR-STRING.
      ******************************************************************

           INITIALIZE ZR900WS-TOTAL-LENGTH
                      ZR900WS-STR-LENGTH
                      ZR900WS-STRING-LST
                      ZR900WS-TEMP-STRING
                      ZR900WS-TEMP-STRING2.

           MOVE 1                       TO I3.

           PERFORM 
               VARYING I2 FROM 1 BY 1
               UNTIL  (I2 > 8)
               OR     (ACMKWS-LABEL (I2) = SPACES)
                 INITIALIZE                ZR900WS-TEMP-STRING
                 MOVE 1                 TO ZR900WS-TMP-STR-LENGTH
                 STRING ACMKWS-LABEL (I2)  DELIMITED BY "  "
                        " "               DELIMITED BY SIZE
                        ACMKWS-VALUE (I2)  DELIMITED BY "  "
                        INTO ZR900WS-TEMP-STRING
                        WITH POINTER ZR900WS-TMP-STR-LENGTH

                 COMPUTE ZR900WS-TOTAL-LENGTH 
                                            = ZR900WS-STR-LENGTH 
                                            + ZR900WS-TMP-STR-LENGTH 
                                            + 2
      * Above accounts for hyphen and space prepended as well as taking out
      * the one extra count that ends up in the pointer
                 IF (ZR900WS-TOTAL-LENGTH > 131) 
                     MOVE R1GN3-SPACE      TO RPT-GROUP-REQUEST
                     PERFORM 700-PRINT-RPT-GRP

                     MOVE ZR900WS-STR-LST (I3) TO R1G3-ATTRIBUTE-STRING
                     MOVE R1GN3-ATTRIBUTES  TO RPT-GROUP-REQUEST
                     PERFORM 700-PRINT-RPT-GRP
                     ADD 1 TO I3
                     INITIALIZE ZR900WS-STR-LENGTH
                                R1G3-ATTRIBUTE-STRING
                 END-IF
 
                 MOVE 1                 TO ZR900WS-TMP-STR-LENGTH
                 IF (ZR900WS-STR-LST (I3) = SPACES)
                     STRING ZR900WS-TEMP-STRING DELIMITED BY "  "
                            INTO ZR900WS-STR-LST (I3)
                            WITH POINTER ZR900WS-TMP-STR-LENGTH
                 ELSE
                     MOVE ZR900WS-STR-LST (I3) TO ZR900WS-TEMP-STRING2
   
                     STRING ZR900WS-TEMP-STRING2 DELIMITED BY "  "
                            ", " DELIMITED BY SIZE
                            ZR900WS-TEMP-STRING DELIMITED BY "  "
                            INTO ZR900WS-STR-LST (I3)
                            WITH POINTER ZR900WS-TMP-STR-LENGTH
                 END-IF
                         
                 COMPUTE ZR900WS-STR-LENGTH = ZR900WS-TMP-STR-LENGTH
                                            - 1
                              
           END-PERFORM.
          
           IF (ZR900WS-STR-LST (I3)  NOT = SPACES)
               MOVE R1GN3-SPACE            TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP

               MOVE ZR900WS-STR-LST (I3)   TO R1G3-ATTRIBUTE-STRING
               MOVE R1GN3-ATTRIBUTES       TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP
           END-IF.
       1026-END.

      ******************************************************************
       1030-DO-CURRENCY-CODE.
      ******************************************************************

           MOVE WF1-ORIG-CURRENCY      TO R1G2-CURR-CODE.
           MOVE R1GN2-CURR-CODE        TO RPT-GROUP-REQUEST.
           PERFORM 700-PRINT-RPT-GRP.

           IF (PRM-DETAIL-OPTION = "C")
               MOVE R1GN32H-CONDENSED  TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           MOVE WF1-ORIG-ND            TO ZR900WS-ORIG-ND.

           IF (PRM-ACO-CURR-DISPLAY        = "T")
               MOVE ZEROES             TO ZR900WS-NET-AMT

           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 7)
                   MOVE ZEROES         TO ZR900WS-REPORT-AMT (I1)
                                          ZR900WS-REPORT-PCT (I1)
           END-PERFORM.
           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 5)
                   MOVE ZEROES         TO ZR900WS-REP-AMT (I1)
                                          ZR900WS-REPORT-FOR (I1)
                                          ZR900WS-REP-FOR (I1)
                                          ZR900WS-PRINT-FOR (I1)
           END-PERFORM.

           MOVE WF1-ORIG-CURRENCY      TO WS-CURRENCY.
           PERFORM 1040-DO-ARO-CUSTOMER
           THRU    1040-END
               UNTIL (ARWORK-NOTFOUND)
               OR    (WF1-COMPANY       NOT = WS-ARO-COMPANY)
               OR    (WF1-SORT-FIELD    NOT = ZR900WS-SORT-FIELD)
               OR    (WF1-ORIG-CURRENCY NOT = WS-CURRENCY).

           MOVE ZR900WS-ORIG-ND        TO R1T21-1-OPENAMT-ND
                                          R1T21-2-OPENAMT-ND
                                          R1T21-3-OPENAMT-ND
                                          R1T21-4-OPENAMT-ND
                                          R1T21-5-OPENAMT-ND
                                          R1T21-6-OPENAMT-ND
                                          R1T21-7-OPENAMT-ND
                                          R1T21-NETAMT-ND
                                          C1T21-1-OPENAMT-ND
                                          C1T21-2-OPENAMT-ND
                                          C1T21-3-OPENAMT-ND
                                          C1T21-4-OPENAMT-ND
                                          C1T21-5-OPENAMT-ND
                                          C1T21-6-OPENAMT-ND
                                          C1T21-7-OPENAMT-ND
                                          C1T21-NETAMT-ND.

           IF (PRM-DETAIL-OPTION = "C")
               MOVE ZR900WS-REPORT-AMT (1) TO C1T21-1-OPENAMT
               MOVE ZR900WS-REPORT-AMT (2) TO C1T21-2-OPENAMT
               MOVE ZR900WS-REPORT-AMT (3) TO C1T21-3-OPENAMT
               MOVE ZR900WS-REPORT-AMT (4) TO C1T21-4-OPENAMT
               MOVE ZR900WS-REPORT-AMT (5) TO C1T21-5-OPENAMT
               MOVE ZR900WS-REPORT-AMT (6) TO C1T21-6-OPENAMT
               MOVE ZR900WS-REPORT-AMT (7) TO C1T21-7-OPENAMT
               MOVE ZR900WS-NET-AMT        TO C1T21-NETAMT
           ELSE
               MOVE ZR900WS-REPORT-AMT (1) TO R1T21-1-OPENAMT
               MOVE ZR900WS-REPORT-AMT (2) TO R1T21-2-OPENAMT
               MOVE ZR900WS-REPORT-AMT (3) TO R1T21-3-OPENAMT
               MOVE ZR900WS-REPORT-AMT (4) TO R1T21-4-OPENAMT
               MOVE ZR900WS-REPORT-AMT (5) TO R1T21-5-OPENAMT
               MOVE ZR900WS-REPORT-AMT (6) TO R1T21-6-OPENAMT
               MOVE ZR900WS-REPORT-AMT (7) TO R1T21-7-OPENAMT
               MOVE ZR900WS-NET-AMT        TO R1T21-NETAMT
           END-IF.

           MOVE ZEROES                 TO AROPWS-OPEN-AMT.
           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 7)
                 ADD ZR900WS-REPORT-AMT (I1)     TO AROPWS-OPEN-AMT
           END-PERFORM.

           IF (AROPWS-OPEN-AMT        NOT = ZEROES)
               PERFORM 
                   VARYING I1 FROM 1 BY 1
                   UNTIL  (I1 > 7)
                       COMPUTE ZR900WS-REPORT-PCT (I1) ROUNDED = 
                                                (ZR900WS-REPORT-AMT (I1)
                                               / AROPWS-OPEN-AMT)
                                               * 100
               END-PERFORM
           ELSE
               PERFORM 
                   VARYING I1 FROM 1 BY 1
                   UNTIL  (I1 > 7)
                       MOVE ZEROES     TO ZR900WS-REPORT-PCT (I1)
               END-PERFORM.

           IF (PRM-DETAIL-OPTION = "C")
               MOVE ZR900WS-REPORT-PCT (1)     TO C1T21-1-PERCENT
               MOVE ZR900WS-REPORT-PCT (2)     TO C1T21-2-PERCENT
               MOVE ZR900WS-REPORT-PCT (3)     TO C1T21-3-PERCENT
               MOVE ZR900WS-REPORT-PCT (4)     TO C1T21-4-PERCENT
               MOVE ZR900WS-REPORT-PCT (5)     TO C1T21-5-PERCENT
               MOVE ZR900WS-REPORT-PCT (6)     TO C1T21-6-PERCENT
               MOVE ZR900WS-REPORT-PCT (7)     TO C1T21-7-PERCENT
           ELSE
               MOVE ZR900WS-REPORT-PCT (1)     TO R1T21-1-PERCENT
               MOVE ZR900WS-REPORT-PCT (2)     TO R1T21-2-PERCENT
               MOVE ZR900WS-REPORT-PCT (3)     TO R1T21-3-PERCENT
               MOVE ZR900WS-REPORT-PCT (4)     TO R1T21-4-PERCENT
               MOVE ZR900WS-REPORT-PCT (5)     TO R1T21-5-PERCENT
               MOVE ZR900WS-REPORT-PCT (6)     TO R1T21-6-PERCENT
               MOVE ZR900WS-REPORT-PCT (7)     TO R1T21-7-PERCENT
           END-IF.

           MOVE R1GN31H-PARTIAL        TO RPT-GROUP-REQUEST.
           PERFORM 700-PRINT-RPT-GRP.
           IF (PRM-DETAIL-OPTION = "C")
               MOVE C1TN21-ARO-COMPANY     TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP
           ELSE
               MOVE R1TN21-ARO-COMPANY     TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP
           END-IF.

           IF (PRM-CSV-FILE-OPT = "Y")
               MOVE ZR900WS-PRM-COMPANY       TO CS1-COMPANY
               MOVE R1G2-CURR-CODE            TO ZR900WS-CR-VAR
               MOVE ZR900WS-CR-SORT           TO CS1-CUSTOMER
               MOVE R1G2-CURR-CODE            TO DB-CURRENCY-CODE
               PERFORM 840-FIND-CUCSET1
               MOVE CUC-DESCRIPTION           TO CS1-CUST-NAME
               MOVE ZR900WS-REPORT-AMT (1)    TO CS1-FUTURE    
               MOVE ZR900WS-REPORT-AMT (2)    TO CS1-CURRENT   
               MOVE ZR900WS-REPORT-AMT (3)    TO CS1-AGE1
               MOVE ZR900WS-REPORT-AMT (4)    TO CS1-AGE2      
               MOVE ZR900WS-REPORT-AMT (5)    TO CS1-AGE3      
               MOVE ZR900WS-REPORT-AMT (6)    TO CS1-AGE4       
               MOVE ZR900WS-REPORT-AMT (7)    TO CS1-AGE5       
               MOVE ZR900WS-REPORT-AMT (8)    TO CS1-AGE6       
               MOVE ZR900WS-REPORT-AMT (9)    TO CS1-OVER6     

               COMPUTE CS1-TOTAL     = ZR900WS-REPORT-AMT (1)
                                     + ZR900WS-REPORT-AMT (2)       
                                     + ZR900WS-REPORT-AMT (3)    
                                     + ZR900WS-REPORT-AMT (4)    
                                     + ZR900WS-REPORT-AMT (5)      
                                     + ZR900WS-REPORT-AMT (6)       
                                     + ZR900WS-REPORT-AMT (7)     
                                     + ZR900WS-REPORT-AMT (8)     
                                     + ZR900WS-REPORT-AMT (9)     
               PERFORM 800-WRITECSV-CUSTDET
           END-IF.

       1030-END.

      ******************************************************************
       1040-DO-ARO-CUSTOMER.
      ******************************************************************

           IF (WF1-SEQ-NBR             = ZEROES)
               IF (PRM-BALANCE         NOT = ZEROS)
                   IF (WF1-AMOUNT      NOT > PRM-BALANCE)
                      MOVE WF1-COMPANY    TO DB-COMPANY
                       MOVE WF1-CUSTOMER   TO DB-CUSTOMER
                       PERFORM
                           UNTIL (ARWORK-NOTFOUND)
                           OR    (WF1-COMPANY     NOT = DB-COMPANY)
                           OR    (WF1-CUSTOMER    NOT = DB-CUSTOMER)
                               PERFORM 8600-FIND-NEXT-ZR9001WORK
                   END-PERFORM
                   GO TO 1040-END.

      *     IF (WF1-SEQ-NBR             = ZEROES)
      *         IF (PRM-PAST-DUE-ONLY   = "Y")
      *             IF (WF1-PAST-DUE-TRANS NOT = "Y")
      *****         IF (WF1-AMOUNT      NOT > ZEROS)
      *                 MOVE WF1-COMPANY    TO DB-COMPANY
      *                 MOVE WF1-CUSTOMER   TO DB-CUSTOMER
      *                 PERFORM
      *                     UNTIL (ARWORK-NOTFOUND)
      *                     OR    (WF1-COMPANY     NOT = DB-COMPANY)
      *                     OR    (WF1-CUSTOMER    NOT = DB-CUSTOMER)
      *                         PERFORM 8600-FIND-NEXT-ZR9001WORK
      *             END-PERFORM
      *             GO TO 1040-END.

           IF (WF1-SEQ-NBR             = ZEROES)
               MOVE WF1-LAST-AGE-PER   TO ZR900WS-L-PER
               IF (PRM-ACO-CURR-DISPLAY    = "T")
                   MOVE ZR900WS-ORIG-ND TO R1G2-AS-OF-TOTAL-ND
                                           R1G21-OPENAMT-ND
                                           R1G32-CUST-TOTAL-ND
               ELSE
                   MOVE ACO-BASE-ND     TO R1G2-AS-OF-TOTAL-ND
                                           R1G21-OPENAMT-ND
                                           R1G32-CUST-TOTAL-ND
               END-IF
               MOVE WF1-AMOUNT          TO R1G21-OPENAMT
                                           R1G2-AS-OF-TOTAL
                                           R1G32-CUST-TOTAL
                                           ZR900WS-CSV-CUST-TOTAL
               ADD  WF1-AMOUNT          TO ZR900WS-NET-AMT
               MOVE WF1-ORIG-ND         TO ZR900WS-ORIG-ND
               MOVE WF1-AGE-PERIOD      TO ZR900WS-AGE-PER-FL
               PERFORM 8600-FIND-NEXT-ZR9001WORK
               GO TO 1040-END.

           MOVE WF1-COMPANY             TO DB-COMPANY.
           MOVE WF1-CUSTOMER            TO DB-CUSTOMER.
           PERFORM 840-FIND-ACMSET1.

           MOVE WF1-CUSTOMER           TO R1G2-ARO-CUSTOMER 
                                          R1G21-ARO-CUSTOMER.
           MOVE ACM-SALESMAN           TO R1G2-ACM-SALESMAN 
                                          R1G21-ACM-SALESMAN.
           MOVE ACM-CREDIT-ANLYST      TO R1G2-ACM-CREDIT-ANLYST.
           MOVE ACM-CONTACT            TO R1G2-ACM-CONTACT.
           MOVE ACM-PHONE-NMBR         TO R1G2-ACM-PHONE-NMBR.
           MOVE ACM-TERMS-CD           TO R1G2-ACM-TERMS-CD
                                          R1G21-ACM-TERMS-CD.
           MOVE ACM-RISK-CD            TO R1G2-ACM-RISK-CD
                                          R1G21-ACM-RISK-CD.

           IF (ACM-NAT-FLAG            = "N")
           AND (PRM-NA-SUMM            = "Y")
                PERFORM 1041-DO-NAT-ACCT
                THRU    1041-END
           ELSE
               MOVE ACM-CREDIT-LIM     TO R1G2-ACM-CREDIT-LIM
               MOVE ACM-LAST-PMT-DATE  TO R1G2-ACM-LAST-PMT-DATE
               IF (ACM-CREDIT-LIM      NOT = ZEROES)
                   COMPUTE ZR900WS-PERCENT ROUNDED = (ACM-CURR-BAL 
                                                   +  ACM-DRAFT-BAL)
                                                   /  ACM-CREDIT-LIM
               ELSE
                   MOVE ZEROES         TO ZR900WS-PERCENT
               END-IF
               COMPUTE ZR900WS-PERCENT ROUNDED = ZR900WS-PERCENT * 100
               MOVE ZR900WS-PERCENT             TO R1G2-PCNT-LIMIT
               IF (PRM-PMNT-AVG-FL     = "I")
                   MOVE 202            TO CRT-MSG-NBR
                   PERFORM 790-GET-MSG
                   MOVE CRT-MESSAGE     TO R1G2-HEADER-1
                                           R1G21-HEADER-1
                   MOVE ACM-YEAR-2-DAYS TO R1G2-ACM-YEAR-2-DAYS
                   IF (ACM-YTD-CASH    NOT = ZEROES)
                       COMPUTE ZR900WS-YTD-CASH ROUNDED 
                                                     = ACM-YTD-CSH-DAYS
                                                     / ACM-YTD-CASH
                       MOVE ZR900WS-YTD-CASH  TO R1G2-ACM-COLLECT-DAYS
                       MOVE ZR900WS-YTD-CASH  TO R1G21-ACM-COLLECT-DAYS
                   ELSE
                       MOVE ZEROES     TO R1G2-ACM-COLLECT-DAYS
                       MOVE ZEROES     TO R1G21-ACM-COLLECT-DAYS
                   END-IF
               ELSE
                   MOVE 203            TO CRT-MSG-NBR
                   PERFORM 790-GET-MSG
                   MOVE CRT-MESSAGE    TO R1G2-HEADER-1
                                          R1G21-HEADER-1
                   MOVE ACM-DBT-PR-YR   TO R1G2-ACM-YEAR-2-DAYS
                   IF (ACM-DBT-YTD-CASH NOT = ZEROES)
                       COMPUTE ZR900WS-YTD-CASH ROUNDED 
                                                     = ACM-DBT-YTD-DAYS
                                                     / ACM-DBT-YTD-CASH
                       MOVE ZR900WS-YTD-CASH  TO R1G2-ACM-COLLECT-DAYS
                       MOVE ZR900WS-YTD-CASH  TO R1G21-ACM-COLLECT-DAYS
                   ELSE
                       MOVE ZEROES     TO R1G2-ACM-COLLECT-DAYS
                       MOVE ZEROES     TO R1G21-ACM-COLLECT-DAYS.

           MOVE ACO-CUST-GROUP         TO DB-CUST-GROUP.
           MOVE WF1-CUSTOMER           TO DB-CUSTOMER.
           PERFORM 840-FIND-CUDSET1.
           IF (PRM-SORT-OPTION         = "N")
                MOVE CUD-NAME          TO R1G2-CUD-NAME
                MOVE CUD-NAME          TO R1G21-CUD-NAME
                MOVE CUD-NAME          TO R1G32-CUD-NAME
           ELSE
               MOVE ACM-SEARCH-NAME    TO R1G2-CUD-NAME
                                          R1G21-CUD-NAME
                                          R1G32-CUD-NAME
           END-IF.
           MOVE WF1-CUSTOMER           TO R1G32-ARO-CUSTOMER.
           MOVE CUD-ADDR1              TO R1G2-CUD-ADDR1.
           MOVE SPACES                 TO R1G2-CUD-ADDR2.      
           IF  (CUD-CITY               = SPACES)
           AND (CUD-STATE              = SPACES)
                IF (CUD-ADDR4          NOT = SPACES)
                    MOVE CUD-ADDR4     TO R1G2-CUD-ADDR2
                END-IF
                IF (CUD-ADDR3          NOT = SPACES)
                    MOVE CUD-ADDR3     TO R1G2-CUD-ADDR2
                END-IF
                IF (CUD-ADDR2          NOT = SPACES)
                    MOVE CUD-ADDR2     TO R1G2-CUD-ADDR2
                END-IF
           ELSE
               MOVE CUD-CITY           TO ZR900WS-CITY
               MOVE CUD-STATE          TO ZR900WS-STATE
               MOVE ZR900WS-ADDR       TO R1G2-CUD-ADDR2.
           MOVE CUD-ZIP                TO R1G2-CUD-ZIP.

           IF (PRM-EXPANDED-OPT        = "Y")
CPS001         PERFORM 9000-DO-CPS-CUST-DETAIL
               MOVE R1GN2-ARO-CUSTOMER TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP
           ELSE
           IF (PRM-DETAIL-OPTION NOT = "C")
               IF  (PRM-PERIOD-OF          = "P")
J56704         AND (PRM-REPORT-OPTION      = "A" OR "C" OR "S" OR "B")
                   MOVE 90                 TO CRT-MSG-NBR
                   PERFORM 790-GET-MSG
                   MOVE CRT-MESSAGE        TO R1G21-TOT-HEADER
                   MOVE "          .00"    TO R1G21-TOT-DSO
                   MOVE IFCOWS-FISCAL-YEAR TO DB-YEAR
                   IF (PRM-NA-SUMM  = "N")
                   OR (ACM-NAT-FLAG = SPACES)
                       PERFORM 840-FIND-ARPSET1
                       IF  (ARCUSTPER-FOUND)
                       AND (ARP-PERIOD-BILL (WS9)     NOT = ZEROES)
                           MOVE ARP-PERIOD-BILL (WS9) TO WS-PERIOD-BILL
                           SUBTRACT ARP-PERIOD-CRDTS (WS9)
                                                FROM WS-PERIOD-BILL
                           IF  (WS-PERIOD-BILL    > ZEROES)
                           AND (R1G2-AS-OF-TOTAL  > ZEROES)
                               ADD WS-PERIOD-BILL   TO WS-SALE
                               ADD R1G2-AS-OF-TOTAL TO WS-TOTAL
                               MOVE R1G2-AS-OF-TOTAL
                                                  TO ZR900WS-CUST-TOTAL
                               COMPUTE WS-DSO ROUNDED 
                                                  = (ZR900WS-CUST-TOTAL
                                                  / WS-PERIOD-BILL)
                                                  * ZR900WS-PERIOD-DAYS
                               MOVE WS-DSO          TO WS-DSO-NBR
                               MOVE WS-DSO-CHAR     TO R1G21-TOT-DSO
                           END-IF
                       END-IF
                 ELSE
                     MOVE NAB-NAT-COMPANY          TO DB-COMPANY
                     MOVE NAB-NAT-CUSTOMER         TO DB-CUSTOMER
                     PERFORM 840-FIND-ARPSET1
                     IF  (ARCUSTPER-FOUND)
                     AND (ARP-PERIOD-BILL (WS9)  NOT = ZEROES)
                          MOVE ARP-PERIOD-BILL (WS9) TO WS-PERIOD-BILL
                          SUBTRACT ARP-PERIOD-CRDTS (WS9)
                                                   FROM WS-PERIOD-BILL
                          IF  (WS-PERIOD-BILL      > ZEROES)
                          AND (R1G2-AS-OF-TOTAL    > ZEROES)
                              MOVE WS-PERIOD-BILL  TO WS-NAT-PERIOD-BILL
                              ADD WS-PERIOD-BILL   TO WS-SALE
                          END-IF
                     END-IF
                     ADD R1G2-AS-OF-TOTAL        TO WS-TOTAL
                     MOVE R1G2-AS-OF-TOTAL       TO ZR900WS-CUST-TOTAL
                     MOVE NAB-NAT-COMPANY        TO DB-NAT-COMPANY
                     MOVE NAB-NAT-CUSTOMER       TO DB-NAT-CUSTOMER
                     MOVE ZEROES                 TO DB-COMPANY
                     MOVE SPACES                 TO DB-CUSTOMER
                     MOVE NACSET1-NAT-CUSTOMER   TO WS-DB-BEG-RNG
                     PERFORM 850-FIND-BEGRNG-NACSET1
                     PERFORM 1043-DO-NAT-DSO
                     THRU    1043-END
                        UNTIL (NATACCT-NOTFOUND)
                           COMPUTE WS-DSO ROUNDED = (ZR900WS-CUST-TOTAL
                                                  / WS-NAT-PERIOD-BILL)
                                                  * ZR900WS-PERIOD-DAYS
                           MOVE WS-DSO         TO WS-DSO-NBR
                           MOVE WS-DSO-CHAR    TO R1G21-TOT-DSO
                 END-IF
               ELSE
                   MOVE SPACES             TO R1G21-TOT-HEADER
                   MOVE SPACES             TO R1G21-TOT-DSO
               END-IF
CPS001*        PERFORM 9000-DO-CPS-CUST-DETAIL
               MOVE R1GN21-ARO-CUSTOMER TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (PRM-DETAIL-OPTION     = "Y" OR "A")
               IF (PRM-AMTS-OPT      = "N")
                   MOVE R1GN3H-FULL        TO RPT-GROUP-REQUEST
               ELSE
                   MOVE R1GN3H-TRUNC       TO RPT-GROUP-REQUEST
               END-IF
               PERFORM 700-PRINT-RPT-GRP
           ELSE
               IF (PRM-DETAIL-OPTION = "E")
                   MOVE R1GN31H-PARTIAL    TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP.

           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 9)
                   MOVE ZEROES         TO ZR900WS-CUSTOMER-AMT (I1)
                                          ZR900WS-CUSTOMER-PCT (I1)
                                          ZR900WS-PRINT-AMT (I1)
           END-PERFORM.
           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 5)
                   MOVE ZEROES         TO ZR900WS-CUST-AMT (I1)
                                          ZR900WS-CUST-FOR (I1)
                                          ZR900WS-PRINT-FOR (I1)
           END-PERFORM.

           MOVE WF1-SEARCH-NAME        TO WS-SEARCH-NAME.
           MOVE WF1-CUSTOMER           TO ZR900WS-CUSTOMER.
           MOVE WF1-ORIG-CURRENCY      TO WS-CURRENCY.

J56704     INITIALIZE                     ZR900WS-SV-BILL-TO.
J56704     IF (PRM-REPORT-OPTION         = "B")
J56704         PERFORM 
J56704             VARYING I1 FROM 1 BY 1
J56704             UNTIL  (I1 > 7)
J56704                 MOVE ZEROES       TO ZR900WS-BILLTO-AMT (I1)
J56074         END-PERFORM
J56704         MOVE WF1-BILL-TO          TO R1G3-BILL-TO
J56704                                      ZR900WS-SV-BILL-TO
J56704         IF (PRM-ACO-CURR-DISPLAY        = "T")
J56704             MOVE ZR900WS-ORIG-ND  TO R1G31-1-BILLAMT-ND
J56704                                      R1G31-2-BILLAMT-ND
J56704                                      R1G31-3-BILLAMT-ND
J56704                                      R1G31-4-BILLAMT-ND
J56704                                      R1G31-5-BILLAMT-ND
J56704                                      R1G31-6-BILLAMT-ND
J56704                                      R1G31-7-BILLAMT-ND
J56704                                      R1G32-1-BILLAMT-ND
J56704                                      R1G32-2-BILLAMT-ND
J56704                                      R1G32-3-BILLAMT-ND
J56704                                      R1G32-4-BILLAMT-ND
J56704                                      R1G32-5-BILLAMT-ND
J56704                                      R1G32-6-BILLAMT-ND
J56704                                      R1G32-7-BILLAMT-ND
J56704         ELSE
J56704             MOVE ACO-BASE-ND      TO R1G31-1-BILLAMT-ND
J56704                                      R1G31-2-BILLAMT-ND
J56704                                      R1G31-3-BILLAMT-ND
J56704                                      R1G31-4-BILLAMT-ND
J56704                                      R1G31-5-BILLAMT-ND
J56704                                      R1G31-6-BILLAMT-ND
J56704                                      R1G31-7-BILLAMT-ND
J56704                                      R1G32-1-BILLAMT-ND
J56704                                      R1G32-2-BILLAMT-ND
J56704                                      R1G32-3-BILLAMT-ND
J56704                                      R1G32-4-BILLAMT-ND
J56704                                      R1G32-5-BILLAMT-ND
J56704                                      R1G32-6-BILLAMT-ND
J56704                                      R1G32-7-BILLAMT-ND
J56704         END-IF
J56704         IF (PRM-DETAIL-OPTION = "Y" OR "A")
J56704             MOVE R1GN3-BILL-TO      TO RPT-GROUP-REQUEST
J56704             PERFORM 700-PRINT-RPT-GRP
J56704         END-IF
J56704     END-IF.

           PERFORM 1060-DO-ARO-TRANS-TYPE
           THRU    1060-END
               UNTIL (ARWORK-NOTFOUND)
               OR    (WF1-COMPANY       NOT = WS-ARO-COMPANY)
               OR    (WF1-SORT-FIELD    NOT = ZR900WS-SORT-FIELD)
               OR    (WF1-ORIG-CURRENCY NOT = WS-CURRENCY)
               OR    (WF1-SEARCH-NAME   NOT = WS-SEARCH-NAME)
               OR    (WF1-CUSTOMER      NOT = ZR900WS-CUSTOMER).

J56704     IF (PRM-REPORT-OPTION         = "B")
J56704         IF (PRM-DETAIL-OPTION = "E")
J56704             MOVE ZR900WS-SV-BILL-TO      TO R1G32-BILL-TO
J56704             MOVE ZR900WS-BILLTO-AMT (1)  TO R1G32-1-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (2)  TO R1G32-2-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (3)  TO R1G32-3-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (4)  TO R1G32-4-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (5)  TO R1G32-5-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (6)  TO R1G32-6-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (7)  TO R1G32-7-BILLAMT
J56704             MOVE R1GN32-BILLTO-EXPSUM    TO RPT-GROUP-REQUEST
J56704         ELSE
J56704             MOVE ZR900WS-BILLTO-AMT (1)  TO R1G31-1-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (2)  TO R1G31-2-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (3)  TO R1G31-3-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (4)  TO R1G31-4-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (5)  TO R1G31-5-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (6)  TO R1G31-6-BILLAMT
J56704             MOVE ZR900WS-BILLTO-AMT (7)  TO R1G31-7-BILLAMT
J56704             MOVE R1GN31-BILLTO-TOTALS    TO RPT-GROUP-REQUEST
J56704         END-IF
J56704         PERFORM 700-PRINT-RPT-GRP
J56704         PERFORM
J56704             VARYING I1 FROM 1 BY 1
J56704             UNTIL  (I1 > 7)
J56704                 MOVE ZEROES       TO ZR900WS-BILLTO-AMT (I1)
J56704         END-PERFORM
J56704         INITIALIZE                   ZR900WS-TOTAL-BILLTO
J56704         INITIALIZE                   R1G31-1-BILLAMT
J56704                                      R1G31-2-BILLAMT
J56704                                      R1G31-3-BILLAMT
J56704                                      R1G31-4-BILLAMT
J56704                                      R1G31-5-BILLAMT
J56704                                      R1G31-6-BILLAMT
J56704                                      R1G31-7-BILLAMT
J56704                                      R1G32-1-BILLAMT
J56704                                      R1G32-2-BILLAMT
J56704                                      R1G32-3-BILLAMT
J56704                                      R1G32-4-BILLAMT
J56704                                      R1G32-5-BILLAMT
J56704                                      R1G32-6-BILLAMT
J56704                                      R1G32-7-BILLAMT
J56704     END-IF.

           IF (PRM-ACO-CURR-DISPLAY        = "T")
               MOVE ZR900WS-ORIG-ND    TO R1G31-1-OPENAMT-ND
                                          R1G31-2-OPENAMT-ND
                                          R1G31-3-OPENAMT-ND
                                          R1G31-4-OPENAMT-ND
                                          R1G31-5-OPENAMT-ND
                                          R1G31-6-OPENAMT-ND
                                          R1G31-7-OPENAMT-ND
                                          R1G32-1-OPENAMT-ND
                                          R1G32-2-OPENAMT-ND
                                          R1G32-3-OPENAMT-ND
                                          R1G32-4-OPENAMT-ND
                                          R1G32-5-OPENAMT-ND
                                          R1G32-6-OPENAMT-ND
                                          R1G32-7-OPENAMT-ND
           ELSE
               MOVE ACO-BASE-ND        TO R1G31-1-OPENAMT-ND
                                          R1G31-2-OPENAMT-ND
                                          R1G31-3-OPENAMT-ND
                                          R1G31-4-OPENAMT-ND
                                          R1G31-5-OPENAMT-ND
                                          R1G31-6-OPENAMT-ND
                                          R1G31-7-OPENAMT-ND
                                          R1G32-1-OPENAMT-ND
                                          R1G32-2-OPENAMT-ND
                                          R1G32-3-OPENAMT-ND
                                          R1G32-4-OPENAMT-ND
                                          R1G32-5-OPENAMT-ND
                                          R1G32-6-OPENAMT-ND
                                          R1G32-7-OPENAMT-ND.

           MOVE ZR900WS-CUSTOMER-AMT (1)  TO R1G31-1-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (2)  TO R1G31-2-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (3)  TO R1G31-3-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (4)  TO R1G31-4-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (5)  TO R1G31-5-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (6)  TO R1G31-6-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (7)  TO R1G31-7-OPENAMT.

           MOVE ZR900WS-CUSTOMER-AMT (1)  TO R1G32-1-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (2)  TO R1G32-2-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (3)  TO R1G32-3-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (4)  TO R1G32-4-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (5)  TO R1G32-5-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (6)  TO R1G32-6-OPENAMT.
           MOVE ZR900WS-CUSTOMER-AMT (7)  TO R1G32-7-OPENAMT.

           IF (PRM-CSV-FILE-OPT = "Y")
               MOVE ZR900WS-PRM-COMPANY       TO CS1-COMPANY
               MOVE R1G32-ARO-CUSTOMER        TO CS1-CUSTOMER
               MOVE R1G32-CUD-NAME            TO CS1-CUST-NAME
               MOVE ZR900WS-CUSTOMER-AMT (1)  TO CS1-FUTURE
               MOVE ZR900WS-CUSTOMER-AMT (2)  TO CS1-CURRENT
               MOVE ZR900WS-CUSTOMER-AMT (3)  TO CS1-AGE1
               MOVE ZR900WS-CUSTOMER-AMT (4)  TO CS1-AGE2
               MOVE ZR900WS-CUSTOMER-AMT (5)  TO CS1-AGE3
               MOVE ZR900WS-CUSTOMER-AMT (6)  TO CS1-AGE4
               MOVE ZR900WS-CUSTOMER-AMT (7)  TO CS1-AGE5
               MOVE ZR900WS-CUSTOMER-AMT (8)  TO CS1-AGE6
               MOVE ZR900WS-CUSTOMER-AMT (9)  TO CS1-OVER6
               MOVE ZR900WS-CSV-CUST-TOTAL    TO CS1-TOTAL
               PERFORM 800-WRITECSV-CUSTDET
           END-IF.
           
           IF (PRM-DETAIL-OPTION NOT = "C")
               MOVE R1GN31-CUSTOMER-TOTALS TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP
           ELSE
               MOVE R1GN32-CUSTOMER-CONDENSED TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP
           END-IF.

           IF (PRM-ACO-CURR-DISPLAY = "T")
               GO TO 1040-TOTAL.

           IF (PRM-PERIOD-OF           = "P")
J56704     AND (PRM-REPORT-OPTION      = "A" OR "C" OR "B")
               MOVE 90                  TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               MOVE CRT-MESSAGE         TO R1T1-TOT-HEADER
                                           R1T1P-TOT-HEADER
               MOVE ".00"              TO R1T1-TOT-DSO
               MOVE ".00"              TO R1T1P-TOT-DSO
               IF (PRM-NA-SUMM = "N")
               OR (ACM-NAT-FLAG = SPACES)
                   MOVE IFCOWS-FISCAL-YEAR TO DB-YEAR
                   PERFORM 840-FIND-ARPSET1
                   IF  (ARCUSTPER-FOUND)
                   AND (ARP-PERIOD-BILL (WS9)     NOT = ZEROES)
                       MOVE ARP-PERIOD-BILL (WS9) TO WS-PERIOD-BILL
                       SUBTRACT ARP-PERIOD-CRDTS (WS9) 
                                                FROM WS-PERIOD-BILL
                       IF  (WS-PERIOD-BILL    > ZEROES)
                       AND (R1G2-AS-OF-TOTAL  > ZEROES)
                            ADD WS-PERIOD-BILL    TO WS-SALE
                            ADD R1G2-AS-OF-TOTAL  TO WS-TOTAL
                            MOVE R1G2-AS-OF-TOTAL TO ZR900WS-CUST-TOTAL
                            COMPUTE WS-DSO ROUNDED = (ZR900WS-CUST-TOTAL
                                                   / WS-PERIOD-BILL)
                                                   * ZR900WS-PERIOD-DAYS
                            MOVE WS-DSO         TO WS-DSO-NBR
                            MOVE WS-DSO-CHAR    TO R1T1-TOT-DSO
                            MOVE WS-DSO-CHAR    TO R1T1P-TOT-DSO
                        END-IF
                   END-IF
               ELSE
                   MOVE WS-DSO                  TO WS-DSO-NBR
                   MOVE WS-DSO-CHAR             TO R1T1-TOT-DSO
                   MOVE WS-DSO-CHAR             TO R1T1P-TOT-DSO
               END-IF.

           MOVE ZEROES                    TO AROPWS-OPEN-AMT.
           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 7)
                   ADD ZR900WS-CUSTOMER-AMT (I1)   TO AROPWS-OPEN-AMT
           END-PERFORM.

           IF (AROPWS-OPEN-AMT NOT = ZEROES)
               PERFORM 
                   VARYING I1 FROM 1 BY 1
                   UNTIL  (I1 > 7)
                       COMPUTE ZR900WS-CUSTOMER-PCT (I1) ROUNDED = 
                                             (ZR900WS-CUSTOMER-AMT (I1)
                                            / AROPWS-OPEN-AMT)
                                            * 100
               END-PERFORM
           ELSE
               PERFORM 
                   VARYING I1 FROM 1 BY 1
                   UNTIL  (I1 > 7)
                       MOVE ZEROES        TO ZR900WS-CUSTOMER-PCT (I1)
               END-PERFORM.

           MOVE ZR900WS-CUSTOMER-PCT (1)  TO R1T1-1-PERCENT.
           MOVE ZR900WS-CUSTOMER-PCT (2)  TO R1T1-2-PERCENT.
           MOVE ZR900WS-CUSTOMER-PCT (3)  TO R1T1-3-PERCENT.
           MOVE ZR900WS-CUSTOMER-PCT (4)  TO R1T1-4-PERCENT.
           MOVE ZR900WS-CUSTOMER-PCT (5)  TO R1T1-5-PERCENT.
           MOVE ZR900WS-CUSTOMER-PCT (6)  TO R1T1-6-PERCENT.
           MOVE ZR900WS-CUSTOMER-PCT (7)  TO R1T1-7-PERCENT.

           IF  (PRM-ACO-AGE-TYPE      = "D")
           AND (PRM-DETAIL-OPTION = "Y" OR "A")
               MOVE ZR900WS-CUSTOMER-PCT (1)  TO R1T1P-1-PERCENT
               MOVE ZR900WS-CUSTOMER-PCT (2)  TO R1T1P-2-PERCENT
               MOVE ZR900WS-CUSTOMER-PCT (3)  TO R1T1P-3-PERCENT
               MOVE ZR900WS-CUSTOMER-PCT (4)  TO R1T1P-4-PERCENT
               MOVE ZR900WS-CUSTOMER-PCT (5)  TO R1T1P-5-PERCENT
               MOVE ZR900WS-CUSTOMER-PCT (6)  TO R1T1P-6-PERCENT
               MOVE ZR900WS-CUSTOMER-PCT (7)  TO R1T1P-7-PERCENT.

           MOVE ZEROES                    TO WS-TOTAL-AMT.
           MOVE ZEROES                    TO WS-TOTAL-FOR.
           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 5)
                   ADD ZR900WS-CUST-AMT (I1)   TO WS-TOTAL-AMT
                   ADD ZR900WS-CUST-FOR (I1)   TO WS-TOTAL-FOR
                   IF (ZR900WS-CUST-AMT (I1) NOT = ZEROES)
                       COMPUTE ZR900WS-PRINT-FOR (I1) ROUNDED
                                                = ZR900WS-CUST-FOR (I1)
                                                / ZR900WS-CUST-AMT (I1)
                   END-IF
           END-PERFORM.

           MOVE ZR900WS-PRINT-FOR (1)  TO R1T1-1-FOR-AVG.
           MOVE ZR900WS-PRINT-FOR (2)  TO R1T1-2-FOR-AVG.
           MOVE ZR900WS-PRINT-FOR (3)  TO R1T1-3-FOR-AVG.
           MOVE ZR900WS-PRINT-FOR (4)  TO R1T1-4-FOR-AVG.
           MOVE ZR900WS-PRINT-FOR (5)  TO R1T1-5-FOR-AVG.

           MOVE ZEROES                 TO ZR900WS-FOR-AVG.
           IF (WS-TOTAL-AMT            NOT = ZEROES)
               COMPUTE ZR900WS-FOR-AVG  ROUNDED = WS-TOTAL-FOR 
                                                / WS-TOTAL-AMT.
                                       
           MOVE ZR900WS-FOR-AVG        TO R1T1-FOR-AVG.
           MOVE ZR900WS-FOR-AVG        TO R1T1P-FOR-AVG.

           IF  (PRM-ACO-AGE-TYPE           = "T")
           AND (PRM-DETAIL-OPTION      = "Y" OR "A")
               MOVE R1TN1-TOTAL-FOR    TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF  (PRM-ACO-AGE-TYPE           = "D")
           AND (PRM-DETAIL-OPTION      = "Y" OR "A")
               MOVE R1TN1-TOTAL-FOR-P  TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

       1040-TOTAL.
           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 7)
                   ADD ZR900WS-CUSTOMER-AMT (I1) 
                                       TO ZR900WS-REPORT-AMT (I1)
                   ADD ZR900WS-CUSTOMER-AMT (I1) 
                                       TO ZR900WS-SORT-AMT (I1)
           END-PERFORM.
           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 5)
                   ADD ZR900WS-CUST-AMT (I1)    TO ZR900WS-REP-AMT (I1)
                   ADD ZR900WS-CUST-FOR (I1)    TO ZR900WS-REP-FOR (I1)
           END-PERFORM.

       1040-END.

      ******************************************************************
       1041-DO-NAT-ACCT.
      ******************************************************************

           MOVE WF1-COMPANY            TO DB-NAT-COMPANY.
           MOVE WF1-CUSTOMER           TO DB-NAT-CUSTOMER.
           PERFORM 840-FIND-NABSET1.
           IF (ACO-CURRENCY-CD         = ACG-CURRENCY-CD)
               MOVE NAB-CREDIT-LIM     TO WS-CREDIT-LIMIT
               COMPUTE WS-CURR-BAL     = NAB-CURR-BAL + NAB-DRAFT-BAL
           ELSE
               IF (IFCRWS-MULT-DIV     = "M")
                   COMPUTE WS-CREDIT-LIMIT ROUNDED
                                           = NAB-CREDIT-LIM 
                                           / IFGRWS-SELL-RATE
                   COMPUTE WS-CURR-BAL ROUNDED    
                                           = (NAB-CURR-BAL 
                                           +  NAB-DRAFT-BAL)
                                           /  IFGRWS-SELL-RATE
               ELSE
                   COMPUTE WS-CREDIT-LIMIT ROUNDED
                                           = NAB-CREDIT-LIM 
                                           * IFGRWS-SELL-RATE
                   COMPUTE WS-CURR-BAL ROUNDED    
                                           = (NAB-CURR-BAL
                                           +  NAB-DRAFT-BAL)
                                           *  IFGRWS-SELL-RATE.

           MOVE WS-CREDIT-LIMIT            TO R1G2-ACM-CREDIT-LIM.
           IF (WS-CREDIT-LIMIT         NOT = ZEROES)
               COMPUTE ZR900WS-PERCENT ROUNDED = WS-CURR-BAL 
                                               / WS-CREDIT-LIMIT
           ELSE
               MOVE ZEROES             TO ZR900WS-PERCENT.

           COMPUTE ZR900WS-PERCENT ROUNDED = ZR900WS-PERCENT * 100.
           MOVE ZR900WS-PERCENT        TO R1G2-PCNT-LIMIT.

           MOVE ZEROES                 TO WS-CNT-1 
                                          WS-CNT-2.
           MOVE ACM-YEAR-2-DAYS        TO WS-YEAR-2-DAYS.
           IF (ACM-YEAR-2-DAYS         NOT = ZEROES)
               MOVE 1                  TO WS-CNT-1.

           MOVE ACM-YTD-CSH-DAYS       TO WS-YTD-CSH-DAYS.
           MOVE ACM-YTD-CASH           TO WS-YTD-CASH.
           MOVE ACM-DBT-PR-YR          TO WS-DBT-PR-YR.
           IF (ACM-DBT-PR-YR           NOT = ZEROES)
               MOVE 1                  TO WS-CNT-2.

           MOVE ACM-DBT-YTD-DAYS       TO WS-DBT-YTD-DAYS.
           MOVE ACM-DBT-YTD-CASH       TO WS-DBT-YTD-CASH.
           MOVE ACM-LAST-PMT-DATE      TO WS-LAST-PMT-DATE.

           MOVE NAB-NAT-COMPANY        TO DB-NAT-COMPANY.
           MOVE NAB-NAT-CUSTOMER       TO DB-NAT-CUSTOMER.
           MOVE ZEROES                 TO DB-COMPANY.
           MOVE SPACES                 TO DB-CUSTOMER.
           MOVE NACSET1-NAT-CUSTOMER   TO WS-DB-BEG-RNG.
           PERFORM 850-FIND-BEGRNG-NACSET1.
           PERFORM 1042-DO-NAT-CONSOLIDATION
           THRU    1042-END
               UNTIL (NATACCT-NOTFOUND).

           MOVE WS-LAST-PMT-DATE       TO R1G2-ACM-LAST-PMT-DATE.
           IF (PRM-PMNT-AVG-FL         = "I")
               MOVE 202                TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               MOVE CRT-MESSAGE        TO R1G2-HEADER-1
                                          R1G21-HEADER-1
               IF (WS-CNT-1            NOT = ZEROES)
                   COMPUTE WS-YEAR-2-DAYS ROUNDED = WS-YEAR-2-DAYS
                                                  / WS-CNT-1
                   MOVE WS-YEAR-2-DAYS   TO R1G2-ACM-YEAR-2-DAYS
               ELSE
                   MOVE ZEROES           TO R1G2-ACM-YEAR-2-DAYS
               END-IF
               IF (WS-YTD-CASH NOT = ZEROES)
                   COMPUTE ZR900WS-YTD-CASH ROUNDED 
                                                     = WS-YTD-CSH-DAYS
                                                     / WS-YTD-CASH
                   MOVE ZR900WS-YTD-CASH  TO R1G2-ACM-COLLECT-DAYS
                   MOVE ZR900WS-YTD-CASH  TO R1G21-ACM-COLLECT-DAYS
               ELSE
                   MOVE ZEROES           TO R1G2-ACM-COLLECT-DAYS
                   MOVE ZEROES           TO R1G21-ACM-COLLECT-DAYS.

           IF (PRM-PMNT-AVG-FL           = "D")
               MOVE 203                  TO CRT-MSG-NBR
               PERFORM 790-GET-MSG
               MOVE CRT-MESSAGE          TO R1G2-HEADER-1
                                            R1G21-HEADER-1
               IF (WS-CNT-2              NOT = ZEROES)
                   COMPUTE WS-DBT-PR-YR ROUNDED = WS-DBT-PR-YR
                                                / WS-CNT-2
                   MOVE WS-DBT-PR-YR     TO R1G2-ACM-YEAR-2-DAYS
               END-IF
               IF (WS-DBT-YTD-CASH NOT = ZEROES)
                   COMPUTE ZR900WS-YTD-CASH ROUNDED 
                                                 = WS-DBT-YTD-DAYS
                                                 / WS-DBT-YTD-CASH
                   MOVE ZR900WS-YTD-CASH  TO R1G2-ACM-COLLECT-DAYS
                   MOVE ZR900WS-YTD-CASH  TO R1G21-ACM-COLLECT-DAYS
               ELSE
                   MOVE ZEROES           TO R1G2-ACM-COLLECT-DAYS
                   MOVE ZEROES           TO R1G21-ACM-COLLECT-DAYS.

           MOVE ACO-COMPANY                  TO DB-COMPANY.
           MOVE WF1-CUSTOMER                 TO DB-CUSTOMER.
           PERFORM 840-FIND-ACMSET1.

       1041-END.

      ******************************************************************
       1042-DO-NAT-CONSOLIDATION.
      ******************************************************************

           MOVE NAC-COMPANY            TO DB-COMPANY.
           MOVE NAC-CUSTOMER           TO DB-CUSTOMER.
           PERFORM 840-FIND-ACMSET1.
           IF (ACM-YEAR-2-DAYS         NOT = ZEROES)
               ADD ACM-YEAR-2-DAYS     TO WS-YEAR-2-DAYS
               ADD 1                   TO WS-CNT-1.
           ADD ACM-YTD-CSH-DAYS        TO WS-YTD-CSH-DAYS.
           ADD ACM-YTD-CASH            TO WS-YTD-CASH.
           IF (ACM-DBT-PR-YR           NOT = ZEROES)
               ADD ACM-DBT-PR-YR       TO WS-DBT-PR-YR
               ADD 1                   TO WS-CNT-2.
           ADD ACM-DBT-YTD-DAYS        TO WS-DBT-YTD-DAYS.
           ADD ACM-DBT-YTD-CASH        TO WS-DBT-YTD-CASH.
           IF (ACM-LAST-PMT-DATE       > WS-LAST-PMT-DATE)
               MOVE ACM-LAST-PMT-DATE  TO WS-LAST-PMT-DATE.

           PERFORM 860-FIND-NXTRNG-NACSET1.

       1042-END.

      ******************************************************************
       1043-DO-NAT-DSO.
      ******************************************************************

           MOVE NAC-COMPANY                TO DB-COMPANY.
           MOVE NAC-CUSTOMER               TO DB-CUSTOMER.
           MOVE IFCOWS-FISCAL-YEAR         TO DB-YEAR.

           PERFORM 840-FIND-ARPSET1.
           IF  (ARCUSTPER-FOUND)
           AND (ARP-PERIOD-BILL (WS9)     NOT = ZEROES)
                MOVE ARP-PERIOD-BILL (WS9) TO WS-PERIOD-BILL
                SUBTRACT ARP-PERIOD-CRDTS (WS9)
                                         FROM WS-PERIOD-BILL
                IF  (WS-PERIOD-BILL    > ZEROES)
                AND (R1G2-AS-OF-TOTAL  > ZEROES)
                     ADD WS-PERIOD-BILL    TO WS-NAT-PERIOD-BILL
                     ADD WS-PERIOD-BILL    TO WS-SALE
                END-IF
           END-IF.

           PERFORM 860-FIND-NXTRNG-NACSET1.

       1043-END.
      ******************************************************************
       1060-DO-ARO-TRANS-TYPE.
      ******************************************************************

J56704     IF (PRM-REPORT-OPTION         = "B")
J56704         IF (WF1-BILL-TO     NOT = ZR900WS-SV-BILL-TO)
J56704             IF (PRM-DETAIL-OPTION = "E")
J56704                 MOVE ZR900WS-SV-BILL-TO      TO R1G32-BILL-TO
J56704                 MOVE ZR900WS-BILLTO-AMT (1)  TO R1G32-1-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (2)  TO R1G32-2-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (3)  TO R1G32-3-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (4)  TO R1G32-4-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (5)  TO R1G32-5-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (6)  TO R1G32-6-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (7)  TO R1G32-7-BILLAMT
J56704                 MOVE R1GN32-BILLTO-EXPSUM    TO RPT-GROUP-REQUEST
J56704             ELSE
J56704                 MOVE ZR900WS-BILLTO-AMT (1)  TO R1G31-1-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (2)  TO R1G31-2-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (3)  TO R1G31-3-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (4)  TO R1G31-4-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (5)  TO R1G31-5-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (6)  TO R1G31-6-BILLAMT
J56704                 MOVE ZR900WS-BILLTO-AMT (7)  TO R1G31-7-BILLAMT
J56704                 MOVE R1GN31-BILLTO-TOTALS    TO RPT-GROUP-REQUEST
J56704             END-IF
J56704             PERFORM 700-PRINT-RPT-GRP
J56704             PERFORM 
J56704                 VARYING I1 FROM 1 BY 1
J56704                 UNTIL  (I1 > 7)
J56704                     MOVE ZEROES       TO ZR900WS-BILLTO-AMT (I1)
J56704             END-PERFORM
J56704             INITIALIZE                   ZR900WS-TOTAL-BILLTO
J56704             INITIALIZE                   R1G31-1-BILLAMT
J56704                                          R1G31-2-BILLAMT
J56704                                          R1G31-3-BILLAMT
J56704                                          R1G31-4-BILLAMT
J56704                                          R1G31-5-BILLAMT
J56704                                          R1G31-6-BILLAMT
J56704                                          R1G31-7-BILLAMT
J56704                                          R1G32-1-BILLAMT
J56704                                          R1G32-2-BILLAMT
J56704                                          R1G32-3-BILLAMT
J56704                                          R1G32-4-BILLAMT
J56704                                          R1G32-5-BILLAMT
J56704                                          R1G32-6-BILLAMT
J56704                                          R1G32-7-BILLAMT
J56704             MOVE WF1-BILL-TO          TO R1G3-BILL-TO
J56704                                          ZR900WS-SV-BILL-TO
J56704             IF (PRM-DETAIL-OPTION = "Y" OR "A")
J56704                 MOVE R1GN3-BILL-TO    TO RPT-GROUP-REQUEST
J56704                 PERFORM 700-PRINT-RPT-GRP
J56704             END-IF
J56704         END-IF
J56704     END-IF.

           PERFORM 
               VARYING I1 FROM 1 BY 1
               UNTIL  (I1 > 9)
                   MOVE ZEROES            TO ZR900WS-PRINT-AMT (I1)
           END-PERFORM.
           MOVE WF1-INVOICE               TO R1G3-ARO-INVOICE
                                             WS-INVOICE-22
                                             R1P3-ARO-INVOICE.
           MOVE WF1-BATCH-NBR             TO R1G3-BATCH-NBR
                                             R1P3-BATCH-NBR.
           MOVE WF1-PAYMENT-SEQ           TO R1G3-PAYMENT-SEQ
                                             R1P3-PAYMENT-SEQ.

           IF (WF1-TRANS-TYPE = "3")
               IF (WF1-CR-INVOICE         NOT = SPACES)
                   MOVE "C"               TO R1G3-ARO-TRANS-TYPE
                                             R1P3-ARO-TRANS-TYPE
                   MOVE WF1-CR-INVOICE    TO R1G3-ARO-INVOICE
                                             WS-INVOICE-22
                                             R1P3-ARO-INVOICE
               ELSE
                   MOVE "I"               TO R1G3-ARO-TRANS-TYPE
                                             R1P3-ARO-TRANS-TYPE.

           IF (WF1-TRANS-TYPE = "4")
               IF (WF1-CR-INVOICE         NOT = SPACES)
                   MOVE "C"               TO R1G3-ARO-TRANS-TYPE
                                             R1P3-ARO-TRANS-TYPE
                   MOVE WF1-CR-INVOICE    TO R1G3-ARO-INVOICE
                                             WS-INVOICE-22
                                             R1P3-ARO-INVOICE
               ELSE
                   MOVE "D"               TO R1G3-ARO-TRANS-TYPE
                                             R1P3-ARO-TRANS-TYPE.

           IF (WF1-TRANS-TYPE = "1")
               MOVE "P"                   TO R1G3-ARO-TRANS-TYPE
                                             R1P3-ARO-TRANS-TYPE.

           IF (WF1-TRANS-TYPE = "2")
               MOVE "C"                   TO R1G3-ARO-TRANS-TYPE
                                             R1P3-ARO-TRANS-TYPE.

           IF (WF1-TRANS-TYPE = "6")
               MOVE "B"                   TO R1G3-ARO-TRANS-TYPE
                                             R1P3-ARO-TRANS-TYPE.

           IF (WF1-SUM-LINE = "Y")
               MOVE WF1-COMPANY           TO DB-COMPANY
               IF (WF1-TRANS-TYPE = "3")
                   MOVE "I"               TO DB-TRANS-TYPE
               ELSE IF (WF1-TRANS-TYPE = "4")
                   MOVE "D"               TO DB-TRANS-TYPE
               ELSE IF (WF1-TRANS-TYPE = "2")
                   MOVE "C"               TO DB-TRANS-TYPE
               END-IF
               END-IF
               END-IF
               MOVE WF1-INVOICE               TO DB-INVOICE
               PERFORM 840-FIND-ARHSET1
               IF (AROIHDR-FOUND)
                   IF (ARH-TRAN-AMT NOT = WF1-TRAN-AMT)
                       MOVE "*"               TO WF1-APPL
                   END-IF
               END-IF
           END-IF.

           MOVE WF1-APPL                  TO R1G3-APPL-FLAG
                                             R1P3-APPL-FLAG.
           MOVE WF1-FUTURE                TO R1G3-FUTURE-FL
                                             R1P3-FUTURE-FL.

           IF  (WF1-TRANS-TYPE            = "3" OR "4" OR "6")
           AND (WF1-CR-INVOICE          = SPACES)
               PERFORM 1080-DO-UPDATE-FOR
               THRU    1080-END.

           MOVE WF1-AGE-PERIOD    TO ZR900WS-PER.
           IF  (R1G3-ARO-TRANS-TYPE = "C")
           AND (PRM-CUSTOMER        = SPACES)
           AND (PRM-MATRIX-LIST     = SPACES)
           AND (PRM-CREDIT-ANLYST   = SPACES)
           AND (PRM-MAJ-CLASS       = SPACES)
           AND (PRM-MIN-CLASS       = SPACES)
           AND (PRM-NA-SUMM         = "N")
           AND (PRM-AGE-AGE-CREDITS = "L")
               MOVE ZR900WS-L-PER   TO ZR900WS-PER.

           IF  (R1G3-ARO-TRANS-TYPE = "P")
           AND (PRM-CUSTOMER        = SPACES)
           AND (PRM-MATRIX-LIST     = SPACES)
           AND (PRM-CREDIT-ANLYST   = SPACES)
           AND (PRM-MAJ-CLASS       = SPACES)
           AND (PRM-MIN-CLASS       = SPACES)
           AND (PRM-NA-SUMM         = "N")
           AND (PRM-AGE-AGE-PYMNT   = "L")
               MOVE ZR900WS-L-PER   TO ZR900WS-PER.

           IF  (R1G3-ARO-TRANS-TYPE = "C")
           AND (WF1-SUM-LINE        = "Y")
           AND (PRM-AGE-AGE-CREDITS = "L")
               MOVE ZR900WS-L-PER   TO ZR900WS-PER.

           MOVE WF1-TRAN-AMT      TO ZR900WS-PRINT-AMT (ZR900WS-PER).
           ADD  WF1-TRAN-AMT      TO ZR900WS-CUSTOMER-AMT (ZR900WS-PER).
           MOVE ZEROES            TO ZR900WS-DISPUTE-AMT.

J56704     IF (PRM-REPORT-OPTION = "B") 
               ADD WF1-TRAN-AMT   TO ZR900WS-BILLTO-AMT (ZR900WS-PER).

           IF  (PRM-AGE-AGE-DISPUTES    = "N")
           AND (ZR900WS-PER         NOT  = 2)
                IF (WF1-DISPUTE-SEQ NOT = ZEROS)
                    IF (WF1-DISPUTE-AMT > WF1-AMOUNT)
                    OR (WF1-DISPUTE-AMT = WF1-AMOUNT)
                        MOVE WF1-TRAN-AMT   TO WF1-DISPUTE-AMT
                        IF (WF1-DISPUTE-TYPE = "C")
                            COMPUTE WF1-DISPUTE-AMT = WF1-DISPUTE-AMT
                                                    * NEGATIVE-ONE
                        END-IF
                    END-IF
                    IF (WF1-DISPUTE-TYPE   = "D" OR "I")
                        ADD WF1-DISPUTE-AMT  TO ZR900WS-PRINT-AMT (2)
                        ADD WF1-DISPUTE-AMT  TO ZR900WS-CUSTOMER-AMT (2)
                        SUBTRACT WF1-DISPUTE-AMT 
                                    FROM ZR900WS-PRINT-AMT (ZR900WS-PER)
                        SUBTRACT WF1-DISPUTE-AMT 
                                FROM ZR900WS-CUSTOMER-AMT (ZR900WS-PER)
                    END-IF
                    IF (WF1-DISPUTE-TYPE   = "C")
                        SUBTRACT WF1-DISPUTE-AMT
                                           FROM ZR900WS-PRINT-AMT (2)
                        SUBTRACT WF1-DISPUTE-AMT
                                           FROM ZR900WS-CUSTOMER-AMT (2)
                        ADD WF1-DISPUTE-AMT 
                                    TO ZR900WS-PRINT-AMT (ZR900WS-PER)
                        ADD WF1-DISPUTE-AMT 
                                TO ZR900WS-CUSTOMER-AMT (ZR900WS-PER).

           IF (PRM-DETAIL-OPTION NOT = "Y" AND "A")
               GO TO 1060-NEXT-RECORD.

           IF (PRM-ACO-CURR-DISPLAY       = "T")
               MOVE WF1-ORIG-ND       TO R1G3-OPENAMT-ND
                                         R1G3-1-OPENAMT-ND
                                         R1G3-2-OPENAMT-ND
                                         R1G3-3-OPENAMT-ND
                                         R1G3-4-OPENAMT-ND
                                         R1G3-5-OPENAMT-ND
                                         R1G3-6-OPENAMT-ND
                                         R1G3-7-OPENAMT-ND
                                         R1G3-8-OPENAMT-ND
                                         R1G3-OPENAMT-ND
                                         R1P3-OPENAMT-ND
                                         R1P3-1-OPENAMT-ND
                                         R1P3-2-OPENAMT-ND
                                         R1P3-3-OPENAMT-ND
                                         R1P3-4-OPENAMT-ND
                                         R1P3-5-OPENAMT-ND
                                         R1P3-6-OPENAMT-ND
                                         R1P3-7-OPENAMT-ND
                                         R1P3-8-OPENAMT-ND
                                         R1P3-OPENAMT-ND
           ELSE
               MOVE ACO-BASE-ND       TO R1G3-OPENAMT-ND
                                         R1G3-1-OPENAMT-ND
                                         R1G3-2-OPENAMT-ND
                                         R1G3-3-OPENAMT-ND
                                         R1G3-4-OPENAMT-ND
                                         R1G3-5-OPENAMT-ND
                                         R1G3-6-OPENAMT-ND
                                         R1G3-7-OPENAMT-ND
                                         R1G3-8-OPENAMT-ND
                                         R1P3-OPENAMT-ND
                                         R1P3-1-OPENAMT-ND
                                         R1P3-2-OPENAMT-ND
                                         R1P3-3-OPENAMT-ND
                                         R1P3-4-OPENAMT-ND
                                         R1P3-5-OPENAMT-ND
                                         R1P3-6-OPENAMT-ND
                                         R1P3-7-OPENAMT-ND
                                         R1P3-8-OPENAMT-ND
                                         R1P3-OPENAMT-ND.

           MOVE ZR900WS-PRINT-AMT (1)    TO R1G3-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (2)    TO R1G3-1-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (3)    TO R1G3-2-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (4)    TO R1G3-3-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (5)    TO R1G3-4-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (6)    TO R1G3-5-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (7)    TO R1G3-6-OPENAMT.
CPS001     MOVE ZR900WS-PRINT-AMT (8)    TO R1G3-7-OPENAMT.
CPS001     MOVE ZR900WS-PRINT-AMT (9)    TO R1G3-8-OPENAMT.

           MOVE ZR900WS-PRINT-AMT (1)    TO R1P3-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (2)    TO R1P3-1-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (3)    TO R1P3-2-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (4)    TO R1P3-3-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (5)    TO R1P3-4-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (6)    TO R1P3-5-OPENAMT.
           MOVE ZR900WS-PRINT-AMT (7)    TO R1P3-6-OPENAMT.
CPS001     MOVE ZR900WS-PRINT-AMT (8)    TO R1P3-7-OPENAMT.
CPS001     MOVE ZR900WS-PRINT-AMT (9)    TO R1P3-8-OPENAMT.

J95019     MOVE WF1-DUE-DATE          TO R1G3-DATE.
J95019     MOVE WF1-DUE-DATE          TO R1P3-DATE.

           IF (PRM-AMTS-OPT      = "N")
               IF (WS-INVOICE-22       NOT = WS-INVOICE-11)
J60763         OR (PRM-FORM-OPT            = "2")
                   MOVE R1G3-ARO-TRANS-TYPE    TO R1G4-ARO-TRANS-TYPE
                   MOVE WS-INVOICE-22          TO R1G4-ARO-INVOICE
                   MOVE R1G3-APPL-FLAG         TO R1G4-APPL-FLAG
                   MOVE R1G3-FUTURE-FL         TO R1G4-FUTURE-FL
J95019             MOVE R1G3-DATE              TO R1G4-DATE
                   MOVE R1G3-OPENAMT           TO R1G4-OPENAMT
                   MOVE R1G3-OPENAMT-ND        TO R1G4-OPENAMT-ND
                   MOVE R1G3-1-OPENAMT         TO R1G4-1-OPENAMT
                   MOVE R1G3-1-OPENAMT-ND      TO R1G4-1-OPENAMT-ND
                   MOVE R1G3-2-OPENAMT         TO R1G4-2-OPENAMT
                   MOVE R1G3-2-OPENAMT-ND      TO R1G4-2-OPENAMT-ND
                   MOVE R1G3-3-OPENAMT         TO R1G4-3-OPENAMT
                   MOVE R1G3-3-OPENAMT-ND      TO R1G4-3-OPENAMT-ND
                   MOVE R1G3-4-OPENAMT         TO R1G4-4-OPENAMT
                   MOVE R1G3-4-OPENAMT-ND      TO R1G4-4-OPENAMT-ND
                   MOVE R1G3-5-OPENAMT         TO R1G4-5-OPENAMT
                   MOVE R1G3-5-OPENAMT-ND      TO R1G4-5-OPENAMT-ND
                   MOVE R1G3-6-OPENAMT         TO R1G4-6-OPENAMT
                   MOVE R1G3-6-OPENAMT-ND      TO R1G4-6-OPENAMT-ND
                   MOVE R1G3-7-OPENAMT         TO R1G4-7-OPENAMT
                   MOVE R1G3-7-OPENAMT-ND      TO R1G4-7-OPENAMT-ND
                   MOVE R1G3-8-OPENAMT         TO R1G4-8-OPENAMT
                   MOVE R1G3-8-OPENAMT-ND      TO R1G4-8-OPENAMT-ND
                   MOVE R1G3-BATCH-NBR         TO R1G4-BATCH-NBR
                   MOVE R1G3-PAYMENT-SEQ       TO R1G4-PAYMENT-SEQ
                   MOVE R1GN3D-ARO-DUE-DATE-2  TO RPT-GROUP-REQUEST
               ELSE
                   MOVE R1GN3D-ARO-DUE-DATE    TO RPT-GROUP-REQUEST
           ELSE
               MOVE R1GN3P-ARO-DUE-DATE   TO RPT-GROUP-REQUEST.
 temp *     DISPLAY "Pre1085 Wf1.TranAmt: " WF1-TRAN-AMT
 temp *             " Wf1.Customer: " WF1-CUSTOMER.
 temp *    DISPLAY " Invoice: " WS-INVOICE-22
 temp *            " TrxTyp: " R1G3-ARO-TRANS-TYPE.
P3FX16     MOVE ZEROES                TO WS-TEMP-TOTAL.
P3FX16     MOVE ZEROES                TO WS-TEMP-AMT.
P3FX17*--- Save off orig amount to check for rounding errors later
P3FX17     MOVE WF1-TRX-AMT       TO WS-TEMP-ORIG.
P3FX17     IF (WF1-TRANS-TYPE = "C")
P3FX17     OR (WF1-TRANS-TYPE = "2")
P3FX17         COMPUTE WS-TEMP-ORIG = WS-TEMP-ORIG * -1.
AI0000     PERFORM 1085-DO-PLAN-INFO
AI0000        THRU 1085-END.
           PERFORM 700-PRINT-RPT-GRP.

           IF  (PRM-DETAIL-OPTION      = "A")
               PERFORM 1070-PRINT-ALL-DETAIL
               THRU    1070-END.

       1060-NEXT-RECORD.
           MOVE WF1-ORIG-ND           TO ZR900WS-ORIG-ND.
           PERFORM 8600-FIND-NEXT-ZR9001WORK.

       1060-END.

      ******************************************************************
       1070-PRINT-ALL-DETAIL.
      ******************************************************************

           MOVE WF1-COMPANY            TO DB-COMPANY.
           MOVE WF1-CUSTOMER           TO DB-CUSTOMER.
           MOVE "T"                    TO DB-CMMT-TYPE.
           MOVE R1P3-ARO-TRANS-TYPE    TO DB-TRANS-TYPE.
           MOVE WF1-INVOICE            TO DB-INVOICE.
           MOVE WF1-BATCH-NBR          TO DB-BATCH-NBR.
           MOVE ZEROS                  TO DB-BEG-DATE
                                          DB-SEQ-NUMBER.
           MOVE CMTSET2-INVOICE        TO WS-DB-BEG-RNG.
           PERFORM 850-FIND-BEGRNG-CMTSET2.
           PERFORM 1071-PRINT-ARCOMMENTS
           THRU    1071-END
               UNTIL (ARCOMMENT-NOTFOUND).

           IF (DB-TRANS-TYPE            = "C")
               MOVE WF1-COMPANY         TO DB-CR-COMPANY
               MOVE WF1-CUSTOMER        TO DB-CR-CUSTOMER
               MOVE DB-TRANS-TYPE       TO DB-CR-TYPE
               MOVE WF1-INVOICE         TO DB-CR-NBR
               MOVE WF1-PAYMENT-SEQ     TO DB-CR-PYMNT-SEQ
               MOVE ARASET3-CR-PYMNT-SEQ TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-ARASET3
               PERFORM 1072-CREDIT-APPLICATIONS
               THRU    1072-END
                   UNTIL (ARAPPLIED-NOTFOUND).

           IF (DB-TRANS-TYPE            = "I" OR "C" OR "D")
               MOVE WF1-PAYMENT-SEQ     TO DB-PAYMENT-SEQ
               MOVE ARASET1-PAYMENT-SEQ TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-ARASET1
               PERFORM 1073-APPLICATIONS
               THRU    1073-END
                   UNTIL (ARAPPLIED-NOTFOUND).

           IF (DB-TRANS-TYPE            = "P")
               MOVE WF1-COMPANY         TO DB-CR-COMPANY
               MOVE WF1-BATCH-NBR       TO DB-CR-BATCH
               MOVE WF1-PAYMENT-SEQ     TO DB-CR-PYMNT-SEQ
               MOVE ARASET2-CR-PYMNT-SEQ TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-ARASET2
               PERFORM 1074-PAYMENT-APPLICATIONS
               THRU    1074-END
                   UNTIL (ARAPPLIED-NOTFOUND).

           IF (WF1-XREF-NBR            NOT = SPACES)
               MOVE WF1-XREF-COMPANY   TO D4-XREF-COMPANY
               MOVE WF1-XREF-TYPE      TO D4-XREF-TYPE
               MOVE WF1-XREF-NBR       TO D4-XREF-NBR
               MOVE D4-X-REFERENCE     TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (WF1-DESC                NOT = SPACES)
           OR (WF1-CUST-PO-NBR         NOT = SPACES)
               MOVE WF1-DESC           TO D5-DESC
               MOVE WF1-CUST-PO-NBR    TO D5-CUST-PO-NBR
               MOVE D5-DETAIL-INFO     TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (WF1-ORIG-CURRENCY       NOT = ACO-CURRENCY-CD)
           OR (WF1-SUM-LINE            = "Y")
           OR (WF1-ACTIVITY            NOT = SPACES)
               MOVE WF1-ORIG-CURRENCY  TO D6-ORIG-CURRENCY
               MOVE WF1-SUM-LINE       TO D6-SUM-LINE
               MOVE WF1-ACTIVITY       TO D6-ACTIVITY
               MOVE D6-DETAIL-INFO     TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

      *** Transferred
           IF (WF1-TRANSFER-FLAG         = "F")
               IF (WF1-PARTIAL-TXFR      = ZEROES)
                   MOVE WF1-CUST           TO D8-CUSTOMER
                   MOVE WF1-TRANSFER-DATE  TO D8-CANCEL-DATE
                   MOVE D8-TRANSFER-TO     TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP
               ELSE
                   MOVE WF1-ORIG-ND          TO D7P-PARTIAL-TXFR-ND
                   MOVE WF1-PARTIAL-TXFR     TO D7P-PARTIAL-TXFR
                   MOVE WF1-CUST             TO D7P-TO-CUSTOMER
                   MOVE WF1-TRANSFER-DATE    TO D7P-TRANSFER-DATE
                   MOVE D7-PARTIAL-TXFR-FROM TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP.

           IF (WF1-TRANSFER-FLAG         = "T")
               MOVE WF1-CUST           TO D7-CUSTOMER
               MOVE WF1-TRANSFER-DATE  TO D7-CANCEL-DATE
               MOVE D7-TRANSFER-FROM   TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (WF1-TRANSFER-FLAG         = "N")
               MOVE WF1-TRANSFER-DATE  TO D9-CANCEL-DATE
               MOVE D9-TRANSFER-NON-AR TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

      *** RTM Payment
           IF (WF1-CANCEL-DATE     NOT = ZEROES)
               MOVE WF1-CANCEL-DATE    TO D10-CANCEL-DATE
               MOVE D10-RTM-PAYMENT    TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF  (DB-TRANS-TYPE          = "I" OR "C" OR "D")
           AND (WF1-DISPUTE-EXISTS     = "Y")
               MOVE WF1-PAYMENT-SEQ    TO DB-PAYMENT-SEQ
               IF (WF1-PAYMENT-SEQ     = ZEROS)
                   MOVE ADPSET1-INVOICE    TO WS-DB-BEG-RNG
               ELSE
                   MOVE ADPSET1-PAYMENT-SEQ TO WS-DB-BEG-RNG
               END-IF
               PERFORM 850-FIND-BEGRNG-ADPSET1
               PERFORM
                   UNTIL (ARDISPUTE-NOTFOUND)
                   IF (ADP-RESOLV-DATE     = ZEROS)
                       MOVE ADP-DISPUTE-DATE    TO D11-DISPUTE-DATE
                       MOVE ADP-DISPUTE-CD      TO D11-DISPUTE-CD
                       IF (PRM-ACO-CURR-DISPLAY = "B")
                           MOVE ADP-DISPUTE-AMT TO D11-DISPUTE-AMOUNT
                       ELSE
                           MOVE ADP-ORIG-DISP   TO D11-DISPUTE-AMOUNT
                       END-IF
                       MOVE D11-DISPUTE         TO RPT-GROUP-REQUEST
                       PERFORM 700-PRINT-RPT-GRP
                   END-IF
                   PERFORM 860-FIND-NXTRNG-ADPSET1
               END-PERFORM.

      *** Pending Applications
           MOVE WF1-PAYMENT-SEQ        TO DB-PAYMENT-SEQ.

           IF (DB-TRANS-TYPE           = "P")
               MOVE WF1-COMPANY        TO DB-CR-COMPANY
               MOVE WF1-BATCH-NBR      TO DB-CR-BATCH
               MOVE WF1-PAYMENT-SEQ    TO DB-CR-PYMNT-SEQ
               MOVE ASGSET3-CR-PYMNT-SEQ   TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-ASGSET3
               IF (ARSAPPLIED-FOUND)
                   MOVE P1-APPLICATIONS    TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP
               END-IF
           ELSE
           IF (DB-TRANS-TYPE           = "I" OR "C" OR "D")
               PERFORM 840-KFIND-ASGSET2
               IF (ARSAPPLIED-KFOUND)
                   MOVE P1-APPLICATIONS    TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP.

      *** Pending AP Interface
           IF (DB-TRANS-TYPE           = "P")
               PERFORM 840-KFIND-AAISET3
               IF (ARAPSELECT-KFOUND)
                   MOVE P2-AP-INTERFACE    TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP
               END-IF
           ELSE
           IF (DB-TRANS-TYPE           = "I" OR "C" OR "D")
               PERFORM 840-KFIND-AAISET2
               IF (ARAPSELECT-KFOUND)
                   MOVE P2-AP-INTERFACE    TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP.

      *** Pending Reversals
           PERFORM 1075-CHECK-REVERSALS
           THRU    1075-END.

      *** Pending Obligation Grouping
           IF (DB-TRANS-TYPE           = "I" OR "C" OR "D")
               PERFORM 840-KFIND-AOGSET2
               IF (AROBLIGGRP-KFOUND)
                   MOVE P4-TRANS-GROUPING  TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP.

      *** Pending Adjustments
           IF (DB-TRANS-TYPE           = "I" OR "C" OR "D")
               MOVE PNDSET1-PAYMENT-SEQ    TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-PNDSET1
               IF (ARPENDADJ-FOUND)
                   MOVE P5-ADJUSTMENTS     TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP.

      *** Last Dates (Statement, Finance Charge, Adv Dunning)
               IF (WF1-LAST-STA-DATE   NOT = ZEROS)
               OR (WF1-LAST-FC-DATE    NOT = ZEROS)
               OR (WF1-LAST-LTR-DATE   NOT = ZEROS)
                   MOVE WF1-LAST-STA-DATE  TO D11-LAST-STA-DATE
                   MOVE WF1-LAST-FC-DATE   TO D11-LAST-FC-DATE
                   MOVE WF1-LAST-LTR-DATE  TO D11-LAST-LTR-DATE
                   MOVE D11-LAST-DATE      TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP.

      *** User Open Fields
               IF (DB-TRANS-TYPE       = "I" OR "C" OR "D")
                   MOVE WF1-ALT-TYPE   TO DB-TRANS-TYPE
                   PERFORM 840-FIND-ARHSET1
                   IF  (AROIHDR-FOUND)
                   AND ((ARH-TRANS-USER1   NOT = SPACES)
                   OR   (ARH-TRANS-USER2   NOT = SPACES)
                   OR   (ARH-TRANS-USER3   NOT = ZEROS)
                   OR   (ARH-TRANS-USER4   NOT = ZEROS)
                   OR   (ARH-TRANS-USER5   NOT = ZEROS))
                       MOVE ARH-TRANS-USER1 TO U1-TRANS-USER1
J95780                 IF (WF1-SUM-LINE        = "N")
J95780                    MOVE WF1-PAYMENT-SEQ    TO DB-PAYMENT-SEQ
J95780                    PERFORM 840-FIND-AROSET1
J95780                    IF  (AROITEMS-FOUND)
J95780                    AND (ARO-TRANS-USER1 NOT = SPACES)
J95780                        MOVE ARO-TRANS-USER1 TO U1-TRANS-USER1
J95780                    END-IF
J95780                 END-IF
                       MOVE ARH-TRANS-USER2    TO U1-TRANS-USER2
                       MOVE ARH-TRANS-USER3    TO U1-TRANS-USER3
                       MOVE ARH-TRANS-USER4    TO U1-TRANS-USER4
                       MOVE ARH-TRANS-USER5    TO U1-TRANS-USER5
                       MOVE U1-USER-OPEN       TO RPT-GROUP-REQUEST
                       PERFORM 700-PRINT-RPT-GRP.

      *** User Sort Fields
               IF  (DB-TRANS-TYPE       = "I" OR "C" OR "D")
               AND ((WF1-SORT-1      NOT = SPACES)
                OR  (WF1-SORT-2      NOT = SPACES)
                OR  (WF1-SORT-3      NOT = SPACES)
                OR  (WF1-SORT-4      NOT = SPACES))
                   MOVE "F"                    TO IFMXVWS-FUNCTION
                   MOVE ZR900WS-MATRIX-CAT (1) TO IFMXVWS-MATRIX-CAT
                   MOVE ZR900WS-HAS-VALIDATION (1)
                                               TO IFMXVWS-HAS-VALIDATION
                   MOVE ZR900WS-DATA-TYPE  (1) TO IFMXVWS-DATA-TYPE
                   MOVE ZR900WS-FIELD-SIZE (1) TO IFMXVWS-SIZE
                   IF (WF1-SORT-1              = SPACES)
                       MOVE SPACES             TO U2-USER-SORT1
                   ELSE
                       MOVE WF1-SORT-1         TO IFMXVWS-VALUE-IN
                       PERFORM 2000-EDIT-FMT-MX-VALUE-70
                       MOVE IFMXVWS-VALUE-OUT  TO U2-USER-SORT1
                   END-IF
                   MOVE ZR900WS-COL-HEAD (1)   TO U2-COL-HEADING1

                   MOVE "F"                    TO IFMXVWS-FUNCTION
                   MOVE ZR900WS-MATRIX-CAT (2) TO IFMXVWS-MATRIX-CAT
                   MOVE ZR900WS-HAS-VALIDATION (2)
                                               TO IFMXVWS-HAS-VALIDATION
                   MOVE ZR900WS-DATA-TYPE  (2) TO IFMXVWS-DATA-TYPE
                   MOVE ZR900WS-FIELD-SIZE (2) TO IFMXVWS-SIZE
                   IF (WF1-SORT-2              = SPACES)
                       MOVE SPACES             TO U2-USER-SORT2
                   ELSE
                       MOVE WF1-SORT-2         TO IFMXVWS-VALUE-IN
                       PERFORM 2000-EDIT-FMT-MX-VALUE-70
                       MOVE IFMXVWS-VALUE-OUT  TO U2-USER-SORT2
                   END-IF
                   MOVE ZR900WS-COL-HEAD (2)   TO U2-COL-HEADING2

                   MOVE "F"                    TO IFMXVWS-FUNCTION
                   MOVE ZR900WS-MATRIX-CAT (3) TO IFMXVWS-MATRIX-CAT
                   MOVE ZR900WS-HAS-VALIDATION (3)
                                               TO IFMXVWS-HAS-VALIDATION
                   MOVE ZR900WS-DATA-TYPE  (3) TO IFMXVWS-DATA-TYPE
                   MOVE ZR900WS-FIELD-SIZE (3) TO IFMXVWS-SIZE
                   IF (WF1-SORT-3              = SPACES)
                       MOVE SPACES             TO U2-USER-SORT3
                   ELSE
                       MOVE WF1-SORT-3         TO IFMXVWS-VALUE-IN
                       PERFORM 2000-EDIT-FMT-MX-VALUE-70
                       MOVE IFMXVWS-VALUE-OUT  TO U2-USER-SORT3
                   END-IF
                   MOVE ZR900WS-COL-HEAD (3)   TO U2-COL-HEADING3

                   MOVE "F"                    TO IFMXVWS-FUNCTION
                   MOVE ZR900WS-MATRIX-CAT (4) TO IFMXVWS-MATRIX-CAT
                   MOVE ZR900WS-HAS-VALIDATION (4)
                                               TO IFMXVWS-HAS-VALIDATION
                   MOVE ZR900WS-DATA-TYPE  (4) TO IFMXVWS-DATA-TYPE
                   MOVE ZR900WS-FIELD-SIZE (4) TO IFMXVWS-SIZE
                   IF (WF1-SORT-4              = SPACES)
                       MOVE SPACES             TO U2-USER-SORT4
                   ELSE
                       MOVE WF1-SORT-4         TO IFMXVWS-VALUE-IN
                       PERFORM 2000-EDIT-FMT-MX-VALUE-70
                       MOVE IFMXVWS-VALUE-OUT  TO U2-USER-SORT4
                   END-IF
                   MOVE ZR900WS-COL-HEAD (4)   TO U2-COL-HEADING4

                   MOVE U2-USER-SORT          TO RPT-GROUP-REQUEST
                   PERFORM 700-PRINT-RPT-GRP.

      *** Trans User Fields
               IF (DB-TRANS-TYPE       = "I" OR "C" OR "D")
                   PERFORM 840-FIND-TUFSET1
                   IF (ARARHUF-FOUND)
                       MOVE TUF-ARH-USR-FLD-01 TO U3-ARH-USR-FLD-01
                       MOVE TUF-ARH-USR-FLD-02 TO U3-ARH-USR-FLD-02
                       MOVE TUF-ARH-USR-FLD-03 TO U3-ARH-USR-FLD-03
                       MOVE TUF-ARH-USR-FLD-04 TO U3-ARH-USR-FLD-04
                       MOVE TUF-ARH-USR-FLD-05 TO U3-ARH-USR-FLD-05
                       MOVE U3-TRANS-HEADER    TO RPT-GROUP-REQUEST
                       PERFORM 700-PRINT-RPT-GRP.

      *** Payment Header User Fields
               IF (DB-TRANS-TYPE       = "P")
                   PERFORM 840-FIND-BUFSET1
                   IF (ARAPHUF-FOUND)
                       MOVE BUF-APH-USR-FLD-01 TO U4-APH-USR-FLD-01
                       MOVE BUF-APH-USR-FLD-02 TO U4-APH-USR-FLD-02
                       MOVE BUF-APH-USR-FLD-03 TO U4-APH-USR-FLD-03
                       MOVE BUF-APH-USR-FLD-04 TO U4-APH-USR-FLD-04
                       MOVE BUF-APH-USR-FLD-05 TO U4-APH-USR-FLD-05
                       MOVE U4-APH-USER-FIELDS TO RPT-GROUP-REQUEST
                       PERFORM 700-PRINT-RPT-GRP.

      *** Payment User Fields
               IF (DB-TRANS-TYPE       = "P")
                   PERFORM 840-FIND-PUFSET1
                   IF (ARAPMUF-FOUND)
                       MOVE PUF-APM-USR-FLD-01 TO U5-APM-USR-FLD-01
                       MOVE PUF-APM-USR-FLD-02 TO U5-APM-USR-FLD-02
                       MOVE PUF-APM-USR-FLD-03 TO U5-APM-USR-FLD-03
                       MOVE PUF-APM-USR-FLD-04 TO U5-APM-USR-FLD-04
                       MOVE PUF-APM-USR-FLD-05 TO U5-APM-USR-FLD-05
                       MOVE U5-APM-USER-FIELDS TO RPT-GROUP-REQUEST
                       PERFORM 700-PRINT-RPT-GRP.

       1070-END.
      ******************************************************************
       1071-PRINT-ARCOMMENTS.
      ******************************************************************

           IF (CMT-PRINT-CODE          NOT =  "P" AND "B")
               GO TO 1071-NEXT.

           MOVE ZR900WS-D1-LABEL       TO D1-LABEL.

           INITIALIZE WS-CMTCMT.
           PERFORM 900-FIND-BEGRNG-CMT-ARCOMMENT.
                PERFORM 
                  UNTIL (CMTCMT-NOTFOUND)
                      MOVE WS-CMT-SIZE     TO CMTCMT-EXT-TEXT-SZ
                      SET  CMTCMT-SOFT-RTN TO TRUE
                      SET  CMTCMT-HARD-RTN TO TRUE
                      IF (CMTCMT-NOT-EOT)
                          PERFORM 900-GET-TEXT-CMT-ARCOMMENT
                      PERFORM
                        UNTIL (CMTCMT-EOT) 
                            INSPECT CMTCMT-EXT-TEXT  REPLACING ALL
                                                     WS-HEX-A
                                                     BY SPACES
                            MOVE CMTCMT-EXT-TEXT     TO D1-COMMENT
                            MOVE D1-COMMENTS        TO RPT-GROUP-REQUEST
                            PERFORM 700-PRINT-RPT-GRP
                            MOVE SPACES             TO D1-LABEL
                            PERFORM 900-GET-TEXT-CMT-ARCOMMENT
                      END-PERFORM
                      PERFORM 900-FIND-NXTRNG-CMT-ARCOMMENT
                END-PERFORM.

       1071-NEXT.
           PERFORM 860-FIND-NXTRNG-CMTSET2.

       1071-END.
      ******************************************************************
       1072-CREDIT-APPLICATIONS.
      ******************************************************************

           IF (ARA-STATUS     = ZEROS)
               GO TO 1072-NEXT.

           IF (ARA-CR-APP-AMT          NOT = ZEROS)
               MOVE ARA-GL-DATE        TO D2-GL-DATE
               MOVE ARA-TRANS-TYPE     TO D2-TRANS-TYPE
               MOVE ARA-INVOICE        TO D2-TRANSACTION
               IF (PRM-ACO-CURR-DISPLAY = "B")
                   MOVE ARA-APPLD-AMT      TO D2-APPLD-AMT
                   MOVE WF1-ORIG-ND        TO D2-APPLD-AMT-ND
               ELSE
                   MOVE ARA-ORIG-APP-AMT   TO D2-APPLD-AMT
                   MOVE WF1-ORIG-ND        TO D2-APPLD-AMT-ND
               END-IF
               MOVE D2-APPLICATIONS TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.


       1072-NEXT.
            PERFORM 860-FIND-NXTRNG-ARASET3.

       1072-END.
      ******************************************************************
       1073-APPLICATIONS.
      ******************************************************************

           IF (ARA-STATUS     = ZEROS)
               GO TO 1073-NEXT.

           IF (ARA-APPLD-AMT           NOT = ZEROS)
               MOVE ARA-GL-DATE        TO D2-GL-DATE
               MOVE ARA-CR-TYPE        TO D2-TRANS-TYPE
               MOVE ARA-CR-NBR         TO D2-TRANSACTION
               IF (PRM-ACO-CURR-DISPLAY = "B")
                   MOVE ARA-APPLD-AMT      TO D2-APPLD-AMT
                   MOVE WF1-ORIG-ND        TO D2-APPLD-AMT-ND
               ELSE
                   MOVE ARA-ORIG-APP-AMT   TO D2-APPLD-AMT
                   MOVE WF1-ORIG-ND        TO D2-APPLD-AMT-ND
               END-IF
               MOVE D2-APPLICATIONS TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (ARA-ADJ-SEQ         NOT = ZEROS)
               MOVE ARA-PAYMENT-SEQ    TO DB-PAYMENT-SEQ
               MOVE ARA-BATCH-NBR      TO DB-BATCH-NBR
               MOVE ARA-APP-SEQ        TO DB-APP-SEQ
               MOVE ADJSET1-APP-SEQ    TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-ADJSET1
               PERFORM
                   UNTIL (ARADJUST-NOTFOUND)
                       IF (PRM-ACO-CURR-DISPLAY = "B")
                           MOVE ADJ-ADJ-AMT        TO D3-ADJ-AMT
                           MOVE WF1-ORIG-ND        TO D3-ADJ-AMT-ND
                       ELSE
                           MOVE ADJ-ORIG-ADJ-AMT   TO D3-ADJ-AMT
                           MOVE WF1-ORIG-ND        TO D3-ADJ-AMT-ND
                       END-IF
                       MOVE ARA-GL-DATE            TO D3-GL-DATE
                       MOVE ADJ-REASON-CODE        TO D3-REASON-CODE
                       MOVE D3-ADJUSTMENTS  TO RPT-GROUP-REQUEST
                       PERFORM 700-PRINT-RPT-GRP

                       PERFORM 860-FIND-NXTRNG-ADJSET1
               END-PERFORM.

       1073-NEXT.
            PERFORM 860-FIND-NXTRNG-ARASET1.

       1073-END.
      ******************************************************************
       1074-PAYMENT-APPLICATIONS.
      ******************************************************************

           IF (ARA-STATUS     = ZEROS)
               GO TO 1074-NEXT.

           IF (ARA-CR-APP-AMT          NOT = ZEROS)
               MOVE ARA-GL-DATE        TO D2-GL-DATE
               MOVE ARA-TRANS-TYPE     TO D2-TRANS-TYPE
               MOVE ARA-INVOICE        TO D2-TRANSACTION
               IF (PRM-ACO-CURR-DISPLAY = "B")
                   MOVE ARA-APPLD-AMT      TO D2-APPLD-AMT
                   MOVE WF1-ORIG-ND        TO D2-APPLD-AMT-ND
               ELSE
                   MOVE ARA-ORIG-APP-AMT   TO D2-APPLD-AMT
                   MOVE WF1-ORIG-ND        TO D2-APPLD-AMT-ND
               END-IF
               MOVE D2-APPLICATIONS TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.

           IF (ARA-ADJ-SEQ         NOT = ZEROS)
           AND (ARA-TRANS-TYPE         = "P")
               MOVE ARA-COMPANY        TO DB-COMPANY
               MOVE ARA-TRANS-TYPE     TO DB-TRANS-TYPE
               MOVE ARA-INVOICE        TO DB-INVOICE
               MOVE ARA-PAYMENT-SEQ    TO DB-PAYMENT-SEQ
               MOVE ARA-BATCH-NBR      TO DB-BATCH-NBR
               MOVE ARA-APP-SEQ        TO DB-APP-SEQ
               MOVE ADJSET1-APP-SEQ    TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-ADJSET1
               PERFORM
                   UNTIL (ARADJUST-NOTFOUND)
                       IF (PRM-ACO-CURR-DISPLAY = "B")
                           MOVE ADJ-ADJ-AMT        TO D3-ADJ-AMT
                           MOVE WF1-ORIG-ND        TO D3-ADJ-AMT-ND
                       ELSE
                           MOVE ADJ-ORIG-ADJ-AMT   TO D3-ADJ-AMT
                           MOVE WF1-ORIG-ND        TO D3-ADJ-AMT-ND
                       END-IF
                       MOVE ARA-GL-DATE            TO D3-GL-DATE
                       MOVE ADJ-REASON-CODE        TO D3-REASON-CODE
                       MOVE D3-ADJUSTMENTS  TO RPT-GROUP-REQUEST
                       PERFORM 700-PRINT-RPT-GRP

                       PERFORM 860-FIND-NXTRNG-ADJSET1
               END-PERFORM.

       1074-NEXT.
            PERFORM 860-FIND-NXTRNG-ARASET2.

       1074-END.
      ******************************************************************
       1075-CHECK-REVERSALS.
      ******************************************************************

           IF (DB-TRANS-TYPE           = "I" OR "C" OR "D")
               MOVE VTDSET1-PAYMENT-SEQ    TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-VTDSET1
               IF (ARTRNRVDTL-FOUND)
                   GO TO 1075-PRINT-REVERSAL-MSG
               END-IF
               MOVE RVTSET2-PAYMENT-SEQ    TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-RVTSET2
               IF (ARPMTRVDTL-FOUND)
                   GO TO 1075-PRINT-REVERSAL-MSG.

           IF (DB-TRANS-TYPE           = "C" OR "P")
               MOVE WF1-COMPANY        TO DB-CR-COMPANY
               MOVE WF1-BATCH-NBR      TO DB-CR-BATCH-NBR
               MOVE DB-TRANS-TYPE      TO DB-CR-TRANS-TYPE
               IF (DB-TRANS-TYPE       = "C")
                   MOVE WF1-INVOICE    TO DB-CR-INVOICE
               ELSE
                   MOVE WF1-INVOICE    TO DB-CR-TRANS-NBR
               END-IF
               MOVE WF1-PAYMENT-SEQ    TO DB-PAYMENT-SEQ
               MOVE VTDSET2-PAYMENT-SEQ    TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-VTDSET2
               IF (ARTRNRVDTL-FOUND)
                   GO TO 1075-PRINT-REVERSAL-MSG.

           IF (DB-TRANS-TYPE           = "P")
               MOVE WF1-COMPANY        TO DB-CR-COMPANY
               MOVE WF1-BATCH-NBR      TO DB-CR-BATCH-NBR
               MOVE WF1-PAYMENT-SEQ    TO DB-CR-PAYMENT-SEQ
               MOVE RVTSET1-CR-PAYMENT-SEQ    TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-RVTSET1
               IF (ARPMTRVDTL-FOUND)
                   GO TO 1075-PRINT-REVERSAL-MSG.

           GO TO 1075-END.

       1075-PRINT-REVERSAL-MSG.

           MOVE P3-REVERSALS           TO RPT-GROUP-REQUEST.
           PERFORM 700-PRINT-RPT-GRP.

       1075-END.
      ******************************************************************
       1080-DO-UPDATE-FOR.
      ******************************************************************

           MOVE WF1-FOR-PERIOD             TO ZR900WS-PER.
           MOVE WF1-TRAN-AMT               TO ZR900WS-FOR-AMT.
           ADD  WF1-TRAN-AMT          TO ZR900WS-CUST-AMT (ZR900WS-PER).
           COMPUTE ZR900WS-FOR-AMT ROUNDED = ZR900WS-FOR-AMT * WF1-PAST.
           ADD ZR900WS-FOR-AMT   TO ZR900WS-CUST-FOR (ZR900WS-PER).

       1080-END.

AI0000******************************************************************
AI0000 1084-COUNT-ZB3.   
AI0000******************************************************************
AI0000 1084-START.
AI0000
           MOVE ZR900WS-PRM-COMPANY      TO DB-COMPANY.
           MOVE WF1-PROCESS-LEVEL        TO DB-PROCESS-LEVEL.
           IF (WF1-CUSTOMER(3:2) = "ER")
               MOVE WF1-CUSTOMER(5:5)    TO DB-PROCESS-LEVEL
           END-IF.
           MOVE WF1-INVOICE(1:10)        TO DB-INVOICE.
           MOVE ZB3SET1-INVOICE          TO WS-DB-BEG-RNG.
           MOVE ZEROS                    TO WS-TEMP-ZB3-CNT.
           PERFORM 850-FIND-BEGRNG-ZB3SET1.
           PERFORM UNTIL (PBHSTDTL-NOTFOUND)
               IF (ZB3-RECORD-TYPE NOT = "O")
                   MOVE SPACES                   TO DB-DTL-KEY        
                   MOVE WS-LEVEL-1              TO DB-LVL-1-KEY  
                   MOVE "INV-TO-PBHST"           TO DB-LVL-2-KEY  
                   MOVE SPACES                   TO DB-LVL-3-KEY  
                   STRING ZB3-PLAN-TYPE          DELIMITED BY SPACE
                          "^"                    DELIMITED BY SIZE
                          ZB3-PLAN-CODE          DELIMITED BY SPACE
                                          INTO DB-DTL-KEY 
                   PERFORM 840-FIND-IF1SET1
                   IF (IF1-DTL-VALUE = WF1-DESC)
                       ADD 1 TO WS-TEMP-ZB3-CNT
                   END-IF
               END-IF
               PERFORM 860-FIND-NXTRNG-ZB3SET1.

P3FX20 1084-END.
AI0000******************************************************************
AI0000 1085-DO-PLAN-INFO.
AI0000******************************************************************
AI0000 1085-START.
AI0000
P3FX20*---Count PBHSTDTL
P3FX20    PERFORM 1084-COUNT-ZB3
P3FX20    THRU    1084-END.
P3FX20*    DISPLAY "1085 ZB3 Count: " WS-TEMP-ZB3-CNT.
P2FX20
           INITIALIZE                       WS-ZB3-PLAN-TYPE
                                            WS-ZB3-PLAN-CODE
                                            WS-ZB3-PROCESS-LVL
                                            WS-ZB3-BILLABLE-AMT
                                            WS-ZB3-REMAINDER
                                            WS-LW-BILL-ITEM
                                            WS-INVOICE-TOT
                                            WS-PAST-DUE-TOT
                                            WS-LW-STATUS.
           COMPUTE WS-INVOICE-TOT =  ZR900WS-PRINT-AMT (1)
                                  +  ZR900WS-PRINT-AMT (2)
                                  +  ZR900WS-PRINT-AMT (3)
                                  +  ZR900WS-PRINT-AMT (4)
                                  +  ZR900WS-PRINT-AMT (5)
                                  +  ZR900WS-PRINT-AMT (6)
                                  +  ZR900WS-PRINT-AMT (7)
                                  +  ZR900WS-PRINT-AMT (8)
                                  +  ZR900WS-PRINT-AMT (9).
      *    COMPUTE WS-PAST-DUE-TOT = ZR900WS-PRINT-AMT (3)
           COMPUTE WS-PAST-DUE-TOT = ZR900WS-PRINT-AMT (4)
                                   + ZR900WS-PRINT-AMT (5)
                                   + ZR900WS-PRINT-AMT (6)
                                   + ZR900WS-PRINT-AMT (7)
                                   + ZR900WS-PRINT-AMT (8)
                                   + ZR900WS-PRINT-AMT (9).

           IF (WS-PAST-DUE-TOT > ZERO)
               MOVE "W"           TO WS-LW-STATUS
           END-IF.
           IF (WF1-CUSTOMER(3:2) = "ER")
               IF (ZR900WS-PRINT-AMT (4) > 0 )
                   MOVE "3"       TO WS-LW-STATUS
               END-IF
               IF (ZR900WS-PRINT-AMT (5) > 0 )
                   MOVE "6"       TO WS-LW-STATUS
               END-IF
               IF (ZR900WS-PRINT-AMT (6) > 0 )
                   MOVE "9"       TO WS-LW-STATUS
               END-IF
               IF (ZR900WS-PRINT-AMT (7) > 0 )
                   MOVE "2"       TO WS-LW-STATUS
               END-IF
               IF (ZR900WS-PRINT-AMT (8) > 0 )
                   MOVE "5"       TO WS-LW-STATUS
               END-IF
               IF (ZR900WS-PRINT-AMT (9) > 0 )
                   MOVE "7"       TO WS-LW-STATUS
               END-IF
           END-IF.
           IF (ACM-ACTIVE-STATUS NOT = "A")
               MOVE "T"           TO WS-LW-STATUS
           END-IF.
      *--- Reset Keys for PBHSTDTL processing
      *--- Processing will loop through all PBHSTDTL for current
      *--- invoice and create balance work file records
           MOVE ZR900WS-PRM-COMPANY      TO DB-COMPANY.
           MOVE WF1-PROCESS-LEVEL        TO DB-PROCESS-LEVEL.
           IF (WF1-CUSTOMER(3:2) = "ER")
               MOVE WF1-CUSTOMER(5:5)    TO DB-PROCESS-LEVEL
           END-IF.
           MOVE WF1-INVOICE(1:10)        TO DB-INVOICE.
           MOVE ZB3SET1-INVOICE          TO WS-DB-BEG-RNG.
           PERFORM 850-FIND-BEGRNG-ZB3SET1.
      *--- Create workfile record for credit and debit memos
      *--- that do not have PBHSTDTL
debug *     DISPLAY "1085-pbhstdtl: " ZB3-INVOICE " " ZB3-REASON-CODE
debug *       " " ZB3-BILLABLE-AMT.
           IF (PBHSTDTL-NOTFOUND)
RETROX*    OR (WF1-TRANS-TYPE = "2")  - 1/19 - Disabled this
      *--- Create workfile record for credit and debit memos
      *--- that do not have PBHSTDTL
               MOVE "conversionManAdj"   TO WS-LW-BILL-ITEM
               INITIALIZE                   WS-LW-BENEFIT
                                            WS-LW-PLAN
                                            WS-LW-OPTION
P3FX04         IF (WF1-TRANS-TYPE = "C")
P3FX04             COMPUTE WS-INVOICE-TOT  = WS-INVOICE-TOT * -1
P3FX04         END-IF
               MOVE WS-INVOICE-TOT       TO WS-ZB3-BILLABLE-AMT
               MOVE WS-INVOICE-TOT       TO WF1-TRX-AMT 
               IF (WF1-CUSTOMER(1:1) = "D")
CPS001             MOVE WF1-CUSTOMER(2:6) TO WS-TMP-NBR-A
CPS001             IF (WF1-CUSTOMER(2:6)  NOT NUMERIC)
CPS001                 MOVE ZEROES         TO WS-TMP-NBR-A
AI0000             END-IF
AI0000             MOVE WS-TMP-NBR-A       TO JSTWS-STR
AI0000             MOVE 6                  TO JSTWS-STR-LEN
AI0000             MOVE 9                  TO JSTWS-STR-OUT-LEN
AI0000             SET JSTWS-NUMERIC TO TRUE
AI0000             PERFORM 2000-JUSTIFY-OBJECT
AI0000             MOVE JSTWS-STR-OUT      TO WS-WF2-CUSTOMER
AI0000         END-IF
P3FX16*         INITIALIZE                       WS-TEMP-TOTAL
               PERFORM 1090-DO-AGING-BUCKETS
                  THRU 1090-END
               IF (WS-INVOICE-TOT < 0)
                   PERFORM 1092-DO-REC84WRK
                      THRU 1092-END
               ELSE
                   PERFORM 1089-DO-ZR9002WORK
                   THRU 1089-END
               END-IF
             ELSE
P3FX05     IF (WF1-TRANS-TYPE = "C")
P3FX05     OR (WF1-TRANS-TYPE = "2")
P3FX05         COMPUTE WF1-TRX-AMT = WF1-TRX-AMT * -1.
DB0001*--- PBHSTDTL exists process Direct Billed customers
DB0001*--- separetly because PBHSTDTLs are different for them
DB0001         IF (WF1-CUSTOMER(1:1) = "D")
DB0001             PERFORM 1086-DO-PBHSTDTL-D
DB0001             THRU    1086-END
DB0001         ELSE
                 PERFORM 1087-DO-PBHSTDTL
                 THRU 1087-END
                   UNTIL (PBHSTDTL-NOTFOUND).

AI0000 1085-END.
DB0001******************************************************************
DB0001 1086-DO-PBHSTDTL-D.
DB0001******************************************************************
DB0001
DB0001
DB0001*--- PBHSTDTL for direct billed customers are ordered by ZB3SETw2
DB0001*--- so the most recent EFF-BILL-DT is for 01, then next is for 02, etc
DB0001*--- so we'll build an arry of pbhstdtl in order and save the record
DB0001*--- keys to then call 1087 for that date based on the invoice suffix
DB0001*--- of 01, 02, etc                     
DB0001*--- Reset Keys for PBHSTDTL processing
DB0001*--- Processing will loop through all PBHSTDTL for current
DB0001*--- invoice and create balance work file records
DB0001     PERFORM VARYING I1 FROM 1 BY 1
DB0001     UNTIL (I1 > 999)
DB0001         MOVE ZEROES             TO WS-ZB3-COMPANY(I1)       
DB0001         MOVE ZEROES             TO WS-ZB3-EMPLOYEE(I1)      
DB0001         MOVE ZEROES             TO WS-ZB3-EFF-BILL-DT(I1)   
DB0001         MOVE SPACES             TO WS-ZB3-PROCESS-LEVEL(I1) 
DB0001         MOVE SPACES             TO WS-ZB3-INVOICE(I1)       
DB0001         MOVE ZEROES             TO WS-ZB3-LINE-NBR(I1).
DB0001
P3FX18*--- Lookup benefit for pbhstdtl plan type and code
P3FX18*--- and compare to WF4-DESC from invoice
           MOVE SPACES                   TO DB-DTL-KEY. 
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY. 
           MOVE "INV-TO-PBHST"           TO DB-LVL-2-KEY. 
           MOVE SPACES                   TO DB-LVL-3-KEY. 
           STRING ZB3-PLAN-TYPE          DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  ZB3-PLAN-CODE          DELIMITED BY SPACE
                                  INTO DB-DTL-KEY.
           PERFORM 840-FIND-IF1SET1.
           IF (LUPTBLDTL-NOTFOUND)
                DISPLAY "****ERROR : Missing INV-TO-PBHST for: " 
                  DB-DTL-KEY 
                 "on Invoice: " WF1-INVOICE " for Customer " 
                  WF1-CUSTOMER 
P3FX18     END-IF.
DB0001     MOVE ZR900WS-PRM-COMPANY      TO DB-COMPANY.
DB0001     MOVE WF1-CUSTOMER(2:6)        TO WS-CUST-EMP-A.
DB0001     MOVE WS-CUST-EMP-N            TO DB-EMPLOYEE.   
DB0001     MOVE ZB3SET2-EMPLOYEE        TO WS-DB-BEG-RNG.
DB0001     PERFORM 850-FIND-BEGRNG-ZB3SET2.
DB0001     PERFORM 
DB0001     UNTIL (PBHSTDTL-NOTFOUND)
DB0001     IF (ZB3-RECORD-TYPE NOT = "O")
DB0001       IF (WF1-INVOICE(1:10) = ZB3-INVOICE)
DB0001         PERFORM VARYING I1 FROM 1 BY 1
DB0001         UNTIL (I1 > 999)
DB0001         OR (WS-ZB3-COMPANY(I1) = ZERO)
DB0001         OR ((WS-ZB3-COMPANY(I1) = ZB3-COMPANY)
DB0001         AND (WS-ZB3-EMPLOYEE(I1) = ZB3-EMPLOYEE)
P3FX18         AND (WS-ZB3-BENEFIT(I1) = IF1-DTL-VALUE)
DB0001         AND (WS-ZB3-EFF-BILL-DT(I1) = ZB3-EFF-BILL-DT))
DB0001             ADD 1 TO I7
DB0001         END-PERFORM
DB0001              IF (WS-ZB3-COMPANY(I1) = ZERO)
DB0001                MOVE ZB3-COMPANY        TO WS-ZB3-COMPANY(I1)       
DB0001           MOVE ZB3-EMPLOYEE       TO WS-ZB3-EMPLOYEE(I1)      
DB0001           MOVE ZB3-EFF-BILL-DT    TO WS-ZB3-EFF-BILL-DT(I1)   
P3FX12           MOVE IF1-DTL-VALUE      TO WS-ZB3-BENEFIT(I1)   
DB0001           MOVE ZB3-PROCESS-LEVEL  TO WS-ZB3-PROCESS-LEVEL(I1) 
DB0001           MOVE ZB3-INVOICE        TO WS-ZB3-INVOICE(I1)       
DB0001           MOVE ZB3-LINE-NBR       TO WS-ZB3-LINE-NBR(I1)
DB0001         END-IF
DB0001       PERFORM 860-FIND-NXTRNG-ZB3SET2 
DB0001       ELSE
DB0001       PERFORM 860-FIND-NXTRNG-ZB3SET2 
DB0001      END-IF
DB0001     ELSE
DB0001       PERFORM 860-FIND-NXTRNG-ZB3SET2. 
DB0001
DB0001     MOVE WF1-INVOICE(11:2)  TO WS-INVOICE-SEQ-A.
DB0001     IF (WS-INVOICE-SEQ-A NOT NUMERIC)
DB0001        DISPLAY "ERROR: Invalid Invoice SEQa " WF1-CUSTOMER 
               " " WF1-INVOICE
DB0001        GO TO 1086-END.
DB0001
DB0001     IF (WS-ZB3-COMPANY(WS-INVOICE-SEQ-N) = ZEROS)
DB0001        DISPLAY "ERROR: Invalid Invoice SEQa for PBHSTDTL: "
DB0001        WF1-CUSTOMER " " WF1-INVOICE
DB0001        GO TO 1086-END.
DB0001
DB0001     MOVE WS-INVOICE-SEQ-N        TO I7.
DB0001     MOVE WS-ZB3-COMPANY(I7)      TO DB-COMPANY.
DB0001     MOVE WS-ZB3-PROCESS-LEVEL(I7) TO DB-PROCESS-LEVEL.
DB0001     MOVE WS-ZB3-INVOICE(I7)      TO DB-INVOICE.
DB0001     MOVE ZB3SET1-INVOICE         TO WS-DB-BEG-RNG.
DB0001     PERFORM 850-FIND-BEGRNG-ZB3SET1.
DB0001     PERFORM 
DB0001     UNTIL (PBHSTDTL-NOTFOUND)
DB0001         IF (ZB3-RECORD-TYPE NOT = "O")
DB0001         AND (ZB3-EFF-BILL-DT = WS-ZB3-EFF-BILL-DT(I7))
DB0001             PERFORM 1087-DO-PBHSTDTL
DB0001             THRU 1087-END
DB0001         ELSE
DB0001             PERFORM 860-FIND-NXTRNG-ZB3SET1
DB0001         END-IF
DB0001     END-PERFORM.
DB0001
DB0001 1086-END.
DB0001
DB0001
AI0000******************************************************************
AI0000 1087-DO-PBHSTDTL.
AI0000******************************************************************
AI0000
           IF (ZB3-RECORD-TYPE = "O")
               GO TO 1087-NEXT-PBHSTDTL.
debug *      DISPLAY "1087-pbhstdtl: " ZB3-INVOICE " " ZB3-REASON-CODE
debug *        " " ZB3-BILLABLE-AMT " " ZB3-PLAN-TYPE " " ZB3-PLAN-CODE.

      *--- Process RETROs in separate paragraph                    
RETROS     IF (ZB3-REASON-CODE = "RETR")
               PERFORM 1088-DO-PBHSTDTL-RETRO
               THRU    1088-END 
               GO TO 1087-NEXT-PBHSTDTL.


debug *     DISPLAY "1087-pbhstdtl: " ZB3-INVOICE " " ZB3-REASON-CODE
debug *       " " ZB3-BILLABLE-AMT.

      *--- Check that PBHSTDTL is for the invoice based on benefit.
      *--- crosswalk to ARO-DESC field.
           MOVE SPACES                   TO DB-DTL-KEY.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "INV-TO-PBHST"           TO DB-LVL-2-KEY.
           MOVE SPACES                   TO DB-LVL-3-KEY.
           STRING ZB3-PLAN-TYPE          DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  ZB3-PLAN-CODE          DELIMITED BY SPACE
                                  INTO DB-DTL-KEY.
           PERFORM 840-FIND-IF1SET1.
           IF (LUPTBLDTL-NOTFOUND)
                DISPLAY "****ERROR : Missing INV-TO-PBHST for: " 
                  DB-DTL-KEY 
                 "on Invoice: " WF1-INVOICE " for Customer " 
                  WF1-CUSTOMER 
               GO TO 1087-NEXT-PBHSTDTL.
           IF (IF1-DTL-VALUE NOT = WF1-DESC)
               GO TO 1087-NEXT-PBHSTDTL.

      *    DISPLAY "Zb3.Company: " ZB3-COMPANY
      *            " Zb3.ProcLvl: " ZB3-PROCESS-LEVEL
      *            " Zb3.Invoice: " ZB3-INVOICE
      *            " Zb3.LineNbr: " ZB3-LINE-NBR.
           MOVE ZB3-EMPLOYEE             TO WS-WF2-CUSTOMER.
           MOVE ZB3-PLAN-TYPE            TO WS-ZB3-PLAN-TYPE.
           MOVE ZB3-PLAN-CODE            TO WS-ZB3-PLAN-CODE.

      *--- find Billing Item value using plan type and plan code
           INITIALIZE                       WS-LW-BENEFIT
                                            WS-LW-BILL-ITEM.
           PERFORM 1094-FIND-BILLING-ITEM
              THRU 1094-END.

      *    DISPLAY "1087 plan type and code " WS-ZB3-PLAN-TYPE
      *               " " WS-ZB3-PLAN-CODE.
      *    DISPLAY "1087 WsBillingString: " WS-BILLING-STRING.
           UNSTRING WS-BILLING-STRING    DELIMITED BY "^"
                                       INTO WS-LW-BENEFIT
                                            WS-LW-BILL-ITEM.
      *--- find the employee's Lifeworks equivalent of Plan and Coverage
      *--- Option.
           INITIALIZE                       WS-ZB3-PLAN-STR
                                            WS-EMP-PLN-OPT.
           STRING WS-ZB3-PLAN-TYPE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  WS-ZB3-PLAN-CODE       DELIMITED BY SPACE
                                       INTO WS-ZB3-PLAN-STR.
           MOVE WF1-TRANS-DATE           TO WS-AS-OF-DATE-ALP.
      *--- For pre-2023 increment date for advanced billing
           IF (WS-AS-OF-DATE-ALP < 20230101)
               MOVE WF1-TRANS-DATE     TO WSDR-FR-DATE
               MOVE 1                  TO WSDR-MONTH-INCR
               PERFORM 900-INCREMENT-DATE
               MOVE WSDR-TO-DATE       TO WS-AS-OF-DATE-ALP
           END-IF.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "BEN-PLAN-OPT"           TO DB-LVL-2-KEY.
           MOVE WS-ZB3-PLAN-STR          TO DB-LVL-3-KEY.
           MOVE WS-WF2-CUSTOMER          TO DB-DTL-KEY.
           PERFORM 850-FIND-NLT-IF1SET1.
           PERFORM
              UNTIL (LUPTBLDTL-NOTFOUND)
                 OR (IF1-LVL-1-KEY    NOT = WS-LEVEL-1)
                 OR (IF1-LVL-2-KEY    NOT = "BEN-PLAN-OPT")
                 OR (IF1-LVL-3-KEY    NOT = WS-ZB3-PLAN-STR)
                 OR (IF1-DTL-KEY(1:9) NOT = WS-WF2-CUSTOMER)

              IF  (WS-AS-OF-DATE-ALP NOT < IF1-DTL-KEY(11:8))
              AND (WS-AS-OF-DATE-ALP NOT > IF1-DTL-KEY(20:8))
                  MOVE IF1-DTL-VALUE      TO WS-EMP-PLN-OPT
              END-IF
              PERFORM 860-FIND-NEXT-IF1SET1

           END-PERFORM.
      *--- Defaults for retirement/pension benefits
           IF (WS-ZB3-PLAN-STR = "DI^PAE")
           OR (WS-ZB3-PLAN-STR = "DI^PAN")
           OR (WS-ZB3-PLAN-STR = "DI^PAV")
               MOVE "CRPAO-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PRS")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PFS")
               MOVE "CRPTOFULL-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PRS1")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DL^DOF")
               MOVE "DOF-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "HL^AGOD")
               MOVE "AGOD-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DL^PRM1")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "HL^CDM2")
               MOVE "CDM2-COVERAGE"    TO WS-EMP-PLN-OPT.
         
           IF (WS-EMP-PLN-OPT = SPACES)
               MOVE SPACES              TO WS-LW-PLAN
               MOVE SPACES               TO WS-LW-OPTION
               MOVE SPACES               TO WS-LW-BENEFIT
               GO TO 1087-AMTS
           ELSE
               UNSTRING WS-EMP-PLN-OPT       DELIMITED BY "-"
                                           INTO WS-LW-PLAN
                                                WS-LW-OPTION
           END-IF.
      *    DISPLAY "1087 WsEmpPlnOpt: " WS-EMP-PLN-OPT
      *            " WsLwPlan: " WS-LW-PLAN
      *            " WsLwOption: " WS-LW-OPTION.

       1087-AMTS.
      *      DISPLAY "1087 PBHSTDTL AMT: " ZB3-INVOICE " " 
      *               WF1-INVOICE " " ZB3-BILLABLE-AMT " " 
      *              ZB3-PLAN-CODE " " ZB3-PLAN-TYPE.
           MOVE ZB3-BILLABLE-AMT         TO WS-ZB3-BILLABLE-AMT.
           PERFORM 1090-DO-AGING-BUCKETS
              THRU 1090-END.

           PERFORM 1089-DO-ZR9002WORK
              THRU 1089-END.

       1087-NEXT-PBHSTDTL.
           PERFORM 860-FIND-NXTRNG-ZB3SET1.

       1087-END.

AI0000
RETROS******************************************************************
RETROS 1088-DO-PBHSTDTL-RETRO.
RETROS******************************************************************
RETROS
           IF (ZB3-RECORD-TYPE = "O")
               GO TO 1088-END.

      *--- Check that PBHSTDTL is for the invoice based on benefit.
      *--- crosswalk to ARO-DESC field.
           MOVE SPACES                   TO DB-DTL-KEY.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "INV-TO-PBHST"           TO DB-LVL-2-KEY.
           MOVE SPACES                   TO DB-LVL-3-KEY.
           STRING ZB3-PLAN-TYPE          DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  ZB3-PLAN-CODE          DELIMITED BY SPACE
                                  INTO DB-DTL-KEY.
           PERFORM 840-FIND-IF1SET1.
           IF (LUPTBLDTL-NOTFOUND)
                DISPLAY "****ERROR: Missing INV-TO-PBHST for: " 
                 DB-DTL-KEY 
                 "on Invoice: " WF1-INVOICE " for Customer " 
                  WF1-CUSTOMER 
               GO TO 1088-END.              
           IF (IF1-DTL-VALUE NOT = WF1-DESC)
               GO TO 1088-END.           

debug *     DISPLAY "1088-pbhstdtl: " ZB3-INVOICE " " ZB3-REASON-CODE
debug *       " " ZB3-BILLABLE-AMT.

           MOVE ZB3-EMPLOYEE             TO WS-WF2-CUSTOMER.
           MOVE ZB3-PLAN-TYPE            TO WS-ZB3-PLAN-TYPE.
           MOVE ZB3-PLAN-CODE            TO WS-ZB3-PLAN-CODE.

      *--- find Billing Item value using plan type and plan code
           INITIALIZE                       WS-LW-BENEFIT
                                            WS-LW-BILL-ITEM.
           PERFORM 1094-FIND-BILLING-ITEM
              THRU 1094-END.

      *    DISPLAY "1088 plan type and code " WS-ZB3-PLAN-TYPE
      *               " " WS-ZB3-PLAN-CODE.
      *    DISPLAY "1088 WsBillingString: " WS-BILLING-STRING.
           UNSTRING WS-BILLING-STRING    DELIMITED BY "^"
                                       INTO WS-LW-BENEFIT
                                            WS-LW-BILL-ITEM.

      *--- find the employee's Lifeworks equivalent of Plan and Coverage
      *--- Option.
           INITIALIZE                       WS-ZB3-PLAN-STR
                                            WS-EMP-PLN-OPT.
           STRING WS-ZB3-PLAN-TYPE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  WS-ZB3-PLAN-CODE       DELIMITED BY SPACE
                                       INTO WS-ZB3-PLAN-STR.
           MOVE WF1-TRANS-DATE           TO WS-AS-OF-DATE-ALP.
      *--- For pre-2023 increment date for advanced billing
           IF (WS-AS-OF-DATE-ALP < 20230101)
               MOVE WF1-TRANS-DATE     TO WSDR-FR-DATE
               MOVE 1                  TO WSDR-MONTH-INCR
               PERFORM 900-INCREMENT-DATE
               MOVE WSDR-TO-DATE       TO WS-AS-OF-DATE-ALP
           END-IF.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "BEN-PLAN-OPT"           TO DB-LVL-2-KEY.
           MOVE WS-ZB3-PLAN-STR          TO DB-LVL-3-KEY.
           MOVE WS-WF2-CUSTOMER          TO DB-DTL-KEY.
           PERFORM 850-FIND-NLT-IF1SET1.
           PERFORM
              UNTIL (LUPTBLDTL-NOTFOUND)
                 OR (IF1-LVL-1-KEY    NOT = WS-LEVEL-1)
                 OR (IF1-LVL-2-KEY    NOT = "BEN-PLAN-OPT")
                 OR (IF1-LVL-3-KEY    NOT = WS-ZB3-PLAN-STR)
                 OR (IF1-DTL-KEY(1:9) NOT = WS-WF2-CUSTOMER)

              IF  (WS-AS-OF-DATE-ALP NOT < IF1-DTL-KEY(11:8))
              AND (WS-AS-OF-DATE-ALP NOT > IF1-DTL-KEY(20:8))
                  MOVE IF1-DTL-VALUE      TO WS-EMP-PLN-OPT
              END-IF
              PERFORM 860-FIND-NEXT-IF1SET1

           END-PERFORM.
      *--- Defaults for retirement/pension benefits
           IF (WS-ZB3-PLAN-STR = "DI^PAE")
           OR (WS-ZB3-PLAN-STR = "DI^PAN")
           OR (WS-ZB3-PLAN-STR = "DI^PAV")
               MOVE "CRPAO-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PRS")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PFS")
               MOVE "CRPTOFULL-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PRS1")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DL^DOF")
               MOVE "DOF-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "HL^AGOD")
               MOVE "AGOD-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DL^PRM1")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "HL^CDM2")
               MOVE "CDM2-COVERAGE"    TO WS-EMP-PLN-OPT.
         
           IF (WS-EMP-PLN-OPT = SPACES)
               MOVE SPACES               TO WS-LW-PLAN
               MOVE SPACES               TO WS-LW-OPTION
               GO TO 1088-AMTS
           ELSE
               UNSTRING WS-EMP-PLN-OPT       DELIMITED BY "-"
                                           INTO WS-LW-PLAN
                                                WS-LW-OPTION
           END-IF.

       1088-AMTS.
           MOVE ZB3-BILLABLE-AMT         TO WS-ZB3-BILLABLE-AMT.
           PERFORM 1090-DO-AGING-BUCKETS
              THRU 1090-END.

           PERFORM 1093-DO-REC84WRK-RETRO
              THRU 1093-END.

       1088-END.

AI0000******************************************************************
AI0000 1089-DO-ZR9002WORK.
AI0000******************************************************************
AI0000
      *--- look for an existing record in the workfile. If not found,
      *--- create one, if found, add to the amounts. 
      *    DISPLAY "1089: WsCust-Emp-Num: " WS-CUST-EMP-NUM
      *            " Invc: " WF1-INVOICE.
           MOVE ZR900WS-PRM-COMPANY   TO WF2-COMPANY.
           MOVE WF1-CUSTOMER          TO WF2-CUSTOMER.
           MOVE WS-CUST-EMP-NUM       TO WF2-EMPLOYEE.
           MOVE WS-LW-BILL-ITEM       TO WF2-LW-BILL-ITEM.
           MOVE WS-ZB3-PLAN-TYPE      TO WF2-PLAN-TYPE.
           MOVE WS-ZB3-PLAN-CODE      TO WF2-PLAN-CODE.
           PERFORM 8400-FIND-ZR9002WORK.
           IF (LWWORK-NOTFOUND)
               PERFORM 8000-CREATE-ZR9002WORK
               MOVE ZR900WS-PRM-COMPANY   TO WF2-COMPANY
               MOVE WF1-CUSTOMER          TO WF2-CUSTOMER
               MOVE WS-CUST-EMP-NUM       TO WF2-EMPLOYEE
               MOVE WS-LW-BILL-ITEM       TO WF2-LW-BILL-ITEM
               MOVE WS-ZB3-PLAN-TYPE      TO WF2-PLAN-TYPE
               MOVE WS-ZB3-PLAN-CODE      TO WF2-PLAN-CODE
               MOVE WS-MAJ-CLASS          TO WF2-MAJ-CLASS
               MOVE WS-MIN-CLASS          TO WF2-MIN-CLASS
               MOVE WS-LW-STATUS          TO WF2-LW-STATUS
               MOVE WS-LW-BENEFIT         TO WF2-LW-BENEFIT
               MOVE WS-LW-PLAN            TO WF2-LW-PLAN
               MOVE WS-LW-OPTION          TO WF2-LW-OPTION

               MOVE WS-INVOICE-TOT        TO WF2-AMOUNT
               MOVE WS-ZB3-BUCKET (1)     TO WF2-AMT-FUTURE 
               MOVE WS-ZB3-BUCKET (2)     TO WF2-AMT-CURRENT
               MOVE WS-ZB3-BUCKET (3)     TO WF2-PAST-DUE-3
               MOVE WS-ZB3-BUCKET (4)     TO WF2-PAST-DUE-4
               MOVE WS-ZB3-BUCKET (5)     TO WF2-PAST-DUE-5
               MOVE WS-ZB3-BUCKET (6)     TO WF2-PAST-DUE-6
               MOVE WS-ZB3-BUCKET (7)     TO WF2-PAST-DUE-7
               MOVE WS-ZB3-BUCKET (8)     TO WF2-PAST-DUE-8
               MOVE WS-ZB3-BUCKET (9)     TO WF2-PAST-DUE-9
           ELSE
               IF (WS-LW-STATUS NOT = SPACES)
                   MOVE WS-LW-STATUS      TO WF2-LW-STATUS
               END-IF
               ADD WS-ZB3-BUCKET (1)      TO WF2-AMT-FUTURE 
               ADD WS-ZB3-BUCKET (2)      TO WF2-AMT-CURRENT
               ADD WS-ZB3-BUCKET (3)      TO WF2-PAST-DUE-3
               ADD WS-ZB3-BUCKET (4)      TO WF2-PAST-DUE-4
               ADD WS-ZB3-BUCKET (5)      TO WF2-PAST-DUE-5
               ADD WS-ZB3-BUCKET (6)      TO WF2-PAST-DUE-6
               ADD WS-ZB3-BUCKET (7)      TO WF2-PAST-DUE-7
               ADD WS-ZB3-BUCKET (8)      TO WF2-PAST-DUE-8
               ADD WS-ZB3-BUCKET (9)      TO WF2-PAST-DUE-9
           END-IF.
       
           PERFORM 8200-STORE-ZR9002WORK.

AI0000 1089-END.
AI0000******************************************************************
AI0000 1090-DO-AGING-BUCKETS.
AI0000******************************************************************
P3FX16*      INITIALIZE WS-TEMP-TOTAL.
AI0000*--- place the pbhstdtl amount in the corresponding aging bucket.
AI0000     INITIALIZE                       WS-ZB3-BUCKET-AMTS.
      *     DISPLAY " 1090 Zf1.Invoice " WF1-INVOICE " " 
      *             ZB3-EFF-BILL-DT.
      *     DISPLAY " 1090 Zf1.TrxAmt: " WF1-TRX-AMT.
      *     DISPLAY " WsZb3BillableAmt: " WS-ZB3-BILLABLE-AMT.
AI0000     PERFORM
AI0000        VARYING I4 FROM 1 BY 1
AI0000         UNTIL (I4 > 9)
AI0000
      *         DISPLAY "1090 PrintAmt: " I4 "-" ZR900WS-PRINT-AMT(I4)
      *        DISPLAY "Wf1TrxAmt: " WF1-TRX-AMT
      *                " BillableAmt: " WS-ZB3-BILLABLE-AMT
AI0000        IF (ZR900WS-PRINT-AMT (I4) NOT = ZERO)
P3FX16            MOVE ZR900WS-PRINT-AMT(I4)  TO WS-TEMP-AMT
P3FX16            MOVE I4                     TO WS-TEMP-SEQ
P3FX17*---Reduce Orig invoice amt tracker by amount of this pbhstdtl
P3FX17            COMPUTE WS-TEMP-ORIG       = WS-TEMP-ORIG  
P3FX17                                       - WS-ZB3-BILLABLE-AMT    
AI0000            COMPUTE WS-ZB3-BUCKET(I4) ROUNDED 
AI0000                                        = (ZR900WS-PRINT-AMT(I4)
AI0000                                        / WF1-TRX-AMT)
AI0000                                        * WS-ZB3-BILLABLE-AMT
                  ADD WS-ZB3-BUCKET(I4)  TO WS-TEMP-TOTAL
AI0000        END-IF
AI0000
AI0000     END-PERFORM.
AI0000
O3FX20     SUBTRACT 1 FROM WS-TEMP-ZB3-CNT.
P3FX16     COMPUTE WS-TEMP-DIFF = WS-TEMP-TOTAL - WS-TEMP-AMT.
P3FX17*      DISPLAY "P3FX17 Open " WF1-INVOICE " " WF1-TRX-AMT " "  
P3FX17*                    WS-TEMP-ORIG " " WS-ZB3-BILLABLE-AMT " " 
      *                WS-TEMP-AMT "-" WS-TEMP-TOTAL "=" WS-TEMP-DIFF.     
P3FX16     IF (WS-TEMP-DIFF < 0 )
P3FX16         COMPUTE WS-TEMP-DIFF = WS-TEMP-DIFF * -1.
P3FX16     IF (WS-TEMP-TOTAL NOT = WS-TEMP-AMT)
P3FX17*--- Skip this invoice for customer ER04977 as the pbhstdtl are odd 
P3FX17*--- because there is a CM and Invoice with the same number
P3FX17     AND (WF1-INVOICE NOT = "IN0147444402")
P3FX20     AND (WS-TEMP-ZB3-CNT = ZERO)
P3FX16*     AND ((WS-TEMP-DIFF = .01)
P3FX17*     OR (WS-TEMP-ORIG = ZERO))
P3FX16        DISPLAY "Rounding Adjustment "WF1-CUSTOMER " " 
                   WF1-INVOICE " " WS-TEMP-SEQ " " WS-TEMP-DIFF " "  
P3FX16             WS-TEMP-TOTAL " " WS-TEMP-AMT
      *       DISPLAY "Bucket before adj " WS-ZB3-BUCKET(WS-TEMP-SEQ)
P3FX16            COMPUTE WS-ZB3-BUCKET(WS-TEMP-SEQ) = 
P3FX16                                WS-ZB3-BUCKET(WS-TEMP-SEQ)
P3FX16                              + WS-TEMP-AMT  
P3FX16                              - WS-TEMP-TOTAL.
      *         DISPLAY "Bucket after adj " WS-ZB3-BUCKET(WS-TEMP-SEQ).
AI0000 1090-END.
AI0000
AI0000******************************************************************
AI0000 1092-DO-REC84WRK.
AI0000******************************************************************
AI0000
      *    GO TO 1092-END.

      *--- write a work file for later use to write record type 84 
      *--- payment transactions. 
      *    DISPLAY "1092: WsCust-Emp-Num: " WS-CUST-EMP-NUM.
           INITIALIZE                    WF4-REC84WRK-REC.
           MOVE ZR900WS-PRM-COMPANY   TO WF4-COMPANY.
           MOVE WF1-CUSTOMER          TO WF4-CUSTOMER.
           MOVE WS-CUST-EMP-NUM       TO WF4-EMPLOYEE.
           MOVE WF1-INVOICE           TO WF4-INVOICE.
           MOVE WF1-TRANS-TYPE        TO WF4-TRANS-TYPE.
CRED01     MOVE WF1-DESC              TO WF4-DESC.            
           MOVE WS-LW-BILL-ITEM       TO WF4-LW-BILL-ITEM.
           MOVE WS-ZB3-PLAN-TYPE      TO WF4-PLAN-TYPE.
           MOVE WS-ZB3-PLAN-CODE      TO WF4-PLAN-CODE.
           MOVE WS-MAJ-CLASS          TO WF4-MAJ-CLASS.
           MOVE WS-MIN-CLASS          TO WF4-MIN-CLASS.
           MOVE WS-LW-STATUS          TO WF4-LW-STATUS.
           MOVE WS-LW-BENEFIT         TO WF4-LW-BENEFIT.
           MOVE WS-LW-PLAN            TO WF4-LW-PLAN.
           MOVE WS-LW-OPTION          TO WF4-LW-OPTION.
           MOVE WS-INVOICE-TOT        TO WF4-TRAN-AMT.
      *    MOVE WF1-TRX-AMT           TO WF4-TRX-AMT.
      *    MOVE WS-ZB3-BUCKET (1)     TO WF4-AMT-FUTURE.
      *    MOVE WS-ZB3-BUCKET (2)     TO WF4-AMT-CURRENT.
      *    MOVE WS-ZB3-BUCKET (3)     TO WF4-PAST-DUE-3.
      *    MOVE WS-ZB3-BUCKET (4)     TO WF4-PAST-DUE-4.
      *    MOVE WS-ZB3-BUCKET (5)     TO WF4-PAST-DUE-5.
      *    MOVE WS-ZB3-BUCKET (6)     TO WF4-PAST-DUE-6.
      *    MOVE WS-ZB3-BUCKET (7)     TO WF4-PAST-DUE-7.
      *    MOVE WS-ZB3-BUCKET (8)     TO WF4-PAST-DUE-8.
      *    MOVE WS-ZB3-BUCKET (9)     TO WF4-PAST-DUE-9.
      *    MOVE WS-LW-SOURCE          TO WF4-LW-SOURCE.
           MOVE WF1-INVOICE           TO WF4-LW-CHK-NBR.
           MOVE WF1-BATCH-NBR         TO WF4-LW-BATCH.
           MOVE WF1-DUE-DATE          TO WF4-LW-DATE-RECVD.

      *    DISPLAY "1092 rec84wrk: " WF4-REC84WRK-REC.
           WRITE REC84WRK-REC       FROM WF4-REC84WRK-REC.

AI0000 1092-END.
AI0000******************************************************************
AI0000 1093-DO-REC84WRK-RETRO.          
AI0000******************************************************************
AI0000
      *--- write a work file for later use to write record type 82 
      *--- credit or debit transaction. 
           INITIALIZE                    WF4-REC84WRK-REC.
           MOVE ZR900WS-PRM-COMPANY   TO WF4-COMPANY.
           MOVE WF1-CUSTOMER          TO WF4-CUSTOMER.
           MOVE ZB3-EMPLOYEE          TO WF4-EMPLOYEE.
           MOVE WF1-INVOICE(1:10)     TO WF4-INVOICE.
           MOVE WF1-INVOICE           TO WF4-INVOICE.
           MOVE "R"                   TO WF4-TRANS-TYPE.
CRED01     MOVE SPACES                TO WF4-DESC. 
           IF (ZB3-BILLABLE-AMT  < ZERO)
CRED01         STRING "RETRO CREDIT FOR: " DELIMITED BY SIZE        
CRED01                WF1-INVOICE(1:10)    DELIMITED BY SPACE
                                          INTO WF4-DESC            
           ELSE           
CRED01         STRING "RETRO DEBIT FOR: " DELIMITED BY SIZE        
CRED01                WF1-INVOICE(1:10)    DELIMITED BY SPACE
                                          INTO WF4-DESC.            
           MOVE ZB3-PLAN-TYPE         TO WF4-PLAN-TYPE.
           MOVE ZB3-PLAN-CODE         TO WF4-PLAN-CODE.
           INITIALIZE                  WS-LW-BENEFIT
                                       WS-LW-BILL-ITEM.
           PERFORM 1094-FIND-BILLING-ITEM
           THRU 1094-END.

           UNSTRING WS-BILLING-STRING  DELIMITED BY "^"
                                     INTO WF4-LW-BENEFIT
                                          WF4-LW-BILL-ITEM.

      *--- find the employee's Lifeworks equivalent of Plan and Coverage
      *--- Option.
           INITIALIZE                WS-ZB3-PLAN-STR
                                     WS-EMP-PLN-OPT.
           STRING WS-ZB3-PLAN-TYPE   DELIMITED BY SPACE
                  "^"                DELIMITED BY SIZE
                  WS-ZB3-PLAN-CODE   DELIMITED BY SPACE
                                     INTO WS-ZB3-PLAN-STR.
           MOVE WF1-TRANS-DATE       TO WS-AS-OF-DATE-ALP.
      *--- For pre-2023 increment date for advanced billing
           IF (WS-AS-OF-DATE-ALP < 20230101)
               MOVE WF1-TRANS-DATE     TO WSDR-FR-DATE
               MOVE 1                  TO WSDR-MONTH-INCR
               PERFORM 900-INCREMENT-DATE
                   MOVE WSDR-TO-DATE       TO WS-AS-OF-DATE-ALP
            END-IF.
            MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
            MOVE "BEN-PLAN-OPT"           TO DB-LVL-2-KEY.
            MOVE WS-ZB3-PLAN-STR          TO DB-LVL-3-KEY.
            MOVE WS-WF2-CUSTOMER          TO DB-DTL-KEY.
            PERFORM 850-FIND-NLT-IF1SET1.
            PERFORM
                UNTIL (LUPTBLDTL-NOTFOUND)
                OR (IF1-LVL-1-KEY    NOT = WS-LEVEL-1)
                OR (IF1-LVL-2-KEY    NOT = "BEN-PLAN-OPT")
                OR (IF1-LVL-3-KEY    NOT = WS-ZB3-PLAN-STR)
                 OR (IF1-DTL-KEY(1:9) NOT = WS-WF2-CUSTOMER)

                    IF  (WS-AS-OF-DATE-ALP NOT < IF1-DTL-KEY(11:8))
                    AND (WS-AS-OF-DATE-ALP NOT > IF1-DTL-KEY(20:8))
                        MOVE IF1-DTL-VALUE      TO WS-EMP-PLN-OPT
                    END-IF
                    PERFORM 860-FIND-NEXT-IF1SET1

            END-PERFORM.
      *--- Defaults for retirement/pension benefits
            IF (WS-ZB3-PLAN-STR = "DI^PAE")
            OR (WS-ZB3-PLAN-STR = "DI^PAN")
            OR (WS-ZB3-PLAN-STR = "DI^PAV")
                MOVE "CRPAO-COVERAGE"    TO WS-EMP-PLN-OPT
            END-IF.
            IF (WS-ZB3-PLAN-STR = "DI^PRS")
                MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT
            END-IF .
            IF (WS-ZB3-PLAN-STR = "DI^PFS")
                MOVE "CRPTOFULL-COVERAGE"    TO WS-EMP-PLN-OPT
            END-IF.
            IF (WS-ZB3-PLAN-STR = "DI^PRS1")
                MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT
            END-IF.
            IF (WS-ZB3-PLAN-STR = "DL^DOF")
                MOVE "DOF-COVERAGE"    TO WS-EMP-PLN-OPT
            END-IF.
            IF (WS-ZB3-PLAN-STR = "HL^AGOD")
                 MOVE "AGOD-COVERAGE"    TO WS-EMP-PLN-OPT
            END-IF.
            IF (WS-ZB3-PLAN-STR = "DL^PRM1")
                MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT
            END-IF.
            IF (WS-ZB3-PLAN-STR = "HL^CDM2")
                MOVE "CDM2-COVERAGE"    TO WS-EMP-PLN-OPT
            END-IF.
      **       DISPLAY "1086 plan-opt " WS-EMP-PLN-OPT
         
            IF (WS-EMP-PLN-OPT = SPACES)
                MOVE SPACES              TO WS-LW-PLAN
                 MOVE SPACES               TO WS-LW-OPTION
                 MOVE SPACES               TO WS-LW-BENEFIT
             ELSE
                 UNSTRING WS-EMP-PLN-OPT   DELIMITED BY "-"
                                         INTO WS-LW-PLAN
                                              WS-LW-OPTION
             END-IF.

           MOVE WS-MAJ-CLASS          TO WF4-MAJ-CLASS.
           MOVE WS-MIN-CLASS          TO WF4-MIN-CLASS.
           MOVE WS-LW-STATUS          TO WF4-LW-STATUS.
           MOVE WS-LW-PLAN            TO WF4-LW-PLAN.
           MOVE WS-LW-OPTION          TO WF4-LW-OPTION.
           COMPUTE WF4-TRAN-AMT ROUNDED = WF1-TRAN-AMT            
                                         / WF1-TRX-AMT          
                                         * ZB3-BILLABLE-AMT.
P3FX16     IF (WS-TEMP-DIFF NOT = ZERO)
P3FX17     AND ((WS-TEMP-DIFF = .01)
P3FX17     OR (WS-TEMP-ORIG = ZERO))
P3FX16         COMPUTE WF4-TRAN-AMT ROUNDED = WF4-TRAN-AMT
P3FX16                              + WS-TEMP-AMT  
P3FX16                              - WS-TEMP-TOTAL.
P3FX06     MOVE WF4-TRAN-AMT            TO WF4-TRX-AMT.
      *    DISPLAY "1093 amts " WF1-TRANS-TYPE ": "
      *           WF4-TRAN-AMT "=" WF1-TRAN-AMT "/"
      *          WF1-TRX-AMT "*" ZB3-BILLABLE-AMT.   
           MOVE WF1-INVOICE(1:10)     TO WF4-LW-CHK-NBR.
           MOVE WF1-BATCH-NBR         TO WF4-LW-BATCH. 
           MOVE ZB3-EFF-BILL-DT       TO WF4-LW-DATE-RECVD.
           MOVE ZB3-EFF-BILL-DT       TO WF4-TRANS-DATE.        
           WRITE REC84WRK-REC       FROM WF4-REC84WRK-REC.

AI0000 1093-END.
AI0000
AI0000******************************************************************
AI0000 1094-FIND-BILLING-ITEM.
AI0000******************************************************************
       1094-START.

           IF (WS-WF2-CUSTOMER = SPACES)
               GO TO 1094-BY-PLAN
           END-IF.

      *--- try to find the Billing Item using an employee exception 
           INITIALIZE                       WS-ZB3-PLAN-STR
                                            WS-BILLING-STRING.
           MOVE WS-WF2-CUSTOMER          TO JSTWS-STR.
           MOVE 9                        TO JSTWS-STR-LEN.
           SET JSTWS-LEFT                TO TRUE.
           PERFORM 2000-JUSTIFY-OBJECT.
           STRING WS-ZB3-PLAN-TYPE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  WS-ZB3-PLAN-CODE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  JSTWS-STR-OUT          DELIMITED BY SPACE
                                       INTO WS-ZB3-PLAN-STR.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "BILLING-ITEM"           TO DB-LVL-2-KEY.
           MOVE SPACES                   TO DB-LVL-3-KEY.
           MOVE WS-ZB3-PLAN-STR          TO DB-DTL-KEY.
           PERFORM 840-FIND-IF1SET1.
           IF (LUPTBLDTL-FOUND)
               MOVE IF1-DTL-VALUE        TO WS-BILLING-STRING
      *--- Fix truncated Detail Value items
               IF (IF1-DTL-VALUE = "CRITILLEE^conversioncriticalIllE")
                    MOVE "CRITILLEE^conversioncriticalIllEe"
                                         TO WS-BILLING-STRING
               END-IF
               IF (IF1-DTL-VALUE = "CRITILLSP^conversioncriticalIllS")
                    MOVE "CRITILLSP^conversioncriticalIllSp"
                                         TO WS-BILLING-STRING
               END-IF
               IF (IF1-DTL-VALUE = "CRITILLCH^conversioncriticalIllC")
                    MOVE "CRITILLCH^conversioncriticalIllCh"
                                         TO WS-BILLING-STRING
               END-IF
               GO TO 1094-END
           END-IF.

       1094-BY-PLAN.
           INITIALIZE                       WS-ZB3-PLAN-STR
                                            WS-BILLING-STRING.
           STRING WS-ZB3-PLAN-TYPE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  WS-ZB3-PLAN-CODE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                                       INTO WS-ZB3-PLAN-STR.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "BILLING-ITEM"           TO DB-LVL-2-KEY.
           MOVE SPACES                   TO DB-LVL-3-KEY.
           MOVE WS-ZB3-PLAN-STR          TO DB-DTL-KEY.
           PERFORM 840-FIND-IF1SET1.
           IF (LUPTBLDTL-FOUND)
      *--- Fix truncated Detail Value items
               MOVE IF1-DTL-VALUE        TO WS-BILLING-STRING
               IF (IF1-DTL-VALUE = "CRITILLEE^conversioncriticalIllE")
                    MOVE "CRITILLEE^conversioncriticalIllEe"
                                         TO WS-BILLING-STRING
               END-IF
               IF (IF1-DTL-VALUE = "CRITILLSP^conversioncriticalIllS")
                    MOVE "CRITILLSP^conversioncriticalIllSp"
                                         TO WS-BILLING-STRING
               END-IF
               IF (IF1-DTL-VALUE = "CRITILLCH^conversioncriticalIllC")
                    MOVE "CRITILLCH^conversioncriticalIllCh"
                                         TO WS-BILLING-STRING
               END-IF
           END-IF.

AI0000 1094-END.
AI0000
      ******************************************************************
       1000-END.
      ******************************************************************

AI0000******************************************************************
AI0000 2000-DO-LIFEWORKS-PHASE1            SECTION.
AI0000******************************************************************
AI0000 2000-START.
AI0000*--- Phase 1 of lifeworks processing generates the Type 80 and 81
AI0000*--- records and adds to the work file of transactions for the 
AI0000*--- Type 82 and 84 outputs (phase 2).

      *    DISPLAY "Start 2000-DO-LIFEWORKS-PHASE1".
AI0000     OPEN EXTEND REC84WRK-FILE.
AI0000     OPEN I-O ZR9002WORK-FILE.

           MOVE PRM-COMPANY            TO WF2-COMPANY.
           INITIALIZE                     WF2-CUSTOMER
                                          WF2-EMPLOYEE
                                          WF2-LW-BILL-ITEM
                                          WF2-PLAN-TYPE
                                          WF2-PLAN-CODE.

           PERFORM 8500-FIND-NLT-ZR9002WORK.
           IF (LWWORK-NOTFOUND)
               MOVE 908                    TO CRT-MSG-NBR
               PERFORM 780-DISPLAY-MSG
               GO TO 2000-CLOSE-FILE
           END-IF.

           MOVE WF2-COMPANY             TO WS-SAVE-COMPANY.
           PERFORM 2010-DO-COMPANY
              THRU 2010-END
             UNTIL (LWWORK-NOTFOUND)
                OR (WF2-COMPANY NOT = WS-SAVE-COMPANY).

       2000-CLOSE-FILE.
           CLOSE ZR9002WORK-FILE.
      
           GO TO 2000-END.

      ******************************************************************
       2010-DO-COMPANY.
      ******************************************************************
       2010-START.

      *    DISPLAY "Start 2010-DO-COMPANY".
           MOVE WF2-CUSTOMER            TO WS-SAVE-CUSTOMER.
CPS001*--- Flag as Employer for "ER" customers
CPS001     INITIALIZE                     WS-EMP-FIRST-NAME
CPS001                                    WS-EMP-LAST-NAME
CPS001                                    WS-CUST-PROC-LVL
CPS001                                    WS-BILLING-GRP.
CPS001     IF (WF2-CUSTOMER(3:2) = "ER")
CPS001         MOVE "Y"                TO WS-EMPLOYER-FLAG
CPS001         MOVE WF2-CUSTOMER(5:5)  TO WS-CUST-PROC-LVL
CPS001     ELSE
CPS001         MOVE "N"                TO WS-EMPLOYER-FLAG
AI0000         MOVE WF2-EMPLOYEE       TO WS-TMP-NBR
AI0000         IF (WF2-EMPLOYEE = ZERO)
CPS001            MOVE WF2-CUSTOMER(2:6)  TO WS-TMP-NBR-A
CPS001            IF (WF2-CUSTOMER(2:6)  NOT NUMERIC)
CPS001                MOVE ZEROES         TO WS-TMP-NBR-A
AI0000            END-IF
CPS001         END-IF
AI0000         MOVE WS-TMP-NBR-A       TO JSTWS-STR
AI0000         MOVE 6                  TO JSTWS-STR-LEN
AI0000         MOVE 9                  TO JSTWS-STR-OUT-LEN
AI0000         SET JSTWS-NUMERIC TO TRUE
AI0000         PERFORM 2000-JUSTIFY-OBJECT
AI0000         MOVE JSTWS-STR-OUT      TO WS-WF2-CUSTOMER
CPS001     END-IF.
           MOVE WF2-COMPANY            TO DB-COMPANY.
           MOVE WF2-CUSTOMER           TO DB-CUSTOMER.
           PERFORM 840-FIND-ACMSET1.
           IF (ARCUSTOMER-FOUND)
               MOVE ACM-MIN-CLASS      TO WS-MIN-CLASS
               IF (WS-EMPLOYER-FLAG = "Y")
                  MOVE "employers"     TO WS-BILLING-GRP
                  IF (WF2-CUSTOMER = "  ER0DISW")
                      MOVE "disabledWaiverOfPremium" TO WS-BILLING-GRP
                  END-IF
               ELSE
                  MOVE "directBilled"  TO WS-BILLING-GRP
                  IF (ACM-MIN-CLASS = "R")
                      MOVE "retirees"  TO WS-BILLING-GRP
                  END-IF
                  IF (ACM-MIN-CLASS = "O")
                      MOVE "directBilled"  TO WS-BILLING-GRP
                  END-IF
               END-IF
           END-IF.
           PERFORM 2012-DO-CUSTOMER
              THRU 2012-END
             UNTIL (LWWORK-NOTFOUND)
                OR (WF2-COMPANY  NOT = WS-SAVE-COMPANY)
                OR (WF2-CUSTOMER NOT = WS-SAVE-CUSTOMER).

       2010-END.

      ******************************************************************
       2012-DO-CUSTOMER.
      ******************************************************************
       2012-START.

      *    DISPLAY "Start 2012-DO-CUSTOMER".
           IF (WS-EMPLOYER-FLAG = "N")
               MOVE WS-CUST-EMP-NUM     TO WS-SAVE-EMPLOYEE
           ELSE
               MOVE WF2-EMPLOYEE        TO WS-SAVE-EMPLOYEE
           END-IF.

 temp *    DISPLAY "2012 WsSaveEmployee: " WS-SAVE-EMPLOYEE.

      *--- find the employee status from HRHISTORY for the as of date.
           INITIALIZE                 WS-BILLING-SUBITEM
                                      WS-EMP-EMP-STATUS.
CPS001     MOVE WS-SAVE-COMPANY    TO DB-COMPANY.
CPS001     MOVE WS-SAVE-EMPLOYEE   TO DB-EMPLOYEE.
CPS001     PERFORM 840-FIND-EMPSET1.
CPS001     IF (EMPLOYEE-FOUND)
CPS001         MOVE EMP-FIRST-NAME TO WS-EMP-FIRST-NAME
CPS001         MOVE EMP-LAST-NAME  TO WS-EMP-LAST-NAME
               MOVE EMP-EMP-STATUS TO WS-EMP-EMP-STATUS
               MOVE WS-SAVE-COMPANY   TO DB-COMPANY
               MOVE WS-SAVE-EMPLOYEE  TO DB-EMPLOYEE
               MOVE ZEROES            TO DB-OBJ-ID
               MOVE "20"              TO DB-FLD-NBR
               MOVE HRHSET1-FLD-NBR   TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-HRHSET1
               PERFORM
                 UNTIL (HRHISTORY-NOTFOUND)
                    OR (HRH-BEG-DATE > PRM-TRANS-DATE)

                 MOVE HRH-A-VALUE     TO WS-EMP-EMP-STATUS
                 PERFORM 860-FIND-NXTRNG-HRHSET1

               END-PERFORM
CPS001     END-IF.
debug *    DISPLAY "SaveCompany: " WS-SAVE-COMPANY "-" WF2-COMPANY.
debug *    DISPLAY "SaveCustomer: " WS-SAVE-CUSTOMER "-" WF2-CUSTOMER.
debug *    DISPLAY "SaveEmployee: " WS-SAVE-EMPLOYEE "-" WF2-EMPLOYEE 
debug *            " Name: " WS-EMP-FIRST-NAME " " WS-EMP-LAST-NAME.
           PERFORM 2014-DO-EMPLOYEE
              THRU 2014-END
             UNTIL (LWWORK-NOTFOUND)
                OR (WF2-COMPANY  NOT = WS-SAVE-COMPANY)
                OR (WF2-CUSTOMER NOT = WS-SAVE-CUSTOMER)
                OR (WF2-EMPLOYEE NOT = WS-SAVE-EMPLOYEE).

       2012-END.

      ******************************************************************
       2014-DO-EMPLOYEE.
      ******************************************************************
       2014-START.

      *    DISPLAY "Start 2014-DO-EMPLOYEE".
           INITIALIZE                      WS-LW-BILL-AMT.
           MOVE WF2-LW-BILL-ITEM        TO WS-SAVE-BILL-ITEM.
           MOVE WF2-LW-STATUS           TO WS-SAVE-STATUS.
           MOVE WF2-LW-BENEFIT          TO WS-SAVE-BENEFIT.
           MOVE WF2-LW-PLAN             TO WS-SAVE-PLAN.
           MOVE WF2-LW-OPTION           TO WS-SAVE-OPTION.
      *    DISPLAY "wf2.LwBillItem: " WF2-LW-BILL-ITEM.
      *    DISPLAY "wf2.LwStatus: " WF2-LW-STATUS.
      *    DISPLAY "wf2.LwBenefit: " WF2-LW-BENEFIT.
      *    DISPLAY "wf2.LwPlan: " WF2-LW-PLAN.
      *    DISPLAY "wf2.LwOption: " WF2-LW-OPTION.
           PERFORM 2016-DO-BILLING-ITEM
              THRU 2016-END
             UNTIL (LWWORK-NOTFOUND)
                OR (WF2-COMPANY      NOT = WS-SAVE-COMPANY)
                OR (WF2-CUSTOMER     NOT = WS-SAVE-CUSTOMER)
                OR (WF2-EMPLOYEE     NOT = WS-SAVE-EMPLOYEE)
                OR (WF2-LW-BILL-ITEM NOT = WS-SAVE-BILL-ITEM).

           PERFORM 9000-DO-CPS-CUST-DETAIL.
  
       2014-END.

      ******************************************************************
       2016-DO-BILLING-ITEM.
      ******************************************************************
       2016-START.

      *    DISPLAY "Start 2016-DO-BILLING-ITEM".
           ADD WF2-AMT-FUTURE       TO WS-LW-BILL-AMT.
           ADD WF2-AMT-CURRENT      TO WS-LW-BILL-AMT.
           ADD WF2-PAST-DUE-3       TO WS-LW-BILL-AMT.
           ADD WF2-PAST-DUE-4       TO WS-LW-BILL-AMT.
           ADD WF2-PAST-DUE-5       TO WS-LW-BILL-AMT.
           ADD WF2-PAST-DUE-6       TO WS-LW-BILL-AMT.
           ADD WF2-PAST-DUE-7       TO WS-LW-BILL-AMT.
           ADD WF2-PAST-DUE-8       TO WS-LW-BILL-AMT.
           ADD WF2-PAST-DUE-9       TO WS-LW-BILL-AMT.
      *    DISPLAY "2016 TrxAmt: " WF2-TRX-AMT.
      *    DISPLAY "2016 Future: " WF2-AMT-FUTURE.
      *    DISPLAY "2016 Current: " WF2-AMT-CURRENT.
      *    DISPLAY "2016 PastDue3Amt: " WF2-PAST-DUE-3.
      *    DISPLAY "2016 PastDue4Amt: " WF2-PAST-DUE-4.
      *    DISPLAY "2016 PastDue5Amt: " WF2-PAST-DUE-5.
      *    DISPLAY "2016 PastDue6Amt: " WF2-PAST-DUE-6.
      *    DISPLAY "2016 PastDue7Amt: " WF2-PAST-DUE-7.
      *    DISPLAY "2016 PastDue8Amt: " WF2-PAST-DUE-8.
      *    DISPLAY "2016 PastDue9Amt: " WF2-PAST-DUE-9.
      *    DISPLAY "2016 WsLwBillAmt: " WS-LW-BILL-AMT.

       2016-NEXT-ZR9002WORK.
           PERFORM 8600-FIND-NEXT-ZR9002WORK.

       2016-END.

AI0000 2000-END.
AI0000
AI0000******************************************************************
AI0000 3000-DO-LIFEWORKS-PHASE2            SECTION.
AI0000******************************************************************
AI0000 3000-START.
AI0000*--- Phase 2 of lifeworks processing generates the Type 82 and 84
AI0000*--- records 
AI0000
AI0000     OPEN INPUT  REC84WRK-FILE.
           MOVE WS-FALSE               TO REC84WRK-SW.
           READ REC84WRK-FILE INTO WF4-REC84WRK-REC
               AT END
                   MOVE WS-TRUE        TO REC84WRK-SW.
           PERFORM 3010-DO-REC84WRK
              THRU 3010-END
             UNTIL (REC84WRK-NOTFOUND).

           GO TO 3000-END.

AI0000******************************************************************
AI0000 3010-DO-REC84WRK.
AI0000******************************************************************
AI0000 3010-START.

      *    DISPLAY "3010 rec84wrk:".                     
      *    DISPLAY "customer: " WF4-CUSTOMER
      *            " employee: " WF4-EMPLOYEE.
      *    DISPLAY " transType: " WF4-TRANS-TYPE
      *            " invoice: " WF4-INVOICE
      *            " TranAmt: " WF4-TRAN-AMT.

      *    DISPLAY "3010 rec84wrk: " WF4-REC84WRK-REC.
      *  DISPLAY "entry to 3010: " WF4-CUSTOMER " " WF4-EMPLOYEE.
           IF (WF4-CUSTOMER(3:1) = "E")
              MOVE WF4-CUSTOMER    TO ZR900WS-CUSTOMER
           ELSE
              MOVE WF4-EMPLOYEE    TO R84-BILLING-ENTITY
           END-IF.

           IF (WF4-CUSTOMER = "  ER0DISW")
               MOVE "disabledWaiverOfPremium" TO WS-BILLING-GRP
           ELSE
             IF (WF4-MIN-CLASS = "R")
                MOVE "retirees"      TO WS-BILLING-GRP
             ELSE
               IF (WF4-CUSTOMER(3:1) = "E")
                  MOVE "employers"     TO WS-BILLING-GRP
               ELSE
                  MOVE "directBilled"  TO WS-BILLING-GRP
               END-IF
             END-IF
           END-IF.
      *--- left justify the customer number.
      *    DISPLAY "3010 Customer: " WF4-CUSTOMER.
           MOVE WF4-CUSTOMER       TO JSTWS-STR.
           MOVE 9                  TO JSTWS-STR-LEN.
           SET JSTWS-LEFT          TO TRUE.
           PERFORM 2000-JUSTIFY-OBJECT.
           MOVE JSTWS-STR-OUT      TO ZR900WS-CUSTOMER.

           IF (WF4-TRANS-TYPE = "P")
           OR (WF4-TRANS-TYPE = "1")
CRED01*    OR (WF4-TRANS-TYPE = "C")
CRED01*    OR (WF4-TRANS-TYPE = "2")
               PERFORM 3030-WRITE-PYMT-TRX
                  THRU 3030-END
RETROB*--- Add logic for stand alone retro adjusts
RETROB     ELSE
RETROB     IF (WF4-TRANS-TYPE = "R")
RETROB         PERFORM 3025-WRITE-RTR-TRX
RETROB            THRU 3025-END
           ELSE
               PERFORM 3020-WRITE-INVC-TRX
                  THRU 3020-END
           END-IF.

       3010-NEXT-REC84WRK.
           MOVE WS-FALSE               TO REC84WRK-SW.
           READ REC84WRK-FILE INTO WF4-REC84WRK-REC
               AT END
                   MOVE WS-TRUE        TO REC84WRK-SW.

       3010-END.

AI0000******************************************************************
AI0000 3020-WRITE-INVC-TRX.
AI0000******************************************************************
AI0000 3020-START.

      *--- set period begin and end date based on the transaction date
      *--- Pre2023 dates are billed in advance so the coverage month
      *--- is incremented.  In 2023 it is immediate billing so no increment
           IF (WF4-TRANS-DATE > 20221231)
               MOVE WF4-TRANS-DATE     TO WS-PER-BEG-DATE
                                          WSDR-FR-DATE
           ELSE
               MOVE WF4-TRANS-DATE     TO WSDR-FR-DATE
               MOVE 1                  TO WSDR-MONTH-INCR
               PERFORM 900-INCREMENT-DATE
               MOVE WSDR-TO-DATE       TO WS-PER-BEG-DATE
                                          WSDR-FR-DATE.
           MOVE 01                 TO WS-PER-BEG-DATE(07:02).
           PERFORM 900-GET-DATE-EOM.
           MOVE WSDR-TO-DATE       TO WS-PER-END-DATE.

      *--- write the R82 record.
           INITIALIZE                 R82-RECORD82-REC.
           MOVE "82"               TO R82-DATA-TYPE.
           MOVE "1"                TO R82-REC-TYPE.    
           MOVE "001"              TO R82-VERSION.     
AI0000     MOVE WF4-EMPLOYEE       TO R82-EMPLOYEE.
AI0000     MOVE WF4-COMPANY        TO DB-COMPANY.
           IF (WF4-EMPLOYEE NOT = ZERO)
AI0000        MOVE WF4-EMPLOYEE       TO DB-EMPLOYEE
AI0000        PERFORM 840-FIND-EMPSET1
AI0000        IF (EMPLOYEE-FOUND)
AI0000            MOVE EMP-FIRST-NAME TO R82-FIRST-NAME
AI0000            MOVE EMP-LAST-NAME  TO R82-LAST-NAME
              END-IF
AI0000     END-IF.
      *--- Alter BIlling Entity and Employer
AI0000*     MOVE ZR900WS-CUSTOMER   TO R82-BILLING-ENTITY.
           IF (ZR900WS-CUSTOMER(1:1) = "E")
              MOVE ZR900WS-CUSTOMER(3:5) TO R82-EMPLOYER
                                            R82-BILLING-ENTITY
              IF (ZR900WS-CUSTOMER = "ER0DISW")
                   MOVE "DISW"         TO R82-EMPLOYER
                                          R82-BILLING-ENTITY
              END-IF
           ELSE
              MOVE ZR900WS-CUSTOMER(2:6) TO R82-BILLING-ENTITY
              MOVE R82-BILLING-ENTITY  TO JSTWS-STR
              MOVE 6                   TO JSTWS-STR-LEN
              SET JSTWS-LEFT           TO TRUE
              PERFORM 2000-JUSTIFY-OBJECT
              MOVE JSTWS-STR-OUT       TO R82-BILLING-ENTITY
           END-IF.
AI0000     MOVE WS-BILLING-GRP     TO R82-BILLING-GROUP.
           MOVE SPACES             TO R82-BILLING-ITEM.
           MOVE WF4-TRAN-AMT       TO R82-TRAN-AMOUNT.
           MOVE WS-PER-BEG-DATE    TO R82-BEGIN-DATE.
           MOVE WS-PER-END-DATE    TO R82-END-DATE.
           MOVE "I"                TO R82-TRAN-TYPE.
           IF (WF4-TRANS-TYPE NOT = "I")
           OR (WF4-TRANS-DATE > PRM-TRANS-DATE)
               MOVE "A"            TO R82-TRAN-TYPE
           END-IF.
           MOVE WF4-LW-BENEFIT     TO R82-BENEFIT.
           MOVE WF4-LW-PLAN        TO R82-PLAN.
           MOVE WF4-LW-OPTION      TO R82-OPTION.
           IF (R82-PLAN = SPACES)
               MOVE SPACES          TO R82-OPTION 
               MOVE SPACES          TO R82-BENEFIT. 
           MOVE WF4-TRANS-DATE     TO R82-TRAN-DATE.
debug      MOVE WF4-INVOICE          TO R82-LAW-INVOICE.
           MOVE ZR900WS-PRM-COMPANY      TO DB-COMPANY.
           MOVE WF4-PROCESS-LEVEL        TO DB-PROCESS-LEVEL. 
          
           IF (WF4-CUSTOMER(3:2) = "ER")
               MOVE WF4-CUSTOMER(5:5)    TO DB-PROCESS-LEVEL
           END-IF.
           MOVE WF4-INVOICE(1:10)        TO DB-INVOICE.
           MOVE ZB3SET1-INVOICE          TO WS-DB-BEG-RNG.
           PERFORM 850-FIND-BEGRNG-ZB3SET1.
           IF (PBHSTDTL-NOTFOUND)
               MOVE "conversionManAdj"   TO R82-BILLING-ITEM
               INITIALIZE                   R82-BENEFIT
                                            R82-PLAN
                                            R82-OPTION
               IF (R82-BENEFIT(1:8) = "SUPPLIFE")
                   MOVE "suppLife"      TO R82-BILLING-GROUP
P3FX03             MOVE R82-EMPLOYEE    TO JSTWS-STR                 
P3FX03             INSPECT JSTWS-STR REPLACING LEADING "0" BY " " 
P3FX03             MOVE 9                        TO JSTWS-STR-LEN
P3FX03             SET JSTWS-LEFT                TO TRUE 
P3FX03             PERFORM 2000-JUSTIFY-OBJECT 
P3FX03             MOVE JSTWS-STR-OUT        TO R82-BILLING-ENTITY
               END-IF
               IF (WF1-CUSTOMER(1:1) = "D")
CPS001             MOVE WF4-CUSTOMER(2:6) TO WS-TMP-NBR-A
CPS001             IF (WF4-CUSTOMER(2:6)  NOT NUMERIC)
CPS001                 MOVE ZEROES         TO WS-TMP-NBR-A
AI0000             END-IF
AI0000             MOVE WS-TMP-NBR-A       TO JSTWS-STR
AI0000             MOVE 6                  TO JSTWS-STR-LEN
AI0000             MOVE 9                  TO JSTWS-STR-OUT-LEN
AI0000             SET JSTWS-NUMERIC TO TRUE
AI0000             PERFORM 2000-JUSTIFY-OBJECT
AI0000             MOVE JSTWS-STR-OUT      TO WS-WF2-CUSTOMER
AI0000         END-IF
P3FX04         IF (WF4-TRANS-TYPE = "C")
P3FX04             COMPUTE R82-TRAN-AMOUNT = WF4-TRAN-AMT * -1
P3FX04         END-IF
AI0000         MOVE WS-CUST-EMP-NUM     TO R82-EMPLOYEE
AI0000         MOVE WS-CUST-EMP-NUM     TO DB-EMPLOYEE
AI0000         PERFORM 840-FIND-EMPSET1
AI0000         IF (EMPLOYEE-FOUND)
AI0000             MOVE EMP-FIRST-NAME TO R82-FIRST-NAME
AI0000             MOVE EMP-LAST-NAME  TO R82-LAST-NAME
               END-IF
      *       DISPLAY "ManAdj2 : " WF4-CUSTOMER " " R82-EMPLOYEE  
      *--- Do not send employer for direct billed
              IF (ZR900WS-CUSTOMER(1:1) NOT = "E") 
                  MOVE SPACES                TO R82-EMPLOYER
              END-IF
      *--- Override Billing Group with "Employers" on
      *--- suppXXXXX billing items for Employers
              IF (ZR900WS-CUSTOMER(1:1) = "E") 
              AND ((R82-BILLING-ITEM = "suppEeLife")
              OR  (R82-BILLING-ITEM = "suppChild")
              OR  (R82-BILLING-ITEM = "suppSpouse"))
                  MOVE "employers"   TO R82-BILLING-GROUP
P3fX01            MOVE R82-EMPLOYER  TO R82-BILLING-ENTITY 
              END-IF  
      *--- If billing group is retirees, force billing item to have ret prefix
              IF (R82-BILLING-GROUP = "retirees")
                IF (R82-BILLING-ITEM = "medical")
                    MOVE "retMed"       TO R82-BILLING-ITEM
                END-IF
                IF (R82-BILLING-ITEM = "dental")
                    MOVE "retDental"    TO R82-BILLING-ITEM
                END-IF
                IF (R82-BILLING-ITEM = "vision")
                    MOVE "retVision"    TO R82-BILLING-ITEM
                END-IF
              END-IF
P3FX24        IF (R82-BILLING-ITEM = "conversionManAdj")
P3FX24            PERFORM 4000-DO-MANADJ-DISTRIBS 
P3FX24        ELSE
P3FX24            MOVE SPACES TO  R82-LAW-DISTRIBS
P3FX24        END-IF
AI0000        PERFORM 800-WRITECSV-RECORD82
           ELSE
DB0001*--- PBHSTDTL exists process Direct Billed customers
DB0001*--- separetly because PBHSTDTLs are different for them
DB0001        IF (ZR900WS-CUSTOMER(1:1) = "D")
DB0001            PERFORM 3024-DO-PBHSTDTL-D
DB0001            THRU    3024-END
DB0001        ELSE
P3FX19        MOVE WF4-TRX-AMT    TO WS-TEMP-ORIG
P3FX19        MOVE WF4-TRAN-AMT   TO WS-TEMP-AMT  
P3FX19        MOVE ZEROES         TO WS-TEMP-TOTAL
P3FX19        IF (WF4-TRANS-TYPE = "C")
P3FX19        OR (WF4-TRANS-TYPE = "2")
P3FX19            COMPUTE WS-TEMP-ORIG = WS-TEMP-ORIG * -1
P3FX19            COMPUTE WS-TEMP-AMT  = WS-TEMP-AMT  * -1
P3FX19        END-IF
              PERFORM 3021-DO-PBHSTDTL
                 THRU 3021-END
                 UNTIL (PBHSTDTL-NOTFOUND).

       3020-END.
AI0000******************************************************************
AI0000 3021-DO-PBHSTDTL.
AI0000******************************************************************
AI0000
           IF (ZB3-RECORD-TYPE = "O")
               GO TO 3021-NEXT-PBHSTDTL.

      *--- Check that PBHSTDTL is for the invoice based on benefit.
      *--- crosswalk to ARO-DESC field.
           MOVE SPACES                   TO DB-DTL-KEY.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "INV-TO-PBHST"           TO DB-LVL-2-KEY.
           MOVE SPACES                   TO DB-LVL-3-KEY.
           STRING ZB3-PLAN-TYPE          DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  ZB3-PLAN-CODE          DELIMITED BY SPACE
                                  INTO DB-DTL-KEY.
           PERFORM 840-FIND-IF1SET1.
           IF (LUPTBLDTL-NOTFOUND)
               GO TO 3021-NEXT-PBHSTDTL.
           IF (IF1-DTL-VALUE NOT = WF4-DESC)
               GO TO 3021-NEXT-PBHSTDTL.
RETROS*--- Process Retros separately                 
RETROS     IF (ZB3-REASON-CODE = "RETR")
               PERFORM 3022-DO-PBHSTDTL-RETRO
               THRU    3022-END
               GO TO 3021-NEXT-PBHSTDTL.  

      *    DISPLAY "zb3.Company: " ZB3-COMPANY
      *            " zb3.ProcLvl: " ZB3-PROCESS-LEVEL
      *            " zb3.Invoice: " ZB3-INVOICE
      *            " zb3.LineNbr: " ZB3-LINE-NBR.
AI0000     MOVE WF4-COMPANY        TO DB-COMPANY.
AI0000     MOVE ZB3-EMPLOYEE       TO DB-EMPLOYEE.
AI0000     MOVE ZB3-EMPLOYEE       TO R82-EMPLOYEE.
AI0000     PERFORM 840-FIND-EMPSET1.
AI0000     IF (EMPLOYEE-FOUND)
AI0000         MOVE EMP-FIRST-NAME TO R82-FIRST-NAME
AI0000         MOVE EMP-LAST-NAME  TO R82-LAST-NAME
           END-IF.
           MOVE ZB3-EMPLOYEE             TO WS-WF2-CUSTOMER.
           MOVE ZB3-PLAN-TYPE            TO WS-ZB3-PLAN-TYPE.
           MOVE ZB3-PLAN-CODE            TO WS-ZB3-PLAN-CODE.
           MOVE ZB3-BILLABLE-AMT         TO R82-TRAN-AMOUNT.
P3FX15
P3FX06     COMPUTE R82-TRAN-AMOUNT ROUNDED = WF4-TRAN-AMT
P3FX06                                      / WF4-TRX-AMT
P3FX06                                      * ZB3-BILLABLE-AMT.
P3FX19*--- Keep track of all calculated amounts - relevant on partial applys
P3FX19    COMPUTE WS-TEMP-TOTAL = WS-TEMP-TOTAL + R82-TRAN-AMOUNT.
P3FX19*---Reduce Orig invoice amt tracker by amount of this pbhstdtl
P3FX19    COMPUTE WS-TEMP-ORIG       = WS-TEMP-ORIG  
P3FX19                               - ZB3-BILLABLE-AMT.
P3FX19    COMPUTE WS-TEMP-DIFF = WS-TEMP-AMT - WS-TEMP-TOTAL.
P3FX19     IF (WS-TEMP-DIFF < 0 )
P3FX19         COMPUTE WS-TEMP-DIFF = WS-TEMP-DIFF * -1.
      *      DISPLAY "3021-diff " WS-TEMP-DIFF " " WS-TEMP-ORIG.
P3FX19    IF (WS-TEMP-ORIG = ZERO)
P3FX19    AND (WS-TEMP-DIFF NOT = ZERO)
      *       DISPLAY "3021 rounding diff " WF4-INVOICE " " 
      *        WS-TEMP-DIFF
P3FX19*--- Add/subtract rounding differences to last amount
P3FX19        COMPUTE R82-TRAN-AMOUNT = R82-TRAN-AMOUNT
P3FX19                                + WS-TEMP-AMT 
P3FX19                                - WS-TEMP-TOTAL.   

      *--- find Billing Item value using plan type and plan code
           INITIALIZE                       WS-LW-BENEFIT
                                            WS-LW-BILL-ITEM.
            PERFORM 3023-FIND-BILLING-ITEM
               THRU 3023-END.

           UNSTRING WS-BILLING-STRING    DELIMITED BY "^"
                                       INTO WS-LW-BENEFIT
                                            WS-LW-BILL-ITEM.

           MOVE WS-LW-BENEFIT            TO R82-BENEFIT.
      *--- Per LW, do not send conversion prefix on 82 records in bill item
      *     MOVE WS-LW-BILL-ITEM          TO R82-BILLING-ITEM.
           IF (WS-LW-BILL-ITEM NOT = "conversionManAdj")
AI0000         MOVE WS-LW-BILL-ITEM(11:30)    TO R82-BILLING-ITEM.

      *--- find the employee's Lifeworks equivalent of Plan and Coverage
      *--- Option.
           INITIALIZE                       WS-ZB3-PLAN-STR
                                            WS-EMP-PLN-OPT.
           STRING WS-ZB3-PLAN-TYPE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  WS-ZB3-PLAN-CODE       DELIMITED BY SPACE
                                       INTO WS-ZB3-PLAN-STR.
           MOVE WF4-TRANS-DATE           TO WS-AS-OF-DATE-ALP.
      *--- For pre-2023 increment date for advanced billing
           IF (WS-AS-OF-DATE-ALP < 20230101)
               MOVE WF4-TRANS-DATE     TO WSDR-FR-DATE
               MOVE 1                  TO WSDR-MONTH-INCR
               PERFORM 900-INCREMENT-DATE
               MOVE WSDR-TO-DATE       TO WS-AS-OF-DATE-ALP
           END-IF.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "BEN-PLAN-OPT"           TO DB-LVL-2-KEY.
           MOVE WS-ZB3-PLAN-STR          TO DB-LVL-3-KEY.
           MOVE WS-WF2-CUSTOMER          TO DB-DTL-KEY.
           PERFORM 850-FIND-NLT-IF1SET1.
           PERFORM
              UNTIL (LUPTBLDTL-NOTFOUND)
                 OR (IF1-LVL-1-KEY    NOT = WS-LEVEL-1)
                 OR (IF1-LVL-2-KEY    NOT = "BEN-PLAN-OPT")
                 OR (IF1-LVL-3-KEY    NOT = WS-ZB3-PLAN-STR)
                 OR (IF1-DTL-KEY(1:9) NOT = WS-WF2-CUSTOMER)

              IF  (WS-AS-OF-DATE-ALP NOT < IF1-DTL-KEY(11:8))
              AND (WS-AS-OF-DATE-ALP NOT > IF1-DTL-KEY(20:8))
                  MOVE IF1-DTL-VALUE      TO WS-EMP-PLN-OPT
              END-IF
              PERFORM 860-FIND-NEXT-IF1SET1

           END-PERFORM.
      *--- Defaults for retirement/pension benefits
           IF (WS-ZB3-PLAN-STR = "DI^PAE")
           OR (WS-ZB3-PLAN-STR = "DI^PAN")
           OR (WS-ZB3-PLAN-STR = "DI^PAV")
               MOVE "CRPAO-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PRS")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PFS")
               MOVE "CRPTOFULL-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PRS1")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DL^DOF")
               MOVE "DOF-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "HL^AGOD")
               MOVE "AGOD-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DL^PRM1")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "HL^CDM2")
               MOVE "CDM2-COVERAGE"    TO WS-EMP-PLN-OPT.
        
           IF (WS-EMP-PLN-OPT = SPACES)
               MOVE SPACES               TO WS-LW-PLAN
               MOVE SPACES               TO WS-LW-OPTION
               GO TO 3021-CONT
           ELSE
               UNSTRING WS-EMP-PLN-OPT       DELIMITED BY "-"
                                           INTO WS-LW-PLAN
                                                WS-LW-OPTION
           END-IF.
      *    DISPLAY "1087 WsEmpPlnOpt: " WS-EMP-PLN-OPT
      *            " WsLwPlan: " WS-LW-PLAN
      *            " WsLwOption: " WS-LW-OPTION.
       3021-CONT.
           MOVE WS-LW-PLAN              TO R82-PLAN.
           MOVE WS-LW-OPTION            TO R82-OPTION.
           IF (R82-PLAN = SPACES)
               MOVE SPACES          TO R82-OPTION 
               MOVE SPACES          TO R82-BENEFIT. 

      *--- Do not send employer for direct billed
           IF (ZR900WS-CUSTOMER(1:1) NOT = "E") 
               MOVE SPACES                TO R82-EMPLOYER
           END-IF.
           IF (R82-BENEFIT(1:8) = "SUPPLIFE")
                MOVE "suppLife"      TO R82-BILLING-GROUP
P3FX03          MOVE R82-EMPLOYEE    TO JSTWS-STR                 
P3FX03          INSPECT JSTWS-STR REPLACING LEADING "0" BY " " 
P3FX03          MOVE 9                        TO JSTWS-STR-LEN 
P3FX03          SET JSTWS-LEFT                TO TRUE 
P3FX03          PERFORM 2000-JUSTIFY-OBJECT 
P3FX03          MOVE JSTWS-STR-OUT        TO R82-BILLING-ENTITY
           END-IF.
      *--- Override Billing Group with "Employers" on
      *--- suppXXXXX billing items for Employers
              IF (ZR900WS-CUSTOMER(1:1) = "E") 
              AND ((R82-BILLING-ITEM = "suppEeLife")
              OR  (R82-BILLING-ITEM = "suppChild")
              OR  (R82-BILLING-ITEM = "suppSpouse"))
                  MOVE "employers"   TO R82-BILLING-GROUP 
P3FX01            MOVE R82-EMPLOYER  TO R82-BILLING-ENTITY.
      *--- If biling group is retirees, force billing item to have ret prefix
           IF (R82-BILLING-GROUP = "retirees")
             IF (R82-BILLING-ITEM = "medical")
                 MOVE "retMed"       TO R82-BILLING-ITEM
             END-IF
             IF (R82-BILLING-ITEM = "dental")
                 MOVE "retDental"    TO R82-BILLING-ITEM
             END-IF
             IF (R82-BILLING-ITEM = "vision")
                 MOVE "retVision"    TO R82-BILLING-ITEM
             END-IF
           END-IF.
P3FX24     IF (R82-BILLING-ITEM = "conversionManAdj")
P3FX24         PERFORM 4000-DO-MANADJ-DISTRIBS 
P3FX24     ELSE
P3FX24        MOVE SPACES TO  R82-LAW-DISTRIBS
P3FX24     END-IF.
AI0000     PERFORM 800-WRITECSV-RECORD82.
           ADD 1                   TO WS-82-COUNT.

       3021-NEXT-PBHSTDTL.
           PERFORM 860-FIND-NXTRNG-ZB3SET1.

       3021-END.
AI0000******************************************************************
AI0000 3022-DO-PBHSTDTL-RETRO.
AI0000******************************************************************
AI0000
           IF (ZB3-RECORD-TYPE = "O")
               GO TO 3022-END.               

      *--- Check that PBHSTDTL is for the invoice based on benefit.
      *--- crosswalk to ARO-DESC field.
           MOVE SPACES                   TO DB-DTL-KEY.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "INV-TO-PBHST"           TO DB-LVL-2-KEY.
           MOVE SPACES                   TO DB-LVL-3-KEY.
           STRING ZB3-PLAN-TYPE          DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  ZB3-PLAN-CODE          DELIMITED BY SPACE
                                  INTO DB-DTL-KEY.
           PERFORM 840-FIND-IF1SET1.
           IF (LUPTBLDTL-NOTFOUND)
               DISPLAY "****ERROR: Missing INV-TO-PBHST for: " 
               DB-DTL-KEY
               GO TO 3022-END.           
           IF (IF1-DTL-VALUE NOT = WF4-DESC)
               GO TO 3022-END.               

AI0000     MOVE WF4-COMPANY        TO DB-COMPANY.
AI0000     MOVE ZB3-EMPLOYEE       TO DB-EMPLOYEE.
AI0000     MOVE ZB3-EMPLOYEE       TO R82-EMPLOYEE.
AI0000     PERFORM 840-FIND-EMPSET1.
AI0000     IF (EMPLOYEE-FOUND)
AI0000         MOVE EMP-FIRST-NAME TO R82-FIRST-NAME
AI0000         MOVE EMP-LAST-NAME  TO R82-LAST-NAME
           END-IF.
           MOVE ZB3-EMPLOYEE             TO WS-WF2-CUSTOMER.
           MOVE ZB3-PLAN-TYPE            TO WS-ZB3-PLAN-TYPE.
           MOVE ZB3-PLAN-CODE            TO WS-ZB3-PLAN-CODE.
           MOVE ZB3-BILLABLE-AMT         TO R82-TRAN-AMOUNT.
P3FX06     COMPUTE R82-TRAN-AMOUNT ROUNDED = WF4-TRAN-AMT
P3FX06                             / WF4-TRX-AMT
P3FX06                             * ZB3-BILLABLE-AMT.
P3FX19*--- Keep track of all calculated amounts - relevant on partial applys
P3FX19    COMPUTE WS-TEMP-TOTAL = WS-TEMP-TOTAL + R82-TRAN-AMOUNT.
P3FX19*---Reduce Orig invoice amt tracker by amount of this pbhstdtl
P3FX19    COMPUTE WS-TEMP-ORIG       = WS-TEMP-ORIG  
P3FX19                               - ZB3-BILLABLE-AMT.
P3FX19    COMPUTE WS-TEMP-DIFF = WS-TEMP-AMT - WS-TEMP-TOTAL.
P3FX19     IF (WS-TEMP-DIFF < 0 )
P3FX19         COMPUTE WS-TEMP-DIFF = WS-TEMP-DIFF * -1.
P3FX19    IF (WS-TEMP-ORIG = ZERO)
P3FX19    AND (WS-TEMP-DIFF NOT = ZERO)
P3FX19*--- Add/subtract rounding differences to last amount
P3FX19        COMPUTE R82-TRAN-AMOUNT = R82-TRAN-AMOUNT
P3FX19                                + WS-TEMP-AMT 
P3FX19                                - WS-TEMP-TOTAL.   

      *--- find Billing Item value using plan type and plan code
           INITIALIZE                       WS-LW-BENEFIT
                                            WS-LW-BILL-ITEM.
            PERFORM 3023-FIND-BILLING-ITEM
               THRU 3023-END.
           UNSTRING WS-BILLING-STRING    DELIMITED BY "^"
                                       INTO WS-LW-BENEFIT
                                            WS-LW-BILL-ITEM.

           MOVE WS-LW-BENEFIT            TO R82-BENEFIT.
      *--- Per LW, do not send conversion prefix on 82 records in bill item
      *     MOVE WS-LW-BILL-ITEM          TO R82-BILLING-ITEM.
           IF (WS-LW-BILL-ITEM NOT = "conversionManAdj")
AI0000         MOVE WS-LW-BILL-ITEM(11:30)    TO R82-BILLING-ITEM.

      *--- find the employee's Lifeworks equivalent of Plan and Coverage
      *--- Option.
           INITIALIZE                       WS-ZB3-PLAN-STR
                                            WS-EMP-PLN-OPT.
           STRING WS-ZB3-PLAN-TYPE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  WS-ZB3-PLAN-CODE       DELIMITED BY SPACE
                                       INTO WS-ZB3-PLAN-STR.
           MOVE WF4-TRANS-DATE           TO WS-AS-OF-DATE-ALP.
      *--- For pre-2023 increment date for advanced billing
           IF (WS-AS-OF-DATE-ALP < 20230101)
               MOVE WF4-TRANS-DATE     TO WSDR-FR-DATE
               MOVE 1                  TO WSDR-MONTH-INCR
               PERFORM 900-INCREMENT-DATE
               MOVE WSDR-TO-DATE       TO WS-AS-OF-DATE-ALP
           END-IF.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "BEN-PLAN-OPT"           TO DB-LVL-2-KEY.
           MOVE WS-ZB3-PLAN-STR          TO DB-LVL-3-KEY.
           MOVE WS-WF2-CUSTOMER          TO DB-DTL-KEY.
           PERFORM 850-FIND-NLT-IF1SET1.
           PERFORM
              UNTIL (LUPTBLDTL-NOTFOUND)
                 OR (IF1-LVL-1-KEY    NOT = WS-LEVEL-1)
                 OR (IF1-LVL-2-KEY    NOT = "BEN-PLAN-OPT")
                 OR (IF1-LVL-3-KEY    NOT = WS-ZB3-PLAN-STR)
                 OR (IF1-DTL-KEY(1:9) NOT = WS-WF2-CUSTOMER)

              IF  (WS-AS-OF-DATE-ALP NOT < IF1-DTL-KEY(11:8))
              AND (WS-AS-OF-DATE-ALP NOT > IF1-DTL-KEY(20:8))
                  MOVE IF1-DTL-VALUE      TO WS-EMP-PLN-OPT
              END-IF
              PERFORM 860-FIND-NEXT-IF1SET1

           END-PERFORM.
      *--- Defaults for retirement/pension benefits
           IF (WS-ZB3-PLAN-STR = "DI^PAE")
           OR (WS-ZB3-PLAN-STR = "DI^PAN")
           OR (WS-ZB3-PLAN-STR = "DI^PAV")
               MOVE "CRPAO-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PRS")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PFS")
               MOVE "CRPTOFULL-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DI^PRS1")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DL^DOF")
               MOVE "DOF-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "HL^AGOD")
               MOVE "AGOD-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "DL^PRM1")
               MOVE "CRPTOREG-COVERAGE"    TO WS-EMP-PLN-OPT.
           IF (WS-ZB3-PLAN-STR = "HL^CDM2")
               MOVE "CDM2-COVERAGE"    TO WS-EMP-PLN-OPT.

           IF (WS-EMP-PLN-OPT = SPACES)
               MOVE SPACES               TO WS-LW-PLAN
               MOVE SPACES               TO WS-LW-OPTION
      *         GO TO 3022-CONT
           ELSE
               UNSTRING WS-EMP-PLN-OPT       DELIMITED BY "-"
                                           INTO WS-LW-PLAN
                                                WS-LW-OPTION
           END-IF.
      *    DISPLAY "1087 WsEmpPlnOpt: " WS-EMP-PLN-OPT
      *            " WsLwPlan: " WS-LW-PLAN
      *            " WsLwOption: " WS-LW-OPTION.
           MOVE WS-LW-PLAN              TO R82-PLAN.
           MOVE WS-LW-OPTION            TO R82-OPTION.
           IF (R82-PLAN = SPACES)
               MOVE SPACES          TO R82-OPTION 
               MOVE SPACES          TO R82-BENEFIT. 

       3022-CONT.
      *--- Back up one month for coverage dates
      *--- 1/10 - Do not backup the month, just use what is in PBHSTDTL
           MOVE ZB3-EFF-BILL-DT    TO WSDR-FR-DATE.
           MOVE ZB3-EFF-BILL-DT    TO R82-BEGIN-DATE.
           MOVE 01                 TO R82-BEGIN-DATE(7:2).
           MOVE ZB3-EFF-BILL-DT    TO WSDR-FR-DATE.
           PERFORM 900-GET-DATE-EOM.
           MOVE WSDR-TO-DATE       TO R82-END-DATE.
           MOVE "A"            TO R82-TRAN-TYPE .
           IF (R82-BENEFIT(1:8) = "SUPPLIFE")
                MOVE "suppLife"      TO R82-BILLING-GROUP
           END-IF.
      *--- Do not send employer for direct billed
           IF (ZR900WS-CUSTOMER(1:1) NOT = "E") 
               MOVE SPACES                TO R82-EMPLOYER
           END-IF.
           IF (R82-BENEFIT(1:8) = "SUPPLIFE")
                MOVE "suppLife"      TO R82-BILLING-GROUP
P3FX03          MOVE R82-EMPLOYEE    TO JSTWS-STR                 
P3FX03          INSPECT JSTWS-STR REPLACING LEADING "0" BY " " 
P3FX03          MOVE 9                        TO JSTWS-STR-LEN
P3FX03          SET JSTWS-LEFT                TO TRUE 
P3FX03          PERFORM 2000-JUSTIFY-OBJECT 
P3FX03          MOVE JSTWS-STR-OUT        TO R82-BILLING-ENTITY
           END-IF.

      *--- Override Billing Group with "Employers" on
      *--- suppXXXXX billing items for Employers
              IF (ZR900WS-CUSTOMER(1:1) = "E") 
              AND ((R82-BILLING-ITEM = "suppEeLife")
              OR  (R82-BILLING-ITEM = "suppChild")
              OR  (R82-BILLING-ITEM = "suppSpouse"))
P3FX01            MOVE R82-EMPLOYER  TO R82-BILLING-ENTITY
                  MOVE "employers"   TO R82-BILLING-GROUP.

      *--- If biling group is retirees, force billing item to have ret prefix
           IF (R82-BILLING-GROUP = "retirees")
             IF (R82-BILLING-ITEM = "medical")
                 MOVE "retMed"       TO R82-BILLING-ITEM
             END-IF
             IF (R82-BILLING-ITEM = "dental")
                 MOVE "retDental"    TO R82-BILLING-ITEM
             END-IF
             IF (R82-BILLING-ITEM = "vision")
                 MOVE "retVision"    TO R82-BILLING-ITEM
             END-IF
           END-IF.
P3FX24     IF (R82-BILLING-ITEM = "conversionManAdj")
P3FX24         PERFORM 4000-DO-MANADJ-DISTRIBS 
P3FX24     ELSE
P3FX24         MOVE SPACES TO  R82-LAW-DISTRIBS
P3FX24     END-IF.
AI0000     PERFORM 800-WRITECSV-RECORD82.
           ADD 1                   TO WS-82-COUNT.

       3022-END.

AI0000******************************************************************
AI0000 3023-FIND-BILLING-ITEM.
AI0000******************************************************************
       3023-START.

           IF (WS-WF2-CUSTOMER = SPACES)
               GO TO 3023-BY-PLAN
           END-IF.

      *--- try to find the Billing Item using an employee exception 
           INITIALIZE                       WS-ZB3-PLAN-STR
                                            WS-BILLING-STRING.
           MOVE WS-WF2-CUSTOMER          TO JSTWS-STR.
           MOVE 9                        TO JSTWS-STR-LEN.
           SET JSTWS-LEFT                TO TRUE.
           PERFORM 2000-JUSTIFY-OBJECT.
           STRING WS-ZB3-PLAN-TYPE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  WS-ZB3-PLAN-CODE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  JSTWS-STR-OUT          DELIMITED BY SPACE
                                       INTO WS-ZB3-PLAN-STR.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "BILLING-ITEM"           TO DB-LVL-2-KEY.
           MOVE SPACES                   TO DB-LVL-3-KEY.
           MOVE WS-ZB3-PLAN-STR          TO DB-DTL-KEY.
           PERFORM 840-FIND-IF1SET1.
           IF (LUPTBLDTL-FOUND)
               MOVE IF1-DTL-VALUE        TO WS-BILLING-STRING
      *--- Fix truncated Detail Value items
               IF (IF1-DTL-VALUE = "CRITILLEE^conversioncriticalIllE")
                    MOVE "CRITILLEE^conversioncriticalIllEe"
                                         TO WS-BILLING-STRING
               END-IF
               IF (IF1-DTL-VALUE = "CRITILLSP^conversioncriticalIllS")
                    MOVE "CRITILLSP^conversioncriticalIllSp"
                                         TO WS-BILLING-STRING
               END-IF
               IF (IF1-DTL-VALUE = "CRITILLCH^conversioncriticalIllC")
                    MOVE "CRITILLCH^conversioncriticalIllCh"
                                         TO WS-BILLING-STRING
               END-IF
               GO TO 3023-END
           END-IF.

       3023-BY-PLAN.
           INITIALIZE                       WS-ZB3-PLAN-STR
                                            WS-BILLING-STRING.
           STRING WS-ZB3-PLAN-TYPE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                  WS-ZB3-PLAN-CODE       DELIMITED BY SPACE
                  "^"                    DELIMITED BY SIZE
                                       INTO WS-ZB3-PLAN-STR.
           MOVE WS-LEVEL-1              TO DB-LVL-1-KEY.
           MOVE "BILLING-ITEM"           TO DB-LVL-2-KEY.
           MOVE SPACES                   TO DB-LVL-3-KEY.
           MOVE WS-ZB3-PLAN-STR          TO DB-DTL-KEY.
           PERFORM 840-FIND-IF1SET1.
           IF (LUPTBLDTL-FOUND)
               MOVE IF1-DTL-VALUE        TO WS-BILLING-STRING
      *--- Fix truncated Detail Value items
               IF (IF1-DTL-VALUE = "CRITILLEE^conversioncriticalIllE")
                    MOVE "CRITILLEE^conversioncriticalIllEe"
                                         TO WS-BILLING-STRING
               END-IF
               IF (IF1-DTL-VALUE = "CRITILLSP^conversioncriticalIllS")
                    MOVE "CRITILLSP^conversioncriticalIllSp"
                                         TO WS-BILLING-STRING
               END-IF
               IF (IF1-DTL-VALUE = "CRITILLCH^conversioncriticalIllC")
                    MOVE "CRITILLCH^conversioncriticalIllCh"
                                         TO WS-BILLING-STRING
               END-IF
           END-IF.

AI0000 3023-END.
AI0000
DB0001******************************************************************
DB0001 3024-DO-PBHSTDTL-D.
DB0001******************************************************************
DB0001
DB0001
DB0001*--- PBHSTDTL for direct billed customers are ordered by ZB3SETw2
DB0001*--- so the most recent EFF-BILL-DT is for 01, then next is for 02, etc
DB0001*--- so we'll build an arry of pbhstdtl in order and save the record
DB0001*--- keys to then call 1087 for that date based on the invoice suffix
DB0001*--- of 01, 02, etc                     
DB0001*--- Reset Keys for PBHSTDTL processing
DB0001*--- Processing will loop through all PBHSTDTL for current
DB0001*--- invoice and create balance work file records
DB0001     PERFORM VARYING I1 FROM 1 BY 1
DB0001     UNTIL (I1 > 100)
DB0001         MOVE ZEROES             TO WS-ZB3-COMPANY(I1)       
DB0001         MOVE ZEROES             TO WS-ZB3-EMPLOYEE(I1)      
DB0001         MOVE ZEROES             TO WS-ZB3-EFF-BILL-DT(I1)   
DB0001         MOVE SPACES             TO WS-ZB3-PROCESS-LEVEL(I1) 
DB0001         MOVE SPACES             TO WS-ZB3-INVOICE(I1)       
DB0001         MOVE ZEROES             TO WS-ZB3-LINE-NBR(I1).
DB0001
DB0001     MOVE ZR900WS-PRM-COMPANY      TO DB-COMPANY.
DB0001     MOVE ZR900WS-CUSTOMER(2:6)    TO WS-CUST-EMP-A.
DB0001     MOVE WS-CUST-EMP-N            TO DB-EMPLOYEE.   
DB0001     MOVE ZB3SET2-EMPLOYEE        TO WS-DB-BEG-RNG.
DB0001     PERFORM 850-FIND-BEGRNG-ZB3SET2.
DB0001     PERFORM 
DB0001     UNTIL (PBHSTDTL-NOTFOUND)
DB0001     IF (ZB3-RECORD-TYPE NOT = "O")
DB0001       IF (WF4-INVOICE(1:10) = ZB3-INVOICE)
P3FX12*--- Lookup benefit for pbhstdtl plan type and code
P3FX12*--- and compare to WF4-DESC from invoice
               MOVE SPACES                   TO DB-DTL-KEY 
               MOVE WS-LEVEL-1              TO DB-LVL-1-KEY 
               MOVE "INV-TO-PBHST"           TO DB-LVL-2-KEY 
               MOVE SPACES                   TO DB-LVL-3-KEY 
               STRING ZB3-PLAN-TYPE          DELIMITED BY SPACE
                      "^"                    DELIMITED BY SIZE
                      ZB3-PLAN-CODE          DELIMITED BY SPACE
                                      INTO DB-DTL-KEY 
               PERFORM 840-FIND-IF1SET1 
               IF (LUPTBLDTL-NOTFOUND)
                    DISPLAY "****ERROR : Missing INV-TO-PBHST for: " 
                      DB-DTL-KEY 
                     "on Invoice: " WF1-INVOICE " for Customer " 
                      WF1-CUSTOMER 
P3FX12         END-IF
DB0001         PERFORM VARYING I1 FROM 1 BY 1
DB0001         UNTIL (I1 > 100)
DB0001         OR (WS-ZB3-COMPANY(I1) = ZERO)
DB0001         OR ((WS-ZB3-COMPANY(I1) = ZB3-COMPANY)
DB0001         AND (WS-ZB3-EMPLOYEE(I1) = ZB3-EMPLOYEE)
P3FX12         AND (WS-ZB3-BENEFIT(I1) = IF1-DTL-VALUE)
               AND (WS-ZB3-EFF-BILL-DT(I1) = ZB3-EFF-BILL-DT))
DB0001             ADD 1 TO I7
DB0001         END-PERFORM
DB0001         IF (WS-ZB3-COMPANY(I1) = ZERO)
DB0001           MOVE ZB3-COMPANY        TO WS-ZB3-COMPANY(I1)       
DB0001           MOVE ZB3-EMPLOYEE       TO WS-ZB3-EMPLOYEE(I1)      
DB0001           MOVE ZB3-EFF-BILL-DT    TO WS-ZB3-EFF-BILL-DT(I1)   
P3FX12           MOVE IF1-DTL-VALUE      TO WS-ZB3-BENEFIT(I1)   
DB0001           MOVE ZB3-PROCESS-LEVEL  TO WS-ZB3-PROCESS-LEVEL(I1) 
DB0001           MOVE ZB3-INVOICE        TO WS-ZB3-INVOICE(I1)       
DB0001           MOVE ZB3-LINE-NBR       TO WS-ZB3-LINE-NBR(I1)
DB0001         END-IF
DB0001       PERFORM 860-FIND-NXTRNG-ZB3SET2 
DB0001       ELSE
DB0001       PERFORM 860-FIND-NXTRNG-ZB3SET2 
DB0001      END-IF
DB0001     ELSE
DB0001       PERFORM 860-FIND-NXTRNG-ZB3SET2. 
DB0001
DB0001     MOVE WF4-INVOICE(11:2)  TO WS-INVOICE-SEQ-A.
DB0001     IF (WS-INVOICE-SEQ-A NOT NUMERIC)
DB0001        DISPLAY "ERROR: Invalid Invoice SEQb: "
DB0001        WF4-CUSTOMER " " WF4-INVOICE
DB0001        GO TO 3024-END.
DB0001
DB0001     IF (WS-ZB3-COMPANY(WS-INVOICE-SEQ-N) = ZEROS)
DB0001        DISPLAY "ERROR: Invalid Invoice SEQb for PBHSTDTL: "
DB0001        WF4-CUSTOMER " " WF4-INVOICE " " ZB3-EFF-BILL-DT " " 
              IF1-DTL-VALUE
DB0001        GO TO 3024-END.
DB0001
DB0001     MOVE WS-INVOICE-SEQ-N        TO I7.
DB0001     MOVE WS-ZB3-COMPANY(I7)      TO DB-COMPANY.
DB0001     MOVE WS-ZB3-PROCESS-LEVEL(I7) TO DB-PROCESS-LEVEL.
DB0001     MOVE WS-ZB3-INVOICE(I7)      TO DB-INVOICE.
DB0001     MOVE ZB3SET1-INVOICE         TO WS-DB-BEG-RNG.
DB0001     PERFORM 850-FIND-BEGRNG-ZB3SET1.
DB0001     PERFORM 
DB0001     UNTIL (PBHSTDTL-NOTFOUND)
DB0001         IF (ZB3-RECORD-TYPE NOT = "O")
DB0001         AND (ZB3-EFF-BILL-DT = WS-ZB3-EFF-BILL-DT(I7))
DB0001             PERFORM 3021-DO-PBHSTDTL
DB0001             THRU 3021-END
DB0001         ELSE
DB0001             PERFORM 860-FIND-NXTRNG-ZB3SET1
DB0001         END-IF
DB0001     END-PERFORM.
DB0001
DB0001 3024-END.
DB0001
DB0001
AI0000******************************************************************
AI0000 3025-WRITE-RTR-TRX. 
AI0000******************************************************************
AI0000 3025-START.

      *--- set period begin and end date based on the transaction date
      *   DISPLAY "3025 - tran date " WF4-TRANS-DATE.
           MOVE WF4-TRANS-DATE     TO WS-PER-BEG-DATE
                                      WSDR-FR-DATE.
           MOVE 01                 TO WS-PER-BEG-DATE(07:02).
           PERFORM 900-GET-DATE-EOM.
           MOVE WSDR-TO-DATE       TO WS-PER-END-DATE.

      *--- write the R82 record.
           INITIALIZE                 R82-RECORD82-REC.
           MOVE "82"               TO R82-DATA-TYPE.
           MOVE "1"                TO R82-REC-TYPE.    
           MOVE "001"              TO R82-VERSION.     
AI0000     MOVE WF4-EMPLOYEE       TO R82-EMPLOYEE.
AI0000     MOVE WF4-COMPANY        TO DB-COMPANY.
           IF (WF4-EMPLOYEE NOT = ZERO)
AI0000        MOVE WF4-EMPLOYEE       TO DB-EMPLOYEE
AI0000        PERFORM 840-FIND-EMPSET1
AI0000        IF (EMPLOYEE-FOUND)
AI0000            MOVE EMP-FIRST-NAME TO R82-FIRST-NAME
AI0000            MOVE EMP-LAST-NAME  TO R82-LAST-NAME
              END-IF
AI0000     END-IF.
      *--- Alter BIlling Entity and Employer
AI0000*     MOVE ZR900WS-CUSTOMER   TO R82-BILLING-ENTITY.
           IF (ZR900WS-CUSTOMER(1:1) = "E")
              MOVE ZR900WS-CUSTOMER(3:5) TO R82-EMPLOYER
                                            R82-BILLING-ENTITY
              IF (ZR900WS-CUSTOMER = "ER0DISW")
                   MOVE "DISW"         TO R82-EMPLOYER
                                          R82-BILLING-ENTITY
              END-IF
           ELSE
              MOVE ZR900WS-CUSTOMER(2:6) TO R82-BILLING-ENTITY
              MOVE R82-BILLING-ENTITY  TO JSTWS-STR
              MOVE 6                   TO JSTWS-STR-LEN
              SET JSTWS-LEFT           TO TRUE
              PERFORM 2000-JUSTIFY-OBJECT
              MOVE JSTWS-STR-OUT       TO R82-BILLING-ENTITY
           END-IF.
AI0000     MOVE WS-BILLING-GRP     TO R82-BILLING-GROUP.
           MOVE SPACES             TO R82-BILLING-ITEM.
           MOVE WF4-TRAN-AMT       TO R82-TRAN-AMOUNT.
           MOVE WS-PER-BEG-DATE    TO R82-BEGIN-DATE.
           MOVE WS-PER-END-DATE    TO R82-END-DATE.
           MOVE "I"                TO R82-TRAN-TYPE.
           IF (WF4-TRANS-TYPE NOT = "I")
           OR (WF4-TRANS-DATE > PRM-TRANS-DATE)
               MOVE "A"            TO R82-TRAN-TYPE
           END-IF.
           MOVE WF4-LW-BENEFIT     TO R82-BENEFIT.
           MOVE WF4-LW-PLAN        TO R82-PLAN.
           MOVE WF4-LW-OPTION      TO R82-OPTION.
           IF (R82-PLAN = SPACES)
               MOVE SPACES          TO R82-OPTION 
               MOVE SPACES          TO R82-BENEFIT. 
           MOVE WF4-TRANS-DATE     TO R82-TRAN-DATE.
debug      MOVE WF4-INVOICE          TO R82-LAW-INVOICE.
           IF (WF4-TRANS-TYPE = "R")
              IF (WF4-LW-BILL-ITEM NOT = "conversionManAdj")
               MOVE WF4-LW-BILL-ITEM(11:30)  TO R82-BILLING-ITEM
              END-IF
               IF (R82-BENEFIT(1:8) = "SUPPLIFE")
                   MOVE "suppLife"      TO R82-BILLING-GROUP
P3FX03             MOVE R82-EMPLOYEE    TO JSTWS-STR                 
P3FX03             INSPECT JSTWS-STR REPLACING LEADING "0" BY " " 
P3FX03             MOVE 9                        TO JSTWS-STR-LEN
P3FX03             SET JSTWS-LEFT                TO TRUE 
P3FX03             PERFORM 2000-JUSTIFY-OBJECT 
P3FX03             MOVE JSTWS-STR-OUT        TO R82-BILLING-ENTITY
               END-IF
               IF (ZR900WS-CUSTOMER(1:1) = "D")
CPS001             MOVE WF4-CUSTOMER(2:6) TO WS-TMP-NBR-A
CPS001             IF (WF4-CUSTOMER(2:6)  NOT NUMERIC)
CPS001                 MOVE ZEROES         TO WS-TMP-NBR-A
AI0000             END-IF
AI0000             MOVE WS-TMP-NBR-A       TO JSTWS-STR
AI0000             MOVE 6                  TO JSTWS-STR-LEN
AI0000             MOVE 9                  TO JSTWS-STR-OUT-LEN
AI0000             SET JSTWS-NUMERIC TO TRUE
AI0000             PERFORM 2000-JUSTIFY-OBJECT
AI0000             MOVE JSTWS-STR-OUT      TO WS-WF2-CUSTOMER
AI0000         MOVE WS-CUST-EMP-NUM     TO R82-EMPLOYEE
AI0000         MOVE WS-CUST-EMP-NUM     TO DB-EMPLOYEE
AI0000         PERFORM 840-FIND-EMPSET1
AI0000         IF (EMPLOYEE-FOUND)
AI0000             MOVE EMP-FIRST-NAME TO R82-FIRST-NAME
AI0000             MOVE EMP-LAST-NAME  TO R82-LAST-NAME
               END-IF
AI0000         END-IF
      *       DISPLAY "ManAdj2 : " WF4-CUSTOMER " " R82-EMPLOYEE  
      *--- Do not send employer for direct billed
              IF (ZR900WS-CUSTOMER(1:1) NOT = "E") 
                  MOVE SPACES                TO R82-EMPLOYER
              END-IF
      *--- Override Billing Group with "Employers" on
      *--- suppXXXXX billing items for Employers
              IF (ZR900WS-CUSTOMER(1:1) = "E") 
              AND ((R82-BILLING-ITEM = "suppEeLife")
              OR  (R82-BILLING-ITEM = "suppChild")
              OR  (R82-BILLING-ITEM = "suppSpouse"))
P3FX01            MOVE R82-EMPLOYER  TO R82-BILLING-ENTITY 
                  MOVE "employers"   TO R82-BILLING-GROUP
              END-IF  
      *--- If billing group is retirees, force billing item to have ret prefix
              IF (R82-BILLING-GROUP = "retirees")
                IF (R82-BILLING-ITEM = "medical")
                    MOVE "retMed"       TO R82-BILLING-ITEM
                END-IF
                IF (R82-BILLING-ITEM = "dental")
                    MOVE "retDental"    TO R82-BILLING-ITEM
                END-IF
                IF (R82-BILLING-ITEM = "vision")
                    MOVE "retVision"    TO R82-BILLING-ITEM
                END-IF
              END-IF
P3FX24        IF (R82-BILLING-ITEM = "conversionManAdj")
P3FX24            PERFORM 4000-DO-MANADJ-DISTRIBS 
P3FX24        ELSE
P3FX24            MOVE SPACES TO  R82-LAW-DISTRIBS
P3FX24        END-IF
AI0000        PERFORM 800-WRITECSV-RECORD82.

       3025-END.

AI0000******************************************************************
AI0000 3030-WRITE-PYMT-TRX.
AI0000******************************************************************
AI0000 3030-START.

           INITIALIZE                  R84-RECORD84-REC.
           MOVE "84"                TO R84-DATA-TYPE.
           MOVE "1"                 TO R84-REC-TYPE.    
           MOVE "001"               TO R84-VERSION.
           IF (ZR900WS-CUSTOMER(1:1) = "E")
      *--- Per LW do not send ER portion in Employer or Bill Entity
      *       MOVE ZR900WS-CUSTOMER TO R84-EMPLOYER
      *                                R84-BILLING-ENTITY
              MOVE ZR900WS-CUSTOMER(3:5) TO R84-EMPLOYER
                                       R84-BILLING-ENTITY
              IF (ZR900WS-CUSTOMER = "ER0DISW")
                   MOVE "DISW"         TO R84-EMPLOYER
                                          R84-BILLING-ENTITY
              END-IF
           ELSE
      *--- Per LW do not send leading zeros on direct bill Bill Entity
      *       MOVE WF4-EMPLOYEE     TO R84-BILLING-ENTITY
              MOVE WF4-EMPLOYEE     TO R84-BILLING-ENTITY
              MOVE R84-BILLING-ENTITY  TO JSTWS-STR
              MOVE 9                   TO JSTWS-STR-LEN
              SET JSTWS-LEFT           TO TRUE
     **         SET JSTWS-NO-REMOVE-0    TO TRUE
              PERFORM 2000-JUSTIFY-OBJECT
              MOVE JSTWS-STR-OUT       TO R84-BILLING-ENTITY
           END-IF.
      *--- Check if payment is applied against a LIFE invoice and if so
      *--- override Billing Group to be "suppLife"
           IF (WF4-CUSTOMER(1:1) = "D")
               MOVE PRM-COMPANY         TO DB-COMPANY
               MOVE WF4-CUSTOMER        TO DB-CUSTOMER
               MOVE "P"                 TO DB-TRANS-TYPE
               MOVE WF4-LW-CHK-NBR      TO DB-TRANS-NBR
               MOVE WF4-LW-BATCH        TO DB-BATCH-NBR
               PERFORM 840-FIND-APMSET7
               IF (ARPAYMENT-FOUND)
                   MOVE APM-COMPANY     TO DB-CR-COMPANY
                   MOVE APM-BATCH-NBR   TO DB-CR-BATCH          
                   MOVE APM-PAYMENT-SEQ TO DB-CR-PYMNT-SEQ
                   MOVE ARASET2-CR-PYMNT-SEQ TO WS-DB-BEG-RNG
                   PERFORM 850-FIND-BEGRNG-ARASET2
                   PERFORM 
                    UNTIL (ARAPPLIED-NOTFOUND)
                      MOVE ARA-COMPANY   TO DB-COMPANY
                      MOVE ARA-TRANS-TYPE TO DB-TRANS-TYPE
                      MOVE ARA-INVOICE     TO DB-INVOICE
                      PERFORM 840-FIND-ARHSET1
                      IF (AROIHDR-FOUND)
                      AND (ARH-DESC = "LIFE")
                          MOVE "suppLife"   TO WS-BILLING-GRP
                      END-IF
                     PERFORM 860-FIND-NXTRNG-ARASET2
                   END-PERFORM
               END-IF
           END-IF.

           MOVE WS-BILLING-GRP      TO R84-BILLING-GROUP.
           MOVE WF4-LW-CHK-NBR      TO JSTWS-STR.
           MOVE 10                  TO JSTWS-STR-LEN.
           SET JSTWS-LEFT           TO TRUE.
           SET JSTWS-NO-REMOVE-0    TO TRUE.
           PERFORM 2000-JUSTIFY-OBJECT.
           MOVE JSTWS-STR-OUT       TO R84-CHECK-NBR.
           MOVE "C"                 TO R84-SOURCE.
           IF (JSTWS-STR-OUT(1:3) = "ACH")
               MOVE "A"             TO R84-SOURCE
           END-IF.
           IF (JSTWS-STR-OUT(1:3) = "OTP" OR "PMC")
           OR (JSTWS-STR-OUT(1:4) = "AUTO" OR "RECP")
               MOVE "O"             TO R84-SOURCE
           END-IF.
           IF (JSTWS-STR-OUT(1:4) = "WIRE")
               MOVE "W"             TO R84-SOURCE
           END-IF.
           IF (JSTWS-STR-OUT(1:4) = "0000")
               MOVE "L"             TO R84-SOURCE
           END-IF.
           MOVE WF4-LW-DATE-RECVD   TO R84-DATE-RECEIVED.
           MOVE WF4-TRAN-AMT        TO R84-AMOUNT.
           IF (WF4-TRAN-AMT < 0)
              COMPUTE R84-AMOUNT = WF4-TRAN-AMT * NEGATIVE-ONE
           END-IF.

      *--- Do not send employer for direct billed
           IF (ZR900WS-CUSTOMER(1:1) NOT = "E") 
               MOVE SPACES                TO R84-EMPLOYER
           END-IF.
           PERFORM 800-WRITECSV-RECORD84.
           ADD 1                   TO WS-84-COUNT.

AI0000 3030-END.
AI0000
AI0000 3000-END.
P3FX24******************************************************************
P3FX24 4000-DO-MANADJ-DISTRIBS             SECTION.
P3FX24******************************************************************
P3FX24 4000-START.
           MOVE SPACES             TO R82-LAW-DISTRIBS.
           MOVE SPACES             TO WS-LAW-DISTRIBS.
           MOVE 1000               TO DB-COMPANY.
           MOVE WF4-TRANS-TYPE     TO DB-TRANS-TYPE.
           MOVE R82-LAW-INVOICE    TO DB-INVOICE.
           PERFORM 840-FIND-ARHSET1.
           IF (AROIHDR-NOTFOUND)
               GO TO 4000-END
           ELSE
               MOVE ARH-COMPANY        TO DB-COMPANY
               MOVE ARH-BATCH-NBR      TO DB-BATCH-NBR
               MOVE ARH-TRANS-TYPE     TO DB-TRANS-TYPE
               MOVE ARH-INVOICE        TO DB-INVOICE
               MOVE ARH-CUSTOMER       TO DB-CUSTOMER
               MOVE AMDSET2-CUSTOMER   TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-AMDSET2
               PERFORM 4001-DO-MANADJ-DISTRIBS
                   UNTIL (ARDISTRIB-NOTFOUND).
P3FX24
P3FX24 4000-END.
P3FX24******************************************************************
P3FX24 4001-DO-MANADJ-DISTRIBS             SECTION.
P3FX24******************************************************************
P3FX24 4001-START.
           MOVE AMD-GL-COMPANY      TO DB-COMPANY.
           PERFORM 840-FIND-GLSSET1.       
           MOVE GLS-CHART-NAME   TO DB-CHART-NAME.
           MOVE AMD-ACCOUNT     TO DB-ACCOUNT.
           MOVE AMD-SUB-ACCT TO DB-SUB-ACCOUNT.
           PERFORM 840-FIND-GDTSET2.
           IF (R82-LAW-DISTRIBS = SPACES)
               MOVE GDT-ACCOUNT-DESC    TO R82-LAW-DISTRIBS
           ELSE
               STRING R82-LAW-DISTRIBS DELIMITED BY "  " 
                      "^"              DELIMITED BY SIZE
                      GDT-ACCOUNT-DESC DELIMITED BY SIZE
                                      INTO WS-LAW-DISTRIBS
                MOVE WS-LAW-DISTRIBS   TO R82-LAW-DISTRIBS
           END-IF.
       4001-NEXT.     
           PERFORM 860-FIND-NXTRNG-AMDSET2.
P3FX24
P3FX24 4001-END.
AI0000
      ******************************************************************
       8000-CREATE-ZR9001WORK              SECTION.
      ******************************************************************
       8000-START.

           MOVE ZEROES                 TO WF1-COMPANY
                                          WF1-DUE-DATE
                                          WF1-TRAN-AMT
                                          WF1-AGE-PERIOD
                                          WF1-FOR-PERIOD
                                          WF1-PAST
                                          WF1-DISPUTE-SEQ
                                          WF1-AMOUNT
                                          WF1-COMP
                                          WF1-XREF-COMPANY
                                          WF1-ORIG-ND
                                          WF1-SORT-DATE
                                          WF1-PAYMENT-SEQ
                                          WF1-TRANS-SORT
                                          WF1-BATCH-NBR
                                          WF1-DISPUTE-AMT
                                          WF1-AMOUNT
                                          WF1-LAST-AGE-PER
                                          WF1-LAST-STA-DATE
                                          WF1-LAST-FC-DATE
                                          WF1-LAST-LTR-DATE
                                          WF1-CANCEL-DATE
                                          WF1-SEQ-NBR.
           MOVE SPACES                 TO WF1-ORIG-CURRENCY
                                          WF1-CANCEL-CUST
                                          WF1-SEARCH-NAME
                                          WF1-CANCEL-CUST
                                          WF1-CUSTOMER
                                          WF1-TRANS-TYPE
                                          WF1-TRANS-SORT-SIGN
                                          WF1-INVOICE
                                          WF1-DISPUTE-EXISTS
                                          WF1-CANCEL-FLAG
                                          WF1-DESC
                                          WF1-CUST-PO-NBR
                                          WF1-ACTIVITY
                                          WF1-XREF-TYPE
                                          WF1-XREF-NBR
                                          WF1-SORT-1
                                          WF1-SORT-2
                                          WF1-SORT-3
                                          WF1-SORT-4
                                          WF1-CUST
                                          WF1-FUTURE
                                          WF1-APPL
                                          WF1-CR-INVOICE
                                          WF1-DISPUTE-TYPE
                                          WF1-SUM-LINE.

           MOVE WS-TRUE                 TO ZR900WS-ZR900WORK-CREATED-SW.

      ******************************************************************
       8200-STORE-ZR9001WORK               SECTION.
      ******************************************************************
       8200-START.

           IF (ZR900WORK-CREATED)
               WRITE ZR9001WORK-REC        INVALID KEY
                   MOVE WF1-COMPANY         TO ZR900WS-WF1-COMPANY
                   MOVE WF1-SORT-FIELD      TO ZR900WS-WF1-SORT-FIELD
                   MOVE WF1-ORIG-CURRENCY   TO ZR900WS-WF1-ORIG-CURRENCY
                   MOVE WF1-SEARCH-NAME     TO ZR900WS-WF1-SEARCH-NAME
                   MOVE WF1-CUSTOMER        TO ZR900WS-WF1-CUSTOMER
                   MOVE WF1-SEQ-NBR         TO ZR900WS-WF1-SEQ-NBR
                   MOVE WF1-TRANS-TYPE      TO ZR900WS-WF1-TRANS-TYPE
                   MOVE WF1-INVOICE         TO ZR900WS-WF1-INVOICE
                   MOVE WF1-PAYMENT-SEQ     TO ZR900WS-WF1-PAYMENT-SEQ
                   MOVE WF1-CR-INVOICE      TO ZR900WS-WF1-CR-INVOICE
                   MOVE WF1-BATCH-NBR       TO ZR900WS-WF1-BATCH-NBR
                   MOVE ZR900WS-WF1-REC-KEY TO CRT-ERR-VAR1
                   MOVE 402                 TO CRT-MSG-NBR
                   PERFORM 780-DISPLAY-MSG.

           IF (NOT ZR900WORK-CREATED)
               REWRITE ZR9001WORK-REC      INVALID KEY
                   MOVE WF1-COMPANY         TO ZR900WS-WF1-COMPANY
                   MOVE WF1-SORT-FIELD      TO ZR900WS-WF1-SORT-FIELD
                   MOVE WF1-ORIG-CURRENCY   TO ZR900WS-WF1-ORIG-CURRENCY
                   MOVE WF1-SEARCH-NAME     TO ZR900WS-WF1-SEARCH-NAME
                   MOVE WF1-CUSTOMER        TO ZR900WS-WF1-CUSTOMER
                   MOVE WF1-SEQ-NBR         TO ZR900WS-WF1-SEQ-NBR
                   MOVE WF1-TRANS-TYPE      TO ZR900WS-WF1-TRANS-TYPE
                   MOVE WF1-INVOICE         TO ZR900WS-WF1-INVOICE
                   MOVE WF1-PAYMENT-SEQ     TO ZR900WS-WF1-PAYMENT-SEQ
                   MOVE WF1-CR-INVOICE      TO ZR900WS-WF1-CR-INVOICE
                   MOVE WF1-BATCH-NBR       TO ZR900WS-WF1-BATCH-NBR
                   MOVE ZR900WS-WF1-REC-KEY TO CRT-ERR-VAR1
                   MOVE 402                 TO CRT-MSG-NBR
                   PERFORM 780-DISPLAY-MSG.

           MOVE WS-FALSE               TO ZR900WS-ZR900WORK-CREATED-SW.

      ******************************************************************
       8400-FIND-ZR9001WORK               SECTION.
      ******************************************************************
       8400-START.

           MOVE WS-FALSE               TO ARWORK-SW.

           READ ZR9001WORK-FILE            KEY WF1-REC-KEY
               INVALID KEY
                   MOVE WS-TRUE        TO ARWORK-SW.

      ******************************************************************
       8500-FIND-NLT-ZR9001WORK           SECTION.
      ******************************************************************
       8500-START.

           MOVE WS-FALSE               TO ARWORK-SW.

           START ZR9001WORK-FILE           KEY NOT < WF1-REC-KEY
               INVALID KEY
                   MOVE WS-TRUE        TO ARWORK-SW.

           IF (ARWORK-FOUND)
               PERFORM 8600-FIND-NEXT-ZR9001WORK.

      ******************************************************************
       8600-FIND-NEXT-ZR9001WORK          SECTION.
      ******************************************************************
       8600-START.

           MOVE WS-FALSE               TO ARWORK-SW.

           READ ZR9001WORK-FILE NEXT RECORD
               AT END
                   MOVE WS-TRUE        TO ARWORK-SW.


AI0000******************************************************************
AI0000 8000-CREATE-ZR9002WORK              SECTION.
AI0000******************************************************************
AI0000 8000-START.

           INITIALIZE                     WF2-REC-KEY
                                          WF2-DATA-FLDS.

           MOVE WS-TRUE                TO ZR900WS-ZR9002WORK-CREATED-SW.
AI0000
AI0000******************************************************************
AI0000 8200-STORE-ZR9002WORK               SECTION.
AI0000******************************************************************
AI0000 8200-START.

      *    DISPLAY "Company: " WF2-COMPANY
      *            " Customer: " WF2-CUSTOMER.
      *    DISPLAY "employee: " WF2-EMPLOYEE
      *            " BillItem: " WF2-LW-BILL-ITEM
      *            " PlanType: " WF2-PLAN-TYPE
      *            " PlanCode: " WF2-PLAN-CODE.
      *    DISPLAY "Wk2Rec: " ZR9002WORK-REC.
           IF (ZR9002WORK-CREATED)
               WRITE ZR9002WORK-REC        INVALID KEY
                   MOVE WF2-COMPANY         TO ZR900WS-WF2-COMPANY
                   MOVE WF2-CUSTOMER        TO ZR900WS-WF2-CUSTOMER
                   MOVE WF2-EMPLOYEE        TO ZR900WS-WF2-EMPLOYEE
                   MOVE WF2-LW-BILL-ITEM    TO ZR900WS-WF2-LW-BILL-ITEM
                   MOVE WF2-PLAN-TYPE       TO ZR900WS-WF2-PLAN-TYPE
                   MOVE WF2-PLAN-CODE       TO ZR900WS-WF2-PLAN-CODE
                   MOVE "Write"             TO CRT-ERR-VAR1
                   MOVE ZR900WS-WF2-REC-KEY TO CRT-ERR-VAR2
                   MOVE 902                 TO CRT-MSG-NBR
                   PERFORM 780-DISPLAY-MSG.

           IF (NOT ZR9002WORK-CREATED)
               REWRITE ZR9002WORK-REC      INVALID KEY
                   MOVE WF2-COMPANY         TO ZR900WS-WF2-COMPANY
                   MOVE WF2-CUSTOMER        TO ZR900WS-WF2-CUSTOMER
                   MOVE WF2-EMPLOYEE        TO ZR900WS-WF2-EMPLOYEE
                   MOVE WF2-LW-BILL-ITEM    TO ZR900WS-WF2-LW-BILL-ITEM
                   MOVE WF2-PLAN-TYPE       TO ZR900WS-WF2-PLAN-TYPE
                   MOVE WF2-PLAN-CODE       TO ZR900WS-WF2-PLAN-CODE
                   MOVE "Rewrite"           TO CRT-ERR-VAR1
                   MOVE ZR900WS-WF2-REC-KEY TO CRT-ERR-VAR2
                   MOVE 902                 TO CRT-MSG-NBR
                   PERFORM 780-DISPLAY-MSG.

           MOVE WS-FALSE               TO ZR900WS-ZR9002WORK-CREATED-SW.
AI0000
AI0000******************************************************************
AI0000 8400-FIND-ZR9002WORK               SECTION.
AI0000******************************************************************
AI0000 8400-START.
AI0000
AI0000     MOVE WS-FALSE               TO LWWORK-SW.
AI0000
AI0000     READ ZR9002WORK-FILE            KEY WF2-REC-KEY
AI0000         INVALID KEY
AI0000             MOVE WS-TRUE        TO LWWORK-SW.
AI0000
AI0000 8400-END.
AI0000******************************************************************
AI0000 8500-FIND-NLT-ZR9002WORK           SECTION.
AI0000******************************************************************
AI0000 8500-START.
AI0000
AI0000     MOVE WS-FALSE               TO LWWORK-SW.
AI0000
AI0000     START ZR9002WORK-FILE           KEY NOT < WF2-REC-KEY
AI0000         INVALID KEY
AI0000             MOVE WS-TRUE        TO LWWORK-SW.
AI0000
AI0000     IF (LWWORK-FOUND)
AI0000         PERFORM 8600-FIND-NEXT-ZR9002WORK.
AI0000
AI0000 8500-END.
AI0000******************************************************************
AI0000 8600-FIND-NEXT-ZR9002WORK          SECTION.
AI0000******************************************************************
AI0000 8600-START.
AI0000
AI0000     MOVE WS-FALSE               TO LWWORK-SW.
AI0000
AI0000     READ ZR9002WORK-FILE NEXT RECORD
AI0000         AT END
AI0000             MOVE WS-TRUE        TO LWWORK-SW.
AI0000
AI0000 8600-END.
      ******************************************************************
       9000-DO-CPS-CUST-DETAIL            SECTION.
      ******************************************************************
       9000-START.

P3FX21     IF (WS-SAVE-CUSTOMER NOT = AR50F1-ACM-CUSTOMER)
P3FX21         MOVE 1000              TO AR50F1-ACM-COMPANY 
P3FX21         MOVE WS-SAVE-CUSTOMER  TO AR50F1-ACM-CUSTOMER 
P3FX21         MOVE "I"               TO AR50F1-FC 
P3FX21         PERFORM AR50S1-TRANSACTION 
P3FX21*        DISPLAY "FX21 balance " WS-SAVE-CUSTOMER " " 
      *           " " WS-SAVE-CUSTOMER(3:2) " " AR50F1-ACM-CURR-BAL 
      *        DISPLAY "Future " AR50F1-OPEN-AMT 
      *        DISPLAY "Current" AR50F1-OPEN-AMT1 
      *        DISPLAY "1-30   " AR50F1-OPEN-AMT2 
      *        DISPLAY "31-60  " AR50F1-OPEN-AMT3 
      *        DISPLAY "61-90  " AR50F1-OPEN-AMT4 
      *        DISPLAY "91-120 " AR50F1-OPEN-AMT5 
      *        DISPLAY "121-150" AR50F1-OPEN-AMT6 
      *        DISPLAY "151-170" AR50F1-OPEN-AMT7 
      *        DISPLAY "Over170" AR50F1-OPEN-AMT8.
P3FX21
P3FX21     IF (AR50F1-ACM-CURR-BAL NOT > ZERO)
P3FX21     AND (AR50F1-OPEN-AMT NOT > ZERO)
P3FX21     AND (AR50F1-OPEN-AMT1 NOT > ZERO)
P3FX21     AND (AR50F1-OPEN-AMT2 NOT > ZERO)
P3FX21         MOVE "W"           TO WS-SAVE-STATUS
P3FX21     END-IF.
P3FX21     IF (WS-SAVE-CUSTOMER (3:2) = "ER")
P3FX21         IF (AR50F1-OPEN-AMT2 > 0 )
P3FX21             MOVE "D"       TO WS-SAVE-STATUS
P3FX21         END-IF
P3FX21         IF (AR50F1-OPEN-AMT3 > 0 )
P3FX21             MOVE "3"       TO WS-SAVE-STATUS
P3FX21         END-IF
P3FX21         IF (AR50F1-OPEN-AMT4  > 0 )
P3FX21             MOVE "6"       TO WS-SAVE-STATUS
P3FX21         END-IF
P3FX21         IF (AR50F1-OPEN-AMT5 > 0 )
P3FX21             MOVE "9"       TO WS-SAVE-STATUS
P3FX21         END-IF
P3FX21         IF (AR50F1-OPEN-AMT6   > 0 )
P3FX21             MOVE "2"       TO WS-SAVE-STATUS
P3FX21         END-IF
P3FX21         IF (AR50F1-OPEN-AMT7 > 0 )
P3FX21             MOVE "5"       TO WS-SAVE-STATUS
P3FX21         END-IF
P3FX21         IF (AR50F1-OPEN-AMT8 > 0 )
P3FX21             MOVE "7"       TO WS-SAVE-STATUS
P3FX21         END-IF
P3FX21     END-IF.
P3FX21     IF (ACM-ACTIVE-STATUS NOT = "A")
P3FX21         MOVE "T"           TO WS-SAVE-STATUS
P3FX21     END-IF.
P3FX21
AI0000     IF (WS-SAVE-CUSTOMER NOT = SPACES)

AI0000         MOVE WS-SAVE-CUSTOMER  TO JSTWS-STR
AI0000         MOVE 9                 TO JSTWS-STR-LEN
AI0000         SET JSTWS-LEFT         TO TRUE
AI0000         PERFORM 2000-JUSTIFY-OBJECT
AI0000     END-IF.
AI0000     INITIALIZE                    WS-BILLING-ITEM.
AI0000     MOVE WS-SAVE-BILL-ITEM     TO WS-BILLING-ITEM.
AI0000     MOVE WS-SAVE-BILL-ITEM(11:40)
AI0000                                TO WS-BILLING-SUBITEM03.
 temp *    DISPLAY "WsBilling-Subitem03: " WS-BILLING-SUBITEM03.
AI0000         
           IF (WS-SAVE-BILL-ITEM(11:40) = "medical")
              MOVE "Med"         TO WS-SAVE-BILL-ITEM(11:40).
           IF (WS-SAVE-BILL-ITEM(11:40) = "dental")
              MOVE "Dental"      TO WS-SAVE-BILL-ITEM(11:40).
           IF (WS-SAVE-BILL-ITEM(11:40) = "vision")
              MOVE "Vision"      TO WS-SAVE-BILL-ITEM(11:40).
CPS001     IF (WS-EMPLOYER-FLAG = "Y")
      *--- Per Rhodes do not consider employee status on determining "ret"
AI0000*        IF (WS-EMP-EMP-STATUS(1:1) = "R")
AI0000*            MOVE "conversion" TO WS-BILLING-SUBITEM01
AI0000*            MOVE "ret"        TO WS-BILLING-SUBITEM02
AI0000*            MOVE WS-SAVE-BILL-ITEM(11:40)
AI0000*                          TO WS-BILLING-SUBITEM03
AI0000*            MOVE WS-BILLING-SUBITEM
AI0000*                         TO WS-BILLING-ITEM
AI0000*        END-IF
AI0000         MOVE "81"                TO R81-DATA-TYPE 
AI0000         MOVE "1"                 TO R81-REC-TYPE     
AI0000         MOVE "001"               TO R81-VERSION      
AI0000         MOVE WS-SAVE-EMPLOYEE    TO R81-EMPLOYEE
AI0000         MOVE JSTWS-STR-OUT(3:5)       TO R81-EMPLOYER
AI0000         MOVE WS-EMP-FIRST-NAME   TO R81-FIRST-NAME
AI0000         MOVE WS-EMP-LAST-NAME    TO R81-LAST-NAME
AI0000         MOVE WS-BILLING-GRP      TO R81-BILLING-GROUP
AI0000         MOVE WS-BILLING-ITEM     TO R81-BILLING-ITEM
AI0000         MOVE WS-LW-BILL-AMT      TO R81-BALANCE           
AI0000         MOVE WS-SAVE-STATUS      TO R81-STATUS
AI0000         IF (WS-SAVE-STATUS = SPACES)
AI0000             MOVE "A"             TO R81-STATUS
AI0000         END-IF
AI0000         MOVE WS-SAVE-BENEFIT     TO R81-BENEFIT
AI0000         MOVE WS-SAVE-PLAN        TO R81-PLAN
AI0000         MOVE WS-SAVE-OPTION      TO R81-OPTION
               IF (R81-BENEFIT(1:8) = "SUPPLIFE")
                    MOVE "suppLife"      TO R81-BILLING-GROUP
               END-IF
               IF (R81-PLAN = SPACES)
                   MOVE SPACES          TO R81-BENEFIT
                   MOVE SPACES          TO R81-OPTION 
               END-IF
               IF (R81-BALANCE NOT = ZERO)
CPS001           PERFORM 800-WRITECSV-RECORD81
                 ADD 1                    TO WS-81-COUNT
               END-IF
CPS001     ELSE
AI0000         IF (WS-BILLING-GRP = "retirees")  
AI0000           MOVE "conversion" TO WS-BILLING-SUBITEM01
AI0000           MOVE "ret"        TO WS-BILLING-SUBITEM02
AI0000           MOVE WS-SAVE-BILL-ITEM(11:40)
AI0000                           TO WS-BILLING-SUBITEM03
AI0000           MOVE WS-BILLING-SUBITEM
AI0000                           TO WS-BILLING-ITEM
AI0000         END-IF
               MOVE "80"                TO R80-DATA-TYPE 
               MOVE "1"                 TO R80-REC-TYPE     
               MOVE "001"               TO R80-VERSION      
AI0000         MOVE WS-SAVE-EMPLOYEE    TO R80-EMPLOYEE
AI0000         MOVE JSTWS-STR-OUT       TO R80-EMPLOYER
AI0000         MOVE WS-EMP-FIRST-NAME   TO R80-FIRST-NAME
AI0000         MOVE WS-EMP-LAST-NAME    TO R80-LAST-NAME
AI0000         MOVE WS-BILLING-GRP      TO R80-BILLING-GROUP
AI0000         MOVE WS-BILLING-ITEM     TO R80-BILLING-ITEM
AI0000         MOVE WS-LW-BILL-AMT      TO R80-BALANCE           
AI0000         MOVE WS-SAVE-STATUS      TO R80-STATUS
AI0000         IF (WS-SAVE-STATUS = SPACES)
AI0000             MOVE "A"             TO R80-STATUS
AI0000         END-IF
AI0000         MOVE WS-SAVE-BENEFIT     TO R80-BENEFIT
AI0000         MOVE WS-SAVE-PLAN        TO R80-PLAN
               IF (R80-BENEFIT(1:8) = "SUPPLIFE")
                    MOVE "suppLife"      TO R80-BILLING-GROUP
               END-IF
AI0000         MOVE WS-SAVE-OPTION      TO R80-OPTION
      *--- Per LW, if Plan is blank, then Plan, option and benefit s/b blank
               IF (R80-PLAN = SPACES)
                   MOVE SPACES          TO R80-BENEFIT
                   MOVE SPACES          TO R80-OPTION 
               END-IF
      *--- Do not send employer for direct billed
               MOVE SPACES                TO R80-EMPLOYER
               IF (R80-BALANCE NOT = ZERO)
CPS001           PERFORM 800-WRITECSV-RECORD80
                 ADD 1                   TO WS-80-COUNT
                END-IF
CPS001     END-IF.
CPS001
CPS001 9000-END.
010090******************************************************************
010100*
010110*   600-BEGIN-BROADCAST
010120*   605-END-BROADCAST
010130*   610-BEG-ELEMENT-TAG
010140*   615-END-ELEMENT-TAG
010150*
010160*   These routines are used for Channels.  Service must be defined
010170*   in WF07.1 before running program.
010180*
010190*   Input:
010200*           ZR900WS-DO-BASE-BROADCAST    (Y/N)
010210*           ZR900WS-PRINT-FILE-1  (Base)
010220*           ZR900WS-ELEMENT-VALUE (Element Value)
010230*           ZR900WS-ELEMENT-TYPE  (Element)
010240*
010250*   Output: none
010260*
010270******************************************************************
010280 600-BEGIN-BROADCAST         SECTION 72.
010290****************************************************************
010300 600-START.
010310*** THE FOLLOWING LINES OF CODE MUST BE PERFORMED ONCE PER EXECUTION OF
010320*** THE PROGRAM PRIOR TO ANY WRITING OF THE PRINTFILE BEING PUBLISH
      *-----------------------------------------------------------------
      *    Call workflow APIs to determine whether workflow system is
      *    present and enabled.  A return code of 0 indicates that 
      *    workflow is enabled and further processing in this program
      *    will occur based on that flag in order to publish a report.
      *-----------------------------------------------------------------
           IF (PRM-REPORT-OPTION = "L")
               GO TO 600-SECTION-END.


           INITIALIZE WFAPI-INPUT.
           INITIALIZE WFAPI-OUTPUT.
           MOVE WFCHWS-SERVICE-NAME    TO WFAPI-I-SERVICE.
           MOVE CRT-PROGRAM-CODE       TO WFAPI-I-CRITERION-1.
           MOVE CRT-JOB-USER           TO WFAPI-I-CRITERION-2.
           MOVE CRT-JOB-NAME           TO WFAPI-I-CRITERION-3.
           PERFORM 1000-WF-SERVICE.
           IF (WFAPI-O-RETURN-CODE = ZEROS)
              INITIALIZE WFAPI-INPUT
              MOVE WFAPI-O-SERVICE     TO WFAPI-I-SERVICE
              MOVE WFAPI-O-AGENT       TO WFAPI-I-AGENT
              MOVE WFAPI-O-PROCEDURE   TO WFAPI-I-PROCEDURE
              STRING CRT-PROGRAM-CODE "-"
                     CRT-JOB-USER     "-"
                     CRT-JOB-NAME     DELIMITED BY SIZE
                                      INTO WFAPI-I-WORK-TITLE
              INITIALIZE WFAPI-OUTPUT
              PERFORM 1000-WF-CREATE-SETUP
              MOVE "Y"                     TO ZR900WS-DO-BASE-BROADCAST
           END-IF.

10530  600-SECTION-END.
010540****************************************************************
010550 605-END-BROADCAST             SECTION 72.
010560****************************************************************
010570 605-START.
010580
      *-----------------------------------------------------------------
      *    The following lines of code must be performed once for each
      *    printfile to be published.
      *-----------------------------------------------------------------

010620     IF  (WFAPI-O-RETURN-CODE   NOT = ZEROS)
           OR  (PRM-REPORT-OPTION = "L")
010630         GO TO 605-SECTION-END.

010650     IF (ZR900WS-DO-BASE-BROADCAST  = "Y")
              INITIALIZE WFAPI-INPUT
              MOVE WFAPI-O-WORKUNIT        TO WFAPI-I-WORKUNIT
              MOVE ZR900WS-PRINT-FILE-1    TO WFAPI-I-FILE-NAME
010690        MOVE 709                     TO CRT-MSG-NBR
010700        MOVE "GLCHN"                 TO CRT-ERROR-CAT
010710        PERFORM 790-GET-MSG
010720        MOVE CRT-MESSAGE             TO WFAPI-I-DESCRIPTION
              MOVE "REPORT"                TO WFAPI-I-DOCUMENT-ID
              INITIALIZE WFAPI-OUTPUT
              PERFORM 1000-WF-ADD-FOLDER-SETUP
           END-IF.

010770*** THE FOLLOWING LINES OF CODE MUST BE PERFORMED ONCE PER EXECUTION OF
010780*** THE PROGRAM AFTER ALL WRITING OF THE PRINTFILES.
010790*** THIS WILL WILL RELEASE THE REPORT(S) TO BE PUBLISHED.

           INITIALIZE WFAPI-INPUT.
           MOVE WFAPI-O-WORKUNIT           TO WFAPI-I-WORKUNIT.
           INITIALIZE WFAPI-OUTPUT.
           PERFORM 1000-WF-RELEASE-SETUP.

010860 605-SECTION-END.
010870
010880****************************************************************
010890 610-BEG-ELEMENT-TAG          SECTION 72.
010900****************************************************************
010910 610-START.
010920
010930*** END TAG
010940*** THE FOLLOWING CODE SHOULD BE INSERTED FOR EACH LEVEL BREAK BEIN
010950*** USED TO BURST THE REPORT IN BROADCAST (THREE LEVEL MAXIMUM)
010960*** PROVIDE THE ELEMENT NAME AND VALUE. 
010970
010980     IF (WFAPI-O-RETURN-CODE        NOT = ZEROS)
010990         GO TO 610-SECTION-END.
011000
011010     MOVE ZR900WS-ELEMENT-TYPE   TO CRT-MSG-NBR.
011020     MOVE "GLCHN"                TO CRT-ERROR-CAT.
011030     PERFORM 790-GET-MSG.
011040
011050     MOVE CRT-MESSAGE            TO WFCHWS-ELEMENT.
011060     MOVE ZR900WS-ELEMENT-VALUE  TO WFCHWS-VALUE.
011070     MOVE WFCHWS-BEG-TAG         TO WFCHWS-TAG-NAME.
           MOVE WFCHWS-TAG-STRING      TO CHN1-TAG-LINE.
011090     
           IF (ZR900WS-DO-BASE-BROADCAST  = "Y")
               MOVE BROADCAST-TAG-LINE-R1   TO RPT-GROUP-REQUEST
               PERFORM 700-PRINT-RPT-GRP.
011130
011140 610-SECTION-END.
011150
011160****************************************************************
011170 615-END-ELEMENT-TAG           SECTION 72.
011180****************************************************************
011190 615-START.
011200*** END TAG
011210*** THE FOLLOWING CODE SHOULD BE INSERTED FOR EACH LEVEL BREAK BEIN
011220*** USED TO BURST THE REPORT IN BROADCAST (THREE LEVEL MAXIMUM)
011230*** PROVIDE THE ELEMENT NAME AND VALUE. 
011240
011250     IF (WFAPI-O-RETURN-CODE        NOT = ZEROS)
011260         GO TO 615-SECTION-END.
011270
011280     MOVE ZR900WS-ELEMENT-TYPE   TO CRT-MSG-NBR.
011290     MOVE "GLCHN"                TO CRT-ERROR-CAT.
011300     PERFORM 790-GET-MSG.
011310
011320     MOVE CRT-MESSAGE            TO WFCHWS-ELEMENT.
011330     MOVE ZR900WS-ELEMENT-VALUE  TO WFCHWS-VALUE.
011340     MOVE WFCHWS-END-TAG         TO WFCHWS-TAG-NAME.
011350     MOVE WFCHWS-TAG-STRING      TO CHN1-TAG-LINE.
011360 
           IF (ZR900WS-DO-BASE-BROADCAST  = "Y")
               MOVE BROADCAST-TAG-LINE-R1   TO RPT-GROUP-REQUEST
011390         PERFORM 700-PRINT-RPT-GRP.
011400
011410 615-SECTION-END.
011420
AI0000****************************************************************
AI0000 2500-CONCATENATE-FILES        SECTION.
AI0000****************************************************************
AI0000 2500-START.

      *    DISPLAY "RecordCounts: 80: " WS-80-COUNT
      *            " 81: " WS-81-COUNT
      *            " 82: " WS-82-COUNT
      *            " 84: " WS-84-COUNT.

      *    IF (WS-80-COUNT = ZERO)
      *        GO TO 2500-REC81.

           INITIALIZE                    WS-COMMAND.
           MOVE WS-DIR-EXT               TO ICLAWDWS-DIR-EXT.
           PERFORM 1000-CREATE-LAWDIR-FILENAME-61.
           MOVE WS-HEADER80-FILE         TO WS-CAT-INP1.
           MOVE WS-RECORD80-FILE         TO WS-CAT-INP2.
           MOVE "LW-REC80.txt"           TO WS-FILE-OUT.
           PERFORM 2501-DO-FILE-CAT
              THRU 2501-END.

       2500-REC81.
           MOVE WS-HEADER80-FILE         TO WS-TMP-FILE.
           PERFORM 901-REMOVE-TMP-FILE.
           MOVE WS-RECORD80-FILE         TO WS-TMP-FILE.
           PERFORM 901-REMOVE-TMP-FILE.

      *    IF (WS-81-COUNT = ZERO)
      *        GO TO 2500-REC82.

           INITIALIZE                    WS-COMMAND.
           MOVE WS-DIR-EXT               TO ICLAWDWS-DIR-EXT.
           PERFORM 1000-CREATE-LAWDIR-FILENAME-61.
           MOVE WS-HEADER81-FILE         TO WS-CAT-INP1.
           MOVE WS-RECORD81-FILE         TO WS-CAT-INP2.
           MOVE "LW-REC81.txt"           TO WS-FILE-OUT.
           PERFORM 2501-DO-FILE-CAT
              THRU 2501-END.

       2500-REC82.
           MOVE WS-HEADER81-FILE         TO WS-TMP-FILE.
           PERFORM 901-REMOVE-TMP-FILE.
           MOVE WS-RECORD81-FILE         TO WS-TMP-FILE.
           PERFORM 901-REMOVE-TMP-FILE.

      *    IF (WS-82-COUNT = ZERO)
      *        GO TO 2500-REC84.

           INITIALIZE                    WS-COMMAND.
           MOVE WS-DIR-EXT               TO ICLAWDWS-DIR-EXT.
           PERFORM 1000-CREATE-LAWDIR-FILENAME-61.
           MOVE WS-HEADER82-FILE         TO WS-CAT-INP1.
           MOVE WS-RECORD82-FILE         TO WS-CAT-INP2.
           MOVE "LW-REC82.txt"           TO WS-FILE-OUT.
           PERFORM 2501-DO-FILE-CAT
              THRU 2501-END.

       2500-REC84.
           MOVE WS-HEADER82-FILE         TO WS-TMP-FILE.
           PERFORM 901-REMOVE-TMP-FILE.
           MOVE WS-RECORD82-FILE         TO WS-TMP-FILE.
           PERFORM 901-REMOVE-TMP-FILE.

      *    IF (WS-84-COUNT = ZERO)
      *        GO TO 2500-CONTINUE.

           INITIALIZE                    WS-COMMAND.
           MOVE WS-DIR-EXT               TO ICLAWDWS-DIR-EXT.
           PERFORM 1000-CREATE-LAWDIR-FILENAME-61.
           MOVE WS-HEADER84-FILE         TO WS-CAT-INP1.
           MOVE WS-RECORD84-FILE         TO WS-CAT-INP2.
           MOVE "LW-REC84.txt"           TO WS-FILE-OUT.
           PERFORM 2501-DO-FILE-CAT
              THRU 2501-END.

       2500-CONTINUE.
           MOVE WS-HEADER84-FILE         TO WS-TMP-FILE.
           PERFORM 901-REMOVE-TMP-FILE.
           MOVE WS-RECORD84-FILE         TO WS-TMP-FILE.
           PERFORM 901-REMOVE-TMP-FILE.

AI0000     GO TO 2500-END.
AI0000
AI0000****************************************************************
AI0000 2501-DO-FILE-CAT.
AI0000****************************************************************
AI0000 2501-START.
AI0000
           STRING "cat "                     DELIMITED BY SIZE
                  WS-CAT-INP1                DELIMITED BY SPACE
                  " "                        DELIMITED BY SIZE
                  WS-CAT-INP2                DELIMITED BY SPACE
                  " > "                      DELIMITED BY SIZE
                  ICLAWDWS-LAWDIR-EXT        DELIMITED BY SPACE
                  "\"                        DELIMITED BY SIZE
                  WS-FILE-OUT                DELIMITED BY SPACE
                  CHAR-NULL                  DELIMITED BY SIZE
                                           INTO WS-COMMAND.
           DISPLAY "cat cmd: " WS-COMMAND.
           CALL "SYSTEM"  USING WS-COMMAND.

AI0000 2501-END.
AI0000
AI0000 2500-END.

ARTOAP*--- Logic copied from ARCOMMOPEN pdlib and altered to 
ARTOAP*--- set any adjustments that result in a credit memo going to AP
ARTOAP*--- to being applied regardless of the as of date (740-)
      ******************************************************************
       710-OPEN-CREDIT-LW                  SECTION.
      ******************************************************************
       710-LW-START.

           INITIALIZE AROPWS-APPLD-AMT
                      AROPWS-ADJ-AMT
                      AROPWS-ORIG-APP-AMT
                      AROPWS-ORIG-ADJ-AMT.
ARTOAP*--- Check ARAPSELECT for a record for this invoice
ARTOAP     MOVE ARO-COMPANY          TO DB-COMPANY.
ARTOAP     MOVE ARO-TRANS-TYPE       TO DB-TRANS-TYPE.
ARTOAP     MOVE ARO-INVOICE          TO DB-INVOICE.
ARTOAP     MOVE ARO-PAYMENT-SEQ      TO DB-PAYMENT-SEQ.
ARTOAP     PERFORM 840-FIND-AAISET2.

           IF (ARO-APPLIED-SEQ         NOT = ZEROES)
               MOVE ARO-COMPANY        TO DB-CR-COMPANY
      **** AROPWS-CUSTOMER IS USED FOR THE ORIGINAL OWNER OF A 
      **** TRANSFERRED CREDIT MEMO
               IF (AROPWS-CUSTOMER     NOT = SPACES)
                   MOVE AROPWS-CUSTOMER TO DB-CR-CUSTOMER
                   INITIALIZE   AROPWS-CUSTOMER
               ELSE
                   MOVE ARO-CUSTOMER   TO DB-CR-CUSTOMER
               END-IF
               MOVE ARO-TRANS-TYPE     TO DB-CR-TYPE
               MOVE ARO-INVOICE        TO DB-CR-NBR
               MOVE ARO-PAYMENT-SEQ    TO DB-CR-PYMNT-SEQ
               MOVE ARO-BATCH-NBR      TO DB-CR-BATCH
               MOVE ARASET3-CR-BATCH   TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-ARASET3
               PERFORM 715-OPEN-AMT-LW
                   UNTIL (ARAPPLIED-NOTFOUND)
               MOVE ARO-COMPANY           TO DB-COMPANY
               MOVE ARO-TRANS-TYPE        TO DB-TRANS-TYPE
               MOVE ARO-INVOICE           TO DB-INVOICE
               MOVE ARO-PAYMENT-SEQ       TO DB-PAYMENT-SEQ
               MOVE ARO-BATCH-NBR         TO DB-BATCH-NBR
               MOVE ARASET1-BATCH-NBR     TO WS-DB-BEG-RNG
               PERFORM 850-FIND-BEGRNG-ARASET1
               PERFORM 716-PAYMENT-APPLY-LW
                   UNTIL (ARAPPLIED-NOTFOUND).

           COMPUTE AROPWS-OPEN-AMT ROUNDED
                                           =  ARO-TRAN-AMT
                                           - (AROPWS-APPLD-AMT
                                           +  AROPWS-ADJ-AMT).

           COMPUTE AROPWS-ORIG-OPEN-AMT ROUNDED
                                           =  ARO-ORIG-AMT
                                           - (AROPWS-ORIG-APP-AMT
                                           +  AROPWS-ORIG-ADJ-AMT).

           IF  (AROPWS-OPEN-AMT         = ZERO)
           AND (AROPWS-ORIG-OPEN-AMT    NOT = ZERO)
                MOVE ZEROS               TO AROPWS-ORIG-OPEN-AMT.

           INITIALIZE   AROPWS-CUSTOMER.

       710-LW-END.
      ******************************************************************
       715-OPEN-AMT-LW                     SECTION.
      ******************************************************************
       715-LW-START.

           IF (ARA-STATUS              NOT = ZEROES)
P3FX09       MOVE ARO-COMPANY        TO WS-SV-COMPANY
P3FX09       MOVE ARO-TRANS-TYPE     TO WS-SV-TRANS-TYPE
P3FX09       MOVE ARO-INVOICE        TO WS-SV-INVOICE
P3FX09       MOVE ARO-PAYMENT-SEQ    TO WS-SV-PAYMENT-SEQ
P3FX09       MOVE ARA-COMPANY        TO DB-COMPANY
P3FX09       MOVE ARA-TRANS-TYPE     TO DB-TRANS-TYPE
P3FX09       MOVE ARA-INVOICE        TO DB-INVOICE
P3FX09       MOVE ARA-PAYMENT-SEQ    TO DB-PAYMENT-SEQ
P3FX09       PERFORM 840-FIND-AROSET1
P3FX09         IF (ARO-TRANS-DATE NOT > AROPWS-POST-DATE) 
               IF (ARA-GL-DATE         NOT > AROPWS-POST-DATE)
                   IF (ARA-CR-ADJ-SEQ  NOT = ZEROS)
                       PERFORM 745-CR-ADJ-AMT-LW
                   END-IF
                   ADD ARA-CR-APP-AMT     TO AROPWS-APPLD-AMT
                   ADD ARA-CR-ORIG-AP-AMT TO AROPWS-ORIG-APP-AMT
               ELSE
P3FX09*            MOVE "F"            TO AROPWS-FUTURE.
P3FX09             MOVE "F"            TO AROPWS-FUTURE
P3FX09             END-IF
P3FX09       ELSE
P3FX09           MOVE "F"            TO AROPWS-FUTURE
P3FX09       END-IF
P3FX09*--- Restore original AROITEMS record
P3FX09       MOVE WS-SV-COMPANY        TO DB-COMPANY
P3FX09       MOVE WS-SV-TRANS-TYPE     TO DB-TRANS-TYPE
P3FX09       MOVE WS-SV-INVOICE        TO DB-INVOICE
P3FX09       MOVE WS-SV-PAYMENT-SEQ    TO DB-PAYMENT-SEQ
P3FX09       PERFORM 840-FIND-AROSET6.
           PERFORM 860-FIND-NXTRNG-ARASET3.

       715-LW-END.
      ******************************************************************
       716-PAYMENT-APPLY-LW                SECTION.
      ******************************************************************
       716-LW-START.

           IF (ARA-STATUS              NOT = ZEROES)
               IF (ARA-GL-DATE         NOT > AROPWS-POST-DATE)
ARTOAP          OR (ARAPSELECT-FOUND)   
                  IF (ARAPSELECT-FOUND)
ARTOAP*--- Display is to log ARAPSELCTS processed                         
ARTOAP             IF (ARA-GL-DATE > AROPWS-POST-DATE)
                     DISPLAY "ARTOAP INV Adj: " ARO-CUSTOMER 
                      " " ARO-INVOICE
                      " " ARA-ADJ-AMT
ARTOAP             END-IF
                   END-IF
                   IF (ARA-ADJ-SEQ     NOT = ZEROS)
                       PERFORM 740-ADJ-AMT-LW
                   END-IF
910922             IF (CRT-PROGRAM-CODE = "ZR900")
910922                IF (ARA-CR-APP-AMT = ZEROES)
910922                    ADD ARA-APPLD-AMT    TO AROPWS-APPLD-AMT
910922                    ADD ARA-ORIG-APP-AMT TO AROPWS-ORIG-APP-AMT
131100                ELSE
131100                  IF (ARA-CR-TYPE NOT = ARA-TRANS-TYPE)
131100                      ADD ARA-APPLD-AMT    TO AROPWS-APPLD-AMT
131100                      ADD ARA-ORIG-APP-AMT TO AROPWS-ORIG-APP-AMT
131100                  END-IF
910922                END-IF
910922             ELSE
910922                ADD ARA-APPLD-AMT    TO AROPWS-APPLD-AMT
910922                ADD ARA-ORIG-APP-AMT TO AROPWS-ORIG-APP-AMT
910922             END-IF     
               ELSE
                   MOVE "F"            TO AROPWS-FUTURE.

           PERFORM 860-FIND-NXTRNG-ARASET1.

       716-LW-END.
      ******************************************************************
       740-ADJ-AMT-LW                      SECTION.
      ******************************************************************
       740-LW-START.

           MOVE ARA-COMPANY            TO DB-COMPANY.
           MOVE ARA-TRANS-TYPE         TO DB-TRANS-TYPE.
           MOVE ARA-INVOICE            TO DB-INVOICE.
           MOVE ARA-PAYMENT-SEQ        TO DB-PAYMENT-SEQ.
           MOVE ARA-BATCH-NBR          TO DB-BATCH-NBR.
           MOVE ARA-APP-SEQ            TO DB-APP-SEQ.
           MOVE ADJSET1-APP-SEQ        TO WS-DB-BEG-RNG.
           PERFORM 850-FIND-BEGRNG-ADJSET1.
           PERFORM
               UNTIL (ARADJUST-NOTFOUND)
               IF (ADJ-REASON-CODE NOT = "CURR")
                   ADD ADJ-ADJ-AMT         TO AROPWS-ADJ-AMT
                   ADD ADJ-ORIG-ADJ-AMT    TO AROPWS-ORIG-ADJ-AMT
               END-IF
               PERFORM 860-FIND-NXTRNG-ADJSET1
               END-PERFORM.

       740-LW-END.
      ******************************************************************
       745-CR-ADJ-AMT-LW                    SECTION.
      ******************************************************************
       745-LW-START.

           MOVE ARA-CR-COMPANY         TO DB-COMPANY.
           MOVE ARA-CR-TYPE            TO DB-TRANS-TYPE.
           MOVE ARA-CR-NBR             TO DB-INVOICE.
           MOVE ARA-CR-PYMNT-SEQ       TO DB-PAYMENT-SEQ.
           MOVE ARA-CR-BATCH           TO DB-BATCH-NBR.
           MOVE ARA-CR-APP-SEQ         TO DB-APP-SEQ.
           MOVE ADJSET1-APP-SEQ        TO WS-DB-BEG-RNG.
           PERFORM 850-FIND-BEGRNG-ADJSET1.
           PERFORM
               UNTIL (ARADJUST-NOTFOUND)
                   ADD ADJ-ADJ-AMT         TO AROPWS-ADJ-AMT
                   ADD ADJ-ORIG-ADJ-AMT    TO AROPWS-ORIG-ADJ-AMT
                   PERFORM 860-FIND-NXTRNG-ADJSET1
           END-PERFORM.
       745-LW-END.


005934******************************************************************
005935 AR50S1-TRANSACTION SECTION .
005936******************************************************************
005937 AR50S1-START.
005938
005939     PERFORM 200-EDIT-ACCESS
005940     THRU    200-END.
005941     IF (ERROR-FOUND)
005942         GO TO AR50S1-TRANSACTION-END.
005943
005944     INITIALIZE AR50F1-PERIOD-AGE.
005945     PERFORM 201-SELECT
005946     THRU    201-END.
005947     IF (AR50F1-PERIOD-AGE > ZEROS)
005948         MOVE SPACES         TO CRT-MESSAGE
005949         MOVE "I"            TO CRT-PASS-FC
005950         MOVE CRT-MANUAL-CF  TO CRT-REQUEST
005951         MOVE "AR502"        TO CRT-SCREEN-CODE
005952         MOVE "I"            TO CRT-DISPLAY-FC
005953         GO TO AR50S1-TRANSACTION-END.
005954
005955     IF (NO-ERROR-FOUND)
005956         PERFORM 400-INQUIRE
005957         THRU    400-END.
005958
005959     GO TO AR50S1-TRANSACTION-END.
005960
005961******************************************************************
005962 200-EDIT-ACCESS.
005963******************************************************************
005964
005965     MOVE AR50F1-ACM-COMPANY      TO DB-COMPANY.
005966
005967     PERFORM 840-FIND-ACOSET1.
005968     IF (ARCOMP-NOTFOUND)
005969         MOVE 102                             TO CRT-ERROR-NBR
005970         MOVE AR50F1-ACM-COMPANY-FN           TO CRT-FIELD-NBR
005971         GO TO 200-END.
005972
005973     MOVE ACO-CUST-GROUP         TO DB-CUST-GROUP.
005974
005975     PERFORM 840-FIND-ACGSET1.
005976     IF (ARCUSTGRP-NOTFOUND)
005977         MOVE 108                             TO CRT-ERROR-NBR
005978         MOVE AR50F1-ACM-COMPANY-FN           TO CRT-FIELD-NBR
005979         GO TO 200-END.
005980
005981     MOVE AR50F1-ACM-CUSTOMER    TO DB-CUSTOMER.
005982     PERFORM 700-EDIT-CUSTOMER-NBR.
005983     IF (ERROR-FOUND)
005984         MOVE AR50F1-ACM-CUSTOMER-FN           TO CRT-FIELD-NBR
005985         GO TO 200-END
005986     ELSE
005987         MOVE DB-CUSTOMER        TO AR50F1-ACM-CUSTOMER.
005988
005989     PERFORM 840-FIND-ACMSET1.
005990
005991     IF (AR50F1-FC = "N")
005992         IF (ARCUSTOMER-FOUND)
005993             PERFORM 850-FIND-NLT-ACMSET1
005994             PERFORM 860-FIND-NEXT-ACMSET1
005995         ELSE
005996             PERFORM 850-FIND-NLT-ACMSET1.
005997
005998     IF (AR50F1-FC = "P")
005999         PERFORM 850-FIND-NLT-ACMSET1
006000         PERFORM 870-FIND-PREV-ACMSET1.
006001
006002     IF (AR50F1-FC = "N" OR "P")
006003         IF (ARCUSTOMER-NOTFOUND)
006004         OR (ACM-COMPANY NOT = AR50F1-ACM-COMPANY)
006005             MOVE 112                         TO CRT-ERROR-NBR
006006             MOVE AR50F1-FC-FN                TO CRT-FIELD-NBR
006007             GO TO 200-END
006008         ELSE
006009             MOVE ACM-CUSTOMER   TO AR50F1-ACM-CUSTOMER
006010                                    DB-CUSTOMER.
006011
006012     IF  (ARCUSTOMER-NOTFOUND)
006013     AND (AR50F1-FC = "I")
006014          MOVE 104                               TO CRT-ERROR-NBR
006015          MOVE AR50F1-ACM-CUSTOMER-FN            TO CRT-FIELD-NBR
006016          GO TO 200-END.
006017
006018     PERFORM 840-FIND-CUDSET1.
006019     IF (CUSTDESC-NOTFOUND)
006020         MOVE 103                              TO CRT-ERROR-NBR
006021         MOVE AR50F1-ACM-CUSTOMER-FN           TO CRT-FIELD-NBR
006022         GO TO 200-END.
006023
006024     IF (AR50F1-X-SUMMARY = SPACES)
006025         MOVE "C"                TO AR50F1-X-SUMMARY.
006026
006027     IF (AR50F1-X-SUMMARY = "G")
006028         MOVE ACG-CURRENCY-CD    TO AR50WS-CURRENCY-CD
006029     ELSE
006030         MOVE ACO-CURRENCY-CD    TO AR50WS-CURRENCY-CD.
006031
006032     IF (AR50F1-X-SUMMARY = "N")
006033         MOVE AR50F1-ACM-COMPANY     TO DB-NAT-COMPANY
006034         MOVE AR50F1-ACM-CUSTOMER    TO DB-NAT-CUSTOMER
006035         MOVE NACSET1-NAT-CUSTOMER   TO WS-DB-BEG-RNG
006036         PERFORM 850-FIND-BEGRNG-NACSET1
006037         IF (NATACCT-NOTFOUND)
006038             MOVE 107                            TO CRT-ERROR-NBR
006039             MOVE AR50F1-ACM-CUSTOMER-FN         TO CRT-FIELD-NBR
006040             GO TO 200-END.
006041
006042     MOVE AR50F1-ACM-COMPANY     TO DB-COMPANY.
006043     MOVE AR50F1-ACM-CUSTOMER    TO DB-CUSTOMER.
006044
006045     IF (AR50F1-X-PROCESS NOT = SPACES)
006046         IF (AR50F1-X-SUMMARY NOT = "C")
006047             MOVE 105                            TO CRT-ERROR-NBR
006048             MOVE AR50F1-X-PROCESS-FN            TO CRT-FIELD-NBR
006049             GO TO 200-END.
006050
006051     IF (AR50F1-X-PROCESS NOT = SPACES)
006052         MOVE AR50F1-X-PROCESS   TO DB-PROCESS-LEVEL
006053         PERFORM 840-FIND-APVSET1
006054         IF (ARPROCLEVL-NOTFOUND)
006055             MOVE 126                            TO CRT-ERROR-NBR
006056             MOVE AR50F1-X-PROCESS-FN            TO CRT-FIELD-NBR
006057             GO TO 200-END.
006058
006059     IF  (AR50F1-X-GAIN-LOSS = "Y")
006060     AND (AR50F1-X-CURRENCY NOT = SPACES)
006061         IF (AR50F1-X-SUMMARY = "C")
006062             IF (AR50F1-X-CURRENCY NOT = ACO-CURRENCY-CD)
006063                 MOVE 129                        TO CRT-ERROR-NBR
006064                 MOVE AR50F1-X-CURRENCY-FN       TO CRT-FIELD-NBR
006065                 GO TO 200-END
006066             END-IF
006067         ELSE
006068             IF  (ACG-CURRENCY-CD = ACO-CURRENCY-CD)
006069             AND (AR50F1-X-CURRENCY NOT = ACO-CURRENCY-CD)
006070                 MOVE 129                        TO CRT-ERROR-NBR
006071                 MOVE AR50F1-X-CURRENCY-FN       TO CRT-FIELD-NBR
006072                 GO TO 200-END.
006073
006074     IF (AR50F1-X-CURRENCY NOT = SPACES)
006075         MOVE AR50F1-X-CURRENCY    TO IFCCWS-CURRENCY-CODE
006076         PERFORM 605-EDIT-CURRENCY-CODE-60
006077         IF  (ERROR-FOUND)
006078         AND (IFCCWS-CURSOR-POSITION = "C")
006079             MOVE AR50F1-X-CURRENCY-FN     TO CRT-FIELD-NBR
006080             GO TO 200-END.
006081
006082     IF (AR50F1-X-CURRENCY NOT = SPACES)
006083         MOVE AR50F1-ACM-COMPANY          TO IFCRWS-COMPANY
006084         MOVE AR50F1-X-CURRENCY           TO IFCRWS-TO-CURR-CODE
006085         MOVE ACO-CURRENCY-CD             TO IFCRWS-FR-CURR-CODE
006086         PERFORM 655-EDIT-CURRENCY-RELATION-60
006087         IF  (ERROR-FOUND)
006088         AND (IFCRWS-CURSOR-POSITION = "C")
006089             MOVE AR50F1-X-CURRENCY-FN     TO CRT-FIELD-NBR
006090             GO TO 200-END.
006091
006092     IF (AR50F1-X-CURRENCY NOT = SPACES)
006093         MOVE AR50F1-X-CURRENCY            TO AR50WS-CURRENCY-CD.
006094
006095     IF (AR50F1-X-GAIN-LOSS = SPACES)
006096         MOVE "N"                TO AR50F1-X-GAIN-LOSS.
006097
006098     IF (AR50F1-X-GAIN-LOSS       = "Y")
006099         IF (AR50F1-X-SUMMARY NOT = "C")
006100             MOVE 106                            TO CRT-ERROR-NBR
006101             MOVE AR50F1-X-PROCESS-FN            TO CRT-FIELD-NBR
006102             GO TO 200-END.
006103
006104* CHECK AGING-CODE
006105
006106     IF (AR50F1-X-SUMMARY = "C")
006107         IF (ACM-AGING-CODE NOT = ZEROS)
006108             MOVE ACM-AGING-CODE       TO DB-AGING-CODE
006109             PERFORM 840-FIND-AGESET1
006110             IF (AGINGCODE-NOTFOUND)
006111                  MOVE 127                        TO CRT-ERROR-NBR
006112                  MOVE AR50F1-ACM-CUSTOMER-FN     TO CRT-FIELD-NBR
006113                  GO TO 200-END.
006114
006115* SET AGING RULES AND VALUES
006116
006117     IF (AR50F1-X-SUMMARY = "C")
006118         IF  (ACM-AGING-CODE     NOT = ZEROS)
006119         AND (AGE-ACTIVE-STATUS  = "A")
006120             MOVE AGE-AGE-PERIODS (1)
006121                                 TO AR50WS-AGE-PERIODS (1)
006122             MOVE AGE-AGE-PERIODS (2)
006123                                 TO AR50WS-AGE-PERIODS (2)
006124             MOVE AGE-AGE-PERIODS (3)
006125                                 TO AR50WS-AGE-PERIODS (3)
006126             MOVE AGE-AGE-PERIODS (4)
006127                                 TO AR50WS-AGE-PERIODS (4)
P3FX22             MOVE 150                         
P3FX22                                 TO AR50WS-AGE-PERIODS (5)
P3FX22             MOVE 170                          
P3FX22                                 TO AR50WS-AGE-PERIODS (6)
006128             MOVE AGE-AGE-TYPE   TO AR50WS-AGE-TYPE
006129             MOVE AGE-AGE-CURRENT
006130                                 TO AR50WS-AGE-CURRENT
006131             MOVE AGE-AGE-CREDITS
006132                                 TO AR50WS-AGE-CREDITS
006133             MOVE AGE-AGE-PYMNT  TO AR50WS-AGE-PYMNT
006134             IF (ACM-AGE-DISPUTES NOT = SPACES)
006135                 MOVE ACM-AGE-DISPUTES   TO AR50WS-AGE-DISPUTES
006136             ELSE
006137                 MOVE AGE-AGE-DISPUTES
006138                                 TO AR50WS-AGE-DISPUTES
006139             END-IF
006140         ELSE
006141             MOVE ACO-AGE-PERIODS (1)
006142                                 TO AR50WS-AGE-PERIODS (1)
006143             MOVE ACO-AGE-PERIODS (2)
006144                                 TO AR50WS-AGE-PERIODS (2)
006145             MOVE ACO-AGE-PERIODS (3)
006146                                 TO AR50WS-AGE-PERIODS (3)
006147             MOVE ACO-AGE-PERIODS (4)
006148                                 TO AR50WS-AGE-PERIODS (4)
P3FX22             MOVE 150                         
P3FX22                                 TO AR50WS-AGE-PERIODS (5)
P3FX22             MOVE 170                          
P3FX22                                 TO AR50WS-AGE-PERIODS (6)
006149             MOVE ACO-AGE-TYPE   TO AR50WS-AGE-TYPE
006150             MOVE ACO-AGE-CURRENT
006151                                 TO AR50WS-AGE-CURRENT
006152             MOVE ACO-AGE-CREDITS
006153                                 TO AR50WS-AGE-CREDITS
006154             MOVE ACO-AGE-PYMNT  TO AR50WS-AGE-PYMNT
006155             IF (ACM-AGE-DISPUTES NOT = SPACES)
006156                 MOVE ACM-AGE-DISPUTES   TO AR50WS-AGE-DISPUTES
006157             ELSE
006158                 MOVE ACO-AGE-DISPUTES
006159                                 TO AR50WS-AGE-DISPUTES
006160             END-IF
006161     ELSE
006162         MOVE ACG-AGE-PERIODS (1)
006163                                 TO AR50WS-AGE-PERIODS (1)
006164         MOVE ACG-AGE-PERIODS (2)
006165                                 TO AR50WS-AGE-PERIODS (2)
006166         MOVE ACG-AGE-PERIODS (3)
006167                                 TO AR50WS-AGE-PERIODS (3)
006168         MOVE ACG-AGE-PERIODS (4)
006169                                 TO AR50WS-AGE-PERIODS (4)
P3FX22             MOVE 150                         
P3FX22                                 TO AR50WS-AGE-PERIODS (5)
P3FX22             MOVE 170                          
P3FX22                                 TO AR50WS-AGE-PERIODS (6)
006170         MOVE ACG-AGE-TYPE       TO AR50WS-AGE-TYPE
006171         MOVE ACG-AGE-CURRENT    TO AR50WS-AGE-CURRENT
006172         MOVE ACG-AGE-CREDITS    TO AR50WS-AGE-CREDITS
006173         MOVE ACG-AGE-PYMNT      TO AR50WS-AGE-PYMNT
006174         IF (ACM-AGE-DISPUTES NOT = SPACES)
006175             MOVE ACM-AGE-DISPUTES   TO AR50WS-AGE-DISPUTES
006176         ELSE
006177             MOVE ACG-AGE-DISPUTES   TO AR50WS-AGE-DISPUTES
006178         END-IF
006179     END-IF.
006180
006181* SET PERIOD HEADING VALUES
006182
006183     MOVE AR50WS-AGE-PERIODS (1) TO AR50F1-PERIOD-1-END.
006184     MOVE AR50WS-AGE-PERIODS (2) TO AR50F1-PERIOD-2-END.
006185     MOVE AR50WS-AGE-PERIODS (3) TO AR50F1-PERIOD-3-END.
006186     MOVE AR50WS-AGE-PERIODS (4) TO AR50F1-PERIOD-4-END.
006187     MOVE AR50WS-AGE-PERIODS (4) TO AR50F1-PERIOD-5-END.
006188     COMPUTE AR50F1-PERIOD-2-BEG =  AR50F1-PERIOD-1-END
006189                                 +  1.
006190     COMPUTE AR50F1-PERIOD-3-BEG =  AR50F1-PERIOD-2-END
006191                                 +  1.
006192     COMPUTE AR50F1-PERIOD-4-BEG =  AR50F1-PERIOD-3-END
006193                                 +  1.
006194
006195     IF (AR50F1-X-DATE           =  SPACES)
006196         MOVE AR50WS-AGE-TYPE    TO AR50F1-X-DATE.
006197
006198 200-END.
006199
006200******************************************************************
006201 201-SELECT.
006202******************************************************************
006203
006204     IF (AR50F1-LINE-FC   = "X")
006205         MOVE SPACES             TO AR50F1-LINE-FC
006206         IF (AR50WS-OPEN-AMT (1) NOT = ZEROS)
006207         OR (AR50F1-COUNT    (1) NOT = ZEROS)
006208             MOVE AR50F1-PT-CURRENCY-ND
006209                                 TO AR50F1-PT-SEL-PRD-TOT-ND
006210             MOVE AR50F1-OPEN-AMT
006211                                 TO AR50F1-PT-SEL-PRD-TOT
006212             MOVE 151            TO CRT-MSG-NBR
006213             PERFORM 790-GET-MSG
006214             MOVE CRT-MESSAGE    TO AR50WS-PARAM-PRD-HEAD
006215             MOVE AR50WS-PARAM-PRD-HEAD
006216                                 TO AR50F1-PER-SELECTED
006217             MOVE 1              TO AR50F1-PERIOD-AGE
006218             GO TO 201-END.
006219
006220     IF (AR50F1-LINE-FC-1 = "X")
006221         MOVE SPACES             TO AR50F1-LINE-FC-1
006222         IF (AR50WS-OPEN-AMT (2) NOT = ZEROS)
006223         OR (AR50F1-COUNT    (2) NOT = ZEROS)
006224             MOVE AR50F1-PT-CURRENCY-ND
006225                                 TO AR50F1-PT-SEL-PRD-TOT-ND
006226             MOVE AR50F1-OPEN-AMT1
006227                                 TO AR50F1-PT-SEL-PRD-TOT
006228             MOVE 152            TO CRT-MSG-NBR
006229             PERFORM 790-GET-MSG
006230             MOVE CRT-MESSAGE    TO AR50WS-PARAM-PRD-HEAD
006231             MOVE AR50WS-PARAM-PRD-HEAD
006232                                 TO AR50F1-PER-SELECTED
006233             MOVE 2              TO AR50F1-PERIOD-AGE
006234             GO TO 201-END.
006235
006236     IF (AR50F1-LINE-FC-2 = "X")
006237         MOVE SPACES             TO AR50F1-LINE-FC-2
006238         IF (AR50WS-OPEN-AMT (3) NOT = ZEROS)
006239         OR (AR50F1-COUNT    (3) NOT = ZEROS)
006240             MOVE AR50F1-PT-CURRENCY-ND
006241                                 TO AR50F1-PT-SEL-PRD-TOT-ND
006242             MOVE AR50F1-OPEN-AMT2
006243                                 TO AR50F1-PT-SEL-PRD-TOT
006244             MOVE 1              TO AR50WS-SPRDH
006245             MOVE "-"            TO AR50WS-PRDH-HYPH
006246             MOVE AR50F1-PERIOD-1-END
006247                                 TO AR50WS-EPRDH
006248             MOVE AR50WS-PARAM-PRD-HEAD
006249                                 TO AR50F1-PER-SELECTED
006250             MOVE 3              TO AR50F1-PERIOD-AGE
006251             GO TO 201-END.
006252
006253     IF (AR50F1-LINE-FC-3 = "X")
006254         MOVE SPACES             TO AR50F1-LINE-FC-3
006255         IF (AR50WS-OPEN-AMT (4) NOT = ZEROS)
006256         OR (AR50F1-COUNT    (4) NOT = ZEROS)
006257             MOVE AR50F1-PT-CURRENCY-ND
006258                                 TO AR50F1-PT-SEL-PRD-TOT-ND
006259             MOVE AR50F1-OPEN-AMT3
006260                                 TO AR50F1-PT-SEL-PRD-TOT
006261             MOVE AR50F1-PERIOD-2-BEG
006262                                 TO AR50WS-SPRDH
006263             MOVE "-"            TO AR50WS-PRDH-HYPH
006264             MOVE AR50F1-PERIOD-2-END
006265                                 TO AR50WS-EPRDH
006266             MOVE AR50WS-PARAM-PRD-HEAD
006267                                 TO AR50F1-PER-SELECTED
006268             MOVE 4              TO AR50F1-PERIOD-AGE
006269             GO TO 201-END.
006270
006271     IF (AR50F1-LINE-FC-4 = "X")
006272         MOVE SPACES             TO AR50F1-LINE-FC-4
006273         IF (AR50WS-OPEN-AMT (5) NOT = ZEROS)
006274         OR (AR50F1-COUNT    (5) NOT = ZEROS)
006275             MOVE AR50F1-PT-CURRENCY-ND
006276                                 TO AR50F1-PT-SEL-PRD-TOT-ND
006277             MOVE AR50F1-OPEN-AMT4
006278                                 TO AR50F1-PT-SEL-PRD-TOT
006279             MOVE AR50F1-PERIOD-3-BEG
006280                                 TO AR50WS-SPRDH
006281             MOVE "-"            TO AR50WS-PRDH-HYPH
006282             MOVE AR50F1-PERIOD-3-END
006283                                 TO AR50WS-EPRDH
006284             MOVE AR50WS-PARAM-PRD-HEAD
006285                                 TO AR50F1-PER-SELECTED
006286             MOVE 5              TO AR50F1-PERIOD-AGE
006287             GO TO 201-END.
006288
006289     IF (AR50F1-LINE-FC-5 = "X")
006290         MOVE SPACES             TO AR50F1-LINE-FC-5
006291         IF (AR50WS-OPEN-AMT (6) NOT = ZEROS)
006292         OR (AR50F1-COUNT    (6) NOT = ZEROS)
006293             MOVE AR50F1-PT-CURRENCY-ND
006294                                 TO AR50F1-PT-SEL-PRD-TOT-ND
006295             MOVE AR50F1-OPEN-AMT5
006296                                 TO AR50F1-PT-SEL-PRD-TOT
006297             MOVE AR50F1-PERIOD-4-BEG
006298                                 TO AR50WS-SPRDH
006299             MOVE "-"            TO AR50WS-PRDH-HYPH
006300             MOVE AR50F1-PERIOD-4-END
006301                                 TO AR50WS-EPRDH
006302             MOVE AR50WS-PARAM-PRD-HEAD
006303                                 TO AR50F1-PER-SELECTED
006304             MOVE 6              TO AR50F1-PERIOD-AGE
006305             GO TO 201-END.
006306
006307     IF (AR50F1-LINE-FC-6 = "X")
006308         MOVE SPACES             TO AR50F1-LINE-FC-6
006309         IF (AR50WS-OPEN-AMT (7) NOT = ZEROS)
006310         OR (AR50F1-COUNT    (7) NOT = ZEROS)
006311             MOVE AR50F1-PT-CURRENCY-ND
006312                                 TO AR50F1-PT-SEL-PRD-TOT-ND
006313             MOVE AR50F1-OPEN-AMT6
006314                                 TO AR50F1-PT-SEL-PRD-TOT
006315             MOVE 153            TO CRT-MSG-NBR
006316             PERFORM 790-GET-MSG
006317             MOVE CRT-MESSAGE    TO AR50WS-PARAM-PRD-HEAD
006318             MOVE AR50F1-PERIOD-4-END
006319                                 TO AR50WS-EPRDH
006320             MOVE AR50WS-PARAM-PRD-HEAD
006321                                 TO AR50F1-PER-SELECTED
006322             MOVE 7              TO AR50F1-PERIOD-AGE
006323             GO TO 201-END.
006324 201-END.
006325
006326******************************************************************
006327 400-INQUIRE.
006328******************************************************************
006329
006330* IF INQUIRY DONE CHECK IF DETAILS REQUIRED
006331
006332     IF (AR50F1-AR50A-NAME        NOT = SPACES)
006333         MOVE AR50F1-AR50A-NAME   TO SYSCMD-FILENAME
006334         PERFORM 900-FILEEXISTS
006335         IF (SYSCMD-ERROR         NOT = ZEROS)
006336             INITIALIZE AR50F1-AR50A-NAME
006337         END-IF
006338     END-IF.
006339
006340     IF (AR50F1-AR50A-NAME = SPACES)
006341         PERFORM 900-BUILD-TMP-FILE-NAME
006342         MOVE WS-TMP-FILE        TO WS-AR50A-NAME
006343                                    AR50F1-AR50A-NAME
006344         PERFORM 900-BUILD-TMP-FILE-NAME
006345         MOVE WS-TMP-FILE        TO WS-AR50B-NAME
006346                                    AR50F1-AR50B-NAME.
006347
006348     IF (AR50F1-AR50A-NAME NOT = SPACES)
006349         MOVE AR50F1-AR50A-NAME  TO WS-AR50A-NAME
006350         MOVE AR50F1-AR50B-NAME  TO WS-AR50B-NAME
006351         OPEN I-O AR50A-FILE
006352         OPEN I-O AR50B-FILE.
006353
006354     CLOSE  AR50A-FILE.
006355     OPEN OUTPUT AR50A-FILE.
006356     CLOSE  AR50A-FILE.
006357     OPEN I-O AR50A-FILE.
006358     CLOSE  AR50B-FILE.
006359     OPEN OUTPUT AR50B-FILE.
006360     CLOSE  AR50B-FILE.
006361     OPEN I-O AR50B-FILE.
006362
006363* TO CLEAR THE SCREEN AND WS FIELDS HERE!
006364
006365     MOVE SPACES                 TO AR50F1-LINE-FC
006366                                    AR50F1-LINE-FC-1
006367                                    AR50F1-LINE-FC-2
006368                                    AR50F1-LINE-FC-3
006369                                    AR50F1-LINE-FC-4
006370                                    AR50F1-LINE-FC-5
006371                                    AR50F1-LINE-FC-6.
006372
006373     INITIALIZE AR50F1-COUNT (1)
006374                AR50F1-COUNT (2)
006375                AR50F1-COUNT (3)
006376                AR50F1-COUNT (4)
006377                AR50F1-COUNT (5)
006378                AR50F1-COUNT (6)
006379                AR50F1-COUNT (7).
006380
006381     MOVE AR50WS-CURRENCY-CD        TO IFCCWS-CURRENCY-CODE.
006382     PERFORM 605-EDIT-CURRENCY-CODE-60.
006383     IF (ERROR-FOUND)
006384         MOVE ACO-BASE-ND            TO AR50F1-OPEN-AMT-ND
006385                                        AR50F1-OPEN-AMT1-ND
006386                                        AR50F1-OPEN-AMT2-ND
006387                                        AR50F1-OPEN-AMT3-ND
006388                                        AR50F1-OPEN-AMT4-ND
006389                                        AR50F1-OPEN-AMT5-ND
006390                                        AR50F1-OPEN-AMT6-ND
006391                                        AR50F1-UNRELAPPLD-ND
006392                                        AR50F1-ACM-CURR-BAL-ND
006393                                        AR50F1-ACM-INV-BAL-ND
006394                                        AR50F1-ACM-DRAFT-BAL-ND
006395                                        AR50F1-ACM-OPEN-ORDS-ND
006396                                        AR50F1-UNAPPLIED-ND
006397                                        AR50F1-UNRELPAYMNT-ND
006398                                        AR50F1-PT-CURRENCY-ND
006399                                        AR50F1-PT-SEL-PRD-TOT-ND
006400     ELSE
006401         MOVE IFCCWS-CURRENCY-ND     TO AR50F1-OPEN-AMT-ND
006402                                        AR50F1-OPEN-AMT1-ND
006403                                        AR50F1-OPEN-AMT2-ND
006404                                        AR50F1-OPEN-AMT3-ND
006405                                        AR50F1-OPEN-AMT4-ND
006406                                        AR50F1-OPEN-AMT5-ND
006407                                        AR50F1-OPEN-AMT6-ND
006408                                        AR50F1-UNRELAPPLD-ND
006409                                        AR50F1-ACM-CURR-BAL-ND
006410                                        AR50F1-ACM-INV-BAL-ND
006411                                        AR50F1-ACM-DRAFT-BAL-ND
006412                                        AR50F1-ACM-OPEN-ORDS-ND
006413                                        AR50F1-UNAPPLIED-ND
006414                                        AR50F1-UNRELPAYMNT-ND
006415                                        AR50F1-PT-CURRENCY-ND
006416                                        AR50F1-PT-SEL-PRD-TOT-ND.
006417
006418     MOVE ZEROS                  TO AR50F1-OPEN-AMT
006419                                    AR50F1-OPEN-AMT1
006420                                    AR50F1-OPEN-AMT2
006421                                    AR50F1-OPEN-AMT3
006422                                    AR50F1-OPEN-AMT4
006423                                    AR50F1-OPEN-AMT5
006424                                    AR50F1-OPEN-AMT6
006425                                    AR50F1-UNRELAPPLD
006426                                    AR50F1-ACM-CURR-BAL
006427                                    AR50F1-ACM-DRAFT-BAL
006428                                    AR50F1-ACM-INV-BAL
006429                                    AR50F1-ACM-OPEN-ORDS
006430                                    AR50F1-ACM-HIGH-BAL
006431                                    AR50F1-ACM-CREDIT-LIM
006432                                    AR50F1-UNAPPLIED
006433                                    AR50F1-UNRELPAYMNT
006434                                    AR50F1-PCNT
006435                                    AR50F1-PCNT1
006436                                    AR50F1-PCNT2
006437                                    AR50F1-PCNT3
006438                                    AR50F1-PCNT4
006439                                    AR50F1-PCNT5
006440                                    AR50F1-PCNT6
006441                                    AR50F1-LIMIT-PCT
006442
006443                                    AR50WS-OPEN-AMT (1)
006444                                    AR50WS-OPEN-AMT (2)
006445                                    AR50WS-OPEN-AMT (3)
006446                                    AR50WS-OPEN-AMT (4)
006447                                    AR50WS-OPEN-AMT (5)
006448                                    AR50WS-OPEN-AMT (6)
006449                                    AR50WS-OPEN-AMT (7)
006450
006451                                    AR50WS-GAINLOS-AMT
006452                                    AR50WS-UNRELAPPLD
006453                                    AR50WS-UNRELPAYMNT
006454                                    AR50WS-UNAPPLIED
006455                                    AR50WS-EAGDT.
006456
006457*     MOVE WS-SYSTEM-DATE-YMD     TO AR50WS-EAGDT.
006458
006459     PERFORM 430-BUILD-THE-WORK-FILE
006460     THRU    430-END.
006461
006462     PERFORM 410-MOVE-TO-SCREEN
006463     THRU    410-END.
006464     MOVE CRT-INQ-COMPLETE       TO CRT-MESSAGE.
006465
006466     MOVE AR50F1-ACM-COMPANY     TO AR50F1-PT-ACM-COMPANY.
006467     MOVE AR50F1-ACM-CUSTOMER    TO AR50F1-PT-ACM-CUSTOMER.
006468     MOVE AR50F1-X-PROCESS       TO AR50F1-PT-X-PROCESS.
006469     MOVE AR50F1-X-DATE          TO AR50F1-PT-X-DATE.
006470     MOVE AR50F1-X-SUMMARY       TO AR50F1-PT-X-SUMMARY.
006471
006472     CLOSE  AR50A-FILE.
006473     CLOSE  AR50B-FILE.
006474
006475 400-END.
006476
006477******************************************************************
006478 410-MOVE-TO-SCREEN.
006479******************************************************************
006480
006481     MOVE ACM-COMPANY            TO AR50F1-ACM-COMPANY.
006482     MOVE ACM-CUSTOMER           TO AR50F1-ACM-CUSTOMER.
006483
006484     MOVE ACO-NAME               TO AR50F1-ACO-NAME.
006485     MOVE ACO-CURRENCY-CD        TO AR50F1-ACO-CURRENCY-CD.
006486
006487     MOVE CUD-NAME               TO AR50F1-CUD-NAME.
006488     MOVE CUD-CUST-GROUP         TO AR50F1-CUD-CUST-GROUP.
006489     MOVE CUD-CUSTOMER           TO AR50F1-CUD-CUSTOMER.
006490     MOVE CUD-VENDOR-GROUP       TO AR50F1-CUD-VENDOR-GROUP.
006491     MOVE CUD-VENDOR             TO AR50F1-CUD-VENDOR.
006492
006493     IF (CUD-VENDOR-GROUP        = SPACES)
006494         MOVE SPACES             TO AR50F1-BALANCE
006495                                    AR50F1-BALANCE-ON
006496     ELSE
006497         MOVE "*"                TO AR50F1-BALANCE-ON
006498         MOVE "ARMSG"            TO CRT-ERROR-CAT
006499         MOVE 371                TO CRT-MSG-NBR
006500         PERFORM 790-GET-MSG
006501         MOVE CRT-MESSAGE        TO AR50F1-BALANCE.
006502
006503     MOVE ZEROS                  TO AR50F1-ACM-START-DATE
006504                                    AR50F1-ACM-LAST-INV-DATE
006505                                    AR50F1-ACM-LAST-PMT-DATE
006506                                    AR50F1-ACM-LAST-STA-DATE.
006507     IF (AR50F1-X-SUMMARY = "C")
006508         MOVE ACM-START-DATE     TO AR50F1-ACM-START-DATE
006509         MOVE ACM-LAST-INV-DATE  TO AR50F1-ACM-LAST-INV-DATE
006510         MOVE ACM-LAST-PMT-DATE  TO AR50F1-ACM-LAST-PMT-DATE
006511         MOVE ACM-LAST-STA-DATE  TO AR50F1-ACM-LAST-STA-DATE.
006512
006513     MOVE ZEROS                  TO AR50WS-CURR-IPA.
006514     IF (AR50F1-X-SUMMARY = "C")
006515         IF (ACM-CURR-CASH NOT = ZEROES)
006516             COMPUTE AR50WS-CURR-IPA ROUNDED  = ACM-CURR-CSH-DAYS
006517                                              / ACM-CURR-CASH
006518         ELSE
006519             MOVE ZEROES         TO AR50WS-CURR-IPA.
006520
006521     MOVE AR50WS-CURR-IPA        TO AR50F1-CURR-IPA.
006522
006523     MOVE ZEROS                  TO AR50F1-ACM-COLLECT-DAYS.
006524     IF (AR50F1-X-SUMMARY = "C")
006525         MOVE ACM-COLLECT-DAYS (1)
006526                                 TO AR50F1-ACM-COLLECT-DAYS.
006527
006528     MOVE ZEROS                         TO AR50WS-YTD-IPA.
006529     MOVE ZEROS                         TO AR50WS-IPA-AVG.
006530     MOVE ZEROS                         TO AR50WS-COLLECT-DAYS.
006531     MOVE ZEROS                         TO AR50WS-IPA-COUNT.
006532     PERFORM 411-MOVE-ARRAY-TO-SCREEN
006533     THRU    411-END
006534         VARYING I2 FROM 1 BY 1
006535         UNTIL  (I2 > 11).
006536
006537     IF (AR50F1-X-SUMMARY = "C")
006538         IF (AR50WS-IPA-COUNT NOT = ZEROES)
006539            COMPUTE AR50WS-IPA-AVG ROUNDED = (AR50WS-COLLECT-DAYS
006540                                            / AR50WS-IPA-COUNT)
006541         ELSE
006542             MOVE ZEROES                     TO AR50WS-IPA-AVG.
006543
006544     MOVE AR50WS-IPA-AVG         TO AR50F1-YTD-IPA.
006545
006546     MOVE ZEROS TO AR50WS-ACM-HIGH-BAL.
006547     IF (AR50F1-X-SUMMARY = "C")
006548         PERFORM 420-GET-HIGH-BALANCE
006549         THRU    420-END
006550             VARYING I1 FROM 1 BY 1
006551             UNTIL  (I1 > 13).
006552
006553     IF (AR50F1-X-SUMMARY = "N")
006554         MOVE ACM-COMPANY        TO DB-COMPANY
006555         MOVE ACM-CUSTOMER       TO DB-CUSTOMER
006556         PERFORM 840-FIND-NABSET1
006557         IF (NATBALANCE-FOUND)
006558             PERFORM 421-GET-HIGH-BALANCE
006559             THRU    421-END
006560                 VARYING I1 FROM 1 BY 1
006561                 UNTIL  (I1 > 13).
006562
006563     IF (AR50F1-X-CURRENCY NOT = SPACES)
006564         MOVE AR50F1-ACM-COMPANY     TO IFGRWS-COMPANY
006565         MOVE ACO-CURRENCY-CD        TO IFGRWS-FR-CURR-CODE
006566         MOVE AR50F1-X-CURRENCY      TO IFGRWS-TO-CURR-CODE
006567         MOVE "AR"                   TO IFGRWS-SYSTEM
006568         MOVE WS-SYSTEM-DATE-YMD     TO IFGRWS-EFFECT-DATE
006569         PERFORM 660-GET-CURRENCY-RATE-60
006570         IF  (ERROR-FOUND)
006571         AND (IFGRWS-CURSOR-POSITION  = "C")
006572             INITIALIZE CRT-ERROR-NBR
006573             MOVE AR50WS-ACM-HIGH-BAL    TO AR50F1-ACM-HIGH-BAL
006574         ELSE
006575             MOVE AR50F1-ACM-COMPANY   TO IFCAWS-COMPANY
006576             MOVE ACO-CURRENCY-CD      TO IFCAWS-FR-CURR-CODE
006577             MOVE AR50F1-X-CURRENCY    TO IFCAWS-TO-CURR-CODE
006578             MOVE "AR"                 TO IFCAWS-SYSTEM
006579             MOVE WS-SYSTEM-DATE-YMD   TO IFCAWS-EFFECT-DATE
006580             MOVE AR50WS-ACM-HIGH-BAL  TO IFCAWS-TRAN-AMOUNT
006581             INITIALIZE IFCAWS-BASE-AMOUNT
006582             MOVE IFGRWS-SELL-RATE     TO IFCAWS-BASERATE
006583             MOVE IFCRWS-MULT-DIV      TO IFCAWS-MULT-DIV
006584             MOVE ZEROES               TO IFCAWS-TRAN-ND
006585             MOVE ZEROES               TO IFCAWS-BASE-ND
006586             PERFORM 690-CALCULATE-AMOUNT-60
006587             MOVE IFCAWS-BASE-AMOUNT   TO AR50WS-ACM-HIGH-BAL.
006588
006589     MOVE AR50WS-ACM-HIGH-BAL    TO AR50F1-ACM-HIGH-BAL.
006590
006591     MOVE SPACES                 TO AR50F1-ACM-TERMS-CD.
006592     IF (AR50F1-X-SUMMARY = "C")
006593         MOVE ACM-TERMS-CD       TO AR50F1-ACM-TERMS-CD.
006594
006595     MOVE SPACES                 TO AR50F1-ACM-CREDIT-ANLYST.
006596     IF (AR50F1-X-SUMMARY = "C")
006597         MOVE ACM-CREDIT-ANLYST  TO AR50F1-ACM-CREDIT-ANLYST.
006598
006599     MOVE SPACES                 TO AR50F1-ACM-RISK-CD.
006600     IF (AR50F1-X-SUMMARY = "C")
006601         MOVE ACM-RISK-CD        TO AR50F1-ACM-RISK-CD.
006602
006603     MOVE ZEROS                  TO AR50F1-ACM-SALESMAN.
006604     IF (AR50F1-X-SUMMARY = "C")
006605         MOVE ACM-SALESMAN       TO AR50F1-ACM-SALESMAN.
006606
006607     IF (AR50F1-X-SUMMARY = "C")
006608         MOVE ACM-CONTACT        TO AR50F1-CUD-CONTACT
006609         MOVE ACM-PHONE-NMBR     TO AR50F1-ACM-PHONE-NMBR
006610         MOVE ACM-PHONE-EXT      TO AR50F1-CUD-PHONE-EXT
006611         MOVE ACO-CURRENCY-CD    TO AR50F1-ACM-CURRENCY-CD
006612         MOVE ACM-CURR-BAL       TO AR50F1-ACM-INV-BAL
006613         MOVE ACM-DRAFT-BAL      TO AR50F1-ACM-DRAFT-BAL
006614         COMPUTE AR50F1-ACM-CURR-BAL = ACM-CURR-BAL
006615                                     + ACM-DRAFT-BAL
006616                                     + AR50WS-GAINLOS-AMT
006617         MOVE ACM-OPEN-ORDS      TO AR50F1-ACM-OPEN-ORDS
006618         MOVE ACM-CREDIT-LIM     TO AR50F1-ACM-CREDIT-LIM
006619         MOVE ACM-HOLD-CODE      TO AR50F1-HOLD-CODE.
006620
006621     IF (AR50F1-X-SUMMARY = "G")
006622         MOVE CUD-CONTACT        TO AR50F1-CUD-CONTACT
006623         MOVE CUD-PHONE-NMBR     TO AR50F1-ACM-PHONE-NMBR
006624         MOVE CUD-PHONE-EXT      TO AR50F1-CUD-PHONE-EXT
006625         MOVE ACG-CURRENCY-CD    TO AR50F1-ACM-CURRENCY-CD
006626         MOVE CUD-CURR-BAL       TO AR50F1-ACM-INV-BAL
006627         MOVE CUD-DRAFT-BAL      TO AR50F1-ACM-DRAFT-BAL
006628         COMPUTE AR50F1-ACM-CURR-BAL = CUD-CURR-BAL
006629                                     + CUD-DRAFT-BAL
006630                                     + AR50WS-GAINLOS-AMT
006631         MOVE CUD-OPEN-ORDS      TO AR50F1-ACM-OPEN-ORDS
006632         MOVE CUD-CREDIT-LIM     TO AR50F1-ACM-CREDIT-LIM
006633         MOVE CUD-HOLD-CODE      TO AR50F1-HOLD-CODE.
006634
006635     IF (AR50F1-X-CURRENCY         NOT = SPACES)
006636         MOVE AR50F1-ACM-COMPANY   TO IFCAWS-COMPANY
006637         MOVE ACO-CURRENCY-CD      TO IFCAWS-FR-CURR-CODE
006638         MOVE AR50F1-X-CURRENCY    TO IFCAWS-TO-CURR-CODE
006639         MOVE "AR"                 TO IFCAWS-SYSTEM
006640         MOVE WS-SYSTEM-DATE-YMD   TO IFCAWS-EFFECT-DATE
006641         MOVE AR50F1-ACM-INV-BAL   TO IFCAWS-TRAN-AMOUNT
006642         INITIALIZE IFCAWS-BASE-AMOUNT
006643         MOVE IFGRWS-SELL-RATE     TO IFCAWS-BASERATE
006644         MOVE IFCRWS-MULT-DIV      TO IFCAWS-MULT-DIV
006645         MOVE IFCRWS-FR-CURR-ND    TO IFCAWS-TRAN-ND
006646         MOVE IFCRWS-TO-CURR-ND    TO IFCAWS-BASE-ND
006647         PERFORM 690-CALCULATE-AMOUNT-60
006648         MOVE IFCAWS-BASE-AMOUNT   TO AR50F1-ACM-INV-BAL.
006649
006650     IF (AR50F1-X-SUMMARY = "N")
006651         MOVE CUD-CONTACT        TO AR50F1-CUD-CONTACT
006652         MOVE CUD-PHONE-NMBR     TO AR50F1-ACM-PHONE-NMBR
006653         MOVE CUD-PHONE-EXT      TO AR50F1-CUD-PHONE-EXT
006654         MOVE ACG-CURRENCY-CD    TO AR50F1-ACM-CURRENCY-CD
006655         MOVE ACM-COMPANY        TO DB-COMPANY
006656         MOVE ACM-CUSTOMER       TO DB-CUSTOMER
006657         PERFORM 840-FIND-NABSET1
006658         IF (NATBALANCE-FOUND)
006659             MOVE NAB-CURR-BAL   TO AR50F1-ACM-INV-BAL
006660             MOVE NAB-DRAFT-BAL  TO AR50F1-ACM-DRAFT-BAL
006661             COMPUTE AR50F1-ACM-CURR-BAL = NAB-CURR-BAL
006662                                         + NAB-DRAFT-BAL
006663                                         + AR50WS-GAINLOS-AMT
006664             MOVE NAB-OPEN-ORDS  TO AR50F1-ACM-OPEN-ORDS
006665             MOVE NAB-CREDIT-LIM TO AR50F1-ACM-CREDIT-LIM
006666             MOVE NAB-HOLD-CODE  TO AR50F1-HOLD-CODE
006667         ELSE
006668             MOVE ZEROES         TO AR50F1-ACM-CURR-BAL
006669                                    AR50F1-ACM-INV-BAL
006670                                    AR50F1-ACM-DRAFT-BAL
006671                                    AR50F1-ACM-OPEN-ORDS
006672                                    AR50F1-ACM-CREDIT-LIM
006673             MOVE SPACES         TO AR50F1-HOLD-CODE.
006674
006675     IF (AR50F1-X-CURRENCY NOT = SPACES)
006676         MOVE AR50F1-X-CURRENCY      TO AR50F1-ACM-CURRENCY-CD
006677         MOVE AR50WS-CURR-BAL        TO AR50F1-ACM-CURR-BAL
006678         MOVE ZEROES                 TO AR50F1-ACM-OPEN-ORDS.
006679
006680     IF (AR50F1-X-CURRENCY NOT = SPACES)
006681         IF  (IFGRWS-SELL-RATE      NOT = ZEROES)
006682         AND (IFCRWS-MULT-DIV       NOT = SPACES)
006683         AND (AR50F1-ACM-CREDIT-LIM NOT = ZEROES)
006684             MOVE AR50F1-ACM-COMPANY    TO IFCAWS-COMPANY
006685             MOVE ACO-CURRENCY-CD       TO IFCAWS-FR-CURR-CODE
006686             MOVE AR50F1-X-CURRENCY     TO IFCAWS-TO-CURR-CODE
006687             MOVE "AR"                  TO IFCAWS-SYSTEM
006688             MOVE WS-SYSTEM-DATE-YMD    TO IFCAWS-EFFECT-DATE
006689             MOVE AR50F1-ACM-CREDIT-LIM TO IFCAWS-TRAN-AMOUNT
006690             INITIALIZE IFCAWS-BASE-AMOUNT
006691             MOVE IFGRWS-SELL-RATE      TO IFCAWS-BASERATE
006692             MOVE IFCRWS-MULT-DIV       TO IFCAWS-MULT-DIV
006693             MOVE ZEROES                TO IFCAWS-TRAN-ND
006694             MOVE ZEROES                TO IFCAWS-BASE-ND
006695             PERFORM 690-CALCULATE-AMOUNT-60
006696             MOVE IFCAWS-BASE-AMOUNT    TO AR50F1-ACM-CREDIT-LIM.
006697
006698     MOVE ZEROES                 TO AR50WS-LIMIT-PCT.
006699     MOVE AR50F1-ACM-CREDIT-LIM  TO AR50WS-CREDIT-LIM.
006700
006701     IF (AR50WS-CREDIT-LIM NOT = ZEROES)
006702         COMPUTE AR50WS-LIMIT-PCT ROUNDED = (((AR50F1-ACM-CURR-BAL
006703                                          +  AR50F1-ACM-OPEN-ORDS)
006704                                          / AR50WS-CREDIT-LIM)
006705                                          * 100)
006706     ELSE
006707         MOVE ZEROES             TO AR50WS-LIMIT-PCT.
006708
006709     MOVE AR50WS-LIMIT-PCT       TO AR50F1-LIMIT-PCT.
006710
006711* XFOOT AND CALCULATE PERCENTAGES
006712
006713     COMPUTE AR50WS-TOPEN-AMT ROUNDED = AR50WS-OPEN-AMT (1)
006714                                      + AR50WS-OPEN-AMT (2)
006715                                      + AR50WS-OPEN-AMT (3)
006716                                      + AR50WS-OPEN-AMT (4)
006717                                      + AR50WS-OPEN-AMT (5)
006718                                      + AR50WS-OPEN-AMT (6)
006719                                      + AR50WS-OPEN-AMT (7).
006720
006721     MOVE AR50WS-OPEN-AMT (1)    TO AR50F1-OPEN-AMT.
006722     MOVE AR50WS-OPEN-AMT (2)    TO AR50F1-OPEN-AMT1.
006723     MOVE AR50WS-OPEN-AMT (3)    TO AR50F1-OPEN-AMT2.
006724     MOVE AR50WS-OPEN-AMT (4)    TO AR50F1-OPEN-AMT3.
006725     MOVE AR50WS-OPEN-AMT (5)    TO AR50F1-OPEN-AMT4.
006726     MOVE AR50WS-OPEN-AMT (6)    TO AR50F1-OPEN-AMT5.
006727     MOVE AR50WS-OPEN-AMT (7)    TO AR50F1-OPEN-AMT6.
P3FX22     MOVE AR50WS-OPEN-AMT (8)    TO AR50F1-OPEN-AMT7.
P3FX22     MOVE AR50WS-OPEN-AMT (9)    TO AR50F1-OPEN-AMT8.
006728     IF (AR50WS-TOPEN-AMT NOT = ZEROS)
006729
006730         COMPUTE AR50WS-PERCENT ROUNDED
006731                                 = (AR50WS-OPEN-AMT (1)
006732                                 /  AR50WS-TOPEN-AMT)
006733                                 * 100
006734         MOVE AR50WS-PERCENT     TO AR50F1-PCNT
006735
006736         COMPUTE AR50WS-PERCENT ROUNDED
006737                                 = (AR50WS-OPEN-AMT (2)
006738                                 /  AR50WS-TOPEN-AMT)
006739                                 * 100
006740         MOVE AR50WS-PERCENT     TO AR50F1-PCNT1
006741
006742         COMPUTE AR50WS-PERCENT ROUNDED
006743                                 = (AR50WS-OPEN-AMT (3)
006744                                 /  AR50WS-TOPEN-AMT)
006745                                 * 100
006746         MOVE AR50WS-PERCENT     TO AR50F1-PCNT2
006747
006748         COMPUTE AR50WS-PERCENT ROUNDED
006749                                 = (AR50WS-OPEN-AMT (4)
006750                                 /  AR50WS-TOPEN-AMT)
006751                                 * 100
006752         MOVE AR50WS-PERCENT     TO AR50F1-PCNT3
006753
006754         COMPUTE AR50WS-PERCENT ROUNDED
006755                                 = (AR50WS-OPEN-AMT (5)
006756                                 /  AR50WS-TOPEN-AMT)
006757                                 * 100
006758         MOVE AR50WS-PERCENT     TO AR50F1-PCNT4
006759
006760         COMPUTE AR50WS-PERCENT ROUNDED
006761                                 = (AR50WS-OPEN-AMT (6)
006762                                 /  AR50WS-TOPEN-AMT)
006763                                 * 100
006764         MOVE AR50WS-PERCENT     TO AR50F1-PCNT5
006765
006766         COMPUTE AR50WS-PERCENT ROUNDED
006767                                 = (AR50WS-OPEN-AMT (7)
006768                                 /  AR50WS-TOPEN-AMT)
006769                                 * 100
006770         MOVE AR50WS-PERCENT     TO AR50F1-PCNT6.
006771
006772     MOVE AR50WS-UNAPPLIED       TO AR50F1-UNAPPLIED.
006773
006774     MOVE AR50WS-UNRELAPPLD      TO AR50F1-UNRELAPPLD.
006775
006776     MOVE AR50WS-UNRELPAYMNT     TO AR50F1-UNRELPAYMNT.
006777
006778     MOVE CRT-USER-NAME          TO AR50F1-USER-NAME.
006779
006780     MOVE ACO-CUST-GROUP         TO AR50F1-PT-CUST-GROUP.
006781
006782     IF (AR50F1-X-PROCESS  NOT = SPACES)
006783     OR (AR50F1-X-CURRENCY NOT = SPACES)
006784     OR (AR50F1-X-ACTIVITY NOT = SPACES)
006785     OR (AR50F1-X-ACCT-CAT NOT = SPACES)
006786         MOVE "*"                TO AR50F1-FILTER-ON
006787     ELSE
006788         INITIALIZE AR50F1-FILTER-ON.
006789
006790     MOVE AR50F1-ACM-COMPANY          TO DB-COMPANY.
006791     MOVE AR50F1-ACM-CUSTOMER         TO DB-CUSTOMER.
006792     MOVE CMTSET3-CUSTOMER            TO WS-DB-BEG-RNG.
006793     PERFORM 850-FIND-BEGRNG-CMTSET3.
006794
006795     IF  (ARCOMMENT-FOUND)
006796         MOVE "*"                     TO AR50F1-COMMENT-FL
006797     ELSE
006798         MOVE SPACES                  TO AR50F1-COMMENT-FL.
006799
006800     MOVE "ARMSG"                     TO CRT-ERROR-CAT.
006801     MOVE 434                         TO CRT-MSG-NBR.
006802     PERFORM 790-GET-MSG.
006803     MOVE CRT-MESSAGE                 TO AR50F1-COMMENTS.
006804
006805 410-END.
006806
006807******************************************************************
006808 411-MOVE-ARRAY-TO-SCREEN.
006809******************************************************************
006810
006811     ADD ACM-COLLECT-DAYS (I2)   TO AR50WS-COLLECT-DAYS.
006812     IF (ACM-COLLECT-DAYS (I2) NOT = ZERO)
006813        ADD 1                    TO AR50WS-IPA-COUNT.
006814
006815 411-END.
006816
006817******************************************************************
006818 420-GET-HIGH-BALANCE.
006819******************************************************************
006820
006821     IF (ACM-HIGH-BAL (I1) > AR50WS-ACM-HIGH-BAL)
006822         MOVE ACM-HIGH-BAL (I1)  TO AR50WS-ACM-HIGH-BAL.
006823
006824 420-END.
006825
006826******************************************************************
006827 421-GET-HIGH-BALANCE.
006828******************************************************************
006829
006830     IF (NAB-HIGH-BAL (I1) > AR50WS-ACM-HIGH-BAL)
006831         MOVE NAB-HIGH-BAL (I1)  TO AR50WS-ACM-HIGH-BAL.
006832
006833 421-END.
006834
006835******************************************************************
006836 430-BUILD-THE-WORK-FILE.
006837******************************************************************
006838
006839     IF (AR50F1-X-SUMMARY NOT = "G")
006840
006841* BUILD WORK FILE FOR SCREEN CUSTOMER
006842
006843         MOVE ACO-COMPANY        TO DB-COMPANY
006844         MOVE AR50F1-ACM-CUSTOMER
006845                                 TO DB-CUSTOMER
006846         PERFORM 435-BUILD-WORK-FILE-COMP-CUST
006847         THRU    435-END
006848     ELSE
006849
006850* BUILD WORK FILE FOR CUSTOMERS IN CUST GROUP
006851
006852         MOVE ACO-CUST-GROUP     TO DB-CUST-GROUP
006853                                    AR50WS-CUST-GROUP
006854         MOVE ACOSET2-CUST-GROUP TO WS-DB-BEG-RNG
006855         PERFORM 850-FIND-BEGRNG-ACOSET2
006856         PERFORM 431-BUILD-WORK-FILE-CUST-GROUP
006857         THRU    431-END
006858                 UNTIL (ARCOMP-NOTFOUND).
006859
006860* FOR NAT ACCOUNT CUSTOMER, BUILD WORK FOR INVOICED CUSTS
006861
006862     IF (AR50F1-X-SUMMARY = "N")
006863         MOVE AR50F1-ACM-COMPANY     TO DB-NAT-COMPANY
006864         MOVE AR50F1-ACM-CUSTOMER    TO DB-NAT-CUSTOMER
006865         MOVE NACSET1-NAT-CUSTOMER   TO WS-DB-BEG-RNG
006866         PERFORM 850-FIND-BEGRNG-NACSET1
006867         PERFORM 432-BUILD-WORK-FILE-NAT-ACT
006868         THRU    432-END
006869                 UNTIL (NATACCT-NOTFOUND).
006870
006871* REINSTATE SCREEN COMPANY, CUST DESC AND CUSTOMER VALUES
006872
006873     IF (AR50F1-X-SUMMARY NOT = "C")
006874         MOVE AR50F1-ACM-COMPANY     TO DB-COMPANY
006875         PERFORM 840-FIND-ACOSET1
006876         MOVE ACO-CUST-GROUP         TO DB-CUST-GROUP
006877         MOVE AR50F1-ACM-CUSTOMER    TO DB-CUSTOMER
006878         PERFORM 840-FIND-CUDSET1
006879         PERFORM 840-FIND-ACMSET1.
006880
006881 430-END.
006882
006883******************************************************************
006884 431-BUILD-WORK-FILE-CUST-GROUP.
006885******************************************************************
006886
006887     MOVE ACO-COMPANY            TO DB-COMPANY.
006888     MOVE AR50F1-ACM-CUSTOMER    TO DB-CUSTOMER.
006889
006890     PERFORM 435-BUILD-WORK-FILE-COMP-CUST
006891     THRU    435-END.
006892
006893     PERFORM 860-FIND-NXTRNG-ACOSET2.
006894
006895 431-END.
006896
006897******************************************************************
006898 432-BUILD-WORK-FILE-NAT-ACT.
006899******************************************************************
006900
006901     MOVE NAC-COMPANY            TO DB-COMPANY.
006902     MOVE NAC-CUSTOMER           TO DB-CUSTOMER.
006903
006904     PERFORM 840-FIND-ACOSET1.
006905     PERFORM 840-FIND-ACMSET1.
006906
006907     IF  (ARCOMP-FOUND)
006908     AND (ARCUSTOMER-FOUND)
006909         PERFORM 435-BUILD-WORK-FILE-COMP-CUST
006910         THRU    435-END.
006911
006912     PERFORM 860-FIND-NXTRNG-NACSET1.
006913
006914 432-END.
006915
006916******************************************************************
006917 435-BUILD-WORK-FILE-COMP-CUST.
006918******************************************************************
006919
006920     MOVE DB-COMPANY             TO AR50WS-COMPANY.
006921     MOVE DB-CUSTOMER            TO AR50WS-CUSTOMER.
006922     MOVE "I"                    TO DB-TRANS-TYPE.
006923     INITIALIZE AR50WS-CURR-BAL.
006924
006925     IF (AR50F1-INCLUDE-BOE      = "Y")
006926         MOVE AROSET6-TRANS-TYPE TO WS-DB-BEG-RNG
006927         PERFORM 850-FIND-BEGRNG-AROSET6
006928     ELSE
006929         MOVE AROSET3-TRANS-TYPE TO WS-DB-BEG-RNG
006930         PERFORM 850-FIND-BEGRNG-AROSET3.
006931
006932     PERFORM 440-PROCESS-AROITEMS
006933     THRU    440-END
006934         UNTIL (AROITEMS-NOTFOUND).
006935
006936     MOVE "D"                    TO DB-TRANS-TYPE.
006937
006938     IF (AR50F1-INCLUDE-BOE      = "Y")
006939         MOVE AROSET6-TRANS-TYPE TO WS-DB-BEG-RNG
006940         PERFORM 850-FIND-BEGRNG-AROSET6
006941     ELSE
006942         MOVE AROSET3-TRANS-TYPE TO WS-DB-BEG-RNG
006943         PERFORM 850-FIND-BEGRNG-AROSET3.
006944
006945     PERFORM 440-PROCESS-AROITEMS
006946     THRU    440-END
006947         UNTIL (AROITEMS-NOTFOUND).
006948
006949     MOVE "C"                    TO DB-TRANS-TYPE.
006950
006951     IF (AR50F1-INCLUDE-BOE      = "Y")
006952         MOVE AROSET6-TRANS-TYPE TO WS-DB-BEG-RNG
006953         PERFORM 850-FIND-BEGRNG-AROSET6
006954     ELSE
006955         MOVE AROSET3-TRANS-TYPE TO WS-DB-BEG-RNG
006956         PERFORM 850-FIND-BEGRNG-AROSET3.
006957
006958     PERFORM 440-PROCESS-AROITEMS
006959     THRU    440-END
006960         UNTIL (AROITEMS-NOTFOUND).
006961
006962     MOVE AR50WS-COMPANY         TO DB-COMPANY.
006963     MOVE AR50WS-CUSTOMER        TO DB-CUSTOMER.
006964     MOVE ZEROS                  TO DB-GL-DATE
006965                                    DB-BATCH-NBR
006966                                    DB-PAYMENT-SEQ.
006967
006968     MOVE APMSET9-CUSTOMER       TO WS-DB-BEG-RNG.
006969     PERFORM 850-FIND-BEGRNG-APMSET9.
006970
006971     IF  (AR50F1-X-ACTIVITY = SPACES)
006972     AND (AR50F1-X-ACCT-CAT = SPACES)
006973         PERFORM 450-PROCESS-PAYMENT
006974         THRU    450-END
006975             UNTIL (ARPAYMENT-NOTFOUND).
006976
006977     IF  (AR50F1-X-ACTIVITY = SPACES)
006978     AND (AR50F1-X-ACCT-CAT = SPACES)
006979         IF (ACG-DRAFT-PROCESS       = "Y")
006980             MOVE AR50WS-COMPANY     TO DB-COMPANY
006981             MOVE AR50WS-CUSTOMER    TO DB-CUSTOMER
006982             MOVE ARDSET9-CUSTOMER   TO WS-DB-BEG-RNG
006983             PERFORM 850-FIND-BEGRNG-ARDSET9
006984             PERFORM 465-PROCESS-ARDRAFTS
006985             THRU    465-END
006986                 UNTIL (ARDRAFTS-NOTFOUND).
006987
006988 435-END.
006989
006990******************************************************************
006991 440-PROCESS-AROITEMS.
006992******************************************************************
006993
006994     IF  (AR50F1-X-ACTIVITY NOT = SPACES)
006995         IF (AR50F1-X-ACTIVITY NOT = ARO-ACTIVITY)
006996             GO TO 440-READ-NEXT-AROITEMS
006997         ELSE
006998             IF (AR50F1-X-ACCT-CAT NOT = ARO-ACCT-CATEGORY)
006999                 GO TO 440-READ-NEXT-AROITEMS.
007000
007001     MOVE ARO-COMPANY            TO DB-COMPANY.
007002     MOVE ARO-CUSTOMER           TO DB-CUSTOMER.
007003     MOVE ARO-ALT-TYPE           TO DB-TRANS-TYPE.
007004     MOVE ARO-INVOICE            TO DB-INVOICE.
007005     PERFORM 840-FIND-ARHSET1.
007006
007007     IF  (AR50F1-X-CURRENCY NOT = SPACES)
007008     AND (AR50F1-X-CURRENCY NOT = ARH-ORIG-CURRENCY)
007009         GO TO 440-READ-NEXT-AROITEMS.
007010
007011     IF (AR50F1-X-PROCESS NOT = SPACES)
007012         IF (AR50F1-X-PROCESS NOT = ARH-PROCESS-LEVEL)
007013             GO TO 440-READ-NEXT-AROITEMS.
007014
007015* UPDATE TOTALS FOR UNRELEASED APPLICATIONS
007016
007017     IF (AR50F1-X-CURRENCY = SPACES)
007018         COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED =  ARO-TRAN-AMT
007019                                             - (ARO-APPLD-AMT
007020                                             +  ARO-ADJ-AMT)
007021     ELSE
007022         COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED =  ARO-ORIG-AMT
007023                                             - (ARO-ORIG-APP-AMT
007024                                             +  ARO-ORIG-ADJ-AMT).
007025
007026     IF (AR50WS-ARO-OPEN-AMT = ZEROS)
007027         GO TO 440-READ-NEXT-AROITEMS.
007028
007029     IF (AR50F1-X-CURRENCY NOT = SPACES)
007030         ADD AR50WS-ARO-OPEN-AMT     TO AR50WS-CURR-BAL.
007031
007032* CHECK FOR DISPUTES & AGE DISPUTES OPTIONS
007033
007034     MOVE ZEROS                  TO AR50WS-ADP-DISPUTE-AMT.
007035
007036     IF  (ARO-TRANS-TYPE         = "C")
007037     AND (AR50WS-AGE-CREDITS     = "R" OR "L")
007038     AND (ARO-DISPUTE-SEQ        > ZEROS)
007039         IF (AR50WS-AGE-DISPUTES = "N")
007040             MOVE ARO-COMPANY          TO DB-COMPANY
007041             MOVE ARO-CUSTOMER         TO DB-CUSTOMER
007042             MOVE ARO-TRANS-TYPE       TO DB-TRANS-TYPE
007043             MOVE ARO-INVOICE          TO DB-INVOICE
007044             MOVE ARO-PAYMENT-SEQ      TO DB-PAYMENT-SEQ
007045             MOVE ADPSET1-PAYMENT-SEQ  TO WS-DB-BEG-RNG
007046             PERFORM 850-FIND-BEGRNG-ADPSET1
007047             PERFORM 442-BLDDZ
007048             THRU    442-END
007049                     UNTIL (ARDISPUTE-NOTFOUND).
007050
007051     IF  (ARO-TRANS-TYPE          = "I" OR "D")
007052     AND (ARO-DISPUTE-SEQ         > ZEROS)
007053         IF (AR50WS-AGE-DISPUTES  = "N")
007054             MOVE ARO-COMPANY          TO DB-COMPANY
007055             MOVE ARO-CUSTOMER         TO DB-CUSTOMER
007056             MOVE ARO-TRANS-TYPE       TO DB-TRANS-TYPE
007057             MOVE ARO-INVOICE          TO DB-INVOICE
007058             MOVE ARO-PAYMENT-SEQ      TO DB-PAYMENT-SEQ
007059             MOVE ADPSET1-PAYMENT-SEQ  TO WS-DB-BEG-RNG
007060             PERFORM 850-FIND-BEGRNG-ADPSET1
007061             PERFORM 442-BLDDZ
007062             THRU    442-END
007063                     UNTIL (ARDISPUTE-NOTFOUND).
007064
007065     IF (AR50WS-ADP-DISPUTE-AMT > AR50WS-ARO-OPEN-AMT)
007066         MOVE AR50WS-ARO-OPEN-AMT
007067                                 TO AR50WS-ADP-DISPUTE-AMT.
007068
007069     IF (AR50WS-ADP-DISPUTE-AMT > ZEROS)
007070         PERFORM 802-CREATE-AR50A
007071         THRU    802-END
007072
007073         MOVE AR50F1-ACM-COMPANY     TO GA-COMPANY
007074         MOVE AR50F1-ACM-CUSTOMER    TO GA-CUSTOMER
007075
007076         MOVE ARO-COMPANY            TO GA-COMP
007077         MOVE ARH-BATCH-NBR          TO GA-BATCH-NBR
007078         MOVE ARO-CUSTOMER           TO GA-CUST
007079         IF (ARO-TRANS-TYPE = "I")
007080             MOVE "1"                TO GA-TRANS-TYPE
007081         END-IF
007082         IF (ARO-TRANS-TYPE = "D")
007083             MOVE "2"                TO GA-TRANS-TYPE
007084         END-IF
007085         IF (ARO-TRANS-TYPE = "C")
007086             MOVE "4"                TO GA-TRANS-TYPE
007087         END-IF
007088         MOVE ARO-ALT-TYPE           TO GA-ALT-TYPE
007089         MOVE ARH-PROCESS-LEVEL      TO GA-PROCESS-LEVEL
007090         MOVE ARO-DUE-DATE           TO GA-DUE-DATE
007091         MOVE ARO-TRANS-TYPE         TO GA-TRAN-TYPE
007092         MOVE ARH-TRANS-USER1        TO GA-TRANS-USER1
007093         MOVE ARH-AC-CUSTOMER-ID     TO GA-AC-CUSTOMER-ID
007094         MOVE ARH-SUM-LINE           TO GA-SUM-LINE
007095         MOVE ARO-INVOICE            TO GA-INVOICE
007096         MOVE ARH-ORIG-CURRENCY      TO GA-ORIG-CURRENCY
007097         MOVE ARO-TRANS-TYPE         TO DB-TRANS-TYPE
007098         MOVE ARO-INVOICE            TO DB-INVOICE
007099         MOVE ARO-PAYMENT-SEQ        TO GA-PAYMENT-SEQ
007100         MOVE ARH-XREF-NBR           TO GA-XREF-NBR
007101         INITIALIZE GA-SEQ-NBR
007102         MOVE WS-SYSTEM-DATE-YMD     TO GA-TRANS-DATE
007103         MOVE AR50WS-ADP-DISPUTE-AMT  TO GA-TRAN-AMT
007104         MOVE ZEROS              TO GA-APPLD-AMT
007105                                    GA-ADJ-AMT
007106
007107         MOVE "Y"                TO AR50WS-DISPUTE-FLAG
007108
007109         PERFORM 443-WRITE-AROITEMS-WORK-FILE
007110         THRU    443-END
007111
007112         MOVE "N"                TO AR50WS-DISPUTE-FLAG.
007113
007114     IF (AR50F1-X-CURRENCY = SPACES)
007115         COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED =  ARO-TRAN-AMT
007116                                             - (ARO-APPLD-AMT
007117                                             +  ARO-ADJ-AMT)
007118                                          - AR50WS-ADP-DISPUTE-AMT
007119     ELSE
007120         COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED =  ARO-ORIG-AMT
007121                                             - (ARO-ORIG-APP-AMT
007122                                             +  ARO-ORIG-ADJ-AMT)
007123                                         - AR50WS-ADP-DISPUTE-AMT.
007124
007125     IF (AR50WS-ARO-OPEN-AMT NOT = ZEROS)
007126         PERFORM 802-CREATE-AR50A
007127         THRU    802-END
007128         INITIALIZE                     AR50WS-ARO-GAINLOS
007129         MOVE AR50F1-ACM-COMPANY     TO GA-COMPANY
007130         MOVE AR50F1-ACM-CUSTOMER    TO GA-CUSTOMER
007131         MOVE ARO-COMPANY            TO GA-COMP
007132         MOVE ARH-BATCH-NBR          TO GA-BATCH-NBR
007133         MOVE ARO-CUSTOMER           TO GA-CUST
007134         IF (ARO-TRANS-TYPE = "I")
007135             MOVE "1"                TO GA-TRANS-TYPE
007136         END-IF
007137         IF (ARO-TRANS-TYPE = "D")
007138             MOVE "2"                TO GA-TRANS-TYPE
007139         END-IF
007140         IF (ARO-TRANS-TYPE = "C")
007141             MOVE "4"                TO GA-TRANS-TYPE
007142         END-IF
007143         MOVE ARO-ALT-TYPE           TO GA-ALT-TYPE
007144         MOVE ARH-PROCESS-LEVEL      TO GA-PROCESS-LEVEL
007145         MOVE ARH-SUM-LINE           TO GA-SUM-LINE
007146         MOVE ARO-INVOICE            TO GA-INVOICE
007147         MOVE ARO-PAYMENT-SEQ        TO GA-PAYMENT-SEQ
007148         MOVE ARH-ORIG-CURRENCY      TO GA-ORIG-CURRENCY
007149         MOVE ARO-DUE-DATE           TO GA-DUE-DATE
007150
007151         MOVE ARH-TRANS-USER1        TO GA-TRANS-USER1
007152         MOVE ARH-AC-CUSTOMER-ID     TO GA-AC-CUSTOMER-ID
007153         MOVE ARO-TRANS-TYPE         TO GA-TRAN-TYPE
007154         MOVE ARO-INVOICE            TO GA-INVOICE
007155         MOVE ARO-TRANS-TYPE         TO DB-TRANS-TYPE
007156         MOVE ARO-INVOICE            TO DB-INVOICE
007157         MOVE ARH-XREF-NBR           TO GA-XREF-NBR
007158         INITIALIZE GA-SEQ-NBR
007159         IF (ARO-TRANS-TYPE          = "D" OR "I")
007160             IF (AR50F1-X-DATE       = "D")
007161                 MOVE ARO-DUE-DATE   TO GA-TRANS-DATE
007162                 MOVE ARO-DUE-DATE   TO AR50WS-AGEDT
007163             ELSE
007164                 MOVE ARO-TRANS-DATE TO AR50WS-AGEDT
007165                 MOVE ARO-TRANS-DATE TO GA-TRANS-DATE
007166             END-IF
007167         END-IF
007168         IF (ARO-TRANS-TYPE          = "C")
007169             IF (AR50WS-AGE-CREDITS = "R")
007170                 IF (AR50F1-X-DATE  = "D")
007171                     MOVE ARO-DUE-DATE   TO AR50WS-AGEDT
007172                     MOVE ARO-DUE-DATE   TO GA-TRANS-DATE
007173                 ELSE
007174                     MOVE ARO-TRANS-DATE TO AR50WS-AGEDT
007175                     MOVE ARO-TRANS-DATE TO GA-TRANS-DATE
007176                 END-IF
007177             END-IF
007178             IF (AR50WS-AGE-CREDITS = "L")
007179                 IF (AR50F1-X-DATE  = "D")
007180                     MOVE ARO-DUE-DATE   TO AR50WS-AGEDT
007181                     MOVE ARO-DUE-DATE   TO GA-TRANS-DATE
007182                 ELSE
007183                     MOVE ARO-TRANS-DATE TO AR50WS-AGEDT
007184                     MOVE ARO-TRANS-DATE TO GA-TRANS-DATE
007185                 END-IF
007186             END-IF
007187             IF (AR50WS-AGE-CREDITS = "N")
007188                 IF (AR50F1-X-DATE  = "D")
007189                     MOVE ARO-DUE-DATE   TO AR50WS-AGEDT
007190                     MOVE ARO-DUE-DATE   TO GA-TRANS-DATE
007191                 ELSE
007192                     MOVE ARO-TRANS-DATE TO AR50WS-AGEDT
007193                     MOVE ARO-TRANS-DATE TO GA-TRANS-DATE
007194                 END-IF
007195             END-IF
007196         END-IF
007197         IF (AR50WS-ADP-DISPUTE-AMT  NOT = ZEROS)
007198             MOVE 1                  TO GA-SEQ-NBR
007199         ELSE
007200             INITIALIZE GA-SEQ-NBR
007201         END-IF
007202         IF (AR50F1-X-CURRENCY = SPACES)
007203             MOVE AR50WS-ARO-OPEN-AMT TO GA-TRAN-AMT
007204             MOVE ARO-APPLD-AMT      TO GA-APPLD-AMT
007205             MOVE ARO-ADJ-AMT        TO GA-ADJ-AMT
007206         ELSE
007207             MOVE AR50WS-ARO-OPEN-AMT TO GA-TRAN-AMT
007208             MOVE ARO-ORIG-APP-AMT   TO GA-APPLD-AMT
007209             MOVE ARO-ORIG-ADJ-AMT   TO GA-ADJ-AMT
007210         END-IF
007211         IF (AR50F1-X-GAIN-LOSS  = "Y")
007212             IF (AR50F1-X-CURRENCY = SPACES)
007213                 ADD ARO-GAINLOS-AMT    TO AR50WS-ARO-GAINLOS
007214                 ADD ARO-GAINLOS-AMT    TO AR50WS-GAINLOS-AMT
007215             ELSE
007216                 MOVE AR50F1-ACM-COMPANY    TO IFGRWS-COMPANY
007217                 MOVE ACO-CURRENCY-CD       TO IFGRWS-FR-CURR-CODE
007218                 MOVE AR50F1-X-CURRENCY     TO IFGRWS-TO-CURR-CODE
007219                 MOVE "AR"                  TO IFGRWS-SYSTEM
007220                 MOVE WS-SYSTEM-DATE-YMD    TO IFGRWS-EFFECT-DATE
007221                 PERFORM 660-GET-CURRENCY-RATE-60
007222                 IF  (ERROR-FOUND)
007223                 AND (IFGRWS-CURSOR-POSITION  = "C")
007224                     INITIALIZE CRT-ERROR-NBR
007225                     ADD ARO-GAINLOS-AMT    TO AR50WS-ARO-GAINLOS
007226                     ADD ARO-GAINLOS-AMT    TO AR50WS-GAINLOS-AMT
007227                 ELSE
007228                     MOVE AR50F1-ACM-COMPANY TO IFCAWS-COMPANY
007229                     MOVE ACO-CURRENCY-CD   TO IFCAWS-FR-CURR-CODE
007230                     MOVE AR50F1-X-CURRENCY TO IFCAWS-TO-CURR-CODE
007231                     MOVE "AR"              TO IFCAWS-SYSTEM
007232                     MOVE WS-SYSTEM-DATE-YMD
007233                                            TO IFCAWS-EFFECT-DATE
007234                     MOVE ARO-GAINLOS-AMT   TO IFCAWS-TRAN-AMOUNT
007235                     INITIALIZE IFCAWS-BASE-AMOUNT
007236                     MOVE IFGRWS-SELL-RATE  TO IFCAWS-BASERATE
007237                     MOVE IFCRWS-MULT-DIV   TO IFCAWS-MULT-DIV
007238                     MOVE ZEROES            TO IFCAWS-TRAN-ND
007239                     MOVE ZEROES            TO IFCAWS-BASE-ND
007240                     PERFORM 690-CALCULATE-AMOUNT-60
007241                     ADD IFCAWS-BASE-AMOUNT TO AR50WS-ARO-GAINLOS
007242                     ADD IFCAWS-BASE-AMOUNT TO AR50WS-GAINLOS-AMT
007243                 END-IF
007244             END-IF
007245         END-IF
007246         PERFORM 443-WRITE-AROITEMS-WORK-FILE
007247         THRU    443-END.
007248
007249     IF (ARO-TRANS-TYPE  = "C")
007250         COMPUTE AR50WS-UNAPPLIED ROUNDED = AR50WS-UNAPPLIED
007251                                          - AR50WS-ARO-OPEN-AMT
007252     END-IF.
007253
007254 440-READ-NEXT-AROITEMS.
007255
007256     IF (AR50F1-INCLUDE-BOE             = "Y")
007257         PERFORM 860-FIND-NXTRNG-AROSET6
007258     ELSE
007259         PERFORM 860-FIND-NXTRNG-AROSET3.
007260
007261
007262 440-END.
007263
007264******************************************************************
007265 442-BLDDZ.
007266******************************************************************
007267
007268* BUILD THE DISPUTE AMOUNT
007269
007270     IF (ADP-DISPUTE-DATE < WS-SYSTEM-DATE-YMD) OR
007271        (ADP-DISPUTE-DATE = WS-SYSTEM-DATE-YMD)
007272         IF (ADP-RESOLV-DATE = ZEROS) OR
007273            (ADP-RESOLV-DATE > WS-SYSTEM-DATE-YMD)
007274             IF (AR50F1-X-CURRENCY = SPACES)
007275                 COMPUTE AR50WS-ADP-DISPUTE-AMT ROUNDED
007276                               = AR50WS-ADP-DISPUTE-AMT
007277                               + ADP-DISPUTE-AMT
007278             ELSE
007279                 COMPUTE AR50WS-ADP-DISPUTE-AMT ROUNDED
007280                               = AR50WS-ADP-DISPUTE-AMT
007281                               + ADP-ORIG-DISP.
007282
007283 442-READ-NEXT-DISPUTE.
007284
007285     PERFORM 860-FIND-NXTRNG-ADPSET1.
007286
007287 442-END.
007288
007289******************************************************************
007290 443-WRITE-AROITEMS-WORK-FILE.
007291******************************************************************
007292
007293     COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED = GA-TRAN-AMT
007294                                         + AR50WS-ARO-GAINLOS.
007295
007296     IF  (AR50WS-ARO-OPEN-AMT    NOT = ZEROS)
007297     AND (ARO-TRANS-TYPE         = "C")
007298         COMPUTE AR50WS-ARO-OPEN-AMT = AR50WS-ARO-OPEN-AMT
007299                                     * NEGATIVE-ONE.
007300
007301     IF (AR50WS-DISPUTE-FLAG = "Y")
007302         MOVE 2              TO AR50WS-P
007303         GO TO 443-CONT.
007304
007305* STORE LAST AGE PERIOD
007306     IF (AR50WS-EAGDT = ZEROS)
007307        MOVE AR50WS-AGEDT        TO AR50WS-EAGDT.
007308     IF (AR50WS-AGEDT < AR50WS-EAGDT)
007309         MOVE AR50WS-AGEDT       TO AR50WS-EAGDT
007310     ELSE
007311         IF  (AR50WS-AGE-CREDITS = "L")
007312         AND (ARO-TRANS-TYPE          = "C")
007313             MOVE AR50WS-EAGDT   TO AR50WS-AGEDT
007314         END-IF
007315     END-IF.
007316
007317     PERFORM 470-FINDPRD
007318     THRU    470-END.
007319
007320 443-CONT.
007321     MOVE 1              TO GA-ORIG-RATE.
007322     MOVE "M"            TO GA-CURR-MUDV.
007323     IF  (AR50F1-X-SUMMARY NOT = "C")
007324     AND (AR50F1-X-CURRENCY    = SPACES)
007325         IF (ACO-CURRENCY-CD NOT = ACG-CURRENCY-CD)
007326             MOVE ARH-GROUP-RATE TO GA-ORIG-RATE
007327             MOVE ARH-GROUP-MUDV TO GA-CURR-MUDV
007328             IF (ARH-GROUP-MUDV = "M")
007329                 COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED
007330                                 = AR50WS-ARO-OPEN-AMT
007331                                 * ARH-GROUP-RATE
007332             ELSE
007333                 COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED
007334                                 = AR50WS-ARO-OPEN-AMT
007335                                 / ARH-GROUP-RATE.
007336
007337     PERFORM 480-ADD-TO-AGE-PERIODS
007338     THRU    480-END.
007339
007340     MOVE AR50WS-P               TO GA-PERIOD.
007341
007342     MOVE CRT-USER-NAME          TO GA-NAME-USER.
007343     PERFORM 810-STORE-AR50A
007344     THRU    810-END.
007345
007346 443-END.
007347
007348
007349******************************************************************
007350 450-PROCESS-PAYMENT.
007351******************************************************************
007352
007353* UPDATE UNRELEASED PAYMENT TOTAL
007354
007355     IF  (ACO-OB-DRF-FL  NOT = "Y")
007356     AND (APM-TRANS-TYPE     = "B")
007357          GO TO 450-READ-NEXT-PAYMENT.
007358
007359     IF  (AR50F1-X-CURRENCY NOT = SPACES)
007360     AND (AR50F1-X-CURRENCY NOT = APM-ORIG-CURRENCY)
007361         GO TO 450-READ-NEXT-PAYMENT.
007362
007363     IF (AR50F1-X-PROCESS NOT = SPACES)
007364         IF (AR50F1-X-PROCESS NOT = APM-PROCESS-LEVEL)
007365             GO TO 450-READ-NEXT-PAYMENT.
007366
007367     IF (APM-STATUS = ZEROS)
007368         PERFORM 451-KPURL
007369         THRU    451-END.
007370
007371     COMPUTE AR50WS-APM-OPEN-AMT ROUNDED =  APM-TRAN-AMT
007372                                         +  APM-CREDIT-APPLD
007373                                         - (APM-APPLD-AMT
007374                                         +  APM-ADJ-AMT).
007375
007376     IF  (APM-STATUS                = ZEROS)
007377     AND (APM-PAYMENT-SEQ       NOT = ZEROS)
007378          MOVE APM-COMPANY          TO DB-CR-COMPANY
007379          MOVE APM-BATCH-NBR        TO DB-CR-BATCH
007380          MOVE APM-PAYMENT-SEQ      TO DB-CR-PYMNT-SEQ
007381          MOVE ARASET2-CR-PYMNT-SEQ TO WS-DB-BEG-RNG
007382          PERFORM 850-FIND-BEGRNG-ARASET2
007383          PERFORM 452-UNRELAPPLD
007384          THRU    452-END
007385              UNTIL (ARAPPLIED-NOTFOUND).
007386
007387     IF (AR50WS-APM-OPEN-AMT = ZEROS)
007388     OR (APM-STATUS          = ZEROS)
007389         GO TO 450-READ-NEXT-PAYMENT.
007390
007391     PERFORM 802-CREATE-AR50A
007392     THRU    802-END.
007393
007394* MOVE THE SCREEN COMPANY AND CUSTOMER TO WORK FILE.
007395
007396     MOVE AR50F1-ACM-COMPANY     TO GA-COMPANY.
007397     MOVE AR50F1-ACM-CUSTOMER    TO GA-CUSTOMER.
007398
007399     MOVE APM-COMPANY            TO GA-COMP.
007400     MOVE APM-BATCH-NBR          TO GA-BATCH-NBR.
007401     MOVE APM-CUSTOMER           TO GA-CUST.
007402     MOVE "3"                    TO GA-TRANS-TYPE.
007403     MOVE APM-TRANS-TYPE         TO GA-TRAN-TYPE.
007404     MOVE APM-PAYMENT-SEQ        TO GA-SEQ-NBR.
007405     MOVE APM-PROCESS-LEVEL      TO GA-PROCESS-LEVEL.
007406     MOVE APM-GL-DATE            TO GA-TRANS-DATE.
007407     INITIALIZE                     GA-XREF-NBR.
007408     MOVE ARH-TRANS-USER1        TO GA-TRANS-USER1.
007409     MOVE ARH-AC-CUSTOMER-ID     TO GA-AC-CUSTOMER-ID.
007410     MOVE APM-TRANS-NBR          TO GA-INVOICE.
007411     MOVE APM-ORIG-CURRENCY      TO GA-ORIG-CURRENCY.
007412     MOVE ZEROS                  TO GA-DUE-DATE.
007413
007414     IF (AR50F1-X-CURRENCY = SPACES)
007415         COMPUTE GA-TRAN-AMT ROUNDED  = (APM-TRAN-AMT
007416                                      +  APM-CREDIT-APPLD
007417                                      -  APM-APPLD-AMT
007418                                      -  APM-ADJ-AMT)
007419                                      *  NEGATIVE-ONE
007420         COMPUTE GA-APPLD-AMT ROUNDED = APM-APPLD-AMT
007421                                      * NEGATIVE-ONE
007422         COMPUTE GA-ADJ-AMT ROUNDED   = APM-ADJ-AMT
007423                                      * NEGATIVE-ONE
007424     ELSE
007425         COMPUTE GA-TRAN-AMT ROUNDED  = (APM-ORIG-AMT
007426                                      +  APM-ORIG-CR-APPLD
007427                                      -  APM-ORIG-APP-AMT
007428                                      -  APM-ORIG-ADJ-AMT)
007429                                      *  NEGATIVE-ONE
007430         COMPUTE GA-APPLD-AMT ROUNDED = APM-ORIG-APP-AMT
007431                                      * NEGATIVE-ONE
007432         COMPUTE GA-ADJ-AMT ROUNDED   = APM-ORIG-ADJ-AMT
007433                                      * NEGATIVE-ONE.
007434
007435     IF (AR50WS-AGE-PYMNT = "R")
007436         MOVE APM-GL-DATE        TO AR50WS-AGEDT
007437     ELSE
007438         IF (AR50WS-AGE-PYMNT = "L")
007439             MOVE AR50WS-EAGDT   TO AR50WS-AGEDT
007440         ELSE
007441             MOVE WS-SYSTEM-DATE-YMD
007442                                 TO AR50WS-AGEDT.
007443
007444     PERFORM 470-FINDPRD
007445     THRU    470-END.
007446
007447     IF (AR50F1-X-CURRENCY = SPACES)
007448         COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED = (APM-TRAN-AMT
007449                                             +  APM-CREDIT-APPLD)
007450                                             - (APM-APPLD-AMT
007451                                             +  APM-ADJ-AMT)
007452     ELSE
007453         COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED = (APM-ORIG-AMT
007454                                             +  APM-ORIG-CR-APPLD)
007455                                             - (APM-ORIG-APP-AMT
007456                                             +  APM-ORIG-ADJ-AMT).
007457
007458     COMPUTE AR50WS-ARO-OPEN-AMT = AR50WS-ARO-OPEN-AMT
007459                                 * NEGATIVE-ONE.
007460
007461     IF (AR50F1-X-CURRENCY NOT = SPACES)
007462         ADD AR50WS-ARO-OPEN-AMT     TO AR50WS-CURR-BAL.
007463
007464     MOVE 1              TO GA-ORIG-RATE.
007465     MOVE "M"            TO GA-CURR-MUDV.
007466     IF  (AR50F1-X-SUMMARY NOT = "C")
007467     AND (AR50F1-X-CURRENCY    = SPACES)
007468         IF (ACO-CURRENCY-CD NOT = ACG-CURRENCY-CD)
007469             MOVE APM-GROUP-RATE TO GA-ORIG-RATE
007470             MOVE APM-GROUP-MUDV TO GA-CURR-MUDV
007471             IF (APM-GROUP-MUDV = "M")
007472                 COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED
007473                                 = AR50WS-ARO-OPEN-AMT
007474                                 * APM-GROUP-RATE
007475             ELSE
007476                 COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED
007477                                 = AR50WS-ARO-OPEN-AMT
007478                                 / APM-GROUP-RATE.
007479
007480     PERFORM 480-ADD-TO-AGE-PERIODS
007481     THRU    480-END.
007482
007483     COMPUTE AR50WS-UNAPPLIED ROUNDED = AR50WS-UNAPPLIED
007484                                      - AR50WS-ARO-OPEN-AMT.
007485
007486     MOVE AR50WS-P               TO GA-PERIOD.
007487
007488     MOVE CRT-USER-NAME          TO GA-NAME-USER.
007489     MOVE APM-PAYMENT-SEQ            TO GA-SEQ-NBR.
007490     PERFORM 810-STORE-AR50A
007491     THRU    810-END.
007492
007493 450-READ-NEXT-PAYMENT.
007494
007495     PERFORM 860-FIND-NXTRNG-APMSET9.
007496
007497 450-END.
007498
007499******************************************************************
007500 451-KPURL.
007501******************************************************************
007502
007503* PROCESS UNRELEASED PAYMENT
007504
007505     IF (AR50F1-X-CURRENCY = SPACES)
007506         MOVE APM-TRAN-AMT           TO AR50WS-APM-TRAN-AMT
007507     ELSE
007508         MOVE APM-ORIG-AMT           TO AR50WS-APM-TRAN-AMT.
007509
007510     IF  (AR50F1-X-SUMMARY NOT = "C")
007511     AND (AR50F1-X-CURRENCY = SPACES)
007512         IF (ACO-CURRENCY-CD NOT = ACG-CURRENCY-CD)
007513             IF (APM-GROUP-MUDV = "M")
007514                 COMPUTE AR50WS-APM-TRAN-AMT ROUNDED
007515                                 = APM-TRAN-AMT
007516                                 * APM-GROUP-RATE
007517             ELSE
007518                 COMPUTE AR50WS-APM-TRAN-AMT ROUNDED
007519                                 = APM-TRAN-AMT
007520                                 / APM-GROUP-RATE.
007521
007522     COMPUTE AR50WS-UNRELPAYMNT ROUNDED = AR50WS-UNRELPAYMNT
007523                                        + AR50WS-APM-TRAN-AMT.
007524
007525 451-END.
007526
007527******************************************************************
007528 452-UNRELAPPLD.
007529******************************************************************
007530
007531     MOVE ARA-APPLD-AMT                TO AR50WS-ARA-APPLD-AMT.
007532     MOVE ARA-ADJ-AMT                  TO AR50WS-ARA-ADJ-AMT.
007533
007534     COMPUTE AR50WS-UNRELAPPLD ROUNDED = AR50WS-UNRELAPPLD
007535                                       + AR50WS-ARA-APPLD-AMT
007536                                       + AR50WS-ARA-ADJ-AMT.
007537
007538 452-READ-NEXT-ARAPPLIED.
007539
007540     PERFORM 860-FIND-NXTRNG-ARASET2.
007541
007542 452-END.
007543
007544******************************************************************
007545 465-PROCESS-ARDRAFTS.
007546******************************************************************
007547
007548     IF  (AR50F1-X-CURRENCY NOT = SPACES)
007549     AND (AR50F1-X-CURRENCY NOT = ARD-ORIG-CURRENCY)
007550         GO TO 465-READ-NEXT-ARDRAFTS.
007551
007552     IF  (AR50F1-X-PROCESS       NOT = SPACES)
007553     AND (AR50F1-X-PROCESS       NOT = ARD-PROCESS-LEVEL)
007554         GO TO 465-READ-NEXT-ARDRAFTS.
007555
007556     IF  (ARD-STATUS             = 5)
007557         GO TO 465-READ-NEXT-ARDRAFTS.
007558
007559     IF  (ARD-STATUS             = 6)
007560     AND (ARD-RISK-FL            NOT = "Y")
007561         GO TO 465-READ-NEXT-ARDRAFTS.
007562
007563     IF  (ARD-STATUS             = 7)
007564     AND (ARD-RESOLUTION-FL      = SPACE)
007565         GO TO 465-CONT.
007566
007567     IF (ARD-STATUS              > 6)
007568         GO TO 465-READ-NEXT-ARDRAFTS.
007569
007570 465-CONT.
007571
007572     PERFORM 802-CREATE-AR50A
007573     THRU    802-END.
007574
007575* MOVE THE SCREEN COMPANY AND CUSTOMER TO WORK FILE.
007576
007577     MOVE AR50F1-ACM-COMPANY     TO GA-COMPANY.
007578     MOVE AR50F1-ACM-CUSTOMER    TO GA-CUSTOMER.
007579
007580     MOVE ARD-COMPANY            TO GA-COMP.
007581     MOVE ZEROS                  TO GA-BATCH-NBR.
007582     MOVE ARD-CUSTOMER           TO GA-CUST.
007583     MOVE "5"                    TO GA-TRANS-TYPE.
007584     MOVE "B"                    TO GA-TRAN-TYPE.
007585     MOVE ARD-PROCESS-LEVEL      TO GA-PROCESS-LEVEL.
007586     IF (AR50F1-X-DATE = "D")
007587         MOVE ARD-MATURITY-DATE  TO GA-TRANS-DATE
007588                                    AR50WS-AGEDT
007589     ELSE
007590         MOVE ARD-DRAFT-DATE     TO GA-TRANS-DATE
007591                                    AR50WS-AGEDT.
007592
007593     MOVE ARH-TRANS-USER1        TO GA-TRANS-USER1.
007594     MOVE ARH-AC-CUSTOMER-ID     TO GA-AC-CUSTOMER-ID.
007595     MOVE ARD-SUFFIX             TO GA-PAYMENT-SEQ.
007596     INITIALIZE                     GA-XREF-NBR.
007597     MOVE ARH-SUM-LINE           TO GA-SUM-LINE.
007598     MOVE ARD-AR-DRAFT-NBR       TO GA-INVOICE.
007599     MOVE ARD-DRAFT-SOURCE       TO GA-DRAFT-SOURCE.
007600     MOVE ZEROS                  TO GA-DUE-DATE
007601                                    GA-ADJ-AMT.
007602     MOVE ARD-ORIG-CURRENCY      TO GA-ORIG-CURRENCY.
007603     INITIALIZE GA-SEQ-NBR.
007604     IF (AR50F1-X-CURRENCY = SPACES)
007605         MOVE ARD-TRAN-AMT       TO GA-TRAN-AMT
007606     ELSE
007607         MOVE ARD-ORIG-AMT       TO GA-TRAN-AMT.
007608
007609     PERFORM 470-FINDPRD
007610     THRU    470-END.
007611
007612     IF (AR50F1-X-CURRENCY = SPACES)
007613         MOVE ARD-TRAN-AMT       TO AR50WS-ARO-OPEN-AMT
007614     ELSE
007615         MOVE ARD-ORIG-AMT       TO AR50WS-ARO-OPEN-AMT.
007616
007617     IF (AR50F1-X-CURRENCY NOT = SPACES)
007618         ADD AR50WS-ARO-OPEN-AMT     TO AR50WS-CURR-BAL.
007619
007620     IF  (AR50F1-X-SUMMARY NOT = "C")
007621     AND (AR50F1-X-CURRENCY    = SPACES)
007622         IF (ACO-CURRENCY-CD NOT = ACG-CURRENCY-CD)
007623             MOVE ARD-GROUP-RATE TO GA-ORIG-RATE
007624             MOVE ARD-GROUP-MUDV TO GA-CURR-MUDV
007625             IF (ARD-GROUP-MUDV = "M")
007626                 COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED
007627                                 = AR50WS-ARO-OPEN-AMT
007628                                 * ARD-GROUP-RATE
007629             ELSE
007630                 COMPUTE AR50WS-ARO-OPEN-AMT ROUNDED
007631                                 = AR50WS-ARO-OPEN-AMT
007632                                 / ARD-GROUP-RATE
007633         ELSE
007634             MOVE 1              TO GA-ORIG-RATE
007635             MOVE "M"            TO GA-CURR-MUDV
007636     ELSE
007637         MOVE 1                  TO GA-ORIG-RATE
007638         MOVE "M"                TO GA-CURR-MUDV.
007639
007640     PERFORM 480-ADD-TO-AGE-PERIODS
007641     THRU    480-END.
007642
007643     MOVE AR50WS-P               TO GA-PERIOD.
007644
007645     MOVE CRT-USER-NAME          TO GA-NAME-USER.
007646     MOVE ARD-CANCEL-SEQ         TO GA-SEQ-NBR.
007647     PERFORM 810-STORE-AR50A
007648     THRU    810-END.
007649
007650 465-READ-NEXT-ARDRAFTS.
007651
007652     PERFORM 860-FIND-NXTRNG-ARDSET9.
007653
007654 465-END.
007655
007656******************************************************************
007657 470-FINDPRD.
007658******************************************************************
007659
007660* FIND AGING PERIOD
007661* INPUT : AR50WS-AGEDT
007662* OUTPUT: P = AGING PERIOD NUMBER.
007663*         P = 1    - FUTURE
007664*         P = 2    - CURRENT
007665*         P = 3..7 - AGE BUCKETS
007666*
007667
007668     MOVE WS-SYSTEM-DATE-YMD     TO WSDR-FR-DATE.
007669     PERFORM 900-DATE-TO-JULIAN.
007670     MOVE WSDR-JULIAN-DAYS       TO AR50WS-J-ASOFD.
007671
007672     MOVE AR50WS-AGEDT           TO WSDR-FR-DATE.
007673     PERFORM 900-DATE-TO-JULIAN.
007674     MOVE WSDR-JULIAN-DAYS       TO AR50WS-J-AGEDT.
007675
007676     COMPUTE AR50WS-DP           = AR50WS-J-ASOFD
007677                                 - AR50WS-J-AGEDT.
007678
007679     MOVE AR50WS-DP              TO AR50WS-DP1.
007680
007681     IF  (AR50WS-AGE-CREDITS = "N")
007682     AND (ARO-TRANS-TYPE     = "C")
007683          MOVE ZEROS              TO AR50WS-DP
007684     END-IF.
007685
007686     IF (AR50WS-DP = ZEROS)
007687         MOVE 2                  TO AR50WS-P
007688         GO TO 470-END.
007689
007690     IF (AR50WS-DP < ZEROS)
007691         IF (AR50WS-DP1 < AR50WS-AGE-CURRENT)
007692         OR (AR50WS-DP1 = AR50WS-AGE-CURRENT)
007693             MOVE 2              TO AR50WS-P
007694             GO TO 470-END
007695         ELSE
007696             MOVE 1              TO AR50WS-P
007697             GO TO 470-END.
007698
007699     IF (AR50WS-DP > 999)
007700         MOVE 7                  TO AR50WS-P
007701         GO TO 470-END.
007702
007703     IF (AR50WS-DP1 NOT > AR50WS-AGE-PERIODS (1))
007704         MOVE 3                  TO AR50WS-P
007705     ELSE
007706         IF (AR50WS-DP1 NOT > AR50WS-AGE-PERIODS (2))
007707             MOVE 4              TO AR50WS-P
007708         ELSE
007709             IF (AR50WS-DP1 NOT > AR50WS-AGE-PERIODS (3))
007710                 MOVE 5          TO AR50WS-P
007711             ELSE
007712                 IF (AR50WS-DP1 NOT > AR50WS-AGE-PERIODS (4))
007713                     MOVE 6      TO AR50WS-P
007714                 ELSE
P3FX22                 IF (AR50WS-DP1 NOT > AR50WS-AGE-PERIODS (5))
P3FX22                     MOVE 7      TO AR50WS-P
P3FX22                 ELSE
P3FX22                 IF (AR50WS-DP1 NOT > AR50WS-AGE-PERIODS (6))
P3FX22                     MOVE 8      TO AR50WS-P
P3FX22                 ELSE
P3FX22                     MOVE 9      TO AR50WS-P.
P3FX22*                     MOVE 7      TO AR50WS-P.
007716
007717 470-END.
007718
007719******************************************************************
007720 480-ADD-TO-AGE-PERIODS.
007721******************************************************************
007722
          IF (AR50WS-P < 1)
          OR (AR50WS-P > 9)
              DISPLAY "AR50-480-ADD " AR50WS-P " " AR50F1-ACM-CUSTOMER.
007723     COMPUTE AR50WS-OPEN-AMT (AR50WS-P) ROUNDED
007724                                 = AR50WS-OPEN-AMT (AR50WS-P)
007725                                 + AR50WS-ARO-OPEN-AMT.
007726
007727     ADD 1 TO AR50F1-COUNT (AR50WS-P).
007728
007729 480-END.
007730
007731
007732******************************************************************
007733 802-CREATE-AR50A.
007734******************************************************************
007735
007736     INITIALIZE GA-NAME-USER
007737                GA-PERIOD
007738                GA-TRANS-DATE
007739                GA-TRANS-TYPE
007740                GA-TRANS-USER1
007741                GA-AC-CUSTOMER-ID
007742                GA-INVOICE
007743                GA-PAYMENT-SEQ
007744                GA-COMPANY
007745                GA-CUSTOMER
007746                GA-BATCH-NBR
007747                GA-SEQ-NBR
007748                GA-COMP
007749                GA-CUST
007750                GA-PROCESS-LEVEL
007751                GA-DUE-DATE
007752                GA-TRAN-AMT
007753                GA-APPLD-AMT
007754                GA-ADJ-AMT
007755                GA-ORIG-RATE
007756                GA-CURR-MUDV
007757                GA-TRAN-TYPE
007758                GA-XREF-NBR
007759                GA-DRAFT-SOURCE
007760                GA-ORIG-CURRENCY
007761                GA-ALT-TYPE.
007762
007763     MOVE WS-TRUE                TO ARWS-AR50A-CREATED-SW.
007764
007765 802-END.
007766******************************************************************
007767 810-STORE-AR50A.
007768******************************************************************
007769
007770     IF (AR50A-CREATED)
007771         WRITE AR50A-REC        INVALID KEY
007772             MOVE 404                 TO CRT-ERROR-NBR
007773             PERFORM 790-GET-MSG.
007774
007775     IF (NOT AR50A-CREATED)
007776         REWRITE AR50A-REC      INVALID KEY
007777             MOVE 404                 TO CRT-ERROR-NBR
007778             PERFORM 790-GET-MSG.
007779
007780     MOVE WS-FALSE               TO ARWS-AR50A-CREATED-SW.
007781
007782 810-END.
007783******************************************************************
007784 AR50S1-TRANSACTION-END.
007785******************************************************************
007786

